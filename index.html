<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{--moe:#0b7e88;--ink:#111;--sidebarW:390px;--b:#e6eeee}
*{box-sizing:border-box}
html,body{margin:0;background:#f6fafb;color:var(--ink);font:12.6px/1.8 Tajawal,system-ui;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
p,li,span,strong,b{letter-spacing:0;word-spacing:.25px}
.app{display:grid;grid-template-columns:var(--sidebarW) 1fr;min-height:100vh}
@media (max-width:1024px){ .app{grid-template-columns:1fr} }

.sidebar{position:sticky;top:0;height:100vh;background:#fff;border-inline-end:1px solid #e8f2f2;box-shadow:0 0 24px rgba(0,0,0,.04);display:flex;flex-direction:column;z-index:5}
@media (max-width:1024px){
  .sidebar{position:relative;height:auto;top:auto;border-inline-end:0;border-bottom:1px solid #e8f2f2}
}
.sb-head{padding:12px;border-bottom:1px solid #eef4f4;font-weight:900;color:#064b50}
.sb-body{padding:12px;overflow:auto;max-height:calc(100vh - 120px)}
@media (max-width:1024px){.sb-body{max-height:none}}
.f{display:flex;flex-direction:column;gap:4px;margin-bottom:10px}
.f label{font-weight:800;color:#03636a;font-size:11.8px}
.sel,.inp,.btn{height:36px;border:1px solid #dbe9e9;border-radius:12px;background:#fff;padding:7px 10px;font-weight:800}
.sel{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#89a 0),linear-gradient(135deg,#89a 50%,transparent 0);background-position:calc(100% - 18px) 50%,calc(100% - 12px) 50%;background-size:6px 6px,6px 6px;background-repeat:no-repeat;cursor:pointer}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid #dbe9e9;border-radius:14px;background:#f2fafb;color:#0b5e63;font-weight:900;padding:7px 12px;cursor:pointer}
.chip.active{background:var(--moe);color:#fff;border-color:transparent}
.btn{cursor:pointer}
.btn.ghost{background:#eef7f7}
.btn.primary{background:var(--moe);color:#fff;border-color:transparent}
.btn.wh{background:#25D366;color:#fff;border-color:#1aae53}
/* Ø²Ø± Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ø´Ù‡Ø±ÙŠ */
.btn.monthlyStats{
  background:linear-gradient(90deg,#0ea5e9,#2563eb);
  color:#fff;
  border-color:transparent;
  box-shadow:0 10px 26px rgba(37,99,235,.18);
}
.btn.monthlyStats:hover{filter:brightness(.98)}
.btn.monthlyStats:active{transform:translateY(1px)}

.sb-actions{margin-top:8px;display:flex;flex-direction:column;gap:10px}
.rights{font-size:10px;color:#7a8790;text-align:center;padding:8px 10px;border-top:1px dashed #eef4f4;margin-top:auto}
.disabled{opacity:.45;pointer-events:none;filter:grayscale(1)}

.box{border:1px solid #e7f0f0;border-radius:14px;padding:12px;background:#fbfeff}
.mini{font-size:11.1px;color:#60727a;font-weight:800}
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #dbe9e9;border-radius:999px;padding:5px 11px;background:#f2fafb;color:#0b5e63;font-weight:900}
.pill b{color:#064b50}
.sep{height:1px;background:#eef4f4;margin:12px 0}
.smallbtn{height:auto;padding:8px 12px;border-radius:14px}
.list{border:1px solid #e7f0f0;border-radius:14px;overflow:hidden;background:#fff}
.list table{width:100%;border-collapse:collapse;font-size:11.6px}
.list th{background:#0b5e63;color:#fff;padding:8px 9px;text-align:center}
.list td{border-top:1px solid #eef4f4;padding:7px 9px;text-align:center}
.tag{display:inline-flex;align-items:center;justify-content:center;padding:2px 9px;border-radius:999px;font-weight:900;border:1px solid #dbe9e9;background:#f2fafb;color:#0b5e63}
.tag.red{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.tag.amber{background:#fef3c7;border-color:#fde68a;color:#92400e}
.tag.green{background:#dcfce7;border-color:#bbf7d0;color:#166534}

/* Ø£Ù„ÙˆØ§Ù† Ø²Ø±Ù‘ÙÙŠ Ø­Ø¶ÙˆØ±ÙŠ */
.btn.importSoft{background:#ffe7e7;border-color:#fecaca;color:#7c2d12}
.btn.driveSoft{background:#e8fff1;border-color:#bbf7d0;color:#166534}
.btn.importSoft:hover{filter:brightness(.98)}
.btn.driveSoft:hover{filter:brightness(.98)}

@keyframes pulseWarn{
  0%{transform:scale(1); box-shadow:0 0 0 rgba(245,158,11,.0)}
  50%{transform:scale(1.01); box-shadow:0 0 0 7px rgba(245,158,11,.12)}
  100%{transform:scale(1); box-shadow:0 0 0 rgba(245,158,11,.0)}
}
.warn{border:1px solid #f59e0b;background:#fffbeb;color:#92400e;border-radius:12px;padding:10px 10px;font-weight:900}
.warn b{color:#7c2d12}
.warn.strong{border-width:2px;animation:pulseWarn 1.05s ease-in-out infinite}
.warn .cta{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
.warn .cta .btn{height:auto;padding:7px 10px;border-radius:12px}
.ok{border:1px solid #bbf7d0;background:#ecfdf5;color:#166534;border-radius:12px;padding:8px 10px;font-weight:900}

.content{padding:16px}
.sheet-wrap{display:flex;justify-content:center;overflow:auto}
.sheet{width:100%;max-width:210mm;min-height:297mm;background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.04)}
.pad{padding:8mm 10mm 9mm}

.hdr{position:relative;margin:0 0 5mm}
.hdr img{width:100%;display:block;border-radius:12px;image-rendering:auto}
.meta-stack{position:absolute;inset-inline-end:12px;top:12px;display:flex;flex-direction:column;gap:6px;min-width:130px;transform:translateX(4px)}
.meta-stack .rowB{background:transparent;border:0;border-radius:10px;padding:6px 10px;font-weight:900;text-align:center}

.title-center{text-align:center;margin:5mm 0 3mm}
.title-center .t{font-weight:900;font-size:22px;color:#064b50}

.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl th{background:#0b5e63;color:#fff;border:1px solid #244a4a;padding:6px 7px;font-weight:900}
.tbl td{border:1px solid #3f5b57;padding:5px 7px;height:10mm;text-align:center}
.tbl .name{width:38%}.tbl .spec{width:14%}.tbl .level{width:16%}.tbl .job{width:16%}.tbl .work{width:16%}

.badges-under{margin:6px auto 0;display:flex;gap:10px;justify-content:flex-start;align-items:center;width:100%}
.badge{display:inline-flex;align-items:center;gap:8px;border:1px solid #0b7e88;border-radius:10px;padding:2px 10px;background:#fff;font-weight:900}
.badge .tag{background:var(--moe);color:#fff;border-radius:8px;padding:2px 8px}

.sec{margin-top:6mm}
.sec h3{margin:0 0 6px;color:#0b5e63;font-size:14px}
.rule-row{display:flex;align-items:center;gap:6px;margin-top:3px}
.rule-row .label{font-weight:900;white-space:nowrap}
.dotfield{display:inline-block;min-width:25mm;border-bottom:1px dotted #2f4f4c;text-align:center;padding:0 2mm}
.timebox{display:inline-block;min-width:26mm;text-align:center;padding:.4mm 2.5mm;background:#fff;color:#111;font-weight:900;border-radius:6px;border:1px solid #000;font-family:ui-monospace,Consolas,monospace;font-size:12px;cursor:text}
.timebox.empty{color:#777;border-color:#bbb}
.checks{margin:5px 0 6px}
.checkline{display:flex;align-items:flex-start;gap:6px;margin:5px 0}
.checkline input{margin-top:3px;transform:scale(1.05)}
.checkline .text{flex:1}
.calc{font-weight:900;color:#0b5e63}

.lines{min-height:26mm;border:1px dashed #2f4f4c;border-radius:10px;padding:8px 10px;background:#fafefe}
.lines div{height:9mm;border-bottom:1px dotted #2f4f4c}
.lines div:last-child{border-bottom:0}
.lines.dotted{border-color:#cfd8d8}
.lines.dotted div{border-bottom:1px dotted #c7cfd0}

.footer-note{margin-top:10mm}
.footer-note span{display:inline-block;margin-inline-end:auto;color:#333;font-size:10.5px;font-weight:800}

/* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
#statsDlg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:50;align-items:center;justify-content:center;padding:12px}
.stats-card{background:#fff;border-radius:16px;max-width:1100px;width:96%;max-height:90vh;overflow:auto;border:1px solid var(--b)}
.stats-card .h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef4f4}
.stats-hdr{position:relative;margin:8px 8px 10px}
.stats-hdr img{width:100%;display:block;border-radius:12px}
.stats-meta{position:absolute;inset-inline-end:12px;top:12px;display:flex;flex-direction:column;gap:6px;min-width:130px}
.stats-meta .rowB{background:transparent;border:0;border-radius:10px;padding:6px 10px;font-weight:900;text-align:center}
.tbl2{width:100%;border-collapse:collapse}
.tbl2 th{background:#0b5e63;color:#fff;border:1px solid #2b4949;padding:6px 8px;position:sticky;top:0}
.tbl2 td{border:1px solid #2b4949;padding:6px 8px}
.tbl2 .no-print{}

/* ÙƒØ´Ù Ø­Ø¶ÙˆØ±ÙŠ */
#hadoryReportDlg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:55;align-items:center;justify-content:center;padding:12px}
.report-card{background:#fff;border-radius:16px;max-width:1100px;width:96%;max-height:90vh;overflow:auto;border:1px solid var(--b)}
.report-card .h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef4f4}
.report-hdr{position:relative;margin:8px 8px 10px}
.report-hdr img{width:100%;display:block;border-radius:12px}
.report-meta{position:absolute;inset-inline-end:12px;top:12px;display:flex;flex-direction:column;gap:6px;min-width:130px}
.report-meta .rowB{background:transparent;border:0;border-radius:10px;padding:6px 10px;font-weight:900;text-align:center}

/* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª */
#clockDlg{display:none;position:fixed;inset:0;z-index:60;background:rgba(0,0,0,.35);align-items:center;justify-content:center;padding:16px}
.clock-card{background:#fff;border:1px solid var(--b);border-radius:16px;max-width:360px;width:96%}
.clock-card .h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef4f4}
.clock-card .b{padding:12px}
.clock-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
.clock-row .col{flex:1}
.clock-row input[type=range]{width:100%}
.clock-big{font:900 26px/1 Tajawal,system-ui;text-align:center;color:#064b50;margin:8px 0}
.clock-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.clock-actions .btn{height:auto;padding:7px 10px}

/* Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® */
#dateGuardDlg{display:none;position:fixed;inset:0;z-index:70;background:rgba(0,0,0,.42);align-items:center;justify-content:center;padding:14px}
.guard-card{background:#fff;border:1px solid var(--b);border-radius:16px;max-width:520px;width:96%;box-shadow:0 16px 48px rgba(0,0,0,.18)}
.guard-card .h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef4f4}
.guard-card .b{padding:12px}
.guard-title{font-weight:900;color:#7c2d12}
.guard-note{background:#fffbeb;border:2px solid #f59e0b;border-radius:14px;padding:10px;font-weight:900;color:#92400e}
.guard-note .k{color:#7c2d12}
.guard-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
.guard-actions .btn{height:auto;padding:8px 12px;border-radius:14px}
.guard-check{display:flex;gap:8px;align-items:flex-start;margin-top:10px;font-weight:900;color:#0b5e63}
.guard-check input{margin-top:3px;transform:scale(1.05)}

*{-webkit-print-color-adjust:exact; print-color-adjust:exact}
@media print{
  @page{size:A4;margin:10mm}
  body{background:#fff}

  body[data-print="stats"] .app{display:none !important}
  body[data-print="stats"] #statsDlg[aria-hidden="false"]{display:block !important; position:static !important; inset:auto !important;background:#fff !important; padding:0 !important}
  body[data-print="stats"] #statsDlg .stats-card{border:0 !important;border-radius:0 !important;width:210mm !important;max-width:none !important;min-height:auto !important;max-height:none !important;overflow:visible !important;box-shadow:none !important;margin:0 auto !important;page-break-inside:avoid}
  body[data-print="stats"] #statsDlg .stats-hdr{display:block !important;margin:0 0 6mm !important}
  body[data-print="stats"] #statsDlg .h, body[data-print="stats"] #statsDlg .stats-actions{display:none !important}
  body[data-print="stats"] #tblStats thead{display:table-header-group}
  body[data-print="stats"] #tblStats th, body[data-print="stats"] #tblStats td{border-color:#000 !important}
  body[data-print="stats"] #tblStats th{background:#0b5e63 !important;color:#fff !important}
  body[data-print="stats"] #tblStats tr{page-break-inside:avoid}
  body[data-print="stats"] #tblStats th:last-child, body[data-print="stats"] #tblStats td:last-child, body[data-print="stats"] #tblStats .no-print{display:none !important}

  body[data-print="hadory"] .app{display:none !important}
  body[data-print="hadory"] #hadoryReportDlg[aria-hidden="false"]{display:block !important; position:static !important; inset:auto !important;background:#fff !important; padding:0 !important}
  body[data-print="hadory"] #hadoryReportDlg .report-card{border:0 !important;border-radius:0 !important;width:210mm !important;max-width:none !important;min-height:auto !important;max-height:none !important;overflow:visible !important;box-shadow:none !important;margin:0 auto !important}
  body[data-print="hadory"] #hadoryReportDlg .report-hdr{display:block !important;margin:0 0 6mm !important}
  body[data-print="hadory"] #hadoryReportDlg .h, body[data-print="hadory"] #hadoryReportDlg .report-actions{display:none !important}
  body[data-print="hadory"] #tblHadoryReport thead{display:table-header-group}
  body[data-print="hadory"] #tblHadoryReport th, body[data-print="hadory"] #tblHadoryReport td{border-color:#000 !important}
  body[data-print="hadory"] #tblHadoryReport th{background:#0b5e63 !important;color:#fff !important}
  body[data-print="hadory"] #tblHadoryReport tr{page-break-inside:avoid}

  body:not([data-print="stats"]):not([data-print="hadory"]) .sidebar,
  body:not([data-print="stats"]):not([data-print="hadory"]) .rights,
  body:not([data-print="stats"]):not([data-print="hadory"]) #clockDlg,
  body:not([data-print="stats"]):not([data-print="hadory"]) #dateGuardDlg,
  body:not([data-print="stats"]):not([data-print="hadory"]) #hadoryReportDlg{display:none !important}

  body:not([data-print="stats"]):not([data-print="hadory"]) .content{padding:0}
  body:not([data-print="stats"]):not([data-print="hadory"]) .sheet{width:210mm;min-height:auto;border:0;box-shadow:none;page-break-inside:avoid}
  body:not([data-print="stats"]):not([data-print="hadory"]) .pad{padding:7mm 9mm 8mm}
  body:not([data-print="stats"]):not([data-print="hadory"]) .hdr{margin:0 0 4mm}
  body:not([data-print="stats"]):not([data-print="hadory"]) .hdr img{max-height:40mm;object-fit:cover;border-radius:8px}

  #alertPack, #absencePack{line-height:1.45 !important}
  #alertPack p, #absencePack p{margin:2mm 0 1.5mm !important}
  #alertPack .sec, #absencePack .sec{margin-top:4mm !important}
  #alertPack .checkline, #absencePack .checkline{margin:3mm 0 !important;gap:4px !important}
  #alertPack .lines div, #absencePack .lines div{height:6mm !important}
  #alertPack .lines, #absencePack .lines{padding:6px 8px !important}
}
</style>
</head>

<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sb-head">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</div>
    <div class="sb-body">

      <div class="f">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</label>
        <div class="chips" id="kindChips">
          <button class="chip active" data-k="late">ØªØ£Ø®Ø±</button>
          <button class="chip" data-k="absent">Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯</button>
          <button class="chip" data-k="gaib">Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨</button>
          <button class="chip" data-k="note">Ù„ÙØª Ù†Ø¸Ø±</button>
        </div>
      </div>

      <div class="f">
        <label>Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…</label>
        <select id="selTeacher" class="sel"></select>
      </div>

      <div class="f">
        <label>ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¯ÙˆØ§Ù…</label>
        <div class="chips" id="seasonChips">
          <button class="chip active" data-season="winter">Ø§Ù„Ø´ØªÙˆÙŠ (07:00â€“14:00)</button>
          <button class="chip" data-season="summer">Ø§Ù„ØµÙŠÙÙŠ (06:45â€“13:45)</button>
        </div>
      </div>

      <div class="f">
        <label>Ø³Ø¨Ø¨ Ù„ÙØª Ø§Ù„Ù†Ø¸Ø±</label>
        <select id="noteReason" class="sel">
          <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨ â€”</option>
          <option>Ø¹Ø¯Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø§Ù„ØµØ¨Ø§Ø­ÙŠ ÙˆÙÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯.</option>
          <option>Ø§Ù„ØªÙ‚ØµÙŠØ± ÙÙŠ Ù…Ù†Ø§ÙˆØ¨Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… Ù…Ù…Ø§ Ø£Ø«Ù‘Ø± Ø¹Ù„Ù‰ Ø§Ù†Ø¶Ø¨Ø§Ø· Ø®Ø±ÙˆØ¬ Ø§Ù„Ø·Ù„Ø§Ø¨.</option>
          <option>Ù‚ØµÙˆØ± ÙÙŠ Ø§Ù„Ø­Ø¶ÙˆØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø±Ø§Ù ÙˆÙ‚Øª Ø§Ù„ÙØ³Ø­Ø© Ù…Ù…Ø§ Ø£Ø¯Ù‰ Ø¥Ù„Ù‰ Ø¶Ø¹Ù Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</option>
          <option>Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø¹Ù„Ù‰ ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ØµÙ„Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ.</option>
          <option>Ø¹Ø¯Ù… Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³ØªÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª.</option>
          <option>Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­ØµØ© Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡Ø§ Ø¯ÙˆÙ† Ù…Ø¨Ø±Ø± Ù†Ø¸Ø§Ù…ÙŠ.</option>
          <option>Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØ© ÙˆÙÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ.</option>
          <option>Ø¹Ø¯Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ø·Ø§Ø¨ÙˆØ± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ Ø¯ÙˆÙ† Ø¹Ø°Ø±.</option>
          <option>Ø§Ù„ØªØºÙŠØ¨ Ø¹Ù† Ø§Ø¬ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±Ø³Ù…ÙŠ Ø¯ÙˆÙ† Ø¹Ø°Ø±.</option>
          <option>Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø¡Ù„Ø© Ø¥Ø¯Ø§Ø±ÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯.</option>
          <option>Ø±ÙØ¶ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§Ø¶Ø± Ø§Ù„Ø±Ø³Ù…ÙŠØ©.</option>
          <option>Ø±ÙØ¶ ØªÙ†ÙÙŠØ° ØªÙˆØ¬ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ Ø£Ùˆ ØªØ±Ø¨ÙˆÙŠ Ø¯ÙˆÙ† Ù…Ø¨Ø±Ø±.</option>
          <option>Ø¹Ø¯Ù… Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ ÙÙŠ (ÙØ§Ø±Ø³) Ø¨Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯.</option>
          <option>Ø¹Ø¯Ù… Ø¯Ø®ÙˆÙ„ Ø­ØµØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙƒÙ„Ù‘ÙÙ Ø¨Ù‡Ø§.</option>
          <option>Ø¹Ø¯Ù… Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ© ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¦Ø°Ø§Ù† .</option>
          <option>Ø§Ù„ØªÙ‚ØµÙŠØ± ÙÙŠ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙÙŠ (Ù†ÙˆØ±) Ø¶Ù…Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯.</option>
          <option>Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù ÙÙŠ Ù…Ù†ØµØ© Ø­Ø¶ÙˆØ±ÙŠ.</option>
        </select>
<!-- âœ… ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ØµØ© (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯: Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØ© / Ø§Ù„Ø®Ø±ÙˆØ¬ Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡Ø§) -->
<div class="f" id="lessonBox" style="display:none">
  <label id="lessonTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ØµØ©</label>

  <div class="row">
    <select id="periodNo" class="sel" style="width:34%">
      <option value="">â€” Ø§Ù„Ø­ØµØ© â€”</option>
      <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
      <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
    </select>

    <span class="pill" style="flex:1;justify-content:center">
      <b id="lessonMins">0</b> Ø¯Ù‚ÙŠÙ‚Ø©
    </span>
  </div>

  <div class="row" style="margin-top:8px">
    <div style="flex:1">
      <div class="mini" id="lessonA_lbl">ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­ØµØ© (Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„)</div>
      <span id="lessonA" class="timebox empty" contenteditable="true" data-mask>--:--</span>
    </div>

    <div style="flex:1">
      <div class="mini" id="lessonB_lbl">ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ù„Ø­ØµØ©</div>
      <span id="lessonB" class="timebox empty" contenteditable="true" data-mask>--:--</span>
    </div>
  </div>

  <div class="mini" id="lessonHint" style="margin-top:6px">
    Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆÙ‚ØªÙŠÙ† ÙˆØ³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
  </div>
</div>

      </div>

      <div class="f">
        <label>Ø§Ù„Ø¹Ø°Ø±/Ø§Ù„Ù‚Ø¨ÙˆÙ„/ÙØ§Ø±Ø³</label>
        <button id="btnUnified" class="btn ghost" style="width:100%;display:flex;justify-content:space-between;align-items:center">
          <span id="unifiedText">Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</span><span>â–¾</span>
        </button>
        <div id="unifiedPanel" style="display:none;border:1px solid #dbe9e9;border-radius:12px;padding:10px;margin-top:8px">
          <div class="f" style="margin:0">
            <label>Ø§Ù„Ø¹Ø°Ø±</label>
            <div class="chips" id="excuseGroup">
              <button class="chip" data-exc="with">Ø¨Ø¹Ø°Ø±</button>
              <button class="chip active" data-exc="without">Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</button>
            </div>
          </div>
          <div class="f" style="margin:8px 0 0">
            <label>Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø°Ø±</label>
            <div class="chips" id="acceptGroup">
              <button class="chip" data-acc="accepted">Ù…Ù‚Ø¨ÙˆÙ„</button>
              <button class="chip active" data-acc="rejected">ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„</button>
            </div>
          </div>
          <div class="f" style="margin:8px 0 0">
            <label>ÙØ§Ø±Ø³ â€” ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù…Ø³Ø§Ø¡Ù„Ø© Ø§Ù„ØºÙŠØ§Ø¨</label>
            <div class="chips" id="frGroup">
              <button class="chip" data-fr="raised">Ù…Ø±ÙÙˆØ¹</button>
              <button class="chip active" data-fr="not">Ù„Ù… ÙŠÙØ±ÙØ¹</button>
            </div>
          </div>
        </div>
      </div>

      <div class="f">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <div class="row"><button id="btnCalToggle" class="btn" style="flex:1">ğŸ—“ï¸ Ù‡Ø¬Ø±ÙŠ</button></div>
        <div id="pickHijri" class="row" style="margin-top:8px">
          <select id="hY" class="sel" style="width:33%"></select>
          <select id="hM" class="sel" style="width:33%"></select>
          <select id="hD" class="sel" style="width:34%"></select>
        </div>
        <div id="pickGreg" class="row" style="display:none;margin-top:8px">
          <input id="gY" class="inp" type="number" min="1900" max="2100" placeholder="YYYY" style="width:40%">
          <input id="gM" class="inp" type="number" min="1" max="12" placeholder="MM" style="width:30%">
          <input id="gD" class="inp" type="number" min="1" max="31" placeholder="DD" style="width:30%">
        </div>
      </div>

      <div class="sep"></div>

      <div class="box" id="hadoryBox">
        <div class="pill"><span>ğŸ“¥</span><b>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø­Ø¶ÙˆØ±ÙŠ</b><span class="mini" id="hadoryStatus">Ø¬Ø§Ù‡Ø²</span></div>

        <div id="hadoryDateWarn" class="warn strong" style="display:none;margin-top:10px">
          <b>ğŸš¨ ØªØ­Ø°ÙŠØ± Ø¥Ù„Ø²Ø§Ù…ÙŠ Ù‚Ø¨Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø£ÙŠ Ù…Ø®Ø§Ù„ÙØ©:</b>
          <div style="margin-top:6px">
            Ø£Ù†Øª Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ø®ØªÙŠØ§Ø± <b>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠÙ‹Ø§</b> ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ ÙŠØ·Ø§Ø¨Ù‚ ÙŠÙˆÙ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø›
            <b>ÙˆØ¥Ù„Ø§ Ø³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</b>.
          </div>
          <div class="mini" style="margin-top:6px;color:#7c2d12;font-weight:900" id="warnReason">â€”</div>
          <div class="cta">
            <span class="pill"><b>Ø§Ù„Ø­Ù…Ø§ÙŠØ©:</b> Ù…ÙØ¹Ù‘Ù„Ø©</span>
            <button id="btnConfirmDateInline" class="btn primary">ØªØ£ÙƒÙŠØ¯ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® âœ…</button>
          </div>
        </div>

        <div id="hadoryDateOk" class="ok" style="display:none;margin-top:10px">
          âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¨Ø«Ù‚Ø©.
        </div>

        <div class="f" style="margin-top:10px">
          <label>Ù…Ù„ÙØ§Øª Excel Ù…Ù† Ù…Ù†ØµØ© Ø­Ø¶ÙˆØ±ÙŠ</label>
          <input id="hadoryFiles" class="inp" type="file" accept=".xlsx,.xls,.csv" multiple style="display:none">
          <div class="row" style="margin-top:6px">
            <button id="btnHadoryImport" class="btn importSoft" style="flex:1">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø­Ø¶ÙˆØ±ÙŠ</button>
            <button id="btnHadoryDrive" class="btn driveSoft" style="flex:1">Ø­Ø¶ÙˆØ±ÙŠ</button>
          </div>
          <div class="mini">ÙŠÙ…ÙƒÙ† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù/Ù…Ù„ÙØ§Øª Ù„Ø£ÙŠ ÙŠÙˆÙ… â€” <b>ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø§ ÙŠÙØ­Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</b> (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ­Ø¯Ø¯Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§).</div>
        </div>

        <div class="f">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
          <div class="row">
            <input id="hadoryManualDate" class="inp" type="date" style="flex:1">
            <button id="btnUseManualDate" class="btn ghost smallbtn">ØªØ·Ø¨ÙŠÙ‚</button>
          </div>
          <div class="mini">
            Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§: <b>06:30â€“07:00</b>ØŒ ÙˆÙ…Ø§ Ø¨Ø¹Ø¯ <b>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø±Ø³Ù…ÙŠ</b> ÙŠÙØ¹Ø¯ ØªØ£Ø®Ø±Ù‹Ø§.
            ÙƒÙ…Ø§ ÙŠØªÙ… Ø±ØµØ¯: <b>Ø§Ù„ØºÙŠØ§Ø¨</b> Ùˆ<b>Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</b> ÙˆÙÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ØµØ© Ø­Ø¶ÙˆØ±ÙŠ.
          </div>
        </div>

        <div class="f">
          <label>Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªÙŠ Ø¸Ù‡Ø±Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª (Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙ‚Ø·)</label>
          <select id="hadoryDates" class="sel">
            <option value="">â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø¹Ø¯ â€”</option>
          </select>
        </div>

        <div class="row" style="justify-content:space-between">
          <span class="pill"><b>ØºÙŠØ§Ø¨:</b> <span id="cAbsent">0</span></span>
          <span class="pill"><b>ØªØ£Ø®Ø±:</b> <span id="cLate">0</span></span>
          <span class="pill"><b>Ù„Ù… ÙŠÙØºÙ„Ù‚ Ø§Ù„Ø¯ÙˆØ§Ù…:</b> <span id="cNoOut">0</span></span>
        </div>

        <div class="f" style="margin-top:10px">
          <label>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚ÙŠÙ† Ù„Ù„Ù…Ø­Ø§Ø³Ø¨Ø© (Ù…Ù† Ø­Ø¶ÙˆØ±ÙŠ)</label>
          <select id="hadoryCases" class="sel">
            <option value="">â€” Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€”</option>
          </select>
          <div class="mini">
            Ù‚Ø¯ ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø¹Ù„Ù… <b>Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©</b> ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… (ØªØ£Ø®Ø± + Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù).
          </div>
        </div>

        <div class="list" style="margin-top:10px">
          <table>
            <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th></tr></thead>
            <tbody id="hadoryMiniTable">
              <tr><td colspan="4" class="mini" style="text-align:center;padding:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="sb-actions">
        <button id="btnHadoryReport" class="btn ghost">ÙƒØ´Ù Ø­Ø¶ÙˆØ±ÙŠ ğŸ—‚ï¸</button>
        <button id="btnStats" class="btn ghost">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ğŸ“Š</button>
        <button id="btnWA" class="btn wh">ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button id="btnPrintSave" class="btn primary">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸</button>
        <button id="btnMonthlyStats" class="btn monthlyStats">Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ø´Ù‡Ø±ÙŠ ğŸ“ˆ</button>
      </div>

    </div>

    <div class="rights">Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ â€” ØªØ·ÙˆÙŠØ±: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ (Ù„Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)</div>
  </aside>

  <main class="content">
    <div class="sheet-wrap">
      <div class="sheet" id="sheet" aria-label="ØµÙØ­Ø© A4">
        <div class="pad">
          <div class="hdr">
            <img id="hdrImg" src="hhh.png" alt="Ù‡ÙŠØ¯Ø±" crossorigin="anonymous">
            <div class="meta-stack">
              <div class="rowB" id="metaDay">â€”</div>
              <div class="rowB" id="metaHijri">â€”</div>
              <div class="rowB">Ø§Ù„Ø±Ù‚Ù…: <span id="metaNo">01</span></div>
            </div>
          </div>

          <div class="title-center"><div class="t" id="mainTitle">ØªÙ†Ø¨ÙŠÙ‡</div></div>

          <table class="tbl">
            <thead><tr>
              <th class="name">Ø§Ù„Ø§Ø³Ù…</th><th class="spec">Ø§Ù„ØªØ®ØµØµ</th><th class="level">Ø§Ù„Ù…Ø±ØªØ¨Ø©</th>
              <th class="job">Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ©</th><th class="work">Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
            </tr></thead>
            <tbody><tr>
              <td id="t_name">â€”</td><td id="t_spec">â€”</td><td id="t_level">â€”</td><td id="t_job">â€”</td><td id="t_work">â€”</td>
            </tr></tbody>
          </table>

          <div class="badges-under">
            <div class="badge"><span class="tag">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</span><span id="t_civil">â€”</span></div>
          </div>

          <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙƒÙ…Ø§ Ù‡Ùˆ -->
          <div id="alertPack" class="sec">
            <h3>( 1 ) Ø®Ø·Ø§Ø¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ â€” <span id="kindTitle">ØªØ£Ø®Ø±</span></h3>
            <div class="rule-row"><span class="label">Ø§Ù„Ù…ÙƒØ±Ù… Ø§Ù„Ù…Ø¹Ù„Ù… :</span>
              <strong id="teacherNameInline" style="min-width:38mm;text-align:center;border-bottom:1px dotted #2f4f4c;display:inline-block;padding:0 2mm">â€”</strong>
              <span>ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡</span></div>
            <p><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ØŒ ÙˆØ¨Ø¹Ø¯ ØŒØŒØŒ</strong></p>
            <p>Ø¥Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ… <span class="dotfield"><span id="dynDay">â€”</span></span>
              Ø§Ù„Ù…ÙˆØ§ÙÙ‚ <span class="dotfield"><span id="dynHijri">â€”</span></span> :</p>

            <div class="checks">
              <label id="lineLate" class="checkline">
                <input type="checkbox" checked>
                <span class="text">
                  ØªØ£Ø®Ø±ÙƒÙ… Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ØŒ ÙˆØ­Ø¶ÙˆØ±ÙƒÙ… Ø§Ù„Ø³Ø§Ø¹Ø© ( <span id="tLateIn" class="timebox empty" contenteditable="true" data-mask>--:--</span> ).
                  <span class="calc">â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®Ø±: <span id="lateTotal">0 Ø¯Ù‚ÙŠÙ‚Ø©</span> (<span id="lateHH">00:00</span> Ø³)</span>
                </span>
              </label>

              <label id="lineAbs" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯ÙƒÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© : ( <span id="tAbsFrom" class="timebox empty" contenteditable="true" data-mask>--:--</span> )
                  Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© : ( <span id="tAbsTo" class="timebox empty" contenteditable="true" data-mask>--:--</span> ).
                  <span class="calc">â€” Ù…Ø¯Ø© Ø¹Ø¯Ù… Ø§Ù„ØªÙˆØ§Ø¬Ø¯: <span id="absTotal">0 Ø¯Ù‚ÙŠÙ‚Ø©</span> (<span id="absHH">00:00</span> Ø³)</span>
                </span>
              </label>
            </div>

            <p>Ø¹Ù„ÙŠÙ‡ Ù†Ø£Ù…Ù„ ØªÙˆØ¶ÙŠØ­ Ø£Ø³Ø¨Ø§Ø¨ Ø°Ù„Ùƒ Ù…Ø¹ Ø¥Ø±ÙØ§Ù‚ Ù…Ø§ ÙŠØ¤ÙŠØ¯ Ø¹Ø°Ø±ÙƒÙ… â€¦ ÙˆÙ„ÙƒÙ… ØªØ­ÙŠØ§ØªÙ†Ø§.</p>
            <p style="margin-top:6px"><strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© :</strong> <span>ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
              &nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> <span class="dotfield" style="min-width:26mm"></span>
              &nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> <span class="dotfield" style="min-width:20mm"></span></p>
          </div>

          <div id="affidavitPack" class="sec">
            <h3>( 2 ) Ø¥ÙØ§Ø¯Ø© Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
            <p>Ø£ÙÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù† Ø³Ø¨Ø¨ <span id="affKind">Ø§Ù„ØªØ£Ø®Ø±</span> Ø§Ù„Ù…ÙˆØ¶Ù‘Ø­ Ø£Ø¹Ù„Ø§Ù‡ Ù‡Ùˆ:</p>
            <div class="lines"><div></div><div></div></div>
            <p style="margin-top:6px">
              <strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… :</strong> <span id="affTeacher">â€”</span>
              &nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ____________________
              &nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______
            </p>
          </div>

          <div id="principalPack" class="sec">
            <h3>( 3 ) Ø±Ø£ÙŠ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
            <label class="checkline"><input type="checkbox"> ØªÙ…Ù‘ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…ÙˆØ¸Ù Ø´ÙÙ‡ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø£Ø®Ø° Ø¨Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·.</label>
            <label class="checkline"><input type="checkbox"> ÙŠÙÙƒØªÙÙ‰ Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¹ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.</label>
            <label class="checkline"><input type="checkbox"> ÙŠÙØ±ÙØ¹ Ù„Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªØµØ§Øµ Ø¹Ù†Ø¯ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©.</label>
            <p style="margin-top:6px">
              <strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± :</strong> <span>ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
              &nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ____________________
              &nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______
            </p>
          </div>

          <div id="absencePack" class="sec" style="display:none">
            <p>Ø¥Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ… <strong><span id="absDayP">â€”</span></strong>
              Ø§Ù„Ù…ÙˆØ§ÙÙ‚ <strong><span id="absDateYMD">â€”</span></strong> ØªØºÙŠØ¨Øª Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„.</p>
            <h3>( 1 ) Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙØ§Ø¯Ø©</h3>
            <p><strong>Ø§Ù„Ù…ÙƒØ±Ù… /</strong> <span id="abs-name-top">â€”</span> <span>ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡</span></p>
            <p><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ØŒ ÙˆØ¨Ø¹Ø¯ ØŒØŒØŒ</strong></p>
            <p>Ù…Ù† Ø®Ù„Ø§Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙˆØ§Ù… ØªØ¨ÙŠÙ† ØºÙŠØ§Ø¨ÙƒÙ… Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…ÙˆØ¶Ø­Ø© Ø¨Ø¹Ø§Ù„ÙŠØ©ØŒ Ø¢Ù…Ù„ Ø§Ù„Ø¥ÙØ§Ø¯Ø© Ø¹Ù† Ø³Ø¨Ø¨ Ø°Ù„Ùƒ
              ÙˆØªÙ‚Ø¯ÙŠÙ… Ù…Ø§ ÙŠØ¤ÙŠØ¯ Ø¹Ø°Ø±ÙƒÙ… Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡Ø› Ø¹Ù„Ù…Ø§Ù‹ Ø¨Ø£Ù†Ù‡ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø³ÙŠØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ù„Ø§Ø²Ù… Ø­Ø³Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª.</p>
            <p><strong>Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± :</strong> <span>ÙÙ‡Ø¯ Ø¨Ù† Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
               &nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ________ &nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______</p>

            <h3>( 2 ) Ø§Ù„Ø¥ÙØ§Ø¯Ø© â€” Ø³Ø·Ø±Ø§Ù† ÙÙ‚Ø·</h3>
            <p><strong>Ø§Ù„Ù…ÙƒØ±Ù… / Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</strong> ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡</p>
            <p><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ØŒ ÙˆØ¨Ø¹Ø¯ ØŒØŒØŒ</strong></p>
            <p>Ø£ÙÙŠØ¯ÙƒÙ… Ø£Ù† ØºÙŠØ§Ø¨ÙŠ ÙƒØ§Ù† Ù„Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
            <div class="lines dotted"><div></div><div></div></div>
            <p>ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ØªÙ‚Ø¯ÙŠÙ… Ù…Ø§ ÙŠØ«Ø¨Øª Ø°Ù„Ùƒ Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡.</p>
            <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… :</strong> <span id="abs-teacher-name">â€”</span> &nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ________ &nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______</p>

            <h3>( 3 ) Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
            <label><input type="checkbox"> ØªÙØ­ØªØ³Ø¨ Ù„Ù‡ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø¸Ø§Ù…ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±.</label><br>
            <label><input type="checkbox"> ÙŠÙØ­ØªØ³Ø¨ ØºÙŠØ§Ø¨Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ù‡ Ù„Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø¥Ø¶Ø·Ø±Ø§Ø±ÙŠØ© Ù„Ù‚Ø¨ÙˆÙ„ Ø¹Ø°Ø±Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±ØµÙŠØ¯Ù‡ ÙŠØ³Ù…Ø­ ÙˆÙ„Ø§ ÙŠÙØ­Ø³Ù… Ø¹Ù„ÙŠÙ‡.</label><br>
            <label><input type="checkbox"> ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„Ø­Ø³Ù… Ù„Ø¹Ø¯Ù… Ù‚Ø¨ÙˆÙ„ Ø¹Ø°Ø±Ù‡.</label>

            <div class="sec" id="principalSignPack" style="margin-top:6mm">
              <h3>( 4 ) ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
              <p>
                <strong>Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± :</strong> <span id="principalNameAbs">â€”</span>
                &nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> <span id="principalSignAbs">____________________</span>
                &nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> <span id="principalDateAbs">â€”</span>
              </p>
            </div>
          </div>

          <div id="notePack" class="sec" style="display:none">
            <h3>Ù†Ù…ÙˆØ°Ø¬ Ù„ÙØª Ù†Ø¸Ø±</h3>
            <p>Ø§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„ÙØ§Ø¶Ù„/ <span id="noteTeacherName" style="font-weight:900">â€”</span> Ø­ÙØ¸Ù‡ Ø§Ù„Ù„Ù‡</p>
            <p><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ØŒ ÙˆØ¨Ø¹Ø¯ ØŒØŒØŒ</strong></p>
            <p>ÙÙŠ ÙŠÙˆÙ… <span id="noteDay" style="font-weight:900;border-bottom:1px dotted #2f4f4c;padding:0 3mm">â€”</span>
              Ø§Ù„Ù…ÙˆØ§ÙÙ‚ <span id="noteHijri" style="font-weight:900;border-bottom:1px dotted #2f4f4c;padding:0 3mm">â€”</span></p>
            <p id="noteParagraph">
              Ø¥Ø´Ø§Ø±Ø©Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©Ø› Ù„ÙˆØ­ÙØ¸
<span id="noteReasonText" style="font-weight:900">Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span>
<span id="noteLessonExtra" style="display:none">
  (Ø§Ù„Ø­ØµØ© Ø±Ù‚Ù… <span id="notePeriodNo" style="font-weight:900">â€”</span>
  â€” <span id="noteLessonKind" style="font-weight:900">Ø§Ù„ØªØ£Ø®Ø±</span>:
  <span id="noteLessonMin" style="font-weight:900">0</span> Ø¯Ù‚ÙŠÙ‚Ø©)
</span>.
              ÙˆÙ†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°Ù„ÙƒØŒ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ØªØ§Ù… Ø¨Ù…Ø§ ÙŠÙÙˆÙƒÙ„ Ø¥Ù„ÙŠÙƒÙ… Ù…Ù† Ù…Ù‡Ø§Ù…Ø› Ø¯Ø¹Ù…Ù‹Ø§ Ù„Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ù…Ù‡Ù†ÙŠ ÙˆØ±ÙØ¹Ù‹Ø§ Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡.
            </p>
            <p><strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ù„Ø§Ø·Ù„Ø§Ø¹:</strong> ............................... &nbsp;&nbsp; <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ............................... &nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ______ / ______ / 14</p>
            <p><strong>ØªÙˆÙ‚ÙŠØ¹ Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</strong> ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</p>
          </div>

          <div class="footer-note"><span>ØªØ­ÙØ¸ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</span></div>

        </div>
      </div>
    </div>
  </main>
</div>
<!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div id="statsDlg" aria-hidden="true">
  <div class="stats-card" id="statsCard">
    <div class="stats-hdr">
      <img id="statsHdrImg" src="hhh.png" alt="Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª" crossorigin="anonymous">
      <div class="stats-meta">
        <div class="rowB" id="statsDay">â€”</div>
        <div class="rowB" id="statsHijri">â€”</div>
      </div>
    </div>
    <div class="h">
      <div style="font-weight:900;color:#064b50">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
      <div class="stats-actions" style="display:flex;gap:6px">
        <button id="btnResetStats" class="btn ghost" title="ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ">ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ â™»ï¸</button>
        <button id="btnStatsPDF" class="btn primary" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button id="btnCloseStats" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div style="padding:12px">
      <table id="tblStats" class="tbl2">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ù€)</th><th>Ø§Ù„Ø¹Ø°Ø±</th><th>ÙØ§Ø±Ø³</th><th>ØªÙØ§ØµÙŠÙ„</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>
  </div>
</div>

<!-- ÙƒØ´Ù Ø­Ø¶ÙˆØ±ÙŠ -->
<div id="hadoryReportDlg" aria-hidden="true">
  <div class="report-card" id="reportCard">
    <div class="report-hdr">
      <img id="reportHdrImg" src="hhh.png" alt="Ù‡ÙŠØ¯Ø± ÙƒØ´Ù Ø­Ø¶ÙˆØ±ÙŠ" crossorigin="anonymous">
      <div class="report-meta">
        <div class="rowB" id="repDay">â€”</div>
        <div class="rowB" id="repHijri">â€”</div>
      </div>
    </div>
    <div class="h">
      <div style="font-weight:900;color:#064b50">ÙƒØ´Ù Ø­Ø¶ÙˆØ±ÙŠ (Ø§Ù„ÙŠÙˆÙ…ÙŠ)</div>
      <div class="report-actions" style="display:flex;gap:6px">
        <button id="btnReportPrint" class="btn ghost" title="Ø·Ø¨Ø§Ø¹Ø©">Ø·Ø¨Ø§Ø¹Ø©</button>
        <button id="btnCloseReport" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div style="padding:12px">
      <div class="mini" style="margin:0 0 10px;text-align:center;font-size:12.8px;font-weight:900;color:#064b50;background:#f2fafb;border:1px solid #dbe9e9;border-radius:12px;padding:8px 10px;line-height:1.9">
        Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¥Ù†ØµØ±Ø§Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†<br>
        <span style="font-size:12px;color:#0b5e63">
          Ø§Ù„ÙŠÙˆÙ…: <span id="repDayTxt">â€”</span> â€” Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="repHijriTxt">â€”</span>
        </span>
      </div>

      <table id="tblHadoryReport" class="tbl2">
        <thead>
          <tr>
            <th style="width:5%">Ù…</th>
            <th style="width:29%">Ø§Ù„Ø§Ø³Ù…</th>
            <th style="width:10%">Ø§Ù„Ù‡ÙˆÙŠØ©</th>
            <th style="width:10%">Ø§Ù„Ø­Ø¶ÙˆØ±</th>
            <th style="width:10%">Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th>
            <th style="width:17%">Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>
  </div>
</div>

<!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª -->
<div id="clockDlg" aria-hidden="true">
  <div class="clock-card">
    <div class="h">
      <div style="font-weight:900;color:#064b50">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª</div>
      <button id="btnClockClose" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="b">
      <div class="clock-big" id="clockPreview">--:--</div>
      <div class="clock-row">
        <div class="col">
          <label style="font-weight:900;color:#03636a">Ø§Ù„Ø³Ø§Ø¹Ø©</label>
          <input id="clockHour" type="range" min="0" max="23" step="1" value="7">
        </div>
        <div class="col">
          <label style="font-weight:900;color:#03636a">Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</label>
          <input id="clockMin" type="range" min="0" max="59" step="1" value="30">
        </div>
      </div>
      <div class="clock-actions">
        <button id="btnClockNow" class="btn ghost">Ø§Ù„Ø¢Ù†</button>
        <button id="btnClockOk" class="btn primary">Ù…ÙˆØ§ÙÙ‚</button>
      </div>
    </div>
  </div>
</div>

<!-- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® -->
<div id="dateGuardDlg" aria-hidden="true">
  <div class="guard-card">
    <div class="h">
      <div class="guard-title">ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</div>
      <button id="btnGuardClose" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="b">
      <div class="guard-note">
        <div>ØªÙ… ØªÙØ¹ÙŠÙ„ <span class="k">Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ®</span> â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯.</div>
        <div style="margin-top:6px">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span class="k" id="guardDate">â€”</span></div>
        <div style="margin-top:6px" class="mini" id="guardWhy">â€”</div>
      </div>

      <div class="guard-check">
        <input type="checkbox" id="chkAck">
        <div>
          Ø£Ù‚Ø±Ù‘ Ø£Ù† <span style="color:#7c2d12">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§</span> ÙŠØ·Ø§Ø¨Ù‚ ÙŠÙˆÙ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ Ù…Ù† Ø­Ø¶ÙˆØ±ÙŠØŒ ÙˆØ£ØªØ­Ù…Ù„ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.
        </div>
      </div>

      <div class="guard-actions">
        <button id="btnGuardReview" class="btn ghost">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <button id="btnGuardConfirm" class="btn primary">ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© âœ…</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= Ø£Ø¯ÙˆØ§Øª Ø£Ø±Ù‚Ø§Ù… ================= */
const AR='Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©', EN='0123456789';
const en2ar=s=>(''+s).replace(/[0-9]/g,d=>AR[d]);
const ar2en=s=>(''+s).replace(/[Ù -Ù©]/g,d=>EN[AR.indexOf(d)]);

/* ================= Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ù†Ø§ØµØ± ================= */
const metaDay=document.getElementById('metaDay');
const metaHijri=document.getElementById('metaHijri');
const metaNo=document.getElementById('metaNo');
const dynDay=document.getElementById('dynDay');
const dynHijri=document.getElementById('dynHijri');
const noteDay=document.getElementById('noteDay');
const noteHijri=document.getElementById('noteHijri');

const t_name=document.getElementById('t_name');
const t_spec=document.getElementById('t_spec');
const t_level=document.getElementById('t_level');
const t_job=document.getElementById('t_job');
const t_work=document.getElementById('t_work');
const t_civil=document.getElementById('t_civil');
const teacherNameInline=document.getElementById('teacherNameInline');
const noteTeacherName=document.getElementById('noteTeacherName');

const lateTotal=document.getElementById('lateTotal');
const lateHH=document.getElementById('lateHH');
const absTotal=document.getElementById('absTotal');
const absHH=document.getElementById('absHH');

const hY=document.getElementById('hY');
const hM=document.getElementById('hM');
const hD=document.getElementById('hD');

const gY=document.getElementById('gY');
const gM=document.getElementById('gM');
const gD=document.getElementById('gD');
/* âœ… ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ØµØ© Ø¯Ø§Ø®Ù„ Ù„ÙØª Ø§Ù„Ù†Ø¸Ø± */
const lessonBox = document.getElementById('lessonBox');
const periodNo = document.getElementById('periodNo');
const lessonTitle = document.getElementById('lessonTitle');
const lessonA = document.getElementById('lessonA');
const lessonB = document.getElementById('lessonB');
const lessonA_lbl = document.getElementById('lessonA_lbl');
const lessonB_lbl = document.getElementById('lessonB_lbl');
const lessonMins = document.getElementById('lessonMins');
const lessonHint = document.getElementById('lessonHint');

const noteLessonExtra = document.getElementById('noteLessonExtra');
const notePeriodNo = document.getElementById('notePeriodNo');
const noteLessonKind = document.getElementById('noteLessonKind');
const noteLessonMin = document.getElementById('noteLessonMin');

let NOTE_LESSON_MODE = ''; // 'enter' Ø£Ùˆ 'exit'
/* ================= Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ================= */
const TEACHERS_CSV=`Ù…ÙˆØ³Ù‰ ØµÙ„Ø¨Ø§Ù† Ø¹Ø¨Ø¯Ù‡ Ø¹Ø³ÙŠØ±ÙŠ	1093013116	966507058931	ÙÙŠØ²ÙŠØ§	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
ÙŠÙˆØ³Ù  Ø¹ÙŠØ³Ù‰ Ø§Ù„Ø¹ÙŠØ¯	1012646822	966592038351	Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ù…Ù†Ø°Ø± Ø¹Ø§Ù…Ø± Ø­Ù…ÙˆØ¯ Ø²Ù…ÙŠØ¹	1065913053	966541188974	Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ù…Ø§Ø¯ Ù…Ø­Ù…Ø¯ Ø¬Ù…Ø¹Ø§Ù† Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ	1048667289	966542203039	Ù…ÙƒØªØ¨Ø§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø­Ø³Ù† ÙŠÙˆØ³Ù Ø­Ø³ÙŠÙ† Ø§Ù„Ø®Ù„ÙŠÙØ©		1056994203	966506907431	ÙƒÙŠÙ…ÙŠØ§Ø¡	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø³Ø§Ù„Ù…ÙŠ	1073861831	966558151033	ÙƒÙŠÙ…ÙŠØ§Ø¡	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø­Ø³Ù† Ø¹Ù„ÙŠ Ø­Ø³Ù† Ø§Ù„Ø´Ù‡Ø±ÙŠ		1037273594	966536824355	Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø­Ø³ÙŠÙ† Ø¨Ù† Ø³Ø¹ÙŠØ¯ Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ù…Ø¯Ù†	1022616799	966556336875	Ù…ÙƒØªØ¨Ø§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
ÙŠØ­ÙŠÙ‰ Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ	1048978892	966555751385	Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
ÙØ±Ø¬ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ù„ÙŠ ÙŠÙˆØ³Ù Ø§Ù„ Ø³ÙŠÙ	1000397735	966504113707	Ø±ÙŠØ§Ø¶ÙŠØ§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¨Ù†Ø¯Ø± Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ù…Ø­Ù…Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ	1046853881	966546135135	Ø­Ø§Ø³Ø¨	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø­Ø³ÙŠÙ† Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¨Ù† ÙÙ‡Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ	1014268567	966504988086	Ø§Ø­ÙŠØ§Ø¡	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ù†Ø§ØµØ± Ø¹Ù„ÙŠ Ù†Ø§ØµØ± Ø§Ù„Ø±Ø§Ø´Ø¯	1008303370	966542933888	Ø­Ø§Ø³Ø¨	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø­Ø³ÙŠÙ† Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø­Ø³ÙŠÙ† Ø§Ù„Ø£Ø­Ù…Ø¯	1060369202	966563740777	Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ù„ÙŠ Ø³Ø¹Ø¯ Ø³Ø¹ÙŠØ¯ Ø§Ù„Ø§ØµÙ„Ø¹ÙŠ Ø§Ù„Ø§Ø­Ù…Ø±ÙŠ	1023999780	966590986464	Ø§Ø­ÙŠØ§Ø¡	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø­Ø³Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡	1005472780	966543705512	Ø§Ø­ÙŠØ§Ø¡	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ù…Ø­Ù…Ø¯ Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„ØªÙˆÙŠØ¬Ø±ÙŠ	1064745944	966541381105	Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙÙŠØµÙ„ Ø¨Ù† ÙØ·ÙŠØ³ Ø§Ù„Ù‡Ø°Ù„ÙŠ	1094733290	966591585407	Ø±ÙŠØ§Ø¶ÙŠØ§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­ÙŠÙ… Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯ Ø§Ø¨ÙˆØ¹ØµÙŠØ¯Ù‡	1033584234	966546623431	Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø¨Ù† Ø³ÙŠÙ Ø§Ù„Ø³Ù‡Ù„ÙŠ	1063175010	966546221133	Ø¹Ù„Ù… Ø§Ø¬ØªÙ…Ø§Ø¹	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¨Ø´ÙŠØ± Ø¨Ù† Ø£Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¢Ù„ Ø³Ù„ÙŠÙ…	1019783917	966500126925	Ù…ÙƒØªØ¨Ø§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø±Ø¨ÙŠØ¹	1004182687	966548638056	Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø³Ø§Ù„Ù… Ø¢Ù„ Ø­Ø¨Ø´Ø§Ù†	1004581359	966500223640	Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø®Ø§Ù„Ø¯ Ø³Ø¹Ø¯ Ø±Ø§Ø´Ø¯ Ø§Ù„Ù…Ø±Ø¶ÙŠ	1025640010	966505877238	Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
ÙÙŠØµÙ„ ÙÙ‡Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ	1086115373	966508448455	Ø±ÙŠØ§Ø¶ÙŠØ§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø­Ø¨ÙŠØ¨ Ø¹Ø¨Ø¯Ø§Ù„ØºÙ†ÙŠ Ø§Ù„Ù…ÙŠÙ…Ù†ÙŠ	1072815481	966530163027	Ø±ÙŠØ§Ø¶ÙŠØ§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø²ÙŠØ§Ø¯ Ø¹ÙˆØ§Ø¶ Ø§Ø¨Ù† Ø¹ÙŠØ¶Ù‡ Ø§Ù„Ø¹Ù…Ø±ÙŠ	1092156742	966557530102	Ø¹Ù„Ù… Ø¥Ø¯Ø§Ø±Ø©	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø¬Ø¨Ø§Ø± Ø­Ù…ÙˆØ¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ	1089635724	966555741488	ÙÙŠØ²ÙŠØ§	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¬Ù…ÙŠÙ„ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø¬ÙˆØ§Ø¯ Ø§Ù„Ø¹Ù„ÙŠ		1029281589	966566712113	ÙÙŠØ²ÙŠØ§	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø­Ø³Ù† Ø¹Ù…Ø± Ø§Ù„Ø§Ø¯Ø±ÙŠØ³ÙŠ	1081556910	966533025505	Ø±ÙŠØ§Ø¶ÙŠØ§Øª	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
ØªÙ‚ÙŠ Ø¹Ø¨Ø¯ Ø§Ù„Ù‡Ø§Ø¯ÙŠ ØªÙ‚ÙŠ Ø§Ù„Ø¹Ù„ÙŠ	1026472363	966543219321	ÙƒÙŠÙ…ÙŠØ§	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø®Ø§Ù„Ø¯ Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ	1034318301	966560687900	ÙƒÙŠÙ…ÙŠØ§	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡  Ø®Ù„ÙˆÙØ©  Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„ Ù…Ø±Ø¹ÙŠ		1029490875	966533225515	Ø¯ÙŠÙ†	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¨Ù† Ø£Ø­Ù…Ø¯ Ø¨Ù† Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø¹Ø¬Ù„Ø§Ù†	1001082179	966559999808	Ø¯ÙŠÙ†	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ø§Ø¯Ù„ Ø¨Ù† Ø¹Ù„ÙŠ Ø¨Ù† Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø§Ø±Ù‚ÙŠ	1007370701	966530667666	Ø±ÙŠØ§Ø¶Ù‡	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ù†Ø¨ÙŠÙ„ Ø¨Ù† Ù…Ø­Ø³Ù† Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ù„Ø§Ù  	1025472604	966562962766	Ø±ÙŠØ§Ø¶Ù‡	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
Ø¹Ø§Ø¯Ù„ Ø¨Ù† Ø¹Ù„ÙŠ Ø¨Ù† Ø³Ù„ÙŠÙ…Ø§Ù† Ø§Ù„Ø³Ø¨Ø¹Ø§Ù†	1003700802	966504836200	Ù…ÙˆØ¬Ù‡ Ø·Ù„Ø§Ø¨ÙŠ	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
ÙŠØ§Ø³Ø± Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯ Ø§Ù„Ù†Ù…Ø±	1001443397	966503834833	Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª	Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø¹Ù„Ù…
Ø¹Ù„ÙŠ Ø¨Ù† Ø­Ø³Ù† Ø¨Ù† Ø¹Ù„ÙŠ Ø¢Ù„ Ù‚Ù…Ø¨Ø±	1004780860	966502085389	Ø³ÙƒØ±ØªØ§Ø±ÙŠÙ‡	Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø¹Ù„Ù…
Ø­Ø³Ù† Ø¨Ù† Ø¹Ø§Ù…Ø± Ø§Ø­Ù…Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ	1013124175	966598893731	Ù…Ø­Ø¶Ø± Ù…Ø®ØªØ¨Ø±	Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø¹Ù„Ù…
Ø¹Ø¯Ù†Ø§Ù† Ø¹Ù„ÙŠ Ø­Ø³ÙŠÙ† Ø§Ù„Ø²Ø±ÙŠÙ‚	1015776766	966505808451	ÙˆÙƒÙŠÙ„	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³
ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ	1024193532	966504532489	Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©	Ù…Ø¹Ù„Ù… Ù…Ù…Ø§Ø±Ø³`;

/* âœ… ØªØ­Ø³ÙŠÙ† Ù‚Ø±Ø§Ø¡Ø© CSV: ÙŠØ¯Ø¹Ù… Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ ØªØ¨ÙˆÙŠØ¨ Ø²Ø§Ø¦Ø¯ (Ø¹Ù…ÙˆØ¯ ÙØ§Ø±Øº) */
function parseTeachersCSV(csv){
  const digitsOnly = (s)=>String(s||'').replace(/[^\d]/g,'').trim();
  const looksCivil = (s)=>digitsOnly(s).length===10;
  const looksPhone = (s)=>{ const d=digitsOnly(s); return d.startsWith('966') && d.length>=11; };

  return csv.trim().split(/\r?\n/).map(line=>{
    const parts=line.split(/\t+/).map(x=>String(x||'').trim());
    const name=(parts[0]||'').trim();
    const rest=parts.slice(1).filter(x=>x!=='');

    let civil='', phone='', spec='', level='';

    // 1) Ø§Ù„ØªÙ‚Ø· Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„Ø¬ÙˆØ§Ù„ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†
    rest.forEach(tok=>{
      if(!civil && looksCivil(tok)) civil=digitsOnly(tok);
      else if(!phone && looksPhone(tok)) phone=digitsOnly(tok);
    });

    // 2) Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ØªØ®ØµØµ + Ù…Ø±ØªØ¨Ø©
    const remaining = rest.filter(tok=>{
      const d=digitsOnly(tok);
      if(civil && d===civil) return false;
      if(phone && d===phone) return false;
      return true;
    });

    if(remaining.length){ spec=remaining[0]||''; level=remaining[1]||''; }

    return {
      name:name.trim(),
      civil:civil,
      phone:phone,
      spec:(spec||'').trim(),
      level:(level||'').trim(),
      job:'',
      work:'Ù…Ø¹Ù„Ù…'
    };
  }).filter(r=>r.name);
}

const TEACHERS=parseTeachersCSV(TEACHERS_CSV);
const TEACHER_BY_CIVIL={}; TEACHERS.forEach(t=>{ if(t.civil) TEACHER_BY_CIVIL[t.civil]=t; });

const selTeacher=document.getElementById('selTeacher');
function fillTeachers(){
  selTeacher.innerHTML='<option value="">â€” Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ â€”</option>';
  TEACHERS.forEach((t,i)=>selTeacher.add(new Option(t.name,i)));
}
fillTeachers();

/* ============= Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© ============= */
let STATE={kind:'late',excuse:'without',accept:'rejected',faris:''};

/* ============= Ø­Ø¶ÙˆØ±ÙŠ Ù…Ø³ØªØ®Ø¯Ù…ØŸ ============= */
let HADORY_USED=false;

/* ============= Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ============= */
let DATE_GUARD_ACTIVE=false;
let DATE_GUARD_CONFIRMED=true;
let DATE_GUARD_REASON='â€”';
const warnReason=document.getElementById('warnReason');

const dateGuardDlg=document.getElementById('dateGuardDlg');
const guardDate=document.getElementById('guardDate');
const guardWhy=document.getElementById('guardWhy');
const chkAck=document.getElementById('chkAck');

function openDateGuard(reason){
  DATE_GUARD_ACTIVE=true;
  DATE_GUARD_CONFIRMED=false;
  DATE_GUARD_REASON=reason||DATE_GUARD_REASON||'';
  chkAck.checked=false;
  const iso=document.getElementById('hadoryManualDate').value||'';
  guardDate.textContent=iso||'â€”';
  guardWhy.textContent=DATE_GUARD_REASON;
  dateGuardDlg.style.display='flex';
  dateGuardDlg.setAttribute('aria-hidden','false');
}
function closeDateGuard(){
  dateGuardDlg.style.display='none';
  dateGuardDlg.setAttribute('aria-hidden','true');
}
document.getElementById('btnGuardClose').onclick=closeDateGuard;
dateGuardDlg.addEventListener('click',(e)=>{ if(e.target===dateGuardDlg) closeDateGuard(); });

document.getElementById('btnGuardReview').onclick=()=>{
  closeDateGuard();
  document.getElementById('hadoryManualDate').focus();
};

document.getElementById('btnGuardConfirm').onclick=()=>{
  const iso = document.getElementById('hadoryManualDate').value || '';
  if(!iso){
    alert('Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø¶ØºØ· (ØªØ·Ø¨ÙŠÙ‚) Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯.');
    return;
  }
  if(!chkAck.checked){
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù‚Ø¨Ù„ ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¥Ù‚Ø±Ø§Ø± Ø¨ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®.');
    return;
  }
  DATE_GUARD_CONFIRMED=true;
  DATE_GUARD_ACTIVE=false;
  closeDateGuard();
  showDateOk(true);
};


function requireDateGuard(actionName){
  if(!HADORY_USED) return true;

  const iso = document.getElementById('hadoryManualDate').value || '';
  if(!iso){
    openDateGuard('ÙŠÙ„Ø²Ù… Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ (ØªØ·Ø¨ÙŠÙ‚) Ù‚Ø¨Ù„: ' + actionName);
    return false;
  }

  if(!DATE_GUARD_ACTIVE) return true;
  if(DATE_GUARD_CONFIRMED) return true;

  openDateGuard(DATE_GUARD_REASON || ('Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…ÙØ¹Ù‘Ù„Ø© Ù‚Ø¨Ù„: ' + actionName));
  return false;
}


/* ============= Ø£Ø±Ø´ÙŠÙ Ù…Ø­Ù„ÙŠ ============= */
const KEY_ARCH='followup_archive_v11';
let ARCH=JSON.parse(localStorage.getItem(KEY_ARCH)||'[]');
function saveARCH(){ localStorage.setItem(KEY_ARCH, JSON.stringify(ARCH)); }
function clearARCH(){ ARCH=[]; saveARCH(); }

function nextSerialForKey(key){
  const n=ARCH.filter(e=>((e.civil||e.name)===key)).length+1;
  return en2ar(String(n).padStart(2,'0'));
}

/* ============= Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ù†Ø§ØµØ± ============= */
const alertPack=document.getElementById('alertPack');
const absencePack=document.getElementById('absencePack');
const notePack=document.getElementById('notePack');
const lineLate=document.getElementById('lineLate');
const lineAbs=document.getElementById('lineAbs');
const kindTitle=document.getElementById('kindTitle');
const statsDlg=document.getElementById('statsDlg');

const WORK_RANGE={ winter:{start:'07:00',end:'14:00'}, summer:{start:'06:45',end:'13:45'} };
let SEASON='winter';

document.getElementById('seasonChips').addEventListener('click',e=>{
  const b=e.target.closest('.chip'); if(!b) return;
  [...e.currentTarget.children].forEach(x=>x.classList.remove('active')); b.classList.add('active');
  SEASON=b.dataset.season;
  recalc();
});

/* ============= Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø§ÙƒÙŠØª ============= */
function setPack(kind){
  STATE.kind=kind;

  document.getElementById('mainTitle').textContent=({late:'ØªÙ†Ø¨ÙŠÙ‡',absent:'ØªÙ†Ø¨ÙŠÙ‡',gaib:'Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨',note:'Ù„ÙØª Ù†Ø¸Ø±'})[kind];
  alertPack.style.display=(kind==='gaib'||kind==='note')?'none':'';
  document.getElementById('affidavitPack').style.display=(kind==='gaib'||kind==='note')?'none':'';
  document.getElementById('principalPack').style.display=(kind==='gaib'||kind==='note')?'none':'';
  absencePack.style.display=(kind==='gaib')?'':'none';
  notePack.style.display=(kind==='note')?'':'none';

  lineLate.style.display=(kind==='late')?'':'none';
  lineAbs.style.display=(kind==='absent')?'':'none';

  kindTitle.textContent=({late:'ØªØ£Ø®Ø±',absent:'Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯'})[kind]||'â€”';
  document.getElementById('affKind').textContent=({late:'Ø§Ù„ØªØ£Ø®Ø±',absent:'Ø¹Ø¯Ù… Ø§Ù„ØªÙˆØ§Ø¬Ø¯'})[kind]||'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©';

  const frWrap=document.getElementById('frGroup').parentElement;
  if(kind==='gaib'){ frWrap.classList.remove('disabled'); if(!STATE.faris) STATE.faris='not'; }
  else { frWrap.classList.add('disabled'); STATE.faris=''; }

  updUnifiedText();

  if(kind==='gaib') updatePrincipalAbs();

  updateLessonUI();
}

document.getElementById('kindChips').addEventListener('click',e=>{
  const b=e.target.closest('.chip'); if(!b) return;
  [...e.currentTarget.children].forEach(x=>x.classList.remove('active')); b.classList.add('active');
  setPack(b.dataset.k);
  recalc();
});

/* ============= Ø§Ù„Ø¹Ø°Ø±/Ø§Ù„Ù‚Ø¨ÙˆÙ„/ÙØ§Ø±Ø³ ============= */
const unifiedPanel=document.getElementById('unifiedPanel'), unifiedText=document.getElementById('unifiedText');
document.getElementById('btnUnified').onclick=()=>{
  unifiedPanel.style.display = (unifiedPanel.style.display==='block') ? 'none' : 'block';
};
unifiedPanel.addEventListener('click',e=>{
  const c=e.target.closest('.chip'); if(!c) return;
  if(c.dataset.exc){ c.parentElement.querySelectorAll('[data-exc]').forEach(x=>x.classList.remove('active')); c.classList.add('active'); STATE.excuse=c.dataset.exc; }
  if(c.dataset.acc){ c.parentElement.querySelectorAll('[data-acc]').forEach(x=>x.classList.remove('active')); c.classList.add('active'); STATE.accept=c.dataset.acc; }
  if(c.dataset.fr && STATE.kind==='gaib'){ c.parentElement.querySelectorAll('[data-fr]').forEach(x=>x.classList.remove('active')); c.classList.add('active'); STATE.faris=c.dataset.fr; }
  updUnifiedText();
  unifiedPanel.style.display='none';
});
function updUnifiedText(){
  const excTxt=(STATE.excuse==='with')?'Ø¨Ø¹Ø°Ø±':'Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±';
  const frTxt=(STATE.kind==='gaib')?(' â€¢ ÙØ§Ø±Ø³: '+(STATE.faris==='raised'?'Ù…Ø±ÙÙˆØ¹':'Ù„Ù… ÙŠÙØ±ÙØ¹')):'';
  unifiedText.textContent=excTxt+frTxt;
}

/* ============= Ø§Ù„ØªØ§Ø±ÙŠØ® Ù‡Ø¬Ø±ÙŠ/Ù…ÙŠÙ„Ø§Ø¯ÙŠ ============= */
let CAL_MODE='h';
const pickHijri=document.getElementById('pickHijri'), pickGreg=document.getElementById('pickGreg');
document.getElementById('btnCalToggle').onclick=()=>{
  CAL_MODE=CAL_MODE==='h'?'g':'h';
  document.getElementById('btnCalToggle').textContent=(CAL_MODE==='h'?'ğŸ—“ï¸ Ù‡Ø¬Ø±ÙŠ':'ğŸ—“ï¸ Ù…ÙŠÙ„Ø§Ø¯ÙŠ');
  pickHijri.style.display=CAL_MODE==='h'?'flex':'none';
  pickGreg.style.display=CAL_MODE==='g'?'flex':'none';
  if(CAL_MODE==='h') syncFromHijri(); else syncFromGregInputs();
};

function hijriToGregorian(y,m,d){
  let lo=new Date(1937,0,1), hi=new Date(2077,11,31);
  const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'numeric',day:'numeric'});
  const parts=dt=>{const p=fmt.formatToParts(dt);return{y:+ar2en(p.find(x=>x.type==='year').value),m:+ar2en(p.find(x=>x.type==='month').value),d:+ar2en(p.find(x=>x.type==='day').value)}};
  while(lo<=hi){
    const mid=new Date((lo.getTime()+hi.getTime())/2),v=parts(mid);
    if(v.y===y&&v.m===m&&v.d===d) return new Date(mid.getFullYear(),mid.getMonth(),mid.getDate());
    if(v.y<y||(v.y===y&&v.m<m)||(v.y===y&&v.m===m&&v.d<d)) lo=new Date(mid.getFullYear(),mid.getMonth(),mid.getDate()+1);
    else hi=new Date(mid.getFullYear(),mid.getMonth(),mid.getDate()-1);
  }
return null;
}
function buildHijriPicker(){
  hY.innerHTML=hM.innerHTML=hD.innerHTML='';
  const now=new Date();
  const currAH=parseInt(ar2en(new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric'}).format(now)),10);
  for(let i=currAH-1;i<=currAH+1;i++) hY.add(new Option(en2ar(i),i));
  for(let i=1;i<=12;i++) hM.add(new Option(en2ar(String(i).padStart(2,'0')),i));
  for(let i=1;i<=30;i++) hD.add(new Option(en2ar(String(i).padStart(2,'0')),i));
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
  hD.value=+ar2en(parts.find(p=>p.type==='day').value);
  hM.value=+ar2en(parts.find(p=>p.type==='month').value);
  hY.value=+ar2en(parts.find(p=>p.type==='year').value);
  hY.onchange=hM.onchange=hD.onchange=syncFromHijri;
  syncFromHijri();
}
function syncFromHijri(){
  const y=+hY.value, m=+hM.value, d=+hD.value;
  const g=hijriToGregorian(y,m,d);
  if(!g){
    alert('Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±. Ø§Ø®ØªØ± ÙŠÙˆÙ…Ù‹Ø§ Ø¢Ø®Ø±.');
    return;
  }

  // âœ… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© (Ø³Ø¨Ø¨ ØªÙˆÙ‚Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª)
  const dayName = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(g);
  const hij = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).format(g);

  metaDay.textContent=dayName; metaHijri.textContent=hij;
  dynDay.textContent=dayName; dynHijri.textContent=hij;
  noteDay.textContent=dayName; noteHijri.textContent=hij;

  document.getElementById('affTeacher').textContent=document.getElementById('t_name').textContent||'â€”';
  document.getElementById('absDayP').textContent=dayName;
  document.getElementById('absDateYMD').textContent=hij;
  document.getElementById('statsDay').textContent=dayName;
  document.getElementById('statsHijri').textContent=hij;
  document.getElementById('repDay').textContent=dayName;
  document.getElementById('repHijri').textContent=hij;

  const repDayTxt=document.getElementById('repDayTxt');
  const repHijriTxt=document.getElementById('repHijriTxt');
  if(repDayTxt) repDayTxt.textContent=dayName;
  if(repHijriTxt) repHijriTxt.textContent=hij;

  updatePrincipalAbs();
}


['gY','gM','gD'].forEach(id=>document.getElementById(id).addEventListener('input',syncFromGregInputs));
function syncFromGregInputs(){
  const y=+gY.value||new Date().getFullYear(), m=+gM.value||new Date().getMonth()+1, d=+gD.value||new Date().getDate();
  const g=new Date(y,m-1,d);
  const dayName=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(g);
  const hij=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).format(g);

  metaDay.textContent=dayName; metaHijri.textContent=hij;
  dynDay.textContent=dayName; dynHijri.textContent=hij;
  noteDay.textContent=dayName; noteHijri.textContent=hij;

  document.getElementById('affTeacher').textContent=document.getElementById('t_name').textContent||'â€”';
  document.getElementById('absDayP').textContent=dayName;
  document.getElementById('absDateYMD').textContent=hij;
  document.getElementById('statsDay').textContent=dayName;
  document.getElementById('statsHijri').textContent=hij;
  document.getElementById('repDay').textContent=dayName;
  document.getElementById('repHijri').textContent=hij;

  const repDayTxt=document.getElementById('repDayTxt');
  const repHijriTxt=document.getElementById('repHijriTxt');
  if(repDayTxt) repDayTxt.textContent=dayName;
  if(repHijriTxt) repHijriTxt.textContent=hij;

  updatePrincipalAbs();
}

/* ============= ÙˆÙ‚Øª ============= */
function toMin(hhmm){
  const m=/^(\d{1,2}):(\d{2})$/.exec(ar2en(hhmm||'')); if(!m) return null;
  const h=+m[1], mi=+m[2]; if(h>23||mi>59) return null;
  return h*60+mi;
}
function fmtHM(mins){
  const h=Math.floor(mins/60), m=mins%60;
  return en2ar(String(h).padStart(2,'0')+':'+String(m).padStart(2,'0'));
}
function attachTimeMask(el){
  el.addEventListener('beforeinput',(e)=>{ if(e.inputType==='insertText'){ const ch=e.data; if(!(/[0-9Ù -Ù©:]/.test(ch))) e.preventDefault(); }});
  el.addEventListener('input',()=>{
    let v=el.textContent.replace(/[^0-9Ù -Ù©]/g,''); v=ar2en(v);
    if(v.length>=3){ v=v.slice(0,4).padEnd(4,'0'); v=v.slice(0,2)+':'+v.slice(2,4);}
    else if(v.length>0){ v=v.padEnd(2,'0'); }
    el.textContent=en2ar(v.length?v:'--:--'); if(el.textContent.includes(':')) el.classList.remove('empty'); placeCaretAtEnd(el); recalc();
  });
  el.addEventListener('blur',()=>{ const m=toMin(el.textContent); if(m==null){ el.textContent='--:--'; el.classList.add('empty'); } else { el.textContent=fmtHM(m); el.classList.remove('empty'); } recalc(); });
  el.addEventListener('click',()=>openClock(el));
}
function placeCaretAtEnd(el){ const r=document.createRange(); r.selectNodeContents(el); r.collapse(false); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); }
['tLateIn','tAbsFrom','tAbsTo','lessonA','lessonB'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) attachTimeMask(el);
});

/* Ø³Ø§Ø¹Ø© Ø§Ø®ØªÙŠØ§Ø± */
let CLOCK_TARGET=null;
const clockDlg=document.getElementById('clockDlg');
const clockHour=document.getElementById('clockHour');
const clockMin=document.getElementById('clockMin');
const clockPreview=document.getElementById('clockPreview');
function showClock(){ clockDlg.style.display='flex'; clockDlg.setAttribute('aria-hidden','false'); }
function hideClock(){ clockDlg.style.display='none'; clockDlg.setAttribute('aria-hidden','true'); CLOCK_TARGET=null; }
function updClockPreview(){ clockPreview.textContent=en2ar(String(clockHour.value).padStart(2,'0')+':'+String(clockMin.value).padStart(2,'0')); }
function openClock(target){
  CLOCK_TARGET=target;
  const cur=toMin(target.textContent); const now=new Date();
  const h=(cur!=null)?Math.floor(cur/60):now.getHours();
  const m=(cur!=null)?(cur%60):now.getMinutes();
  clockHour.value=h; clockMin.value=m; updClockPreview(); showClock();
}
clockHour.addEventListener('input',updClockPreview);
clockMin.addEventListener('input',updClockPreview);
document.getElementById('btnClockNow').onclick=()=>{ const now=new Date(); clockHour.value=now.getHours(); clockMin.value=now.getMinutes(); updClockPreview(); };
document.getElementById('btnClockOk').onclick=()=>{ if(!CLOCK_TARGET) return; const m=+clockMin.value, h=+clockHour.value; CLOCK_TARGET.textContent=en2ar(String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')); CLOCK_TARGET.classList.remove('empty'); hideClock(); recalc(); };
document.getElementById('btnClockClose').onclick=hideClock;
clockDlg.addEventListener('click',(e)=>{ if(e.target===clockDlg) hideClock(); });

/* Ø­Ø³Ø§Ø¨Ø§Øª */
function detectLessonMode(reason){
  const r = String(reason||'').trim();
  if(r.includes('Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØ©')) return 'enter';
  if(r.includes('Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­ØµØ© Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡Ø§')) return 'exit';
  return '';
}

function resetLessonFields(){
  if(periodNo) periodNo.value='';
  if(lessonA){ lessonA.textContent='--:--'; lessonA.classList.add('empty'); }
  if(lessonB){ lessonB.textContent='--:--'; lessonB.classList.add('empty'); }
  if(lessonMins) lessonMins.textContent='0';
  if(notePeriodNo) notePeriodNo.textContent='â€”';
  if(noteLessonMin) noteLessonMin.textContent='0';
}

function recalcLesson(){
  if(!NOTE_LESSON_MODE){
    if(lessonMins) lessonMins.textContent='0';
    if(noteLessonMin) noteLessonMin.textContent='0';
    return;
  }

  const a = toMin(lessonA?.textContent.trim());
  const b = toMin(lessonB?.textContent.trim());

  let mins = 0;
  if(a!=null && b!=null){
    if(NOTE_LESSON_MODE==='enter'){
      mins = Math.max(0, b - a);   // Ø¯Ø®ÙˆÙ„ - Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­ØµØ©
    }else{
      mins = Math.max(0, a - b);   // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­ØµØ© - Ø®Ø±ÙˆØ¬ ÙØ¹Ù„ÙŠ
    }
  }

  lessonMins.textContent = en2ar(mins);
  noteLessonMin.textContent = en2ar(mins);
}

function updateLessonUI(){
  const reason = document.getElementById('noteReason')?.value || '';
  NOTE_LESSON_MODE = (STATE.kind==='note') ? detectLessonMode(reason) : '';

  const on = !!NOTE_LESSON_MODE;

  if(lessonBox) lessonBox.style.display = on ? '' : 'none';
  if(noteLessonExtra) noteLessonExtra.style.display = on ? 'inline' : 'none';

  if(!on){
    resetLessonFields();
    return;
  }

  if(NOTE_LESSON_MODE==='enter'){
    lessonTitle.textContent = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØ©';
    lessonA_lbl.textContent = 'ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­ØµØ© (Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„)';
    lessonB_lbl.textContent = 'ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ù„Ø­ØµØ©';
    noteLessonKind.textContent = 'Ø§Ù„ØªØ£Ø®Ø±';
    lessonHint.textContent = 'Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­ØµØ© ÙˆÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” Ø³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ£Ø®Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.';
  }else{
    lessonTitle.textContent = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­ØµØ©';
    lessonA_lbl.textContent = 'ÙˆÙ‚Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­ØµØ© (Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„)';
    lessonB_lbl.textContent = 'ÙˆÙ‚Øª Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø¹Ù„Ù… Ù…Ù† Ø§Ù„Ø­ØµØ©';
    noteLessonKind.textContent = 'Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø¨ÙƒØ±';
    lessonHint.textContent = 'Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­ØµØ© ÙˆÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ â€” Ø³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø¨ÙƒØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.';
  }

  notePeriodNo.textContent = (periodNo.value ? en2ar(periodNo.value) : 'â€”');

  recalcLesson();
}
function recalc(){
  const wsM=toMin(WORK_RANGE[SEASON].start);
  const tLateM=toMin(document.getElementById('tLateIn').textContent.trim());
  if(tLateM!=null&&wsM!=null&&tLateM>wsM){
    const mins=tLateM-wsM;
    lateTotal.textContent=en2ar(mins)+' Ø¯Ù‚ÙŠÙ‚Ø©';
    lateHH.textContent=fmtHM(mins);
  } else {
    lateTotal.textContent='0 Ø¯Ù‚ÙŠÙ‚Ø©';
    lateHH.textContent='00:00';
  }
  recalcLesson();

  const aFM=toMin(document.getElementById('tAbsFrom').textContent.trim()), aTM=toMin(document.getElementById('tAbsTo').textContent.trim());
  if(aFM!=null&&aTM!=null&&aTM>aFM){
    const mins=aTM-aFM;
    absTotal.textContent=en2ar(mins)+' Ø¯Ù‚ÙŠÙ‚Ø©';
    absHH.textContent=fmtHM(mins);
  } else {
    absTotal.textContent='0 Ø¯Ù‚ÙŠÙ‚Ø©';
    absHH.textContent='00:00';
  }
}

/* Ø³Ø¨Ø¨ Ù„ÙØª Ø§Ù„Ù†Ø¸Ø± */
document.getElementById('noteReason').addEventListener('change', e=>{
  document.getElementById('noteReasonText').textContent = e.target.value || 'Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©';
  updateLessonUI();
});

if(periodNo){
  periodNo.addEventListener('change', updateLessonUI);
}

/* Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ù„Ù… */
selTeacher.addEventListener('change',e=>{
  if(e.target.value==='') return;         // âœ… ÙŠÙ…Ù†Ø¹ Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„ÙØ§Ø±Øº = 0
  const i = Number(e.target.value);
  const t = Number.isInteger(i) ? TEACHERS[i] : null;
  if(!t) return;

  t_name.textContent=t.name||'â€”'; t_spec.textContent=t.spec||'â€”'; t_level.textContent=t.level||'â€”';
  t_job.textContent=t.job||'â€”'; t_work.textContent=t.work||'â€”'; t_civil.textContent=t.civil||'â€”';
  teacherNameInline.textContent=t.name||'â€”'; noteTeacherName.textContent=t.name||'â€”'; document.getElementById('affTeacher').textContent=t.name||'â€”';
  document.getElementById('abs-name-top').textContent=t.name||'â€”'; document.getElementById('abs-teacher-name').textContent=t.name||'â€”';

  const key = t.civil || t.name;
  metaNo.textContent = nextSerialForKey(key);

  updatePrincipalAbs();
});

/* ØªØ¶Ù…ÙŠÙ† ØµÙˆØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
async function embedImageToDataURL(imgEl){
  try{
    const src=imgEl.getAttribute('src')||''; if(!src) return;
    const u=src.match(/^data:/)? src : encodeURI(src);
    const resp=await fetch(u,{mode:'cors',cache:'no-store'}); if(!resp.ok) return;
    const blob=await resp.blob(); const reader=new FileReader();
    await new Promise(res=>{ reader.onload=()=>{ imgEl.src=reader.result; res(); }; reader.readAsDataURL(blob); });
  }catch(e){}
}
async function ensureAllImagesEmbedded(root){
  const imgs=[...root.querySelectorAll('img')];
  for(const im of imgs){ if(!im.src.startsWith('data:')) await embedImageToDataURL(im); }
}

/* Ø·Ø¨Ø§Ø¹Ø©/Ø­ÙØ¸ PDF â€” âœ… Ø¥ØµÙ„Ø§Ø­: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª ØªÙƒØ³Ø± Ø§Ù„ØªÙ†ÙÙŠØ° */
document.getElementById('btnPrintSave').addEventListener('click', async (e)=>{
  if(!requireDateGuard('Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸')) return;

  if(selTeacher.value===''){ alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹'); return; } // âœ…
const i = Number(selTeacher.value);
const t = TEACHERS[i];
if(!t){ alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù….'); return; }                 // âœ…


  // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ PDF
  ARCH.push({
    ts: Date.now(),
    civil: t.civil,
    name: t.name,
    kind: STATE.kind,
    excuse: STATE.excuse,
    accept: STATE.accept,
    faris: (STATE.kind === 'gaib' ? (STATE.faris || 'not') : ''),
    hijri: metaHijri.textContent,
    day: metaDay.textContent,
       noteReason: (STATE.kind === 'note')
      ? (document.getElementById('noteReasonText')?.textContent || '')
      : '',

    period: (STATE.kind==='note' ? (periodNo?.value || '') : ''),
    lessonMode: (STATE.kind==='note' ? (NOTE_LESSON_MODE || '') : ''),
    lessonMins: (STATE.kind==='note' ? ar2en(lessonMins?.textContent || '0') : ''),
    lessonA: (STATE.kind==='note' ? (lessonA?.textContent.trim() || '') : ''),
    lessonB: (STATE.kind==='note' ? (lessonB?.textContent.trim() || '') : '')
  });
  saveARCH();

  const { jsPDF } = window.jspdf;

  const btn = e.currentTarget;
  const old = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ PDF...';

  try{
    const sheet = document.getElementById('sheet');
    await ensureAllImagesEmbedded(sheet);

    const canvas = await html2canvas(sheet, {
  scale: 2,
  backgroundColor: '#fff',   // âœ… Ø§Ù„ØµØ­ÙŠØ­
  useCORS: true,

      allowTaint: false,
      imageTimeout: 0,
      logging: false
    });

  const pdf = new jsPDF({orientation:'p', unit:'mm', format:'a4'});
const pageW = 210, pageH = 297;

let imgW = pageW;
let imgH = canvas.height * pageW / canvas.width;

if(imgH > pageH){
  imgH = pageH;
  imgW = canvas.width * pageH / canvas.height;
}

const x = (pageW - imgW) / 2;
pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, 0, imgW, imgH);

    pdf.save(`Ø¥Ø¬Ø±Ø§Ø¡ - ${t.name}.pdf`);

    if(confirm('ØªÙ… Ø­ÙØ¸ Ù…Ù„Ù PDF. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¢Ù†ØŸ')) {
      setTimeout(()=>window.print(), 200);
    }

  }catch(err){
    alert('ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF: ' + (err?.message || err));
  }finally{
    btn.disabled = false;
    btn.textContent = old;
  }
});

/* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
document.getElementById('btnStats').onclick=openStats;
document.getElementById('btnCloseStats').onclick=()=>{ statsDlg.style.display='none'; statsDlg.setAttribute('aria-hidden','true'); };
document.getElementById('btnResetStats').onclick=()=>{ if(confirm('ØªØ£ÙƒÙŠØ¯: Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ')){ clearARCH(); openStats(); } };
document.getElementById('btnStatsPDF').onclick=async()=>{
  const dlg=document.getElementById('statsDlg');
  const card=document.getElementById('statsCard');
  await ensureAllImagesEmbedded(card);
  dlg.setAttribute('aria-hidden','false');
  document.body.setAttribute('data-print','stats');
  window.print();
  setTimeout(()=>document.body.removeAttribute('data-print'),300);
};
function shortDetails(r){
  if(r.kind === 'late') return 'ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±';
  if(r.kind === 'absent') return 'ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯';
  if(r.kind === 'gaib') return 'ØºÙŠØ§Ø¨';
if(r.kind === 'note'){
  let extra='';
  if(r.lessonMode){
    const lbl = (r.lessonMode==='enter') ? 'ØªØ£Ø®Ø±' : 'Ø®Ø±ÙˆØ¬ Ù…Ø¨ÙƒØ±';
    extra = ` â€” Ø§Ù„Ø­ØµØ©: ${r.period?en2ar(r.period):'â€”'} â€” ${lbl}: ${en2ar(r.lessonMins||0)} Ø¯`;
  }
  return `Ù„ÙØª Ù†Ø¸Ø± â€” ${r.noteReason || 'â€”'}${extra}`;
}
  return 'â€”';
}

/* âœ… openStats Ù…Ø­Ø³Ù‘Ù† Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
function openStats(){
  const tb=document.querySelector('#tblStats tbody'); tb.innerHTML='';
  const byTeacher=new Map();
  ARCH.forEach(r=>{
    const k=(r.civil||r.name);
    if(!byTeacher.has(k)) byTeacher.set(k,{name:r.name,rows:[]});
    byTeacher.get(k).rows.push(r);
  });

  for(const {name,rows} of byTeacher.values()){
    rows.sort((a,b)=>a.ts-b.ts);

    rows.forEach((r,idx)=>{
      const tr=document.createElement('tr');

      if(idx===0){
        const td=document.createElement('td');
        td.rowSpan=rows.length;
        td.style.fontWeight='900';
        td.textContent=name;
        tr.appendChild(td);
      }

      const tdType=document.createElement('td');
      tdType.textContent=({late:'ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±',absent:'ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯',gaib:'Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨',note:'Ù„ÙØª Ù†Ø¸Ø±'})[r.kind]||'â€”';

      const tdDay=document.createElement('td'); tdDay.textContent=r.day||'â€”';
      const tdHij=document.createElement('td'); tdHij.textContent=r.hijri||'â€”';
      const tdExc=document.createElement('td'); tdExc.textContent=(r.excuse==='with'?'Ø¨Ø¹Ø°Ø±':'Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±');
      const tdF=document.createElement('td'); tdF.textContent=(r.kind==='gaib'?((r.faris==='raised')?'Ù…Ø±ÙÙˆØ¹':'Ù„Ù… ÙŠÙØ±ÙØ¹'):'');
      const tdDet=document.createElement('td'); tdDet.textContent=shortDetails(r);

      const tdAct=document.createElement('td');
      tdAct.className='no-print';
      tdAct.innerHTML=`<button class="btn ghost delRow" data-ts="${r.ts}" title="Ø­Ø°Ù">Ø­Ø°Ù</button>`;

      tr.appendChild(tdType);
      tr.appendChild(tdDay);
      tr.appendChild(tdHij);
      tr.appendChild(tdExc);
      tr.appendChild(tdF);
      tr.appendChild(tdDet);
      tr.appendChild(tdAct);

      tb.appendChild(tr);
    });
  }

  statsDlg.style.display='flex';
  statsDlg.setAttribute('aria-hidden','false');
  document.getElementById('statsDay').textContent=document.getElementById('metaDay').textContent;
  document.getElementById('statsHijri').textContent=document.getElementById('metaHijri').textContent;
}
document.getElementById('tblStats').addEventListener('click',(e)=>{
  const btn=e.target.closest('.delRow'); if(!btn) return;
  const ts=+btn.dataset.ts; if(!Number.isFinite(ts)) return;
  if(confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')){
    const idx=ARCH.findIndex(r=>r.ts===ts);
    if(idx>-1){ ARCH.splice(idx,1); saveARCH(); openStats(); }
  }
});

/* ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ØºÙŠØ§Ø¨ */
const PRINCIPAL_NAME='ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ';
function updatePrincipalAbs(){
  const nameEl=document.getElementById('principalNameAbs');
  const signEl=document.getElementById('principalSignAbs');
  const dateEl=document.getElementById('principalDateAbs');
  if(!nameEl||!dateEl||!signEl) return;
  nameEl.textContent=PRINCIPAL_NAME;
  signEl.textContent='____________________';
  dateEl.textContent=document.getElementById('metaHijri').textContent||'â€”';
}

/* =========================
   Ø­Ø¶ÙˆØ±ÙŠ
   ========================= */
const hadoryFiles = document.getElementById('hadoryFiles');
const hadoryManualDate = document.getElementById('hadoryManualDate');
const btnUseManualDate = document.getElementById('btnUseManualDate');
const hadoryDates = document.getElementById('hadoryDates');
const hadoryCases = document.getElementById('hadoryCases');
const hadoryStatus = document.getElementById('hadoryStatus');
const hadoryMiniTable = document.getElementById('hadoryMiniTable');
const cAbsent = document.getElementById('cAbsent');
const cLate = document.getElementById('cLate');
const cNoOut = document.getElementById('cNoOut');
const hadoryDateWarn = document.getElementById('hadoryDateWarn');
const hadoryDateOk = document.getElementById('hadoryDateOk');

document.getElementById('btnHadoryImport').addEventListener('click', ()=>{
  try{ hadoryFiles.click(); }catch(e){ alert('ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª.'); }
});

document.getElementById('btnHadoryDrive').addEventListener('click', ()=>{
  window.open('https://drive.google.com/drive/folders/1pjqnwJ47M93BkLSygUZ7u3xrZFUYHCtY?usp=sharing','_blank');
});

document.getElementById('btnConfirmDateInline').onclick=()=>{
  if(!HADORY_USED) return;
  openDateGuard(DATE_GUARD_REASON || 'ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø§Ù„Ø¥Ù‚Ø±Ø§Ø± Ø¨Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.');
};

let HADORY_LOGS=[];
let HADORY_DAILY=[];
let HADORY_CASES=[];
let HADORY_IMPORT_DATES=[];

function setHadoryStatus(txt){ hadoryStatus.textContent = txt; }

function showDateWarn(on, reason){
  hadoryDateWarn.style.display=on?'block':'none';
  warnReason.textContent=reason||'â€”';
  if(on && HADORY_USED){
    hadoryDateOk.style.display='none';
    DATE_GUARD_ACTIVE=true;
    DATE_GUARD_CONFIRMED=false;
    DATE_GUARD_REASON=reason||'ÙŠÙ„Ø²Ù… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±.';
  }
}
function showDateOk(on){
  hadoryDateOk.style.display=on?'block':'none';
  if(on && HADORY_USED){
    hadoryDateWarn.style.display='none';
    DATE_GUARD_ACTIVE=false;
    DATE_GUARD_CONFIRMED=true;
    DATE_GUARD_REASON='';
  }
}

function normalizeDate(raw){
  if(raw===undefined || raw===null) return '';

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø®Ù„ÙŠØ© Excel ØªÙÙ‚Ø±Ø£ ÙƒÙ€ Date
  if(raw instanceof Date){
    const y = raw.getFullYear();
    const m = String(raw.getMonth()+1).padStart(2,'0');
    const d = String(raw.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  let s = String(raw).trim();
  if(!s) return '';

  // Excel serial date number
  if(!isNaN(Number(s)) && !s.includes(':') && !s.includes('/') && !s.includes('-')){
    const n = Number(s);
    if(n > 20000 && n < 70000){
     const dc = XLSX?.SSF?.parse_date_code ? XLSX.SSF.parse_date_code(n) : null;
if(dc && dc.y && dc.m && dc.d){
  return `${dc.y}-${String(dc.m).padStart(2,'0')}-${String(dc.d).padStart(2,'0')}`;
}

// fallback (Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙÙ‚Ø·)
const dt = new Date(Math.round((n - 25569) * 86400 * 1000));
const y = dt.getFullYear();
const m = String(dt.getMonth()+1).padStart(2,'0');
const d = String(dt.getDate()).padStart(2,'0');
return `${y}-${m}-${d}`;

    }
  }

  s = s.replace(/\./g,'/').replace(/\\/g,'/');
  let m = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
  if(m) return `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;

  m = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})\s+\d{1,2}:\d{2}/);
  if(m) return `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;

  m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m) return `${m[1]}-${m[2]}-${m[3]}`;

  return '';
}

function normalizeTime(raw){
  if(raw===undefined || raw===null) return '';

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø®Ù„ÙŠØ© Excel ØªÙÙ‚Ø±Ø£ ÙƒÙ€ Date (ÙˆÙ‚Øª)
  if(raw instanceof Date){
    const h=String(raw.getHours()).padStart(2,'0');
    const m=String(raw.getMinutes()).padStart(2,'0');
    return `${h}:${m}`;
  }

  let s=String(raw).trim();
  if(!s) return '';

  // Excel fraction of a day (0..1)
  if(!isNaN(Number(s)) && !s.includes(':') && !s.includes('/') && !s.includes('-')){
    const v=Number(s);
    if(v>=0 && v<1){
      const total=Math.round(v*24*60);
      const h=String(Math.floor(total/60)).padStart(2,'0');
      const m=String(total%60).padStart(2,'0');
      return `${h}:${m}`;
    }
  }

  // "06:32 AM" / "1:36 PM" / "06:32" / "06:32:10"
  let m=s.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?/i);
  if(m){
    let h=parseInt(m[1],10);
    const mm=m[2];
    const ap=(m[4]||'').toUpperCase();
    if(ap==='PM' && h<12) h+=12;
    if(ap==='AM' && h===12) h=0;
    if(h>=0 && h<=23) return `${String(h).padStart(2,'0')}:${mm}`;
  }

  s=s.replace(/\s+/g,'').toUpperCase();
  m=s.match(/^(\d{1,2}):(\d{2})(AM|PM)?$/);
  if(m){
    let h=parseInt(m[1],10);
    const mm=m[2];
    const ap=m[3];
    if(ap==='PM' && h<12) h+=12;
    if(ap==='AM' && h===12) h=0;
    if(h>=0 && h<=23) return `${String(h).padStart(2,'0')}:${mm}`;
  }

  return '';
}

function diffMin(start,end){
  const s=toMin(start), e=toMin(end);
  if(s==null||e==null) return 0;
  let d=e-s; if(d<0) d+=24*60;
  return d;
}
function setGregFromISO(iso){
  if(!iso) return;
  const m=iso.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return;
  gY.value=+m[1]; gM.value=+m[2]; gD.value=+m[3];
  syncFromGregInputs();
}
function isAutoOutText(s){
  const v=String(s||'').toLowerCase();
  return /ØªÙ„Ù‚Ø§Ø¦ÙŠ|Ø¢Ù„ÙŠ|Ø§Ù„ÙŠ|auto|system|default/.test(v);
}
function normH(s){
  return String(s||'')
    .trim()
    .toLowerCase()
    .replace(/\u200f|\u200e/g,'')
    .replace(/[^\p{L}\p{N}\s:\/\-]/gu,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function normalizeName(v){
  return String(v||'')
    .replace(/\u200f|\u200e/g,'')
    .replace(/[^\p{L}\p{N}\s]/gu,' ')
    .replace(/\s+/g,' ')
    .trim();
}

function findIdxByAny(headers, patterns){
  for(let i=0;i<headers.length;i++){
    const h = normH(headers[i]);
    for(const p of patterns){
      if(p && p.test && p.test(h)) return i;
    }
  }
  return -1;
}

const ID_PATS = [
  /Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ/,
  /Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ/,
  /Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©/,
  /Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/,
  /Ù‡ÙˆÙŠØ©/,
  /Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù/,
  /Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ/,
  /Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/,
  /\bid\b/,
  /national id/,
  /civil/
];function bestHeaderRow(rows){
  let best={i:-1,score:-1,headers:[]};
  const max=Math.min(25, rows.length);
  for(let i=0;i<max;i++){
    const r=rows[i]||[];
    const headers=r.map(x=>String(x||''));
   const idIdx  = findIdxByAny(headers, ID_PATS);
const nameIdx = findIdxByAny(headers, [/Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù/,/Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/,/Ø§Ù„Ø§Ø³Ù…/,/Ø§Ù„Ø¥Ø³Ù…/,/[Ø§Ø¥Ø£Ø¢]Ø³Ù…/]);
const inIdx  = findIdxByAny(headers,[/Ø§Ù„Ø­Ø¶ÙˆØ±/,/ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø­Ø¶ÙˆØ±/,/ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¯Ø®ÙˆÙ„/]);
const outIdx = findIdxByAny(headers, [/[Ø§Ø¥Ø£Ø¢]Ù†ØµØ±Ø§Ù/,/ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù/,/ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†ØµØ±Ø§Ù/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¥Ù†ØµØ±Ø§Ù/,/ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ø±ÙˆØ¬/]);

    const score=(idIdx>-1?5:0)+(inIdx>-1?3:0)+(outIdx>-1?2:0)+(nameIdx>-1?2:0);
    if(score>best.score){ best={i,score,headers}; }
  }
  return best.i>-1?best.i:0;
}
function guessDateFromFileName(fileName){
  const s = ar2en(String(fileName||''));

  // 1) 2026-02-12 / 2026_2_12 / 2026.2.12
  let m = s.match(/(20\d{2})[._\-\/](\d{1,2})[._\-\/](\d{1,2})/);
  if(m){
    const y=m[1], mo=String(+m[2]).padStart(2,'0'), d=String(+m[3]).padStart(2,'0');
    return `${y}-${mo}-${d}`;
  }

  // 2) 12-02-2026
  m = s.match(/(\d{1,2})[._\-\/](\d{1,2})[._\-\/](20\d{2})/);
  if(m){
    const y=m[3], mo=String(+m[2]).padStart(2,'0'), d=String(+m[1]).padStart(2,'0');
    return `${y}-${mo}-${d}`;
  }

  // 3) 20260212
  m = s.match(/(20\d{2})(\d{2})(\d{2})/);
  if(m){
    return `${m[1]}-${m[2]}-${m[3]}`;
  }

  return '';
}
hadoryFiles.addEventListener('change', async (e)=>{
  const files=[...e.target.files||[]];
  if(!files.length) return;

  HADORY_USED=true;
  DATE_GUARD_ACTIVE=true;
  DATE_GUARD_CONFIRMED=false;

  setHadoryStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...');
  HADORY_LOGS=[]; HADORY_DAILY=[]; HADORY_CASES=[]; HADORY_IMPORT_DATES=[];
  renderHadoryEmpty();

  showDateWarn(true,'Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø§Ø¶ØºØ· (ØªØ·Ø¨ÙŠÙ‚) Ø«Ù… Ø£ÙƒØ¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.');
  setHadoryStatus('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® â€” Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø·Ø¨Ù‘Ù‚.');

  const datesFromCells=new Set();
  const datesFromNames=new Set();

  for(const f of files){
  try{
    const ext = (f.name.split('.').pop()||'').toLowerCase();
    let wb;

    if(ext === 'csv'){
      const text = await f.text();
      wb = XLSX.read(text, { type:'string' });
    }else{
      const ab = await f.arrayBuffer();
      wb = XLSX.read(ab, { type:'array' });
    }

      const fnDate=guessDateFromFileName(f.name);
      if(fnDate) datesFromNames.add(fnDate);

      wb.SheetNames.forEach(sn=>{
        const sh=wb.Sheets[sn];
        const rows=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
        if(!rows.length) return;

        const headerRowIndex = bestHeaderRow(rows);
        const headers=(rows[headerRowIndex]||[]).map(h=>String(h||'').trim());

const nameIdx = findIdxByAny(headers, [/Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù/,/Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/,/Ø§Ù„Ø§Ø³Ù…/,/Ø§Ù„Ø¥Ø³Ù…/,/[Ø§Ø¥Ø£Ø¢]Ø³Ù…/]);
const idIdx   = findIdxByAny(headers, ID_PATS);

const dateIdx = findIdxByAny(headers,[/ØªØ§Ø±ÙŠØ®/]);

const inIdx   = findIdxByAny(headers,[/Ø§Ù„Ø­Ø¶ÙˆØ±/,/ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø­Ø¶ÙˆØ±/,/ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¯Ø®ÙˆÙ„/]);
const outIdx  = findIdxByAny(headers, [/[Ø§Ø¥Ø£Ø¢]Ù†ØµØ±Ø§Ù/,/ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù/,/ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†ØµØ±Ø§Ù/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¥Ù†ØµØ±Ø§Ù/,/ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬/,/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ø±ÙˆØ¬/]);

        const outTypeIdx=findIdxByAny(headers,[/Ù†ÙˆØ¹ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù/,/Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ù†ØµØ±Ø§Ù/,/Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØµØ±Ø§Ù/,/Ù…Ù„Ø§Ø­Ø¸Ø©/,/Ù…Ù„Ø§Ø­Ø¸Ø§Øª/,/note/]);

        if(idIdx<0) return;

        for(let r=headerRowIndex+1;r<rows.length;r++){
          const row=rows[r];
          if(!row || row.every(c=>String(c).trim()==='')) continue;

// ===== Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„ØµÙ (Ø¥ØµÙ„Ø§Ø­ Ø£Ø®Ø·Ø§Ø¡ name + return) =====
const idRaw = ar2en(String(row[idIdx]||'')).replace(/\D/g,'').trim();
const civil = (idRaw.length===10) ? idRaw : '';
const empNo = (!civil && idRaw) ? idRaw : '';

const fileName = (nameIdx>=0) ? normalizeName(row[nameIdx]) : '';
if(!fileName && !empNo && !civil) continue;

let dateStr = '';
if(dateIdx>=0) dateStr = normalizeDate(row[dateIdx]);

// âœ… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ©: Ø®Ø° Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
if(!dateStr && fnDate) dateStr = fnDate;

if(dateStr) datesFromCells.add(dateStr);


const attend = (inIdx>=0) ? normalizeTime(row[inIdx]) : '';
const leave  = (outIdx>=0) ? normalizeTime(row[outIdx]) : '';

let workMinutes = 0;
if(attend && leave) workMinutes = diffMin(attend, leave);

const outTypeRaw = (outTypeIdx>=0)? String(row[outTypeIdx]||'').trim() : '';
const autoOut = isAutoOutText(outTypeRaw);

const t = (civil ? (TEACHER_BY_CIVIL[civil] || null) : null);
const displayName = (t?.name) || fileName || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';

HADORY_LOGS.push({
  date: dateStr,
  civil: (civil || empNo || ''),
  name: displayName,
  attend, leave, workMinutes,
  outType: outTypeRaw, autoOut,
  _srcFile:f.name, _sheet:sn
});

       }
      });
    }catch(err){ console.error(err); }
  }

  const allDates=[...new Set([...datesFromCells, ...datesFromNames].filter(Boolean))].sort();
  HADORY_IMPORT_DATES=allDates;

  hadoryDates.innerHTML = `<option value="">â€” (Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©) â€”</option>` + allDates.map(d=>`<option value="${d}">${d}</option>`).join('');
  setHadoryStatus(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (${HADORY_LOGS.length} Ø³Ø¬Ù„) â€” Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø·Ø¨Ù‘Ù‚`);

  showDateWarn(true, allDates.length
    ? `ØªÙˆØ§Ø±ÙŠØ® Ø¸Ù‡Ø±Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù: ${allDates.join(' ØŒ ')} â€” Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµØ­ÙŠØ­ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø£ÙƒØ¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.`
    : 'Ù„Ù… ÙŠØ¸Ù‡Ø± ØªØ§Ø±ÙŠØ® ÙˆØ§Ø¶Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù/Ø§Ù„Ø§Ø³Ù… â€” Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµØ­ÙŠØ­ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø£ÙƒØ¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.'
  );

  hadoryFiles.value='';
});

btnUseManualDate.addEventListener('click', ()=>{
  const iso=hadoryManualDate.value||'';
  if(!iso){ alert('Ø­Ø¯Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'); return; }

  setGregFromISO(iso);

  if(HADORY_IMPORT_DATES.length && !HADORY_IMPORT_DATES.includes(iso)){
    showDateWarn(true,'ğŸš¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø£ÙŠ ØªØ§Ø±ÙŠØ® Ø¸Ù‡Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù‚Ø¨Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø£ÙŠ Ù…Ø®Ø§Ù„ÙØ©.');
  }else{
    showDateWarn(true,'ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ¯ÙˆÙŠÙ‹Ø§ â€” Ø§Ù„Ø¢Ù† Ø§Ø¶ØºØ· (ØªØ£ÙƒÙŠØ¯ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®) Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø«Ù… ØªØ§Ø¨Ø¹.');
  }

  applyHadoryForManualDate(iso);
});

function renderHadoryEmpty(){
  cAbsent.textContent='0'; cLate.textContent='0'; cNoOut.textContent='0';
  hadoryCases.innerHTML=`<option value="">â€” Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€”</option>`;
  hadoryMiniTable.innerHTML=`<tr><td colspan="4" class="mini" style="text-align:center;padding:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`;
  HADORY_CASES=[];
}

function applyHadoryForManualDate(iso){
  if(!iso){ renderHadoryEmpty(); return; }
  if(!HADORY_LOGS.length){ renderHadoryEmpty(); return; }

  const wsM=toMin(WORK_RANGE[SEASON].start);

  const byCivil={};
  HADORY_LOGS.forEach(r=>{
if(r.date !== iso) return;

    const prev=byCivil[r.civil];
    if(!prev){ byCivil[r.civil]=r; return; }
    const prevScore = (prev.leave?100000:0) + (prev.workMinutes||0) + (prev.attend?500:0);
    const curScore  = (r.leave?100000:0) + (r.workMinutes||0) + (r.attend?500:0);
    if(curScore>prevScore) byCivil[r.civil]=r;
  });

  HADORY_DAILY = TEACHERS.map(t=>{
    const rec=byCivil[t.civil];
    if(rec) return {...rec, spec:t.spec, level:t.level, phone:t.phone};
    return { date:iso, civil:t.civil, name:t.name, attend:'', leave:'', workMinutes:0, spec:t.spec, level:t.level, phone:t.phone, outType:'', autoOut:false };
  });

  const cases=[];
  let nAbsent=0, nLate=0, nNoOut=0;

  const addCase=(obj)=>cases.push(obj);

  HADORY_DAILY.forEach(r=>{
    const attendM = toMin(r.attend);

    const isAbsent = !r.attend && !r.leave && (!r.workMinutes);
    if(isAbsent){
      nAbsent++;
      addCase({type:'gaib', label:'ØºÙŠØ§Ø¨', order:1, civil:r.civil, name:r.name, attend:'', leave:'', badge:'red', sortA:0});
      return;
    }

    if(attendM!=null && wsM!=null && attendM>wsM){
      const lateMin = attendM-wsM;
      nLate++;
      addCase({type:'late', label:'ØªØ£Ø®Ø±', order:2, civil:r.civil, name:r.name, attend:r.attend, leave:r.leave||'', badge:'amber', sortA:lateMin});
    }

    const noOut = (r.attend && !r.leave) || (r.attend && r.leave && r.autoOut);
    if(noOut){
      nNoOut++;
      const lbl = r.autoOut ? 'Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù (Ø§Ù†ØµØ±Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ)' : 'Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù ÙÙŠ Ù…Ù†ØµØ© Ø­Ø¶ÙˆØ±ÙŠ';
      addCase({type:'noout', label:lbl, order:3, civil:r.civil, name:r.name, attend:r.attend||'', leave:r.leave||'', badge:'amber', sortA:0});
    }
  });

  cAbsent.textContent=String(nAbsent);
  cLate.textContent=String(nLate);
  cNoOut.textContent=String(nNoOut);

  cases.sort((a,b)=>{
    if(a.order!==b.order) return a.order-b.order;
    if(a.order===2){
      if((b.sortA||0)!==(a.sortA||0)) return (b.sortA||0)-(a.sortA||0);
    }
    return a.name.localeCompare(b.name,'ar');
  });

  HADORY_CASES = cases;

  hadoryCases.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€”</option>` + cases.map((c,i)=>{
    let extra='';
    if(c.type==='late') extra=` â€” ${en2ar(c.sortA)} Ø¯`;
    const txt = `${c.label}${extra} â€” ${c.name} â€” ${c.attend||'--:--'} / ${c.leave||'--:--'}`;
    return `<option value="${i}">${txt}</option>`;
  }).join('');

  if(!cases.length){
    hadoryMiniTable.innerHTML=`<tr><td colspan="4" class="mini" style="text-align:center;padding:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªÙˆØ¬Ø¨ Ø¥Ø¬Ø±Ø§Ø¡ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯.</td></tr>`;
  }else{
    hadoryMiniTable.innerHTML = cases.slice(0,22).map(c=>{
      const tagClass = c.badge==='red'?'tag red':'tag amber';
      const kindLabel =
        (c.type==='gaib')?'ØºÙŠØ§Ø¨':
        (c.type==='late')?`ØªØ£Ø®Ø± (${en2ar(c.sortA)}Ø¯)`:
        'Ù„Ù… ÙŠÙØºÙ„Ù‚ Ø§Ù„Ø¯ÙˆØ§Ù…';
      return `<tr>
        <td><span class="${tagClass}">${kindLabel}</span></td>
        <td style="text-align:right;font-weight:900">${c.name}</td>
        <td>${c.attend||'--:--'}</td>
        <td>${c.leave||'--:--'}</td>
      </tr>`;
    }).join('');
  }

  hadoryCases.onchange = ()=>{
    if(!requireDateGuard('ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ù…Ù† Ø­Ø¶ÙˆØ±ÙŠ')) return;

   if(hadoryCases.value==='') return;      // âœ… ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙØ§Ø±Øº = 0
const idx = Number(hadoryCases.value);
if(!Number.isInteger(idx) || !HADORY_CASES[idx]) return;

    const c=HADORY_CASES[idx];

    const tIdx = TEACHERS.findIndex(x=>x.civil===c.civil);
    if(tIdx>=0){
      selTeacher.value=String(tIdx);
      selTeacher.dispatchEvent(new Event('change'));
    }

    if(c.type==='gaib'){
      setChipActive('kindChips','gaib'); setPack('gaib');
    }else if(c.type==='late'){
      setChipActive('kindChips','late'); setPack('late');
      const el=document.getElementById('tLateIn');
      el.textContent=en2ar(ar2en(c.attend||'--:--'));
      el.classList.toggle('empty', !c.attend);
      recalc();
    }else{
      setChipActive('kindChips','note'); setPack('note');
      document.getElementById('noteReason').value='Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù ÙÙŠ Ù…Ù†ØµØ© Ø­Ø¶ÙˆØ±ÙŠ.';
      document.getElementById('noteReason').dispatchEvent(new Event('change'));
    }

    setHadoryStatus('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
  };

  setHadoryStatus('ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆÙÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠ â€” (Ù‚Ø¯ ØªØªÙƒØ±Ø± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ù„Ù„Ù…Ø¹Ù„Ù… Ø§Ù„ÙˆØ§Ø­Ø¯)');
}

function setChipActive(containerId, key){
  const wrap=document.getElementById(containerId);
  [...wrap.children].forEach(x=>x.classList.remove('active'));
  const btn=wrap.querySelector(`[data-k="${key}"]`);
  if(btn) btn.classList.add('active');
}

/* ÙˆØ§ØªØ³Ø§Ø¨ */
document.getElementById('btnWA').addEventListener('click', ()=>{
  if(!requireDateGuard('Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨')) return;

if(selTeacher.value==='') return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
const i = Number(selTeacher.value);
if(!Number.isInteger(i) || !TEACHERS[i]) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
  const t=TEACHERS[i]; const kind=STATE.kind;

  const kindLabel={late:'ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±',absent:'ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯',gaib:'Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨',note:'Ù„ÙØª Ù†Ø¸Ø±'}[kind];

  let details='';
  if(kind==='late'){
    details=`ØªØ£Ø®Ù‘Ø± Ø¹Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø±Ø³Ù…ÙŠØŒ ÙˆÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±: ${document.getElementById('tLateIn').textContent.trim()}Ø› Ù†Ø£Ù…Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø¨Ø¨ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„.`;
  } else if(kind==='absent'){
    details=`Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯ Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ù…Ø› Ù†Ø£Ù…Ù„ Ø¥ÙŠØ¶Ø§Ø­ Ø§Ù„Ø³Ø¨Ø¨ ÙˆØ¥Ø±ÙØ§Ù‚ Ù…Ø§ ÙŠØ¤ÙŠØ¯Ù‡.`;
  } else if(kind==='gaib'){
    details=`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ù…ÙˆØ¶Ù‘Ø­.`;
  } else if(kind==='note'){
  let extra='';
  if(NOTE_LESSON_MODE){
    const lbl = (NOTE_LESSON_MODE==='enter') ? 'ØªØ£Ø®Ø±' : 'Ø®Ø±ÙˆØ¬ Ù…Ø¨ÙƒØ±';
    extra = ` â€” Ø§Ù„Ø­ØµØ©: ${periodNo.value?en2ar(periodNo.value):'â€”'} â€” ${lbl}: ${lessonMins.textContent||'0'} Ø¯Ù‚ÙŠÙ‚Ø©`;
  }
  details=`Ù„ÙØª Ù†Ø¸Ø± Ø¨Ø³Ø¨Ø¨: ${document.getElementById('noteReasonText').textContent.trim()}${extra}`;
}

  const msg=`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…
${kindLabel}
Ø§Ù„Ø§Ø³Ù…: ${t.name}
Ø§Ù„ÙŠÙˆÙ…: ${metaDay.textContent}
Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ù€): ${metaHijri.textContent}
${details}
*Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©*`;

  window.open(`https://wa.me/${t.phone||'966500000000'}?text=${encodeURIComponent(msg)}`,'_blank');
});

/* =========================
   ÙƒØ´Ù Ø­Ø¶ÙˆØ±ÙŠ (Ø§Ù„ÙŠÙˆÙ…ÙŠ)
   ========================= */
const hadoryReportDlg=document.getElementById('hadoryReportDlg');
const tblHadoryReport=document.querySelector('#tblHadoryReport tbody');

function openHadoryReport(){
  if(!requireDateGuard('ÙØªØ­ ÙƒØ´Ù Ø­Ø¶ÙˆØ±ÙŠ')) return;

  const iso=hadoryManualDate.value||'';
  if(!iso){ alert('Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø§Ø¶ØºØ· (ØªØ·Ø¨ÙŠÙ‚) Ø£ÙˆÙ„Ø§Ù‹.'); return; }
  if(!HADORY_DAILY.length){ alert('Ø§Ø³ØªÙˆØ±Ø¯ Ù…Ù„Ù Ø­Ø¶ÙˆØ±ÙŠ Ø«Ù… Ø§Ø¶ØºØ· (ØªØ·Ø¨ÙŠÙ‚) Ù„ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ´Ù.'); return; }

  const present=[], absent=[];
  HADORY_DAILY.forEach(r=>{
    const isAbsent=!r.attend && !r.leave && (!r.workMinutes);
    if(isAbsent) absent.push(r); else present.push(r);
  });

  present.sort((a,b)=>{
    const am=toMin(a.attend)||99999;
    const bm=toMin(b.attend)||99999;
    if(am!==bm) return am-bm;
    return (a.name||'').localeCompare(b.name||'','ar');
  });
  absent.sort((a,b)=> (a.name||'').localeCompare(b.name||'','ar'));

  const rows=[...present, ...absent];
  const wsM=toMin(WORK_RANGE[SEASON].start);

  tblHadoryReport.innerHTML = rows.map((r,idx)=>{
    const isAbsent=!r.attend && !r.leave && (!r.workMinutes);

    let statusHTML = `<span class="tag green">Ø­Ø§Ø¶Ø±</span>`;

    const attendM=toMin(r.attend);
    if(attendM!=null && wsM!=null && attendM>wsM && !isAbsent){
      statusHTML = `<span class="tag amber">Ù…ØªØ£Ø®Ø±</span>`;
    }

    const noOut = (r.attend && !r.leave) || (r.attend && r.leave && r.autoOut);
    if(noOut && !isAbsent){
      statusHTML = `<span class="tag amber">Ù„Ù… ÙŠÙØºÙ„Ù‚ Ø§Ù„Ø¯ÙˆØ§Ù…</span>`;
    }

    if(isAbsent) statusHTML = `<span class="tag red">ØºØ§Ø¦Ø¨</span>`;

    return `<tr>
      <td style="font-weight:900">${en2ar(idx+1)}</td>
      <td style="font-weight:900">${r.name||'â€”'}</td>
      <td>${r.civil||'â€”'}</td>
      <td>${r.attend||'--:--'}</td>
      <td>${r.leave||'--:--'}</td>
      <td>${statusHTML}</td>
    </tr>`;
  }).join('');

  document.getElementById('repDay').textContent=metaDay.textContent;
  document.getElementById('repHijri').textContent=metaHijri.textContent;

  hadoryReportDlg.style.display='flex';
  hadoryReportDlg.setAttribute('aria-hidden','false');
}
document.getElementById('btnHadoryReport').addEventListener('click', openHadoryReport);

document.getElementById('btnCloseReport').addEventListener('click', ()=>{
  hadoryReportDlg.style.display='none';
  hadoryReportDlg.setAttribute('aria-hidden','true');
});
hadoryReportDlg.addEventListener('click',(e)=>{
  if(e.target===hadoryReportDlg){
    hadoryReportDlg.style.display='none';
    hadoryReportDlg.setAttribute('aria-hidden','true');
  }
});

/* âœ… Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø­Ø¶ÙˆØ±ÙŠ */
document.getElementById('btnReportPrint').addEventListener('click', async ()=>{
  const card=document.getElementById('reportCard');
  await ensureAllImagesEmbedded(card);
  hadoryReportDlg.setAttribute('aria-hidden','false');
  document.body.setAttribute('data-print','hadory');
  window.print();
  setTimeout(()=>document.body.removeAttribute('data-print'),300);
});

/* ØªÙ‡ÙŠØ¦Ø© */
function init(){
  buildHijriPicker();
  setPack('late');
  SEASON='winter';
  statsDlg.style.display='none';
  document.getElementById('clockDlg').style.display='none';
  closeDateGuard();
  updatePrincipalAbs();

  hadoryManualDate.value='';
  hadoryDateWarn.style.display='none';
  hadoryDateOk.style.display='none';
  setHadoryStatus('Ø¬Ø§Ù‡Ø²');

  // âœ… Ø±Ø¨Ø· Ø²Ø± "Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ø´Ù‡Ø±ÙŠ" Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·
  const btnMonthlyStats = document.getElementById('btnMonthlyStats');
  if (btnMonthlyStats) {
    btnMonthlyStats.addEventListener('click', (e) => {
      e.preventDefault();
      const url = 'https://fhz545-hub.github.io/teacher-eval-1447/2';
      const w = window.open(url, '_blank');
      if (!w) window.location.href = url;
    });
  }
}
try{ init(); }catch(err){ console.error(err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø±Ù…Ø¬ÙŠ Ù…Ù†Ø¹ ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø±. Ø§ÙØªØ­ Console Ù„Ù„ØªÙØ§ØµÙŠÙ„.'); }
</script>
</body>
</html>
