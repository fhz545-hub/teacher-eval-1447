<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>الشؤون الإدارية والمتابعة</title>
<meta name="theme-color" content="#0b7e88">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">

<!-- مكتبات -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --moe:#0b7e88; --ink:#111; --label:#064c50;
  --bg:#f7fafc; --content:190mm; --nudgeX:0mm; --scale:1;
}
*{box-sizing:border-box}
html,body{
  margin:0;background:var(--bg);color:var(--ink);
  font:13.8px/1.9 "Tajawal","Noto Sans Arabic","Noto Naskh Arabic",system-ui;
  -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
}
.sheet-wrap{display:grid;place-items:center;margin:10mm 0;padding:8px}
.sheet{
  width:210mm;min-height:297mm;background:#fff;
  transform:translateX(var(--nudgeX)) scale(var(--scale));
  transform-origin: top center;
  filter: contrast(1.06);
}

/* الهيدر */
.header{padding:9mm 12mm 6mm;border-bottom:2px solid #eaf1f1}
.header .row{display:flex;justify-content:space-between;align-items:center;gap:10mm}
.header .row>div{width:50%}
.org{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  text-align:center;color:var(--label);transform:translateX(12mm)
}
.org .l1{font-weight:900;font-size:16px}
.org .l2{font-weight:900}
.org .l3{font-weight:800}
.meta{text-align:left}
.meta-item{display:block;white-space:nowrap;margin:0 0 2px}
.meta-item .label{font-weight:900;color:var(--label);margin-left:4px}
.meta-item .value{font-weight:900}
.case-total{margin-top:4px;font-size:10.8px;color:#2f4f4b}

/* شريط الأدوات */
.toolbar{position:sticky;top:0;z-index:10;display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:10px 12px;background:#fff;border-bottom:1px solid #eee}
.toolbar button{border:0;border-radius:10px;padding:9px 12px;cursor:pointer;background:var(--moe);color:#fff;font-weight:800}
.toolbar .secondary{background:#eef7f7;color:#0b5e63;border:1px solid #d7ecec}
.toolbar input[type=file]{display:none}
.toolbar .hint{font-size:12px;color:#6b7280}
.select,.search,.t{padding:8px 10px;border:1px solid #d7ecec;border-radius:10px;background:#fff}
.toolbar-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;width:100%}
.controls-row{width:100%;display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:8px;padding-top:6px;border-top:1px dashed #e5efef}
.controls-row .block{display:flex;align-items:center;gap:6px}
.controls-row .pack{display:flex;align-items:center;gap:4px}

/* الصفحة الداخلية */
.page{padding:6mm 0 10mm;display:grid;place-items:center}
.content{width:var(--content);margin:0 auto}

/* عنوان */
.notice-center{width:var(--content);margin:5mm auto 2mm;display:flex;flex-direction:column;align-items:center;gap:6px}
.notice-center .title{font-weight:900;font-size:28px;line-height:1.1;color:#0b5e63;filter:contrast(120%)}
.seg{display:inline-flex;background:#eef7f7;border:1px solid #d7ecec;border-radius:999px;overflow:hidden}
.seg input{display:none}
.seg label{padding:10px 16px;cursor:pointer;font-weight:800;color:#0b5e63;user-select:none}
.seg input:checked+label{background:#0b7e88;color:#fff}

/* جدول بيانات المعلم */
.table-wrap{width:var(--content);margin:4mm auto 0;display:flex;justify-content:center;overflow-x:auto}
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl thead th{
  background:#0b5e63;color:#fff;border:1.2px solid #244a4a;
  padding:6px 7px;text-align:center;font-weight:900;font-size:13px
}
.tbl td{
  border:1.2px solid #3f5b57;padding:5px 7px;vertical-align:middle;
  height:12mm;font-size:13.2px;line-height:1.55;background:#fff;text-align:center
}
.tbl thead th.name,.tbl td.name{width:38%}
.tbl thead th.spec,.tbl td.spec{width:14%}
.tbl thead th.level,.tbl td.level{width:16%}
.tbl thead th.job,.tbl td.job{width:16%}
.tbl thead th.work,.tbl td.work{width:16%}
.tbl td span[contenteditable]{display:block;outline:none;overflow-wrap:anywhere;word-break:break-word;font-weight:700}
.tbl td.name span[contenteditable]{font-size:15.5px;font-weight:900}

/* السجل المدني — خارج الجدول أسفل الاسم */
.below-flex{width:var(--content);margin:2mm auto 0;display:flex;flex-direction:row-reverse;justify-content:flex-end}
.civil-badge{
  width:38%;display:flex;align-items:center;gap:10px;justify-content:center;
  border:1.5px solid var(--moe);background:#fff;color:#0b3340;border-radius:12px;min-height:9.5mm;padding:3px 6px
}
.civil-badge .labTag{background:var(--moe);color:#fff;font-weight:900;padding:2px 10px;border-radius:8px;white-space:nowrap}
.civil-badge .civilValue{background:#fff;padding:0 6px;border-radius:6px;min-width:42mm;display:inline-block;text-align:center;font-weight:900}

/* أقسام التنبيه */
.sec{width:var(--content);margin:6mm auto;padding:0}
.sec h3{margin:0 0 8px;color:#0b5e63}
.sec h3 .kind{color:#0b7e88}
.rule-row{display:flex;align-items:center;gap:8px;margin-top:4px}
.rule-row .label{font-weight:900;white-space:nowrap}
.rule-row .dots{flex:1;border-bottom:1px dotted #9fb7b3;height:0}
.rule-row .leftnote{white-space:nowrap}
.dotfield{display:inline-block;min-width:28mm;border-bottom:1px dotted #9fb7b3;text-align:center;padding:0 2mm}
.checks{margin:6px 0 8px}
.checkline{display:flex;align-items:flex-start;gap:8px;margin:6px 0}
.checkline input{margin-top:4px;transform:scale(1.15)}
.checkline .text{flex:1}
.calc{font-weight:900;color:#0b5e63}
.timebox{display:inline-block;min-width:28mm;text-align:center;padding:.5mm 3mm;background:#fff;color:#111;font-weight:900;border-radius:6px;border:1px solid #000;font-family:ui-monospace,Consolas,monospace}
.timebox.empty{color:#777;border-color:#bbb}

/* حزمة مساءلة الغياب */
.abs-pack{width:var(--content);margin:6mm auto}
.abs-pack h3{margin:0 0 8px;color:#0b5e63}
.abs-pack .para{margin:0 0 6px}
.abs-pack .lines{min-height:28mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe}
.abs-pack .lines div{height:10mm;border-bottom:1px dotted #9fb7b3}
.abs-pack .lines div:last-child{border-bottom:0}
.abs-pack .choices label{display:block;margin:6px 0}
.abs-pack .note{color:#374151;font-size:11.2px;line-height:1.85;margin-top:6mm}

/* لفت النظر — قائمة السبب بدون إطار */
.reason-wrap{display:inline-block;border-bottom:1px dotted #9fb7b3;padding:0 2mm}
.reason-wrap select{
  border:none;outline:none;background:transparent;appearance:none;-webkit-appearance:none;-moz-appearance:none;
  font:inherit;color:inherit;padding:0;margin:0;cursor:pointer
}
.reason-wrap select:focus{outline:none}
#noteReasonText{font-weight:900}

/* ملاحظة (لا تُطبع) */
.rights{width:var(--content);margin:2mm auto 8mm;text-align:center;font-size:9.2px;color:#6b7280;font-weight:700}
@media print{ .rights{display:none !important} }
body.exporting .rights{display:none !important}
body.exporting .seg{display:none !important}

/* طباعة */
@media print{
  @page{size:A4;margin:9mm}
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  body{background:#fff;color:#000}
  .toolbar{display:none !important}
  .sheet-wrap{margin:0}
  .sheet{margin:0;transform:translateX(var(--nudgeX)) scale(1) !important;filter:none !important}
  .page{padding:0;display:block}
  :root{--content:190mm}
  .content,.notice-center,.table-wrap,.below-flex,.sec,.abs-pack{width:var(--content) !important;margin:0 auto !important}
  .tbl td,.tbl th{border-color:#000 !important}
}

/* نافذة الاستيراد — تم جعلها طبقة Overlay */
#importDialog{display:none;position:fixed;inset:0;z-index:400;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:12px}
#importCard{background:#fff;border-radius:14px;min-width:320px;max-width:900px;width:90%;padding:16px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.25)}
#previewTable th,#previewTable td{border:1px solid #e5efef;padding:6px 8px;text-align:center}
#previewTable{border-collapse:collapse;width:100%}

/* نافذة الإحصائيات */
#statsDialog{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:300;align-items:center;justify-content:center;padding:12px}
#statsCard{background:#fff;border-radius:14px;min-width:320px;max-width:1100px;width:96%;padding:14px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.25)}
#statsCard h3{margin:0 0 8px;color:#0b5e63}
.stats-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
.stats-actions button{border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
.stats-actions .primary{background:var(--moe);color:#fff}
.stats-actions .ghost{background:#eef7f7;color:#0b5e63;border:1px solid #d7ecec}
.stats-grid{display:grid;grid-template-columns:1fr;gap:10px}
.stats-table{width:100%;border-collapse:collapse}
.stats-table th{background:#0b5e63;color:#fff;border:1px solid #2e4a4a;padding:6px 7px}
.stats-table td{border:1px solid #3f5b57;padding:5px 7px;background:#fff;text-align:center}
@media (min-width:900px){ .stats-grid{grid-template-columns: 1fr 1fr;}}
</style>
</head>
<body>

<!-- الأدوات -->
<div class="toolbar">
  <div class="toolbar-row">
    <button id="btnMakePDF" class="secondary">📄 إنشاء PDF</button>
    <button id="btnWA" class="secondary">📲 واتساب</button>
    <button id="btnOpenStats" class="secondary" title="إحصائيات وأرشيف">📊 إحصائيات</button>
    <button id="btnClearImport" class="secondary" title="مسح الأسماء/البيانات">🧹 تصفير الاستيراد</button>

    <div class="drop" id="dropZone" style="display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px dashed #d7ecec;border-radius:10px;cursor:pointer">
      <button id="btnImport" class="secondary">⬆️ استيراد ملفات</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.ods,.csv,.tsv,.txt,.json">
      <span class="hint">أفلت الملف هنا أو اضغط للاستيراد</span>
    </div>

    <span class="hint">ابحث واختر معلماً:</span>
    <input id="teacherSearch" class="search" placeholder="ابحث بالاسم…">
    <select id="teacherSelect" class="select" style="min-width:220px">
      <option value="">— اختر معلماً —</option>
    </select>
  </div>

  <div class="controls-row">
    <div class="block">
      <span class="hint">تاريخ الواقعة (هجري):</span>
      <div class="pack">
        <select id="hjDay" class="select"></select>
        <select id="hjMonth" class="select"></select>
        <select id="hjYear" class="select"></select>
      </div>
    </div>
    <div class="block"><span class="hint">بداية الدوام:</span><input id="workStart" class="t" type="time" value="06:45" step="60"></div>
    <div class="block"><span class="hint">نهاية الدوام:</span><input id="workEnd" class="t" type="time" value="13:45" step="60"></div>
  </div>
</div>

<div class="sheet-wrap">
  <div class="sheet" id="sheet">
    <!-- الهيدر -->
    <div class="header">
      <div class="row">
        <div class="org">
          <div class="l1">المملكة العربية السعودية</div>
          <div class="l2">وزارة التعليم</div>
          <div class="l3">الإدارة العامة للتعليم بالمنطقة الشرقية</div>
          <div class="l3" id="schoolNameHdr">مدرسة اليعقوبي الثانوية</div>
        </div>
        <div class="meta">
          <div class="meta-item"><span class="label">الرقم:</span><span class="value" id="serialNo">01</span></div>
          <div class="meta-item"><span class="label">التاريخ:</span><span class="value" id="hdrHijri">١٤٤٧/٠٤/١٣ هـ</span></div>
          <div class="case-total">إجمالي مساءلات المعلم: <strong id="caseTotal">0</strong></div>
        </div>
      </div>
    </div>

    <div class="page">
      <div class="content">

        <!-- عنوان واختيار النوع -->
        <div class="notice-center">
          <div class="title" id="mainTitle">تنبيه</div>
          <div class="seg" id="noticeSeg">
            <input type="radio" name="nt" id="nt-note"  value="note"><label for="nt-note">لفت نظر</label>
            <input type="radio" name="nt" id="nt-gaib"  value="gaib"><label for="nt-gaib">غياب</label>
            <input type="radio" name="nt" id="nt-late"  value="late" checked><label for="nt-late">تأخر</label>
            <input type="radio" name="nt" id="nt-abs"   value="absent"><label for="nt-abs">عدم تواجد</label>
            <input type="radio" name="nt" id="nt-early" value="early"><label for="nt-early">انصراف مبكر</label>
          </div>
        </div>

        <!-- جدول بيانات المعلم -->
        <div class="table-wrap">
          <table class="tbl" aria-label="بيانات الموظف">
            <thead>
              <tr>
                <th class="name">الاسم</th>
                <th class="spec">التخصص</th>
                <th class="level">المرتبة</th>
                <th class="job">رقم الوظيفة</th>
                <th class="work">العمل الحالي</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="name"><span id="t_name"  contenteditable="true"></span></td>
                <td class="spec"><span id="t_spec"  contenteditable="true"></span></td>
                <td class="level"><span id="t_level" contenteditable="true"></span></td>
                <td class="job"><span  id="t_job"   contenteditable="true"></span></td>
                <td class="work"><span id="t_work"  contenteditable="true"></span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- السجل المدني أسفل الاسم خارج الجدول -->
        <div class="below-flex">
          <div class="civil-badge">
            <span class="labTag">السجل المدني</span>
            <span id="t_civil" class="civilValue" contenteditable="true"></span>
          </div>
        </div>

        <!-- (أ) حزمة التنبيه -->
        <div id="alertPack">
          <div class="sec">
            <h3>( 1 ) خطاب التنبيه — <span class="kind" id="kindTitle">تأخر</span></h3>

            <div class="rule-row">
              <span class="label">الأستاذ الفاضل :</span>
              <span class="dots"></span>
              <span class="leftnote">حفظه الله</span>
            </div>

            <p style="margin:6px 0 2px"><strong>السلام عليكم ورحمة الله وبركاته</strong></p>
            <p style="margin:0 0 6px">وبعد :</p>

            <p style="margin:0 0 6px">
              إنه في يوم
              <span class="dotfield" id="dayField"><span id="dynDay">—</span></span>
              الموافق
              <span class="dotfield" id="hijriField"><span id="dynHijri">—</span> هـ</span>
              :
            </p>

            <div class="checks">
              <label id="lineLate" class="checkline">
                <input type="checkbox" checked>
                <span class="text">
                  تأخركم من بداية العمل، وحضوركم الساعة ( <span id="tLateIn" class="timebox empty">--:--</span> ).
                  <span class="calc">— إجمالي التأخر: <span id="lateTotal">0 دقيقة</span></span>
                </span>
              </label>

              <label id="lineAbs" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  عدم تواجدكم أثناء العمل من الساعة : ( <span id="tAbsFrom" class="timebox empty">--:--</span> )
                  إلى الساعة : ( <span id="tAbsTo" class="timebox empty">--:--</span> ).
                  <span class="calc">— مدة عدم التواجد: <span id="absTotal">0 دقيقة</span></span>
                </span>
              </label>

              <label id="lineEarly" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  انصرافكم مبكرًا قبل نهاية العمل من الساعة : ( <span id="tEarlyFrom" class="timebox empty">--:--</span> ).
                  <span class="calc">— مدة الانصراف المبكر: <span id="earlyTotal">0 دقيقة</span></span>
                </span>
              </label>
            </div>

            <p>عليه نأمل توضيح أسباب ذلك مع إرفاق ما يؤيد عذركم … ولكم تحياتي.</p>

            <p style="margin-top:8px">
              <strong>مدير المدرسة :</strong>
              <span id="managerName1" class="dotfield" style="min-width:45mm">فهد حامد علي الزهراني</span>
              &nbsp;&nbsp; <strong>التوقيع :</strong> <span class="dotfield" style="min-width:30mm"></span>
              &nbsp;&nbsp; <strong>التاريخ :</strong> <span class="dotfield" style="min-width:22mm"></span> هـ
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) الإفادة</h3>
            <p><strong>مدير المدرسة :</strong> <span id="managerName2">فهد حامد علي الزهراني</span></p>
            <p><strong>الأستاذ الفاضل / مدير المدرسة.</strong></p>
            <p>السلام عليكم ورحمة الله وبركاته وبعد :</p>
            <div style="min-height:38mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe">
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;"></div>
            </div>
            <p><span>الاسم :</span> <strong id="afadaName">—</strong>
               &nbsp;&nbsp;&nbsp; <span>التوقيع :</span> ____________________
               &nbsp;&nbsp;&nbsp; <span>التاريخ :</span> ____________________ هـ</p>
          </div>

          <div class="sec">
            <h3>( 3 ) رأي مدير المدرسة</h3>
            <p><label><input type="radio" name="opinion"> عذره مقبول</label>
               &nbsp;&nbsp;<label><input type="radio" name="opinion"> عذره غير مقبول ويُحسم عليه</label></p>
            <p><strong>مدير المدرسة :</strong> <span id="managerName3">فهد حامد علي الزهراني</span></p>
            <p><span>التوقيع :</span> ____________________ &nbsp;&nbsp; <span>التاريخ :</span> ____________________ هـ</p>
          </div>
        </div>

        <!-- (ب) حزمة مساءلة غياب -->
        <div id="absencePack" class="abs-pack" style="display:none">
          <div class="sec" style="margin-top:0">
            <p class="para" id="absIntro">
              إنه في يوم <strong><span id="absDayP">—</span></strong>
              الموافق <strong><span id="absDateYMD">—</span></strong>
              تغيبت عن العمل.
            </p>
            <h3>( 1 ) طلب الإفادة</h3>
            <p class="para"><strong>الأستاذ الفاضل /</strong> <span id="abs-name-top">—</span> <span>حفظه الله</span></p>
            <p class="para"><strong>السلام عليكم ورحمة الله وبركاته</strong> وبعد ،،،</p>
            <p class="para">
              من خلال متابعة سجل الدوام تبين غيابكم خلال الفترة الموضحة بعالية، آمل الإفادة عن سبب ذلك
              وعليكم تقديم ما يؤيد عذركم خلال أسبوع فقط من تاريخه، علماً بأنه في حالة عدم الإلتزام سيتم اتخاذ اللازم حسب التعليمات.
            </p>
            <p class="para">
              <strong>اسم الرئيس المباشر :</strong> <span id="managerName4">فهد بن حامد علي الزهراني</span>
              &nbsp;&nbsp;&nbsp; <strong>التوقيع :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______ هـ
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) الإفادة</h3>
            <p class="para"><strong>الأستاذ الفاضل / مدير المدرسة</strong> حفظه الله</p>
            <p class="para"><strong>السلام عليكم ورحمة الله وبركاته</strong> وبعد:</p>
            <p class="para">أفيدكم أن غيابي كان للأسباب التالية:</p>
            <div class="lines"><div></div><div></div><div></div></div>
            <p class="para">وسأقوم بتقديم ما يثبت ذلك خلال أسبوع من تاريخه.</p>
            <p class="para">
              <strong>اسم المعلم :</strong> <span id="abs-teacher-name">—</span>
              &nbsp;&nbsp;&nbsp; <strong>التوقيع :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______ هـ
            </p>
          </div>

          <div class="sec">
            <h3>( 3 ) مدير المدرسة</h3>
            <div class="choices">
              <label><input type="checkbox"> تُحتسب له إجازة مرضية بعد التأكد من نظامية التقرير.</label>
              <label><input type="checkbox"> يُحتسب غيابه من رصيده للإجازات الإضطرارية لقبول عذره إذا كان رصيده يسمح ولا يُحسم عليه.</label>
              <label><input type="checkbox"> يعتمد الحسم لعدم قبول عذره.</label>
            </div>
            <p class="para">
              <strong>اسم الرئيس المباشر :</strong> <span id="managerName5">فهد بن حامد علي الزهراني</span>
              &nbsp;&nbsp;&nbsp; <strong>التوقيع :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______ هـ
            </p>
          </div>

          <div class="note">
            <strong>ملاحظات هامة</strong><br>
            1- تُستكمل الاستمارة وتُسلم لشؤون الموظفين لاستكمال ما يجب حيالها.<br>
            2- إذا سبق العطل الرسمية غياب ولحقها غياب تُحتسب مدة الغياب كاملة بما فيها العطل الرسمية.<br>
            3- يجب أن يوضح المتغيب أسباب غيابه فور تسلمه الاستمارة ويعيدها لرئيسه.<br>
            4- يُعطى المتغيب مدة أسبوع لتقديم ما يؤيد عذره فإذا انقضت المدة الزمنية تُستكمل الاستمارة ويتم الحسم.
          </div>
        </div>

        <!-- (ج) نموذج لفت النظر -->
        <div id="notePack" class="sec" style="display:none">
          <h3>نموذج لفت النظر</h3>

          <p style="margin:0 0 4px">
            <span><strong>الأستاذ الفاضل/</strong></span>
            <span id="noteTeacherName" contenteditable="true" style="font-weight:900"></span>
            <span>حفظه الله</span>
          </p>
          <p style="margin:0 0 6px"><strong>السلام عليكم ورحمة الله وبركاته، وبعد ،،،</strong></p>

          <!-- الفقرة الرئيسة باستدعاء السبب من القائمة -->
          <p id="noteParagraph" style="margin:0 0 8px">
            إشارةً إلى التعليمات والأنظمة المعتمدة؛ لوحِظ 
            <span id="noteReasonText" style="font-weight:900">المهمة المحددة</span>
            وفق الجدول والتعليمات المنظمة. ونأمل منكم المبادرة بمعالجة ذلك، والالتزام التام دعمًا للانضباط المهني ورفعًا لجودة الأداء.
          </p>

          <!-- القائمة المنسدلة (بدون إطار، أسفلها خط منقط) -->
          <div class="reason-wrap" title="اختر سبب لفت النظر">
            <select id="noteReasonSelect">
              <option value="">— اختر السبب —</option>
              <option>عدم المشاركة في الإشراف الصباحي المكلّف به وفق جدول المناوبة المعتمد، مما أثّر على انتظام سير الطابور الصباحي وانضباط الطلاب.</option>
              <option>عدم أداء مهام المناوبة في نهاية الدوام المدرسي، وما يترتب عليه من ضعف في تنظيم خروج الطلاب وضمان سلامتهم.</option>
              <option>التقصير في الإشراف أثناء فترة الفسحة، مما نتج عنه غياب المتابعة السلوكية اللازمة للطلاب داخل الساحة المدرسية.</option>
              <option>عدم الإشراف على أداء صلاة الظهر في المصلى المدرسي رغم إدراجه ضمن المهام الموكلة.</option>
              <option>عدم الالتزام بإعداد الدروس أو التحضير الإلكتروني في منصة مدرستي وفق المتطلبات التربوية المعتمدة.</option>
              <option>الخروج من الحصة الدراسية قبل انتهاء وقتها المحدد دون مبرر نظامي، مما يؤثر على انضباط العملية التعليمية.</option>
              <option>التأخر في دخول الحصة الدراسية عن الوقت المحدد في الجدول الزمني، مما يخلُّ بانضباط الجدول اليومي للمدرسة.</option>
              <option>عدم الحضور للطابور الصباحي دون عذر رسمي، وهو ما يُعد تقصيرًا في أداء الواجبات اليومية المناطة بالمعلم.</option>
              <option>عدم حضور مجلس أولياء الأمور بالرغم من توجيه الدعوة الرسمية، مما فوّت فرصة التواصل الفعّال مع أولياء الأمور ودعم الشراكة المدرسية.</option>
              <option>التغيب عن اجتماع المدرسة الرسمي دون عذر نظامي، وهو ما يُعد مخالفة للأنظمة والتعليمات الإدارية.</option>
              <option>عدم الرد على المساءلة الإدارية الموجهة في الوقت المحدد، مما يدل على عدم تجاوب مع الإجراءات النظامية.</option>
              <option>رفض التوقيع على النماذج أو المحاضر الرسمية الصادرة من إدارة المدرسة، وهو ما يخالف مقتضى التعاون الإداري والمهني.</option>
              <option>رفض تنفيذ التوجيه الإداري أو التربوي الصادر من قائد المدرسة أو المشرف التربوي دون مبرر نظامي.</option>
              <option>عدم رفع بيانات الغياب على منصة (فارس) في الوقت المحدد وفق التعليمات المنظمة.</option>

              <!-- إضافات بصياغة رسمية تربوية (الانتظار) -->
              <option>عدم دخولكم حصة الانتظار المكلَّف بها وفق الجدول المعتمد والتعليمات المنظمة، وما ترتّب على ذلك من إخلال بانضباط سير اليوم الدراسي ومتابعة الطلاب.</option>
              <option>تأخُّركم عن مباشرة حصة الانتظار المكلَّف بها في وقتها المحدد وفق الجدول المعتمد، بما يؤثّر في انضباط الحصص وتسلسلها واستمرارية التعلّم.</option>
            </select>
          </div>

          <!-- ختام -->
          <p style="margin:10px 0 8px">
           حرصًا على الانضباط المهني ورفع كفاءة الممارسة داخل المدرسة، نأمل تلافي ما ورد مستقبلاً، والالتزام التام بالتعليمات والمهام الوظيفية المعتمدة؛ دعمًا لجودة الأداء وتحقيقًا لمصلحة العمل المدرسي.
           تبليغ لا يشترط الإفادة.
            وتقبّلوا خالص التحية والتقدير،،
          </p>

          <!-- التوقيعات -->
          <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
            <div style="flex:1">
              <p style="margin:0 0 4px"><strong>توقيع الموظف بالاطلاع:</strong> ...............................</p>
              <p style="margin:0 0 4px"><strong>الاسم:</strong> ...............................</p>
              <p style="margin:0"><strong>التاريخ:</strong> ______ / ______ / 14هـ</p>
            </div>
            <div style="flex:1">
              <p style="margin:0 0 4px"><strong>توقيع قائد المدرسة:</strong> <span id="managerNameNote">فهد حامد علي الزهراني</span></p>
            </div>
          </div>
        </div>

        <div class="rights">مبادرة اليعقوبي — تطوير: فهد حامد الزهراني</div>

      </div>
    </div>
  </div>
</div>

<!-- حوار الاستيراد -->
<div id="importDialog" role="dialog" aria-modal="true">
  <div id="importCard">
    <h3 style="margin-top:0;color:#0b5e63">استيراد بيانات المعلمين</h3>
    <div class="map-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0">
      <label>ورقة العمل (Sheet)</label><select id="sheetSelect"></select>
      <label>عمود الاسم</label><select id="mapName"></select>
      <label>عمود السجل المدني / الهوية</label><select id="mapCivil"></select>
      <label>عمود التخصص</label><select id="mapSpec"></select>
      <label>عمود المرتبة / المستوى</label><select id="mapLevel"></select>
      <label>عمود رقم الوظيفة</label><select id="mapJob"></select>
      <label>عمود العمل الحالي</label><select id="mapWork"></select>
      <label>عمود المدرسة (اختياري)</label><select id="mapSchool"></select>
      <label>عمود الجوال / واتساب</label><select id="mapPhone"></select>
    </div>
    <div class="preview" style="max-height:260px;overflow:auto;border:1px solid #e5efef;border-radius:10px;margin-top:8px">
      <table id="previewTable"></table>
    </div>
    <div class="dlg-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn-ghost" id="btnCancelImport" style="border:1px solid #d7ecec;background:#eef7f7;color:#0b5e63;border-radius:10px;padding:9px 12px;font-weight:800">إلغاء</button>
      <button class="btn-primary" id="btnConfirmImport" style="background:#0b7e88;color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800">اعتماد الاستيراد</button>
    </div>
  </div>
</div>

<!-- نافذة الإحصائيات -->
<div id="statsDialog" role="dialog" aria-modal="true">
  <div id="statsCard">
    <h3>إحصائيات وإرشيف المساءلات والتنبيهات</h3>
    <div class="stats-actions">
      <button id="btnExportArchive" class="ghost">💾 نسخ احتياطي</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        ⤴️ استعادة
        <input id="restoreInput" type="file" accept=".json" style="display:none">
      </label>
      <button id="btnResetAll" class="ghost">↺ تصفير المساءلات</button>
      <span class="hint">يمكن تصفية الأرشيف باسم المعلم:</span>
      <input id="statsFilter" class="search" placeholder="اكتب اسم معلم…">
      <button id="btnCloseStats" class="primary">إغلاق</button>
    </div>

    <div class="stats-grid">
      <div>
        <h3 style="margin-top:0">الأرشيف (تفصيلي)</h3>
        <table class="stats-table" id="tblArchive">
          <thead><tr>
            <th>التاريخ (هجري)</th>
            <th>اسم المعلم</th>
            <th>السجل المدني</th>
            <th>نوع الإجراء</th>
            <th>رقم الإجراء</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h3 style="margin-top:0">ملخص حسب المعلم</h3>
        <table class="stats-table" id="tblSummary">
          <thead><tr>
            <th>المعلم</th>
            <th>السجل المدني</th>
            <th>مساءلة غياب</th>
            <th>تنبيه تأخر</th>
            <th>تنبيه عدم تواجد</th>
            <th>تنبيه انصراف مبكر</th>
            <th>لفت نظر</th>
            <th>الإجمالي</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- لوحة المؤقّت -->
<div id="timePad" style="display:none;position:fixed;background:#fff;border:1px solid #e6eeee;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.25);padding:10px;z-index:200">
  <div class="display" id="timePadDisplay" style="font:700 18px ui-monospace,Consolas,monospace;text-align:center;margin-bottom:6px">--:--</div>
  <div class="grid" style="display:grid;grid-template-columns:repeat(3,44px);gap:6px;justify-content:center">
    <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
    <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
    <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
    <button data-k=":">:</button><button data-k="0">0</button><button class="del">⌫</button>
  </div>
  <div class="row" style="display:flex;gap:8px;justify-content:center;margin-top:8px">
    <button class="action" id="timePadSave">حفظ</button><button id="timePadClose">إغلاق</button>
  </div>
</div>

<script>
/* ===== هوية وتوافق ===== */
const BASE_TITLE='الشؤون الإدارية والمتابعة';
const DEFAULT_WA='966504532489';
const AR='٠١٢٣٤٥٦٧٨٩', EN='0123456789';
const en2ar = s => (s+'').replace(/[0-9]/g,d=>AR[d]);
const ar2en = s => (s+'').replace(/[٠-٩]/g,d=>EN[AR.indexOf(d)]);

/* ===== تناسب تلقائي لكل الأجهزة ===== */
function fitSheet(){
  const sheet=document.getElementById('sheet');
  if(!sheet) return;
  const avail = Math.max(320, window.innerWidth - 16);
  const scale = Math.min(1, avail / sheet.offsetWidth);
  document.documentElement.style.setProperty('--scale', String(scale));
}
addEventListener('resize', fitSheet);
addEventListener('orientationchange', fitSheet);
document.addEventListener('DOMContentLoaded', fitSheet);

/* ===== تاريخ هجري (أم القرى) ===== */
function fmtHijriNoSuffix(d){
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  const DD=en2ar(parts.find(p=>p.type==='day').value.padStart(2,'0'));
  const MM=en2ar(parts.find(p=>p.type==='month').value.padStart(2,'0'));
  const YY=en2ar(parts.find(p=>p.type==='year').value);
  return `${DD}/${MM}/${YY}`;
}
function fmtHijriYMDNoSuffix(d){
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  const DD=en2ar(parts.find(p=>p.type==='day').value.padStart(2,'0'));
  const MM=en2ar(parts.find(p=>p.type==='month').value.padStart(2,'0'));
  const YY=en2ar(parts.find(p=>p.type==='year').value);
  return `${YY}/${MM}/${DD}`;
}
const wdHijri = d => new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(d);

function hijriToGregorian(y,m,d){
  const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'});
  const parts = dt => { const p=fmt.formatToParts(dt); let yy,mm,dd;
    p.forEach(q=>{ if(q.type==='year') yy=parseInt(ar2en(q.value),10);
                   if(q.type==='month') mm=parseInt(ar2en(q.value),10);
                   if(q.type==='day') dd=parseInt(ar2en(q.value),10); });
    return {yy,mm,dd}; };
  let t=new Date(1937,0,1);
  for(let i=0;i<60000;i++){
    const a=parts(t);
    if(a.yy===y && a.mm===m && a.dd===d) return new Date(t.getFullYear(),t.getMonth(),t.getDate());
    t.setDate(t.getDate()+1);
  }
  return null;
}

(function buildHijriPicker(){
  const dSel=document.getElementById('hjDay'), mSel=document.getElementById('hjMonth'), ySel=document.getElementById('hjYear');
  for(let d=1; d<=30; d++) dSel.add(new Option(en2ar(String(d).padStart(2,'0')), d));
  for(let m=1; m<=12; m++) mSel.add(new Option(en2ar(String(m).padStart(2,'0')), m));
  const now=new Date();
  const curAH=parseInt(ar2en(new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric'}).format(now)),10);
  for(let y=curAH-10; y<=curAH+10; y++) ySel.add(new Option(en2ar(y), y));
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
  dSel.value=parseInt(ar2en(parts.find(p=>p.type==='day').value),10);
  mSel.value=parseInt(ar2en(parts.find(p=>p.type==='month').value),10);
  ySel.value=parseInt(ar2en(parts.find(p=>p.type==='year').value),10);
  function update(){
    const y=+ySel.value,m=+mSel.value,d=+dSel.value;
    const g=hijriToGregorian(y,m,d); if(!g){ alert('تعذّر تحويل التاريخ الهجري'); return; }
    const hijYMD=fmtHijriYMDNoSuffix(g);
    document.getElementById('hdrHijri').textContent = `${hijYMD} هـ`;
    const hijNo=fmtHijriNoSuffix(g);
    const dayName = wdHijri(g);
    document.getElementById('dynDay').textContent = dayName;
    document.getElementById('dynHijri').textContent = hijNo;
    document.getElementById('absDayP').textContent  = dayName;
    document.getElementById('absDateYMD').textContent = hijYMD;
  }
  dSel.onchange=mSel.onchange=ySel.onchange=update; update();
})();

/* ===== بيانات المعلمين (cache) ===== */
let TEACHERS=JSON.parse(localStorage.getItem('teachersCache')||'[]');
let currentIdx = null;
function pad2(n){return String(n).padStart(2,'0');}

/* اسم المدير — يسمح بتعديل الآلية (cache) */
const MANAGER_KEY='managerName';
function getManagerName(){
  return localStorage.getItem(MANAGER_KEY) || 'فهد حامد علي الزهراني';
}
function setManagerName(v){
  if(!v) return; localStorage.setItem(MANAGER_KEY, v);
  ['managerName1','managerName2','managerName3','managerName4','managerName5','managerNameNote'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent=v;
  });
}

/* ===== أرشيف الإجراءات (دائم + نسخ احتياطي) ===== */
const ARCHIVE_KEY='caseArchive_v1';
let ARCHIVE = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');

function teacherKeyFromObj(obj){
  const civil=(obj.civil||'').trim();
  const name=(obj.name||'').trim();
  return civil? ('id:'+civil) : ('name:'+name);
}
function getCurrentTeacher(){ if(currentIdx==null) return null; return TEACHERS[currentIdx] || null; }
function computeCountsFor(key){
  let total=0, byType={gaib:0, late:0, absent:0, early:0, note:0};
  for(const e of ARCHIVE){ if(e.tkey===key){ total++; if(byType[e.kind]!=null) byType[e.kind]++; } }
  return {total, byType};
}
function nextSerialFor(key){ return computeCountsFor(key).total + 1; }
function refreshHeaderCounts(){
  const t=getCurrentTeacher(); 
  if(!t){ document.getElementById('serialNo').textContent='01'; document.getElementById('caseTotal').textContent='0'; return; }
  const key=teacherKeyFromObj(t);
  document.getElementById('serialNo').textContent = pad2(nextSerialFor(key));
  document.getElementById('caseTotal').textContent = computeCountsFor(key).total;
}
function saveArchive(){ localStorage.setItem(ARCHIVE_KEY, JSON.stringify(ARCHIVE)); refreshHeaderCounts(); }

/* تسجيل إجراء جديد في الأرشيف */
function recordCase(kind, source){
  const t=getCurrentTeacher();
  if(!t){ alert('يرجى اختيار معلّم أولاً.'); return; }
  const key=teacherKeyFromObj(t);
  const serial = nextSerialFor(key);
  const hj=document.getElementById('hdrHijri').textContent.replace('هـ','').trim();
  const day=document.getElementById('dynDay').textContent.trim();
  ARCHIVE.push({
    ts: Date.now(), hj, day, kind, serial, source: source || 'manual',
    tkey: key, name: (t.name||'').trim(), civil: (t.civil||'').trim()
  });
  saveArchive();
}

/* ربط الرقم والإجمالي بالمعلم الحالي */
function refreshCaseNo(){ refreshHeaderCounts(); }

/* تطبيق المعلم المختار */
function applyTeacher(t, idx){
  currentIdx = idx;
  document.getElementById('schoolNameHdr').textContent = t.school || 'مدرسة اليعقوبي الثانوية';
  const set=(id,v)=>document.getElementById(id).textContent=v||'';
  set('t_name',t.name); set('t_spec',t.spec); set('t_level',t.level||t.rank); set('t_job',t.job); set('t_work',t.work);
  document.getElementById('t_civil').textContent = t.civil || '';
  document.getElementById('afadaName').textContent = t.name || '—';
  document.getElementById('abs-name-top').textContent = t.name || '—';
  document.getElementById('abs-teacher-name').textContent = t.name || '—';
  /* لفت نظر — الاسم */
  document.getElementById('noteTeacherName').textContent = t.name || '';
  refreshCaseNo();
}
function refillSelect(){
  const sel=document.getElementById('teacherSelect');
  sel.innerHTML='<option value="">— اختر معلماً —</option>';
  TEACHERS.forEach((t,i)=> sel.add(new Option(t.name? t.name : `بدون اسم ${i+1}`, i)));
}
refillSelect();
document.getElementById('teacherSelect').addEventListener('change',e=>{
  const i=+e.target.value; if(Number.isInteger(i)&&TEACHERS[i]) applyTeacher(TEACHERS[i], i);
});
document.getElementById('teacherSearch').addEventListener('input',e=>{
  const q=e.target.value.trim(); const sel=document.getElementById('teacherSelect');
  for(const o of sel.options){ if(!o.value){o.hidden=false;continue;} o.hidden=q && !o.text.includes(q); }
});
['t_name','t_spec','t_level','t_job','t_work','t_civil','noteTeacherName'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('blur',()=>{
    if(currentIdx==null || !TEACHERS[currentIdx]) return;
    const v=el.textContent.trim();
    if(id==='t_name' || id==='noteTeacherName'){ 
      TEACHERS[currentIdx].name=v;
      document.getElementById('t_name').textContent=v;
      document.getElementById('noteTeacherName').textContent=v;
      document.getElementById('afadaName').textContent=v||'—';
      document.getElementById('abs-name-top').textContent=v||'—';
      document.getElementById('abs-teacher-name').textContent=v||'—';
    } else if(id==='t_spec'){ TEACHERS[currentIdx].spec=v; }
    else if(id==='t_level'){ TEACHERS[currentIdx].level=v; }
    else if(id==='t_job'){ TEACHERS[currentIdx].job=v; }
    else if(id==='t_work'){ TEACHERS[currentIdx].work=v; }
    else if(id==='t_civil'){ TEACHERS[currentIdx].civil=v; }
    localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
    refreshCaseNo();
  });
});

/* تمكين تعديل اسم المدير يدوياً (نقرة مزدوجة) */
['managerName1','managerName2','managerName3','managerName4','managerName5','managerNameNote'].forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
  el.setAttribute('contenteditable','true');
  el.addEventListener('blur', ()=> setManagerName(el.textContent.trim()||''));
});
setManagerName(getManagerName());

/* تصفير الاستيراد */
document.getElementById('btnClearImport').addEventListener('click', ()=>{
  if(!confirm('تأكيد تصفير بيانات الاستيراد والأسماء؟')) return;
  TEACHERS=[]; localStorage.removeItem('teachersCache'); refillSelect();
  ['t_name','t_spec','t_level','t_job','t_work','t_civil','afadaName','abs-name-top','abs-teacher-name','noteTeacherName'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent='';
  });
  document.getElementById('afadaName').textContent='—';
  document.getElementById('abs-name-top').textContent='—';
  document.getElementById('abs-teacher-name').textContent='—';
  currentIdx=null;
  refreshCaseNo();
});

/* ===== الاستيراد (كما هو) ===== */
const fileInput=document.getElementById('fileInput');
const drop=document.getElementById('dropZone');
const importDialog=document.getElementById('importDialog');
document.getElementById('btnImport').addEventListener('click',()=>fileInput.click());
drop.addEventListener('click', (e)=>{ if(e.target.id!=='btnImport') fileInput.click();});
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background='#f7ffff';}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background='transparent';}));
drop.addEventListener('drop',e=>{e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(f) beginImport(f);});
fileInput.addEventListener('change',e=>{if(e.target.files && e.target.files[0]) beginImport(e.target.files[0]);});

let IMPORT_CTX = {workbook:null, sheets:[], arrays:{}, headers:{}};

function detectSeparator(txt){
  const cTab=(txt.match(/\t/g)||[]).length, cSemi=(txt.match(/;/g)||[]).length, cComma=(txt.match(/,/g)||[]).length;
  if(cTab>cSemi && cTab>cComma) return '\t';
  if(cSemi>cComma) return ';';
  return ',';
}
async function readTextAllEnc(file){
  const buf=await file.arrayBuffer();
  try{ return new TextDecoder('utf-8',{fatal:false}).decode(buf); }catch{}
  try{ return new TextDecoder('windows-1256',{fatal:false}).decode(buf); }catch{}
  try{ return new TextDecoder('iso-8859-6',{fatal:false}).decode(buf); }catch{}
  return await file.text();
}
function sheetToAOA(ws){ return XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:''}); }
function pickHeaderRow(A){
  const rowsToCheck = Math.min(5, A.length);
  let bestIdx = 0, bestScore = -1;
  const keywords = ['الاسم','اسم','name','المعلم','الموظف','السجل','الهوية','التخصص','المرتبة','المستوى','رقم الوظيفة','العمل','الجوال','الهاتف','whatsapp','mobile','phone','الإيميل','الايميل','البريد'];
  for(let r=0;r<rowsToCheck;r++){
    const row=(A[r]||[]).join(' ').toLowerCase();
    let score=0; keywords.forEach(k=>{ if(row.includes(k)) score++; });
    if(score>bestScore){ bestScore=score; bestIdx=r; }
  }
  return bestIdx;
}
function guess(header){
  const h=(header||'').toString().trim().toLowerCase();
  const norm=h.replace(/[^\u0600-\u06FFa-z0-9 ]/g,'');
  const tests={
    name:['name','الاسم','اسم','المعلم','معلم','الموظف','موظف'],
    civil:['civil','national','id','identity','السجل','السجل المدني','رقم الهوية','الهوية','هوية','رقم السجل'],
    spec:['التخصص','تخصص','subject','spec','specialty'],
    level:['المرتبة','رتبة','rank','grade','level','المستوى','مستوى','الرتبه'],
    job:['رقم الوظيفة','وظيفة','job','employee id','كود','رقم وظيفي'],
    work:['العمل الحالي','العمل','work','job title','المسمى'],
    school:['المدرسة','school'],
    phone:['الجوال','الهاتف','واتساب','whatsapp','mobile','phone','رقم','رقم الجوال','رقم الهاتف','contact'],
    email:['الإيميل','الايميل','البريد','email','e-mail','mail']
  };
  for(const k in tests){ if(tests[k].some(key=>norm.includes(key))) return k; }
  return null;
}

/* === beginImport (كما هو) === */
async function beginImport(file){
  try{
    const lower=(file.name||'').toLowerCase();
    let wb=null;

    if(/\.(csv|tsv|txt)$/.test(lower)){
      const text=await readTextAllEnc(file);
      const sep = detectSeparator(text);
      const rows = text.split(/\r?\n/).map(line=> line.split(sep));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wbNew = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wbNew, ws, 'البيانات');
      wb = wbNew;
    } else if(/\.json$/.test(lower)){
      const text=await readTextAllEnc(file);
      const data = JSON.parse(text);
      const ws = XLSX.utils.json_to_sheet(Array.isArray(data)? data : []);
      const wbNew = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wbNew, ws, 'البيانات');
      wb = wbNew;
    } else {
      const buf=await file.arrayBuffer();
      wb = XLSX.read(buf, {type:'array'});
    }

    if(!wb || !wb.SheetNames || !wb.SheetNames.length) throw new Error('لم يتم العثور على أوراق في الملف.');

    IMPORT_CTX.workbook=wb;
    IMPORT_CTX.sheets=wb.SheetNames.slice();
    IMPORT_CTX.arrays={};
    wb.SheetNames.forEach(sh=>{
      const ws=wb.Sheets[sh];
      IMPORT_CTX.arrays[sh]=sheetToAOA(ws);
    });

    openImportDialog();
  }catch(err){
    console.error(err);
    alert('تعذّر استيراد الملف. تأكّد من الصيغة وأن الملف غير محمي بكلمة مرور.\nالتفاصيل: ' + (err.message||err));
  }
}

function openImportDialog(){
  const sheetSel=document.getElementById('sheetSelect');
  sheetSel.innerHTML='';
  (IMPORT_CTX.sheets.length?IMPORT_CTX.sheets:['البيانات']).forEach(sh=>sheetSel.add(new Option(sh,sh)));
  sheetSel.onchange=refreshMappingUI;

  ['mapName','mapCivil','mapSpec','mapLevel','mapJob','mapWork','mapSchool','mapPhone'].forEach(id=>document.getElementById(id).innerHTML='');
  refreshMappingUI();
  importDialog.style.display='flex';
  document.getElementById('btnCancelImport').onclick=()=>{ importDialog.style.display='none'; };
  document.getElementById('btnConfirmImport').onclick=confirmImport;
}
function refreshMappingUI(){
  const sheetSel=document.getElementById('sheetSelect');
  const sh=sheetSel.value || IMPORT_CTX.sheets[0] || 'البيانات';
  const A=(IMPORT_CTX.arrays[sh]||[]).slice(); if(!A.length){ return; }

  const headerRowIdx = pickHeaderRow(A);
  const HEADS = (A[headerRowIdx]||[]).map(x=>String(x||'').trim());
  const ROWS  = A.slice(headerRowIdx+1, headerRowIdx+1+20);

  const fillSel=id=>{ const el=document.getElementById(id); el.innerHTML='<option value="">— اختر عمودًا —</option>'; HEADS.forEach((h,i)=>el.add(new Option(h||`عمود ${i+1}`, i))); return el; };
  const sName=fillSel('mapName'), sCivil=fillSel('mapCivil'), sSpec=fillSel('mapSpec'),
        sLevel=fillSel('mapLevel'), sJob=fillSel('mapJob'), sWork=fillSel('mapWork'),
        sSchool=fillSel('mapSchool'), sPhone=fillSel('mapPhone');

  const idxByRole={}; HEADS.forEach((h,i)=>{ const r=guess(h); if(r && idxByRole[r]==null) idxByRole[r]=i; });
  if(idxByRole.name!=null) sName.value=idxByRole.name;
  if(idxByRole.civil!=null) sCivil.value=idxByRole.civil;
  if(idxByRole.spec!=null) sSpec.value=idxByRole.spec;
  if(idxByRole.level!=null) sLevel.value=idxByRole.level;
  if(idxByRole.job!=null) sJob.value=idxByRole.job;
  if(idxByRole.work!=null) sWork.value=idxByRole.work;
  if(idxByRole.school!=null) sSchool.value=idxByRole.school;
  if(idxByRole.phone!=null) sPhone.value=idxByRole.phone;

  const table=document.getElementById('previewTable');
  table.innerHTML='';
  const thead=document.createElement('thead'); const hr=document.createElement('tr');
  HEADS.forEach(h=>{const th=document.createElement('th'); th.textContent=h||''; hr.appendChild(th);});
  thead.appendChild(hr); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  ROWS.forEach(r=>{
    const tr=document.createElement('tr');
    HEADS.forEach((_,i)=>{const td=document.createElement('td'); td.textContent=(r[i]!=null?r[i]:''); tr.appendChild(td);});
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  IMPORT_CTX.headers={sheet:sh, headerRowIdx, heads:HEADS};
}
function normalizePhone(raw){
  if(!raw) return '';
  let s = String(raw).trim();
  s = ar2en(s).replace(/[^\d]/g,'');
  if(s.startsWith('00966')) s = s.slice(2);
  if(s.startsWith('00')) s = s.slice(2);
  if(s.startsWith('966')) { if(s.length===13 && s[3]==='0') s='966'+s.slice(4); return s; }
  if(s.startsWith('05') && s.length===10) return '966'+s.slice(1);
  if(s.startsWith('5')  && s.length===9 ) return '966'+s;
  return s;
}
function confirmImport(){
  try{
    const ctx=IMPORT_CTX.headers||{};
    const A=IMPORT_CTX.arrays[ctx.sheet]||[];
    if(!A.length){ alert('لا توجد بيانات في الورقة المحددة.'); return; }

    const getIdx = id => { const v=document.getElementById(id).value; return v? parseInt(v,10): -1; };
    const ixName=getIdx('mapName'), ixCivil=getIdx('mapCivil'), ixSpec=getIdx('mapSpec'),
          ixLevel=getIdx('mapLevel'), ixJob=getIdx('mapJob'), ixWork=getIdx('mapWork'),
          ixSchool=getIdx('mapSchool'), ixPhone=getIdx('mapPhone');

    const start = (ctx.headerRowIdx!=null? ctx.headerRowIdx+1 : 1);
    const out=[];
    for(let r=start;r<A.length;r++){
      const row=A[r]||[]; if(!row.some(c=>String(c||'').trim())) continue;
      const pick=i=> (i>=0 && i<row.length)? String(row[i]??'').trim() : '';
      out.push({
        name:pick(ixName),
        civil:pick(ixCivil),
        spec:pick(ixSpec),
        level:pick(ixLevel),
        job:pick(ixJob),
        work:pick(ixWork),
        school:pick(ixSchool),
        phone:normalizePhone(pick(ixPhone))
      });
    }
    TEACHERS=out.filter(t=> (t.name||t.civil||t.spec||t.level||t.job||t.work||t.phone));
    localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
    refillSelect();
    importDialog.style.display='none';
    if(TEACHERS.length){ document.getElementById('teacherSelect').value='0'; applyTeacher(TEACHERS[0],0); }
    else alert('تم الاستيراد، ولكن لم يتم العثور على صفوف بيانات صالحة بعد التحقق من الخرائط.');
  }catch(err){
    console.error(err);
    alert('حدث خطأ أثناء اعتماد الاستيراد: ' + (err.message||err));
  }
}

/* ===== تبديل نوع الإجراء ===== */
const segEl   = document.getElementById('noticeSeg');
const radios  = segEl.querySelectorAll('input[name="nt"]');
const kindLbl = document.getElementById('kindTitle');
const mainTitle = document.getElementById('mainTitle');
const alertPack = document.getElementById('alertPack');
const absencePack = document.getElementById('absencePack');
const notePack = document.getElementById('notePack');
const rowLate  = document.getElementById('lineLate');
const rowAbs   = document.getElementById('lineAbs');
const rowEarly = document.getElementById('lineEarly');

function setNotice(kind){
  // إظهار الصفحة المطلوبة دون إخفاء دائم لأي صفحة — التنقّل آمن
  alertPack.style.display   = (kind==='late' || kind==='absent' || kind==='early') ? 'block':'none';
  absencePack.style.display = (kind==='gaib') ? 'block':'none';
  notePack.style.display    = (kind==='note') ? 'block':'none';

  if(kind==='gaib'){
    mainTitle.textContent = 'مساءلة غياب';
  }else if(kind==='note'){
    mainTitle.textContent = 'لفت نظر';
  }else{
    mainTitle.textContent = 'تنبيه';
  }

  // عنوان النوع داخل خطاب التنبيه
  if(kind==='late'){ kindLbl.textContent='تأخر'; }
  else if(kind==='absent'){ kindLbl.textContent='عدم تواجد'; }
  else if(kind==='early'){ kindLbl.textContent='انصراف مبكر'; }

  rowLate.style.display  = (kind==='late')   ? 'flex' : 'none';
  rowAbs.style.display   = (kind==='absent') ? 'flex' : 'none';
  rowEarly.style.display = (kind==='early')  ? 'flex' : 'none';

  refreshCaseNo();
}
radios.forEach(r => r.addEventListener('change', e => setNotice(e.target.value)));
setNotice(segEl.querySelector('input[name="nt"]:checked')?.value || 'late');

/* ===== PDF بجودة عالية (يحافظ على العربية/RTL) ===== */
async function exportPDFBlob(){
  const root=document.documentElement;
  const prevScale = getComputedStyle(root).getPropertyValue('--scale');
  root.style.setProperty('--scale','1'); document.body.classList.add('exporting');
  const sheet=document.getElementById('sheet');
  const canvas = await html2canvas(sheet,{scale:4,useCORS:true,background:'#ffffff',logging:false,letterRendering:true});
  document.body.classList.remove('exporting'); root.style.setProperty('--scale', prevScale||'1');
  const img = canvas.toDataURL('image/jpeg',1.0);
  const {jsPDF}=window.jspdf; const pdf=new jsPDF('p','mm','a4');
  const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
  const px2mm=px=>px*25.4/96, imgWmm=px2mm(canvas.width), imgHmm=px2mm(canvas.height);
  const s=Math.min(pageW/imgWmm,pageH/imgHmm), w=imgWmm*s, h=imgHmm*s;
  pdf.addImage(img,'JPEG',(pageW-w)/2,(pageH-h)/2,w,h);
  return pdf.output('blob');
}
document.getElementById('btnMakePDF').addEventListener('click', async ()=>{
  const kind=document.querySelector('input[name="nt"]:checked')?.value || 'late';
  recordCase(kind,'PDF');
  const name=(document.getElementById('t_name').textContent||document.getElementById('noteTeacherName').textContent||'بدون اسم').trim();
  const hj=(document.getElementById('hdrHijri').textContent||'التاريخ الهجري').trim();
  const fileName=`${BASE_TITLE} — ${document.getElementById('mainTitle').textContent} — ${name} — ${hj}.pdf`;
  const blob=await exportPDFBlob();
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=fileName; a.click(); URL.revokeObjectURL(url);
});

/* ===== مؤقّت وحسابات (كما هو) ===== */
let active=null; const pad=document.getElementById('timePad'),disp=document.getElementById('timePadDisplay');
document.querySelectorAll('.timebox').forEach(el=>el.addEventListener('click',()=>openPad(el)));
function openPad(el){active=el;disp.textContent=el.dataset.value||'--:--';pad.style.display='block';const r=el.getBoundingClientRect();pad.style.left=Math.min(window.innerWidth-220,r.left)+'px';pad.style.top=(r.bottom+8)+'px';}
function closePad(){pad.style.display='none';active=null;}
document.getElementById('timePadClose').addEventListener('click',closePad);
document.getElementById('timePadSave').addEventListener('click',()=>{if(!active) return; const v=disp.textContent; active.textContent=v; active.classList.toggle('empty',!/\d\d:\d\d/.test(v)); active.dataset.value=v; recalc(); closePad();});
document.querySelectorAll('#timePad .grid button').forEach(b=>b.addEventListener('click',()=>{
  if(b.classList.contains('del')){disp.textContent=disp.textContent.slice(0,-1)||'--:--';return;}
  const k=b.dataset.k; let v=disp.textContent.replace(/-/g,'').replace(/:/g,''); if(disp.textContent==='--:--') v='';
  if(k===':'){if(v.length>=2 && !v.includes(':')) disp.textContent=v.slice(0,2)+':'+v.slice(2); return;}
  if(/[0-9]/.test(k)){v+=k; if(v.length<=4){disp.textContent=(v.padEnd(4,'-').slice(0,2))+':'+(v.padEnd(4,'-').slice(2,4));}}
}));
const t2m=t=>{ if(!/^\d{2}:\d{2}$/.test(t||'')) return null; const [h,m]=t.split(':').map(Number); return h*60+m; };
const fmtDur=mins=>{ mins=Math.max(0,Math.round(mins||0)); const h=Math.floor(mins/60),m=mins%60; return h?(m?`${h} ساعة و ${m} دقيقة`:`${h} ساعة`):`${m} دقيقة`; };
function recalc(){
  const ws=document.getElementById('workStart')?.value||'06:45';
  const we=document.getElementById('workEnd')?.value||'13:45';
  const mWS=t2m(ws), mWE=t2m(we);
  const mLate=t2m((document.getElementById('tLateIn')?.dataset.value)||'');
  const late = (mWS!=null && mLate!=null) ? Math.max(0, mLate - mWS) : 0;
  const mAF=t2m((document.getElementById('tAbsFrom')?.dataset.value)||'');
  const mAT=t2m((document.getElementById('tAbsTo')?.dataset.value)||'');
  const abs = (mAF!=null && mAT!=null) ? Math.max(0, mAT - mAF) : 0;
  const mEF=t2m((document.getElementById('tEarlyFrom')?.dataset.value)||'');
  const early = (mWE!=null && mEF!=null) ? Math.max(0, mWE - mEF) : 0;
  document.getElementById('lateTotal').textContent  = fmtDur(late);
  document.getElementById('absTotal').textContent   = fmtDur(abs);
  document.getElementById('earlyTotal').textContent = fmtDur(early);
}
recalc();

/* ===== رسالة واتساب — دعم «لفت نظر» أيضاً ===== */
function beautifyTime(t){ return en2ar((t||'--:--')); }
function buildWhatsAppMessage(){
  const school = (document.getElementById('schoolNameHdr').textContent||'مدرسة اليعقوبي الثانوية').trim();
  const name   = (document.getElementById('t_name').textContent||document.getElementById('noteTeacherName').textContent||'—').trim();
  const kind   = document.querySelector('input[name="nt"]:checked')?.value || 'late';
  const hj     = (document.getElementById('hdrHijri').textContent||'—').replace(/\s+/g,' ').trim();
  const dayName= (document.getElementById('dynDay').textContent||'—').trim();
  const serial = (document.getElementById('serialNo').textContent||'01').trim();
  const total  = (document.getElementById('caseTotal').textContent||'0').trim();
  const ws     = beautifyTime(document.getElementById('workStart')?.value||'--:--');
  const we     = beautifyTime(document.getElementById('workEnd')?.value||'--:--');

  if(kind==='note'){
    const reason = document.getElementById('noteReasonText').textContent.trim();
    return `السلام عليكم ورحمة الله وبركاته

الأستاذ/ ${name} حفظه الله،

نفيدكم بصدور «لفت نظر» رقم (${en2ar(serial)}) في ${school} يوم ${dayName} الموافق ${hj}.
النص: لوحظ عدم مباشرتكم أداء ${reason} وفق التعليمات المعتمدة.

نأمل تلافي ذلك مستقبلًا والالتزام بالمهام الوظيفية. مع الشكر والتقدير.

مدير المدرسة:
${getManagerName()}

إجمالي الإجراءات حتى تاريخه: ${en2ar(total)}.`;
  }

  let body='';
  if(kind==='gaib'){
    body =
`السلام عليكم ورحمة الله وبركاته

الأستاذ/ ${name} وفقه الله،

نفيدكم بوجود مساءلة غياب برقم (${en2ar(serial)}) في ${school}.
وذلك يوم ${dayName} الموافق ${hj}؛ وقد تم تسجيل غيابكم عن العمل في ذلك اليوم.

نأمل التكرّم بمراجعة مدير المدرسة وتقديم إفادتكم خلال المدة النظامية (٧ أيام).

مدير المدرسة:
${getManagerName()}

إجمالي مساءلاتكم حتى تاريخه: ${en2ar(total)}.`;
  }
  else if(kind==='late'){
    const tIn = beautifyTime(document.getElementById('tLateIn').dataset.value||'--:--');
    const dur = (document.getElementById('lateTotal').textContent||'—');
    body =
`السلام عليكم ورحمة الله وبركاته

الأستاذ/ ${name} وفقه الله،

نفيدكم بوجود تنبيه تأخر برقم (${en2ar(serial)}) في ${school}.
يوم ${dayName} الموافق ${hj}.
بداية الدوام: (${ws}) — وقت حضوركم: (${tIn}) — إجمالي التأخر: ${dur}.

نأمل مراجعة الإدارة وتقديم الإفادة خلال (٧ أيام).

مدير المدرسة:
${getManagerName()}

إجمالي مساءلاتكم حتى تاريخه: ${en2ar(total)}.`;
  }
  else if(kind==='absent'){
    const from = beautifyTime(document.getElementById('tAbsFrom').dataset.value||'--:--');
    const to   = beautifyTime(document.getElementById('tAbsTo').dataset.value||'--:--');
    const dur  = (document.getElementById('absTotal').textContent||'—');
    body =
`السلام عليكم ورحمة الله وبركاته

الأستاذ/ ${name} وفقه الله،

نفيدكم بوجود تنبيه عدم تواجد برقم (${en2ar(serial)}) في ${school}.
يوم ${dayName} الموافق ${hj}.
مدة عدم التواجد من (${from}) إلى (${to}) — الإجمالي: ${dur}.

نأمل مراجعة الإدارة وتقديم الإفادة خلال (٧ أيام).

مدير المدرسة:
${getManagerName()}

إجمالي مساءلاتكم حتى تاريخه: ${en2ar(total)}.`;
  }
  else { // early
    const from = beautifyTime(document.getElementById('tEarlyFrom').dataset.value||'--:--');
    const dur  = (document.getElementById('earlyTotal').textContent||'—');
    body =
`السلام عليكم ورحمة الله وبركاته

الأستاذ/ ${name} وفقه الله،

نفيدكم بوجود تنبيه انصراف مبكر برقم (${en2ar(serial)}) في ${school}.
يوم ${dayName} الموافق ${hj}.
وقت الانصراف: (${from}) — نهاية الدوام النظامية: (${we}) — مدة الانصراف المبكر: ${dur}.

نأمل مراجعة الإدارة وتقديم الإفادة خلال (٧ أيام).

مدير المدرسة:
${getManagerName()}

إجمالي مساءلاتكم حتى تاريخه: ${en2ar(total)}.`;
  }

  return body;
}
function getCurrentTeacherPhone(){
  if(currentIdx==null || !TEACHERS[currentIdx]) return '';
  return TEACHERS[currentIdx].phone || '';
}
document.getElementById('btnWA').addEventListener('click', ()=>{
  if(currentIdx==null){ alert('يرجى اختيار معلّم أولاً من القائمة.'); return; }
  const kind=document.querySelector('input[name="nt"]:checked')?.value || 'late';
  recordCase(kind,'WA');

  let phone = getCurrentTeacherPhone();
  if(!phone){
    alert('لا يوجد رقم جوال للمعلّم في الملف؛ سيُستخدم الرقم الافتراضي مؤقتًا.');
    phone = DEFAULT_WA;
  }
  const msg=buildWhatsAppMessage();
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
});

/* ===== إحصائيات وأرشيف — دعم نوع note ===== */
const dlgStats=document.getElementById('statsDialog');
const btnOpenStats=document.getElementById('btnOpenStats');
const btnCloseStats=document.getElementById('btnCloseStats');
const statsFilter=document.getElementById('statsFilter');
const tblArchiveBody=document.querySelector('#tblArchive tbody');
const tblSummaryBody=document.querySelector('#tblSummary tbody');

btnOpenStats.addEventListener('click',()=>{ renderStatsTables(); dlgStats.style.display='flex'; });
btnCloseStats.addEventListener('click',()=>{ dlgStats.style.display='none'; });

document.getElementById('btnExportArchive').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(ARCHIVE,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ارشيف_مساءلات_المعلمين.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('restoreInput').parentElement.addEventListener('click', ()=> document.getElementById('restoreInput').click());
document.getElementById('restoreInput').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(Array.isArray(data)){ ARCHIVE=data; saveArchive(); renderStatsTables(); alert('تمت الاستعادة بنجاح.'); }
      else alert('الملف غير صالح.');
    }catch{ alert('تعذر قراءة الملف.'); }
  };
  r.readAsText(f);
});
document.getElementById('btnResetAll').addEventListener('click', ()=>{
  if(!confirm('سيتم حذف كل الأرشيف وجميع العدادات. هل أنت متأكد؟')) return;
  ARCHIVE=[]; saveArchive(); renderStatsTables(); alert('تم التصفير.');
});
statsFilter.addEventListener('input', renderStatsTables);

function renderStatsTables(){
  const q=(statsFilter.value||'').trim();
  const filtered = ARCHIVE.slice().sort((a,b)=>b.ts-a.ts).filter(e=> !q || (e.name||'').includes(q));

  // أرشيف تفصيلي
  tblArchiveBody.innerHTML='';
  filtered.forEach(e=>{
    const tr=document.createElement('tr');
    const typeText = e.kind==='gaib'?'مساءلة غياب': e.kind==='late'?'تنبيه تأخر': e.kind==='absent'?'تنبيه عدم تواجد': e.kind==='early'?'تنبيه انصراف مبكر':'لفت نظر';
    tr.innerHTML = `<td>${e.hj}</td><td>${e.name||''}</td><td>${e.civil||''}</td><td>${typeText}</td><td>${pad2(e.serial)}</td>`;
    tblArchiveBody.appendChild(tr);
  });

  // ملخص حسب المعلم (أضفنا عمود لفت نظر)
  const map=new Map();
  for(const e of ARCHIVE){
    const k=e.tkey; if(!map.has(k)) map.set(k,{name:e.name||'',civil:e.civil||'',gaib:0,late:0,absent:0,early:0,note:0,total:0});
    const row=map.get(k); row[e.kind]=(row[e.kind]||0)+1; row.total++;
  }
  const rows=[...map.values()].sort((a,b)=> b.total-a.total);
  tblSummaryBody.innerHTML='';
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.civil}</td><td>${r.gaib||0}</td><td>${r.late||0}</td><td>${r.absent||0}</td><td>${r.early||0}</td><td>${r.note||0}</td><td><strong>${r.total||0}</strong></td>`;
    tblSummaryBody.appendChild(tr);
  }
  refreshHeaderCounts();
}

/* ===== لفت النظر — منطق دمج السبب ===== */
const noteSelect = document.getElementById('noteReasonSelect');
const noteText   = document.getElementById('noteReasonText');
noteSelect.addEventListener('change', ()=>{
  const v = noteSelect.value.trim();
  noteText.textContent = v ? v : 'المهمة المحددة';
});

/* ===== عند البدء ===== */
refreshHeaderCounts();
</script>
</body>
</html>
