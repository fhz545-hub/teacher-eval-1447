<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>نموذج تقييم الاداء الوظيفي للمعلمين للعام ١٤٤٧هـ</title>

<!-- خطوط -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<!-- مكتبات -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --teal:#0f4c46; --ink:#103330; --muted:#456A66; --border:#e5efec; --bg:#f7fbfa;
  --line:#cfe1dd; --green:#22c55e; --amber:#f59e0b; --red:#ef4444; --accent:#16a34a;
}
html,body{margin:0!important;padding:0!important;background:#fff;color:var(--ink);
  -webkit-text-size-adjust:100%; print-color-adjust: exact; -webkit-print-color-adjust: exact;
  font-family:"Tajawal",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
*{box-sizing:border-box}

/* وعاء الصفحة */
#page{width:794px; min-height:1123px; margin:0 auto; background:#fff;}
.wrap{max-width:100%; margin-inline:auto; padding:6px 10px; display:flex; flex-direction:column; min-height:100%}

/* الهيدر */
header{text-align:center;margin:0 0 6px}
header .topline{font-weight:700;color:var(--teal);font-size:13px;line-height:1.25}
header .schooltitle{display:flex;gap:6px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:3px}
header .schooltitle h1{font-size:14.5px;color:var(--teal);margin:0}
.badge{background:#eaf4f1;border:1px solid var(--border);padding:4px 8px;border-radius:10px;font-weight:700;color:#0b2f2c;font-size:11.2px}

/* وصف مختصر (لا يطبع) */
.note{margin:6px 0 8px;color:#0f3d37;background:#edf8f4;border:1px solid var(--line);
  border-radius:10px;padding:8px 10px;line-height:1.25;font-size:12px}

/* أدوات الرأس */
.header-edit{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
.header-edit .editable{cursor:text;padding:6px 8px;border-radius:8px;background:#fff;border:1px dashed transparent}
.header-edit .editable[contenteditable="true"]{border-color:var(--border);background:#fffdea}
.small-action{font-size:12px;padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:#fff;color:#0f4c46;cursor:pointer}

/* صف الأدوات (علوي) */
.tools-grid{display:grid;gap:8px;align-items:center;margin:6px 0;grid-template-columns:repeat(12,minmax(0,1fr))}
.tool-box{display:flex;flex-wrap:wrap;align-items:center;gap:8px;background:#fbfdfc;border:1px solid var(--border);border-radius:10px;padding:6px 8px}
.btn-mini{font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid #cfe1dd;background:#fff;color:#0f4c46;cursor:pointer}
.icon-btn,.btn.icon{width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #cfe1dd;border-radius:10px;background:#fff;cursor:pointer}
.icon-btn svg,.btn.icon svg{width:18px;height:18px;stroke:var(--teal);fill:none;stroke-width:2}
.btn.primary{background:#0f7a66;color:#fff;border-color:#0f7a66}
.btns-row{display:flex;align-items:center;gap:6px}
.badge-mini{font-size:11px;color:#4b6864}
.xs{width:140px} .xs2{width:180px}

/* حقول الهوية */
.fld{
  height:44px;border:1px solid #cfe1dd;border-radius:999px;background:#fff;
  font:600 15px/44px "Tajawal",system-ui; padding:0 14px;color:var(--ink);outline:none;letter-spacing:.1px
}
.fld.hint{color:#6a7c86;font-weight:600}
.fld:focus{box-shadow:0 0 0 3px rgba(13,110,253,.12)}

/* توزيع */
.col-span-4{grid-column:span 4 / span 4}
.col-span-12{grid-column:span 12 / span 12}
.info-grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:8px;margin:6px 0}

/* شريط المراحل + الرابط */
.stage-bar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:6px 0}
.stage-btn{border:1px solid var(--border);background:#fff;color:#0f4c46;border-radius:999px;padding:5px 12px;font-weight:700;font-size:12px;cursor:pointer}
.stage-btn.active{background:#eaf8f4;border-color:var(--accent);color:#0b6e44}
.stage-link{
  display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
  border:1px solid var(--border);background:#f0fbf7;color:#0b6e44;text-decoration:none;font-weight:800;font-size:12px
}
.stage-link svg{width:16px;height:16px;stroke:#0b6e44;fill:none;stroke-width:2}

/* لوحات المراحل */
.stage-panel{overflow:hidden;max-height:0;opacity:0;background:#fbfdfc;border:1px dashed var(--border);border-radius:10px;margin:4px 0;padding:0 8px;transition:max-height .3s ease, opacity .22s ease}
.stage-panel.open{opacity:1;padding:8px;max-height:480px}
.stage-panel .row{display:grid;grid-template-columns:1fr;gap:6px}
.goal{height:34px;border:1px solid #cfe1dd;border-radius:8px;padding:0 10px;font:inherit}

/* بطاقة بيانات المعلم (عرض الشاشة) */
.idcard{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-start;background:#fbfdfc;border:1px solid var(--border);border-radius:10px;padding:6px 8px;margin:6px 0}
.idchip{background:#f2f7f6;border:1px solid var(--border);border-radius:10px;padding:4px 8px;font-size:11.5px;color:#0f4c46}

/* المؤشر */
.bar-row{display:flex;align-items:center;gap:6px;margin:6px 0 2px;transition:opacity .2s}
.bar-row.dim{opacity:.45;filter:grayscale(.1)}
.chip{background:#f2f7f6;border:1px solid var(--border);padding:6px 8px;border-radius:10px;font-weight:700;color:#09312d;min-width:135px;text-align:center;font-size:11.5px}
.meter{position:relative;height:20px;flex:1;background:#eaf1ef;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.fill{position:absolute;inset:3px;border-radius:10px;background:linear-gradient(90deg, var(--red) 0%, #ff914d 45%, var(--green) 100%);}
.thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#fff;border:3px solid #8b5a2b;box-shadow:0 1px 5px rgba(0,0,0,.15)}
.meter .ticks{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none;direction:ltr;padding:0 6px}
.meter .ticks span{width:22px;height:22px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#000;background:transparent;font-size:12px}

/* الجدول */
table{width:100%;border-collapse:collapse}
th,td{background:#ffffff;border:1px solid var(--line);padding:6px 8px;vertical-align:middle;font-size:12.2px}
th{background:var(--teal);color:#fff;text-align:center;font-size:12px;line-height:1.2;padding:6px 8px}
th:first-child,td:first-child{border-radius:8px 0 0 8px}
th:last-child, td:last-child{border-radius:0 8px 8px 0}
.w-tight{width:76px;text-align:center}
.w{width:70px;text-align:center}
th .sub{display:block;font-size:10px;opacity:.92;margin-top:2px}
select.grade{width:62px;height:28px;text-align:center;border:1px solid #cfe1dd;border-radius:8px;background:#fff;font-size:12.3px}
td.brief{font-size:12.2px;color:#1d3f3b;line-height:1.55}

/* القوة/التطوير */
.cards{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:7px 8px;min-height:56px}
.card h3{margin:0 0 4px;font-size:13px}
#strength h3{color:#136b3e} #dev h3{color:#b4372d}
#strengthBody,#devBody{font-family:"Cairo", Tahoma, sans-serif;font-size:11.4px;line-height:1.5}

/* وصف قصير داخل لوحة التخطيط */
.stage-desc{background:#f1fbf7;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:12px;color:#0f3d37;margin-top:6px}

/* سطر الهوية للطباعة فقط */
.print-only{display:none}
.idrow{display:flex;gap:6px;align-items:center;justify-content:space-between;margin:6px 0 4px}
.idrow .cell{flex:1;background:#f6fbfa;border:1px solid var(--border);border-radius:10px;padding:6px 8px;font-weight:700;color:#0f4c46}
.idrow .cell b{color:#09312d}

/* منطقة التوقيعات */
.signs{margin:10px 0 2px}
.signs-flex{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sig{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px;min-height:90px;display:flex;flex-direction:column;gap:8px}
.sig .label{font-weight:700;color:#0f4c46}
.sig .name{font-size:16px;font-weight:800;color:#0f4c46}
.sig .edit{margin-inline-start:auto;font-size:12px;border:1px solid #cfe1dd;background:#f3faf8;color:#0f4c46;border-radius:8px;padding:4px 8px;cursor:pointer}
.sig .line{border-bottom:1px dashed #9fb5b1;height:22px}
.sig .hint{font-size:11px;color:#6a8682}

/* أزرار سفلية (لا تُطبع) */
.actions{display:flex;gap:8px;justify-content:center;margin:8px 0 4px;flex-wrap:wrap}
.tool-box select.fld{height:36px;line-height:36px;border-radius:8px}

/* نافذة منبثقة */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100}
.modal.show{display:flex}
.modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25)}
.modal .dialog{position:relative;background:#fff;border:1px solid #dbe8e5;border-radius:12px;min-width:320px;max-width:92vw;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:101}
.modal .dialog h3{margin:0 0 10px;font-size:14px;color:#0f4c46}
.modal .row{display:flex;gap:8px;align-items:center}
.modal input{flex:1;height:36px;border:1px solid #cfe1dd;border-radius:8px;padding:0 10px;font:inherit;direction:ltr}
.modal .actions{justify-content:flex-end;margin:10px 0 0}
.modal .actions .btn{background:#eaf3f1}
.modal .actions .btn.primary{background:#0f7a66;color:#fff}

/* حقوق */
.footer{margin:6px 0 2px;text-align:center;font-size:10.5px;color:#6a8682}
.footer:before{content:"© ";}

/* طباعة A4 */
@page{size:A4 portrait; margin:4mm 5mm 5mm 5mm}
@media print{
  html,body{height:auto;margin:0!important;padding:0!important}
  #page{width:210mm;min-height:297mm;height:297mm;display:flex}
  .wrap{max-width:100%;padding:4mm 5mm;display:flex;flex-direction:column;min-height:100%}
  .push{flex:1 1 auto} /* يدفع التوقيع للأسفل دائمًا */

  table{font-size:10.6px}
  td.brief{font-size:10.4px;line-height:1.4}
  th,td{padding:3.5px 5px}
  .card{min-height:44px}
  .no-print{display:none!important}
  .stage-panel{display:none!important}
  body[data-stage="planning"] #stage-planning{display:block!important;max-height:none!important;opacity:1!important;border-style:solid}

  /* عرض الهوية كسطر واحد */
  .print-only{display:block}
  .idrow{display:flex}

  body.bw-print{-webkit-filter:grayscale(100%) contrast(1.05);filter:grayscale(100%) contrast(1.05)}
}

/* طبقة التحجيم (للقطع/الطباعة عبر الزر) */
#sheet{transform-origin:top center}

/* تجاوب */
@media (max-width:920px){
  .col-span-4,.col-span-12{grid-column:span 12 / span 12}
  .signs-flex{grid-template-columns:1fr}
}
</style>
</head>
<body data-stage="planning">
<div id="page">
  <div class="wrap" id="sheet">

    <!-- الهيدر -->
    <header>
      <div class="topline">
        الإدارة العامة للتعليم بالمنطقة الشرقية • <span id="sectorNameDisplay">قطاع التعليم بالخبر</span> • <span id="schoolNameDisplay">مدرسة اليعقوبي الثانوية</span>
      </div>
      <div class="schooltitle">
        <h1>تقييم الأداء الوظيفي للمعلمين للعام ١٤٤٧هـ</h1>
        <span class="badge" id="hijriChip">التاريخ الهجري: —</span>
      </div>

      <!-- تعديل رأس الصفحة -->
      <div class="header-edit no-print" style="margin-top:6px">
        <div class="tool-box">
          <span class="badge-mini">اسم المدرسة للعرض:</span>
          <div id="schoolName" class="editable" contenteditable="false">مدرسة اليعقوبي الثانوية</div>
          <button class="small-action" id="editSchoolBtn">تعديل</button>
        </div>
        <div class="tool-box">
          <span class="badge-mini">القطاع/المحافظة:</span>
          <div id="sectorName" class="editable" contenteditable="false">قطاع التعليم بالخبر</div>
          <button class="small-action" id="editSectorBtn">تعديل</button>
        </div>
        <div class="tool-box">
          <button class="small-action" id="saveSettingsBtn">حفظ</button>
          <button class="small-action" id="resetSettingsBtn">افتراضي</button>
        </div>
      </div>
    </header>

    <!-- وصف موجز (لا يطبع) -->
    <div class="note no-print" id="descNote">
      نموذج قبلي تدريبي يعرّف المعلم بعناصر التقييم ويعرض مؤشر الإنجاز مع نقاط القوة ومجالات التطوير، وفق ممارسات وزارة التعليم. يشمل المراحل: التخطيط، المراجعة النصف سنوية، التقييم النهائي. يدعم استيراد بيانات من Excel، حفظ PDF، ورسالة واتساب، مع تعديل بيانات المدرسة.
    </div>

    <!-- صف الأدوات العلوي: استيراد + أسماء + (تنزيل/مسح/قالب) -->
    <div class="tools-grid no-print">
      <div class="tool-box col-span-12" style="justify-content:flex-start">
        <label for="excelInput" class="icon-btn" title="استيراد ملف المعلمين (Excel)">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 5 17 10"/><line x1="12" y1="5" x2="12" y2="15"/></svg>
        </label>
        <input type="file" id="excelInput" accept=".xlsx,.xls,.csv"/>
        <select id="tSelect" class="fld xs2" style="display:none" title="الأسماء من الإكسل">
          <option value="">— اختر اسمًا —</option>
        </select>
        <button class="btn-mini" id="exportExcelBtn" title="تنزيل قائمة المعلمين (Excel)">تنزيل</button>
        <button class="btn-mini" id="clearTeachersBtn" title="مسح بيانات المعلمين">مسح</button>
        <button class="btn-mini" id="importTemplateBtn" title="تحميل قالب Excel فارغ">قالب</button>
      </div>
    </div>

    <!-- صف المعلومات: اسم/هوية/تخصص -->
    <div class="info-grid">
      <div class="col-span-4"><input class="fld hint" id="tName" value="اكتب اسمك هنا"/></div>
      <div class="col-span-4"><input class="fld hint" id="tId" value="اكتب رقم هويتك هنا"/></div>
      <div class="col-span-4"><input class="fld hint" id="tSpec" value="اكتب تخصصك هنا"/></div>
    </div>

    <!-- شريط المراحل + الرابط -->
    <div class="no-print">
      <div class="stage-bar">
        <button class="stage-btn active" data-stage="planning" id="btnPlanning">مرحلة التخطيط</button>
        <button class="stage-btn" data-stage="mid" id="btnMid">المراجعة النصف سنوية</button>
        <button class="stage-btn" data-stage="final" id="btnFinal">التقييم النهائي</button>
        <a class="stage-link" href="https://fhz545-hub.github.io/teachervisit/" target="_blank" rel="noopener">
          <svg viewBox="0 0 24 24"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg>
          لمشاهدة الزيارات الصفية
        </a>
      </div>
    </div>

    <!-- لوحات المراحل -->
    <div id="stage-planning" class="stage-panel">
      <b>مرحلة التخطيط — بداية العام:</b>
      <div class="stage-desc">مرحلة يُحدَّد فيها مع المعلم الأهداف المهنية والتربوية بداية العام، لضبط الأداء وفق الخطط الدراسية.</div>
      <div class="row" style="margin-top:6px">
        <input class="goal" id="g1" placeholder="هدف 1 — مثال: رفع نواتج التعلم في مهارات القراءة بنسبة 10%"/>
        <input class="goal" id="g2" placeholder="هدف 2 — مثال: تنفيذ مبادرتين تعليميتين في الفصل الدراسي الأول"/>
        <input class="goal" id="g3" placeholder="هدف 3 — مثال: تفعيل منصة تعليمية أسبوعيًا بمتوسط تفاعل 80%"/>
        <input class="goal" id="g4" placeholder="هدف 4 — مثال: عقد لقاءات مجتمعات تعلم مرتين شهريًا"/>
      </div>
      <div id="planningTips" class="card" style="margin-top:6px">
        <h3>تنبيهات مرحلة التخطيط</h3>
        <div style="font-size:11.5px;line-height:1.6">
          • صياغة الأهداف بمؤشرات قابلة للقياس.<br/>• توثيق أدوات المتابعة (زيارات، مبادرات، تدريب).<br/>• المؤشر غير مفعّل في هذه المرحلة.
        </div>
      </div>
    </div>

    <div id="stage-mid" class="stage-panel">
      <b>مرحلة المراجعة النصف سنوية — منتصف العام:</b>
      <ul style="margin:6px 0 0 0;padding:0 1.25em;font-size:12px">
        <li>متابعة التقدّم نحو الأهداف المحددة.</li><li>الاستناد إلى الزيارات الفنية والتقارير.</li><li>خطة قصيرة الأمد حتى نهاية العام.</li>
      </ul>
    </div>

    <div id="stage-final" class="stage-panel">
      <b>مرحلة التقييم النهائي — نهاية العام:</b>
      <ul style="margin:6px 0 0 0;padding:0 1.25em;font-size:12px">
        <li>استكمال التقييم وتعبئة الاستمارة.</li><li>قياس ما تحقق واعتماد الدرجة النهائية.</li>
      </ul>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="btn-mini" id="lockFinalBtn" title="قفل الدرجات قبل الاعتماد">قفل الدرجات</button>
        <button class="btn-mini" id="approveFinalBtn" title="اعتماد الدرجة النهائية">اعتماد الدرجة</button>
      </div>
    </div>

    <!-- بطاقة بيانات المعلم (عرض الشاشة) -->
    <div class="idcard" id="idcard">
      <span class="idchip">المعلم: <b id="s_name">—</b></span>
      <span class="idchip">الهوية: <b id="s_id">—</b></span>
      <span class="idchip">التخصص: <b id="s_spec">—</b></span>
      <span class="idchip">مرحلة التقييم: <b id="s_stage">التخطيط</b></span>
    </div>

    <!-- سطر الهوية للطباعة فقط -->
    <div class="print-only">
      <div class="idrow">
        <div class="cell">اسم المعلم: <b id="p_name">—</b></div>
        <div class="cell">رقم الهوية: <b id="p_id">—</b></div>
        <div class="cell">التخصص: <b id="p_spec">—</b></div>
      </div>
    </div>

    <!-- المؤشر -->
    <div class="bar-row" id="barRow">
      <div class="chip" id="scoreChip">مؤشر الإنجاز: 0.00 / 5</div>
      <div class="meter">
        <div class="fill"></div>
        <div class="ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>
        <div class="thumb" id="thumb" style="left:0%"></div>
      </div>
      <div class="chip" id="percentChip">المجموع: %0</div>
    </div>

    <!-- الجدول -->
    <table id="tbl">
      <thead>
        <tr>
          <th class="w-tight">#</th>
          <th>العنصر</th>
          <th class="w">الوزن</th>
          <th class="w-tight">الدرجة<span class="sub">(1–5)</span></th>
          <th>تفسير / أمثلة مختصرة</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <!-- القوة/التطوير -->
    <div class="cards">
      <div id="strength" class="card">
        <h3>نقاط القوة</h3>
        <div id="strengthBody">—</div>
      </div>
      <div id="dev" class="card">
        <h3>مجالات التطوير</h3>
        <div id="devBody">—</div>
      </div>
    </div>

    <!-- دافع مرن لأسفل الصفحة -->
    <div class="push"></div>

    <!-- منطقة التوقيعات (تثبت بأسفل الصفحة في الطباعة/PDF) -->
    <div class="signs" id="signs">
      <div class="signs-flex">
        <div class="sig" id="sigTeacher">
          <div class="label">اسم المعلم</div>
          <div class="name" id="signTeacherName">—</div>
          <div class="line" title="توقيع المعلم"></div>
          <div class="hint">توقيع المعلم</div>
        </div>
        <div class="sig" id="sigPrincipal">
          <div style="display:flex;align-items:center;gap:8px">
            <div class="label">اسم مدير المدرسة</div>
            <button class="edit no-print" id="editPrincipalBtn" title="تعديل اسم المدير">تعديل</button>
          </div>
          <div class="name" id="signPrincipalName">فهد حامد الزهراني</div>
          <div class="line" title="توقيع المدير"></div>
          <div class="hint">توقيع مدير المدرسة</div>
        </div>
      </div>
    </div>

    <!-- واتساب إعداد -->
    <div class="modal" id="waModal" aria-hidden="true">
      <div class="backdrop"></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="waTitle">
        <h3 id="waTitle">رقم واتساب المدير (دولي بدون +)</h3>
        <div class="row"><input id="waPhone" type="tel" inputmode="numeric" placeholder="مثال: 9665XXXXXXXX"/></div>
        <div class="actions" style="margin-top:10px">
          <button class="btn icon" id="waClose" title="إغلاق"><svg viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
          <button class="btn icon primary" id="waSave" title="حفظ"><svg viewBox="0 0 24 24"><path d="M4 7h16v13H4z"/><path d="M8 7V4h8v3"/><path d="M12 11v6"/></svg></button>
        </div>
      </div>
    </div>

    <!-- أزرار سفلية لا تُطبع -->
    <div class="actions no-print">
      <div class="tool-box" title="يؤثر على الطباعة فقط">
        <span class="badge-mini">وضع الطباعة:</span>
        <select id="printMode" class="fld xs">
          <option value="color" selected>ملون</option>
          <option value="bw">أبيض وأسود</option>
        </select>
      </div>

      <div class="btns-row">
        <!-- حفظ بيانات المعلم -->
        <button class="btn icon" id="saveTeacherBtn" title="حفظ بيانات المعلم">
          <svg viewBox="0 0 24 24"><path d="M4 7h16v13H4z"/><path d="M8 7V4h8v3"/><path d="M12 11v6"/></svg>
        </button>

        <!-- مسح بيانات المعلم -->
        <button class="btn icon" id="clearOneBtn" title="مسح بيانات هذا المعلم">
          <svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6l1 14h10l1-14"/></svg>
        </button>

        <!-- طباعة -->
        <button class="btn icon" id="printBtn" title="طباعة A4">
          <svg viewBox="0 0 24 24"><path d="M6 9V2h12v7"/><path d="M6 13h12v9H6z"/><path d="M6 13H4a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2"/></svg>
        </button>

        <!-- حفظ PDF -->
        <button class="btn icon" id="saveBtn" title="حفظ PDF">
          <svg viewBox="0 0 24 24"><path d="M12 3v12"/><path d="M7 8l5 5 5-5"/><path d="M4 21h16"/></svg>
        </button>

        <!-- واتساب -->
        <button class="btn icon" id="waBtn" title="إرسال واتساب">
          <svg viewBox="0 0 24 24"><path d="M16.2 13.3c-.3-.1-1.4-.7-1.7-.8-.3-.1-.5-.1-.7.2l-.6.7c-.2.2-.3.3-.6.2-.3-.1-1.2-.4-2.1-1.2-.8-.7-1.3-1.5-1.5-1.8-.1-.2 0-.4.1-.5l.4-.5c.1-.2.2-.3.3-.5.1-.2.1-.4 0-.6s-.6-1.5-.8-2c-.2-.5-.5-.5-.7-.5H7c-.2 0-.5.1-.8.4-.3.3-1 .9-1 2.3 0 1.4 1 2.7 1.1 2.9.1.2 1.9 3 4.7 4.2.6.3 1.1.5 1.5.6.7.2 1.3.2 1.8.1.5-.1 1.5-.6 1.7-1.3.2-.6.2-1.1.1-1.2-.1-.1-.3-.2-.6-.3z"/><path d="M20 12a8 8 0 1 1-14.9 4.2L4 21l4.8-1.3A8 8 0 1 1 20 12z"/></svg>
        </button>

        <!-- إعداد واتساب -->
        <button class="btn icon" id="waConfigBtn" title="ضبط رقم مدير المدرسة">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a2 2 0 1 0 2.89 2.77l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a2 2 0 0 0-1.82-.33 2 2 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a2 2 0 0 0-1-1.51 2 2 0 0 0-1.82.33l-.06.06A2 2 0 1 1 4.24 18l.06-.06A2 2 0 0 0 4.63 16 2 2 0 0 0 3.12 15H3a2 2 0 1 1 0-4h.12A2 2 0 0 0 4.63 9a2 2 0 0 0-.33-1.82L4.24 7A2 2 0 1 1 7.07 4.17l.06.06A2 2 0 0 0 9 4.63 2 2 0 0 0 10 3.12V3a2 2 0 1 1 4 0v.12A2 2 0 0 0 15 4.63a2 2 0 0 0 1.82-.33l.06-.06A2 2 0 1 1 19.71 7l-.06.06A2 2 0 0 0 19.37 9a2 2 0 0 0 1.51 1h.12a2 2 0 1 1 0 4h-.12a2 2 0 0 0-1.49 1z"/></svg>
        </button>
      </div>
    </div>

    <!-- حقوق -->
    <div class="footer">
      مبادرة مدرسة اليعقوبي الثانوية بالخبر — تصميم وتنفيذ: فهد حامد الزهراني
    </div>

  </div>
</div>

<script>
/* ===== أدوات مساعدة لتنظيف النصوص ===== */
function collapseSpaces(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim(); }
function digitsOnly(s){ return String(s||'').replace(/\D+/g,''); }

/* ===== التاريخ الهجري ===== */
function hijriUmmAlQura(){
  let txt='—';
  try{
    const opt={weekday:'long',day:'numeric',month:'long',year:'numeric'};
    txt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',opt).format(new Date());
  }catch(e){
    try{ txt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(new Date()); }
    catch{ txt=new Date().toLocaleDateString('ar-SA'); }
  }
  document.getElementById('hijriChip').textContent='التاريخ الهجري: '+txt+' هـ';
  return txt+' هـ';
}
const hijriToday=hijriUmmAlQura();

/* ===== إعدادات الرأس ===== */
const LS_SETTINGS='yaqubi_settings_v16';
function loadSettings(){
  const s=localStorage.getItem(LS_SETTINGS);
  if(s){
    try{
      const obj=JSON.parse(s);
      if(obj.schoolName) document.getElementById('schoolName').textContent=obj.schoolName;
      if(obj.sectorName) document.getElementById('sectorName').textContent=obj.sectorName;
    }catch(e){}
  }
  applyHeaderTexts();
}
function saveSettings(){
  const obj={
    schoolName: collapseSpaces(document.getElementById('schoolName').textContent || 'مدرسة اليعقوبي الثانوية'),
    sectorName: collapseSpaces(document.getElementById('sectorName').textContent || 'قطاع التعليم بالخبر')
  };
  localStorage.setItem(LS_SETTINGS,JSON.stringify(obj));
  applyHeaderTexts(); alert('تم حفظ الإعدادات.');
}
function resetSettings(){
  document.getElementById('schoolName').textContent='مدرسة اليعقوبي الثانوية';
  document.getElementById('sectorName').textContent='قطاع التعليم بالخبر';
  saveSettings();
}
document.getElementById('editSchoolBtn').addEventListener('click',()=>toggleEditable('schoolName'));
document.getElementById('editSectorBtn').addEventListener('click',()=>toggleEditable('sectorName'));
document.getElementById('saveSettingsBtn').addEventListener('click',saveSettings);
document.getElementById('resetSettingsBtn').addEventListener('click',()=>{ if(confirm('إعادة الإعدادات إلى الافتراضي؟')) resetSettings(); });
function toggleEditable(id){
  const el=document.getElementById(id);
  const editing=el.getAttribute('contenteditable')==='true';
  if(!editing){
    el.setAttribute('contenteditable','true'); el.focus();
    el.addEventListener('blur',()=>{ el.textContent=collapseSpaces(el.textContent); el.setAttribute('contenteditable','false'); applyHeaderTexts();},{once:true});
  }else{ el.setAttribute('contenteditable','false'); applyHeaderTexts(); }
}
function applyHeaderTexts(){
  const school=collapseSpaces(document.getElementById('schoolName').textContent||'مدرسة اليعقوبي الثانوية');
  const sector=collapseSpaces(document.getElementById('sectorName').textContent||'قطاع التعليم بالخبر');
  document.getElementById('schoolNameDisplay').textContent=school;
  document.getElementById('sectorNameDisplay').textContent=sector;
}
loadSettings();

/* ===== وضع الطباعة ===== */
const LS_PRINT='yaqubi_print_mode';
const printModeSel=document.getElementById('printMode');
function loadPrintMode(){ const m=localStorage.getItem(LS_PRINT)||'color'; if(printModeSel){printModeSel.value=m; applyPrintMode(m);} }
function applyPrintMode(mode){ if(mode==='bw') document.body.classList.add('bw-print'); else document.body.classList.remove('bw-print'); }
if(printModeSel){ printModeSel.addEventListener('change',()=>{localStorage.setItem(LS_PRINT,printModeSel.value); applyPrintMode(printModeSel.value);}); loadPrintMode(); }

/* ===== عناصر التقييم ===== */
const items=[
  {name:"أداء الواجبات الوظيفية",weight:10,brief:"انضباط يومي؛ التزام بالجدول والمواعيد؛ تحضير وتتبع للدرس؛ تسليم التقارير في وقتها."},
  {name:"التفاعل مع المجتمع المهني",weight:10,brief:"مجتمعات تعلم مهنية؛ تبادل زيارات؛ حضور دورات؛ مشاركة موارد وخبرات."},
  {name:"التفاعل مع أولياء الأمور",weight:10,brief:"قنوات تواصل منضبطة؛ رسائل موجزة؛ متابعة بنّاءة لحالات الطلاب."},
  {name:"التنوع في استراتيجيات التدريس",weight:10,brief:"تنويع أساليب التعلم النشط؛ مراعاة الفروق؛ أسئلة عليا؛ تعلم تعاوني."},
  {name:"تحسين نتائج المتعلمين",weight:10,brief:"قياس قبلي/بعدي؛ خطط علاج؛ إثراء؛ متابعة تقدم."},
  {name:"إعداد وتنفيذ خطة التعلم",weight:10,brief:"توزيع منهج؛ تحضير علمي؛ تقويم بنائي؛ التزام بالزمن."},
  {name:"توظيف تقنيات ووسائل التعلم المناسبة",weight:10,brief:"منصات تعليم؛ موارد تفاعلية؛ مصادر متعددة؛ محتوى منظم."},
  {name:"تهيئة البيئة التعليمية",weight:5, brief:"تهيئة نفسية؛ تنظيم المقاعد؛ لوحات صفية."},
  {name:"الإدارة الصفية",weight:5,  brief:"قواعد واضحة؛ إدارة وقت؛ انتقالات سلسة؛ متابعة الغياب."},
  {name:"تحليل نتائج المتعلمين وتشخيص مستوياتهم",weight:10,brief:"تحليل بنود؛ تحديد القوة والضعف؛ تقارير مختصرة."},
  {name:"تنوع أساليب التقويم",weight:10,brief:"اختبارات مختلفة؛ مهام أداء؛ ملفات إنجاز."},
];

/* بناء الجدول */
const tbody=document.getElementById('rows');
(function buildTable(){
  items.forEach((it,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="w-tight" style="text-align:center">${idx+1}</td>
      <td>${it.name}</td>
      <td class="w"><b>${it.weight}%</b></td>
      <td class="w-tight">
        <select class="grade" data-g="3" aria-label="درجة العنصر">
          <option value="5">5</option><option value="4">4</option>
          <option value="3" selected>3</option><option value="2">2</option><option value="1">1</option>
        </select>
      </td>
      <td class="brief">${it.brief}</td>`;
    tbody.appendChild(tr);
  });
})();

/* حساب المؤشر + العبارات */
const gradesEls=()=>[...document.querySelectorAll('.grade')];
const barRow=document.getElementById('barRow');
const scoreChip=document.getElementById('scoreChip');
const percentChip=document.getElementById('percentChip');
const thumb=document.getElementById('thumb');
function overallText(avg){ if(avg>=4.5) return "مثالي"; if(avg>=3.5) return "تخطّى التوقعات"; if(avg>=2.5) return "وافق التوقعات"; if(avg>=1.5) return "بحاجة إلى تطوير"; return "غير مرضي"; }
function recalc(){
  let weighted=0, per=0;
  gradesEls().forEach((sel,i)=>{
    const g=Number(sel.value); sel.dataset.g=g;
    const w=items[i].weight;
    weighted+=g*w; per+=(g/5)*w;
  });
  const avg=weighted/100, pct=Math.round(per);
  scoreChip.textContent=`مؤشر الإنجاز: ${avg.toFixed(2)} / 5`;
  percentChip.textContent=`المجموع: %${pct}`;
  const pos=((avg-1)/4)*100; thumb.style.left=`${pos}%`;
  return {avg,pct,overall:overallText(avg)};
}
gradesEls().forEach(el=>el.addEventListener('change',recalc));
recalc();

/* ===== حقول الهوية: تلميح + تنظيف ===== */
const HINTS={ tName:"اكتب اسمك هنا", tId:"اكتب رقم هويتك هنا", tSpec:"اكتب تخصصك هنا" };
["tName","tId","tSpec"].forEach(id=>{
  const el=document.getElementById(id);
  function setHint(){ el.value=HINTS[id]; el.classList.add('hint'); }
  function isHint(v){ return collapseSpaces(v)===HINTS[id]; }
  function clearHint(){ if(isHint(el.value)) { el.value=""; el.classList.remove('hint'); } }
  el.addEventListener('focus', clearHint);
  el.addEventListener('blur', ()=>{
    // تنظيف
    if(id==='tId'){ el.value=digitsOnly(el.value); }
    else{ el.value=collapseSpaces(el.value); }
    if(!el.value.trim()) setHint();
    updateSummary();
  });
  if(!el.value.trim()) setHint();
});

/* بيانات المعلم + سطر الطباعة + التوقيع */
const s_name=document.getElementById('s_name');
const s_id=document.getElementById('s_id');
const s_spec=document.getElementById('s_spec');
const s_stage=document.getElementById('s_stage');
const signTeacherName=document.getElementById('signTeacherName');
const p_name=document.getElementById('p_name');
const p_id=document.getElementById('p_id');
const p_spec=document.getElementById('p_spec');

['tName','tId','tSpec'].forEach(id=>document.getElementById(id).addEventListener('input',updateSummary));
function getCleanVal(id){
  let v=document.getElementById(id).value;
  if(id==='tId') v=digitsOnly(v);
  else v=collapseSpaces(v);
  if(v===HINTS[id]) v="";
  return v.trim();
}
function updateSummary(){
  const name=getCleanVal('tName')||'—';
  const id=getCleanVal('tId')||'—';
  const spec=getCleanVal('tSpec')||'—';
  s_name.textContent=name; s_id.textContent=id; s_spec.textContent=spec;
  signTeacherName.textContent=name;
  p_name.textContent=name; p_id.textContent=id; p_spec.textContent=spec;
}
updateSummary();

/* اسم المدير (افتراضي + تخزين محلي) */
const LS_PRINCIPAL='yaqubi_principal_name';
(function loadPrincipal(){
  const saved=localStorage.getItem(LS_PRINCIPAL);
  const el=document.getElementById('signPrincipalName');
  el.textContent = (saved && collapseSpaces(saved)) ? collapseSpaces(saved) : 'فهد حامد الزهراني';
})();
document.getElementById('editPrincipalBtn').addEventListener('click',()=>{
  const el=document.getElementById('signPrincipalName');
  const current=el.textContent.trim();
  const v=prompt('اسم مدير المدرسة:', current||'');
  if(v!==null){
    const name=collapseSpaces(v)||'—';
    el.textContent=name;
    localStorage.setItem(LS_PRINCIPAL,name);
  }
});

/* تبديل المراحل */
const stageButtons=[...document.querySelectorAll('.stage-btn')];
const stagePanels={ planning:document.getElementById('stage-planning'), mid:document.getElementById('stage-mid'), final:document.getElementById('stage-final') };
function setStageLabel(key){ s_stage.textContent= key==='planning'?'التخطيط': key==='mid'?'المراجعة النصف سنوية':'التقييم النهائي'; }
function applyStageState(key){
  document.body.setAttribute('data-stage', key);
  const isPlanning = key==='planning';
  document.querySelectorAll('select.grade').forEach(s=> s.disabled = isPlanning);
  if(isPlanning){ barRow.classList.add('dim'); scoreChip.textContent='وضع التخطيط: المؤشر غير مُفعّل'; percentChip.textContent='—'; }
  else{ barRow.classList.remove('dim'); recalc(); }
  setStageLabel(key);
}
Object.values(stagePanels).forEach(p=>{p.classList.remove('open'); p.style.maxHeight='0px';});
applyStageState('planning');
stageButtons.forEach(b=>{
  b.addEventListener('click',()=>{
    const key=b.dataset.stage, panel=stagePanels[key];
    const isOpen=panel.classList.contains('open');
    Object.values(stagePanels).forEach(p=>{p.classList.remove('open'); p.style.maxHeight='0px';});
    if(!isOpen){ panel.classList.add('open'); panel.style.maxHeight=panel.scrollHeight+'px'; }
    stageButtons.forEach(x=>x.classList.toggle('active', x===b));
    applyStageState(key);
  });
});

/* شد الصفحة لصفحة واحدة عند الطباعة */
const SHEET=document.getElementById('sheet');
function fitOnceForA4(){
  const page=document.getElementById('page');
  const prevMinH=page.style.minHeight, prevH=page.style.height, prevDisp=page.style.display;
  page.style.minHeight='297mm'; page.style.height='297mm'; page.style.display='block';
  const mmToPx=3.78; const avail=(297-14)*mmToPx;
  const h=SHEET.scrollHeight;
  const scale=Math.min(1,(avail/h)*0.995);
  SHEET.dataset.prev=SHEET.style.transform||'';
  SHEET.style.transform=`scale(${scale})`;
  return ()=>{ if(SHEET.dataset.prev!==undefined){SHEET.style.transform=SHEET.dataset.prev; delete SHEET.dataset.prev;}
               page.style.minHeight=prevMinH; page.style.height=prevH; page.style.display=prevDisp; };
}

/* تحقق قبل الطباعة/الحفظ */
function validateCommon(){
  const name=getCleanVal('tName');
  const id=getCleanVal('tId');
  const spec=getCleanVal('tSpec');
  if(!name){ alert('رجاءً اكتب اسم المعلم.'); document.getElementById('tName').focus(); return false; }
  if(!/^\d{10}$/.test(id)){ alert('رجاءً أدخل رقم هوية صحيحًا (10 أرقام).'); document.getElementById('tId').focus(); return false; }
  if(!spec){ alert('رجاءً اكتب التخصص.'); document.getElementById('tSpec').focus(); return false; }
  return true;
}
function validatePlanningGoals(){
  const g1=collapseSpaces(document.getElementById('g1')?.value||'');
  const g2=collapseSpaces(document.getElementById('g2')?.value||'');
  const g3=collapseSpaces(document.getElementById('g3')?.value||'');
  const g4=collapseSpaces(document.getElementById('g4')?.value||'');
  const missing=[g1,g2,g3,g4].map((g,i)=>!g? (i+1):null).filter(Boolean);
  if(missing.length){ alert('مرحلة التخطيط تتطلب إدخال الأهداف الأربعة قبل الطباعة/الحفظ/الإرسال.\nالأهداف الناقصة: '+missing.join('، ')); return false; }
  return true;
}
function validateBeforeExport(){
  if(!validateCommon()) return false;
  if(document.body.dataset.stage==='planning' && !validatePlanningGoals()) return false;
  return true;
}

/* زر الطباعة */
document.getElementById('printBtn').addEventListener('click', ()=>{
  if(!validateBeforeExport()) return;
  const isPlanning = document.body.dataset.stage==='planning';
  const wasOpen = stagePanels.planning.classList.contains('open');
  if(isPlanning && !wasOpen){
    stagePanels.planning.classList.add('open'); stagePanels.planning.style.maxHeight=stagePanels.planning.scrollHeight+'px';
  }
  const undo=fitOnceForA4();
  setTimeout(()=>window.print(),60);
  setTimeout(()=>{
    undo();
    if(isPlanning && !wasOpen){
      stagePanels.planning.classList.remove('open'); stagePanels.planning.style.maxHeight='0px';
    }
  }, 800);
});

/* حفظ PDF (صورة للحروف العربية السليمة) */
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  if(!validateBeforeExport()) return;
  try{
    document.body.classList.add('for-capture');
    const isPlanning = document.body.dataset.stage==='planning';
    const wasOpen = stagePanels.planning.classList.contains('open');
    if(isPlanning && !wasOpen){
      stagePanels.planning.classList.add('open'); stagePanels.planning.style.maxHeight=stagePanels.planning.scrollHeight+'px';
      await new Promise(r=>setTimeout(r,60));
    }
    const name=(getCleanVal('tName')||'غير مسمى').replace(/[\\/:*?"<>|]/g,'-');
    const stageLabel=s_stage.textContent.trim();
    const filename=`تقييم الأداء الوظيفي - ${name} - مرحلة ${stageLabel} - ${hijriToday}.pdf`;

    const page=document.getElementById('page');
    const prevMinH=page.style.minHeight, prevH=page.style.height, prevDisp=page.style.display;
    page.style.minHeight='297mm'; page.style.height='297mm'; page.style.display='block';

    const canvas=await html2canvas(page,{useCORS:true,scale:2,background:'#ffffff',scrollX:0,scrollY:0,windowWidth:page.scrollWidth,windowHeight:page.scrollHeight});
    const imgData=canvas.toDataURL('image/png',1.0);
    const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
    const margin=5; const pdfW=210-2*margin, pdfH=297-2*margin;
    const imgWmm=canvas.width*0.264583, imgHmm=canvas.height*0.264583;
    const ratio=Math.min(pdfW/imgWmm, pdfH/imgHmm); const w=imgWmm*ratio, h=imgHmm*ratio;
    const x=margin+(pdfW-w)/2, y=margin+(pdfH-h)/2;
    pdf.addImage(imgData,'PNG',x,y,w,h,'','FAST'); pdf.save(filename);

    page.style.minHeight=prevMinH; page.style.height=prevH; page.style.display=prevDisp;
    if(isPlanning && !wasOpen){ stagePanels.planning.classList.remove('open'); stagePanels.planning.style.maxHeight='0px'; }
  }catch(err){ alert('تعذّر الحفظ PDF.'); console.error(err);
  }finally{ document.body.classList.remove('for-capture'); }
});

/* واتساب */
const LS_WA='yaqubi_whatsapp_phone';
const waBtn=document.getElementById('waBtn');
const waConfigBtn=document.getElementById('waConfigBtn');
const waModal=document.getElementById('waModal');
const waPhone=document.getElementById('waPhone');
const waSave=document.getElementById('waSave');
const waClose=document.getElementById('waClose');
let waPendingSend=false;

function isPhoneOk(v){ const d=digitsOnly(v); return /^\d{11,15}$/.test(d) ? d : ''; }
function openModal(pending=false){ waPendingSend=pending; waPhone.value=localStorage.getItem(LS_WA)||''; waModal.classList.add('show'); setTimeout(()=>waPhone.focus(),80); }
function closeModal(){ waModal.classList.remove('show'); waPendingSend=false; }
waConfigBtn.addEventListener('click',()=>openModal(false));
waBtn.addEventListener('click',(ev)=>{
  if(!validateBeforeExport()) return;
  const saved=isPhoneOk(localStorage.getItem(LS_WA)||'');
  if(saved){ sendWhatsApp(saved); }
  else{ ev.preventDefault(); openModal(true); }
});
waClose.addEventListener('click',closeModal);
waModal.querySelector('.backdrop').addEventListener('click',closeModal);
waSave.addEventListener('click',()=>{
  const digits=isPhoneOk(waPhone.value.trim());
  if(!digits){ alert('أدخل رقمًا دوليًا صحيحًا بدون + (مثال: 9665XXXXXXXX).'); return; }
  localStorage.setItem(LS_WA, digits);
  const toSend=waPendingSend; closeModal();
  if(toSend){ sendWhatsApp(digits); } else { alert('تم حفظ رقم واتساب المدير.'); }
});
function collectGoals(){
  const g1=collapseSpaces(document.getElementById('g1')?.value||'');
  const g2=collapseSpaces(document.getElementById('g2')?.value||'');
  const g3=collapseSpaces(document.getElementById('g3')?.value||'');
  const g4=collapseSpaces(document.getElementById('g4')?.value||'');
  return [g1,g2,g3,g4].filter(Boolean);
}
function sendWhatsApp(phoneDigits){
  const name=getCleanVal('tName');
  const spec=getCleanVal('tSpec');
  const id=getCleanVal('tId');
  const school=document.getElementById('schoolNameDisplay').textContent.trim();
  const sector=document.getElementById('sectorNameDisplay').textContent.trim();
  const stageLabel=s_stage.textContent.trim();

  let msg = `السلام عليكم،\n${school} (${sector})\nالاسم: ${name}\nالهوية: ${id}\nالتخصص: ${spec}\nمرحلة التقييم: ${stageLabel}\nاسم المعلم للتوقيع: ${name}\n`;
  if(document.body.dataset.stage==='planning'){
    const goals=collectGoals();
    msg += `\nأهداف مرحلة التخطيط:\n`;
    if(goals.length){ goals.forEach((g,i)=>{ msg+=`${i+1}- ${g}\n`; }); }
    else { msg += `— لم تُسجل أهداف بعد —\n`; }
  }else{
    const S=recalc();
    msg += `${document.getElementById('scoreChip').textContent} | ${document.getElementById('percentChip').textContent}\nالتقدير العام: ${S.overall}\n`;
  }
  msg += `\nالتاريخ الهجري: ${hijriToday}`;
  const encoded=encodeURIComponent(msg);
  const url=`https://api.whatsapp.com/send?phone=${phoneDigits}&text=${encoded}`;
  const win=window.open(url,'_blank');
  setTimeout(()=>{ if(!win || win.closed || typeof win.closed==='undefined'){ window.location.href=`https://wa.me/${phoneDigits}?text=${encoded}`; }},400);
}

/* استيراد/تصدير Excel (مع تنظيف) */
const LS_TEACHERS='yaqubi_teachers_v16';
let teachers=[];
const tSelect=document.getElementById('tSelect');

function saveTeachersList(){ localStorage.setItem(LS_TEACHERS, JSON.stringify(teachers)); }
function loadTeachers(){
  const raw=localStorage.getItem(LS_TEACHERS);
  teachers = raw ? (JSON.parse(raw)||[]) : [];
  rebuildTeacherUI();
}
function clearTeachers(){
  if(!confirm('سيتم مسح جميع بيانات المعلمين المحفوظة. هل تريد المتابعة؟')) return;
  localStorage.removeItem(LS_TEACHERS);
  teachers=[]; rebuildTeacherUI();
  alert('تم مسح جميع بيانات المعلمين.');
}
document.getElementById('clearTeachersBtn').addEventListener('click',clearTeachers);

function rebuildTeacherUI(){
  tSelect.innerHTML='<option value="">— اختر اسمًا —</option>';
  if(teachers.length>0){
    teachers.forEach((t,i)=>{ const op=document.createElement('option'); op.value=String(i); op.textContent=t.name; tSelect.appendChild(op); });
    tSelect.style.display='inline-block';
    applyTeacherToForm(teachers[0]);
  }else{
    tSelect.style.display='none';
    ['tName','tId','tSpec'].forEach(id=>{
      const el=document.getElementById(id);
      if(!el.value.trim()){ el.value=HINTS[id]; el.classList.add('hint'); }
    });
    updateSummary();
  }
}
function applyTeacherToForm(t){
  document.getElementById('tName').value=t.name||HINTS.tName;
  document.getElementById('tId').value=t.id||HINTS.tId;
  document.getElementById('tSpec').value=t.spec||HINTS.tSpec;
  ['tName','tId','tSpec'].forEach(id=>{
    const el=document.getElementById(id);
    el.classList.toggle('hint', el.value===HINTS[id]);
  });
  if(t.goals){ ['g1','g2','g3','g4'].forEach((gid,ix)=>document.getElementById(gid).value=t.goals[ix]||''); }
  if(t.grades){ gradesEls().forEach((sel,i)=> sel.value = t.grades[i]||sel.value); recalc(); }
  updateSummary();
}
function normalizeHeader(h){
  if(!h) return '';
  h=String(h).trim().toLowerCase();
  const map={'name':'name','الاسم':'name','teacher':'name','fullname':'name','full name':'name',
             'id':'id','identity':'id','الهوية':'id','رقم الهوية':'id','national id':'id',
             'spec':'spec','specialization':'spec','التخصص':'spec','major':'spec','subject':'spec'};
  return map[h]||h;
}
document.getElementById('excelInput').addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data);
    const sh=wb.Sheets[wb.SheetNames[0]];
    const raw=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
    if(raw.length===0){ alert('الملف فارغ'); return; }
    const headers=raw[0].map(h=>normalizeHeader(h));
    const rows=raw.slice(1);
    const newTeachers=[];
    rows.forEach(r=>{
      if(r.every(c=>String(c).trim()==='')) return;
      const obj={name:'',id:'',spec:''};
      r.forEach((cell,idx)=>{
        const key=headers[idx]||'';
        if(key.includes('name')) obj.name=collapseSpaces(cell);
        else if(key.includes('id')) obj.id=digitsOnly(cell);
        else if(key.includes('spec')) obj.spec=collapseSpaces(cell);
      });
      if(!obj.name && r[0]) obj.name=collapseSpaces(r[0]);
      if(!obj.id && r[1]) obj.id=digitsOnly(r[1]);
      if(!obj.spec && r[2]) obj.spec=collapseSpaces(r[2]);
      if(obj.name) newTeachers.push(obj);
    });
    if(newTeachers.length===0){ alert('لم يتم العثور على بيانات صالحة. تأكد من أعمدة (الاسم/الهوية/التخصص).'); return; }
    teachers=newTeachers; saveTeachersList(); rebuildTeacherUI();
    alert('تم استيراد القائمة بنجاح.');
  }catch(err){ console.error(err); alert('فشل استيراد الملف.'); }
  finally{ e.target.value=''; }
});
tSelect.addEventListener('change',()=>{
  if(tSelect.value==="") return;
  const t=teachers[Number(tSelect.value)];
  applyTeacherToForm(t);
});
document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
  if(!teachers || teachers.length===0){ alert('لا توجد بيانات لتصدير.'); return; }
  const header=['الاسم','الهوية','التخصص'];
  const data=teachers.map(t=>[t.name,t.id,t.spec]);
  const ws=XLSX.utils.aoa_to_sheet([header,...data]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'المعلمون');
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  saveAs(new Blob([wbout],{type:'application/octet-stream'}),'قائمة_المعلمين.xlsx');
});
document.getElementById('importTemplateBtn').addEventListener('click', ()=>{
  const header=['الاسم','الهوية','التخصص'];
  const ws=XLSX.utils.aoa_to_sheet([header,['مثال: محمد علي','1010101010','رياضيات']]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'قالب_المعلمين');
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  saveAs(new Blob([wbout],{type:'application/octet-stream'}),'قالب_المعلمين.xlsx');
});

/* قفل/اعتماد النهائي */
const lockBtn=document.getElementById('lockFinalBtn');
const approveBtn=document.getElementById('approveFinalBtn');
if(lockBtn) lockBtn.addEventListener('click', ()=>{ document.querySelectorAll('select.grade').forEach(el=> el.disabled = true); alert('تم قفل الدرجات. يمكنك الاعتماد الآن.'); });
if(approveBtn) approveBtn.addEventListener('click', ()=>{ alert('تم اعتماد الدرجة النهائية. يُفضَّل حفظ PDF الآن.'); });

/* حفظ/مسح بيانات المعلم (أيقونات جديدة) */
function collectTeacherFromForm(){
  const name=getCleanVal('tName');
  const id=getCleanVal('tId');
  const spec=getCleanVal('tSpec');
  const goals=['g1','g2','g3','g4'].map(gid=>collapseSpaces(document.getElementById(gid)?.value||''));
  const grades=gradesEls().map(sel=>Number(sel.value));
  return {name,id,spec,goals,grades,stage:document.body.dataset.stage||'planning'};
}
function upsertTeacher(t){
  // إن وجد بنفس الهوية، حدّث، وإلا أضف
  let idx=teachers.findIndex(x=>x.id && t.id && x.id===t.id);
  if(idx<0){ idx=teachers.findIndex(x=>x.name===t.name && t.name); }
  if(idx>=0){ teachers[idx]=t; } else { teachers.push(t); }
  // إعادة بناء القائمة
  saveTeachersList(); rebuildTeacherUI();
  // إذا وجد عنصر مطابق اختره بالقائمة
  const foundIndex=teachers.findIndex(x=>x.id===t.id && t.id);
  if(foundIndex>=0){ tSelect.value=String(foundIndex); }
}
document.getElementById('saveTeacherBtn').addEventListener('click', ()=>{
  if(!validateCommon()) return;
  if(document.body.dataset.stage==='planning' && !validatePlanningGoals()) return;
  const t=collectTeacherFromForm();
  upsertTeacher(t);
  alert('تم حفظ بيانات المعلم.');
});
document.getElementById('clearOneBtn').addEventListener('click', ()=>{
  const id=getCleanVal('tId');
  const name=getCleanVal('tName');
  if(!id && !name){ alert('لا يمكن التحديد. يرجى إدخال الاسم أو الهوية.'); return; }
  if(!confirm('سيتم مسح بيانات هذا المعلم. متابعة؟')) return;
  const before=teachers.length;
  teachers=teachers.filter(x=> !( (id && x.id===id) || (!id && name && x.name===name) ));
  saveTeachersList(); rebuildTeacherUI();
  alert(before!==teachers.length? 'تم مسح بيانات المعلم.' : 'لم يتم العثور على سجل مطابق.');
});

/* تحسين للجوال */
(function mobileTune(){ if(window.innerWidth<640){ document.documentElement.style.fontSize='14px'; }})();

/* تحميل بيانات المعلمين إن وجدت */
loadTeachers();
</script>
</body>
</html>
