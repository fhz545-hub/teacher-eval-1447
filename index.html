<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</title>
<meta name="theme-color" content="#0b7e88">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">

<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{ --moe:#0b7e88; --ink:#111; --label:#064c50; --bg:#f7fafc; --content:190mm; --nudgeX:0mm; --scale:1; }
*{box-sizing:border-box}
html,body{ margin:0;background:var(--bg);color:var(--ink);
  font:13.8px/1.9 "Tajawal","Noto Sans Arabic","Noto Naskh Arabic",system-ui;
  -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility; }
.sheet-wrap{display:grid;place-items:center;margin:10mm 0;padding:8px}
.sheet{ width:210mm;min-height:297mm;background:#fff;
  transform:translateX(var(--nudgeX)) scale(var(--scale));
  transform-origin: top center; filter: contrast(1.06); }

/* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± (ÙŠØ³Ø§Ø±: Ø§Ù„Ù…Ù…Ù„ÙƒØ© | ÙˆØ³Ø·: Ø§Ù„Ø´Ø¹Ø§Ø± | ÙŠÙ…ÙŠÙ†: Ø§Ù„ØªØ§Ø±ÙŠØ®) ===== */
.header{padding:8mm 12mm 6mm;border-bottom:2px solid #eaf1f1}
.hdr-grid{
  display:grid;
  grid-template-columns: 1fr 150px 1fr; /* ÙŠØ³Ø§Ø± | ÙˆØ³Ø· | ÙŠÙ…ÙŠÙ† */
  align-items:center; gap:12mm;
}

/* ÙŠØ³Ø§Ø±: Ø§Ù„Ù…Ù…Ù„ÙƒØ©/Ø§Ù„ÙˆØ²Ø§Ø±Ø©/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„Ù…Ø¯Ø±Ø³Ø© â€” (ØªÙ… Ø§Ù„ØªÙˆØ³ÙŠØ· ÙˆØ§Ù„ØªØµØºÙŠØ±) */
.hdr-left-org{
  justify-self:start;
  display:flex; align-items:center; justify-content:center; /* ØªÙˆØ³ÙŠØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
  text-align:center;
}
.org{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:var(--label); line-height:1.2; max-width:100%;
}
.org .l1{font-weight:900;font-size:13.2px}
.org .l2{font-weight:900;font-size:12.2px}
.org .l3{font-weight:800;font-size:12.2px}

/* ÙˆØ³Ø·: Ø§Ù„Ø´Ø¹Ø§Ø± (ÙƒÙ…Ø§ Ù‡Ùˆ) */
.hdr-center{ justify-self:center; text-align:center; }
.hdr-center img{
  width:150px;height:150px;object-fit:contain;display:block;margin:0 auto;
  image-rendering:-webkit-optimize-contrast;
}

/* ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø±Ù‚Ù… + Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù…Ø²Ø§Ø­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ÙŠØ³Ø§Ø±) â€” ÙƒÙ…Ø§ Ù‡Ùˆ */
.hdr-right-info{ justify-self:end; text-align:right; transform: translateX(-8mm); }
.meta-item{display:block;white-space:nowrap;margin:0 0 2px}
.meta-item .label{font-weight:900;color:var(--label);margin-left:4px}
.meta-item .value{font-weight:900}
.case-total{margin-top:4px;font-size:12px;color:#2f4f4b}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
.toolbar{position:sticky;top:0;z-index:10;display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:10px 12px;background:#fff;border-bottom:1px solid #eee}
.toolbar button{border:0;border-radius:10px;padding:9px 12px;cursor:pointer;background:var(--moe);color:#fff;font-weight:800}
.toolbar .secondary{background:#eef7f7;color:#0b5e63;border:1px solid #d7ecec}
.toolbar input[type=file]{display:none}
.toolbar .hint{font-size:12px;color:#6b7280}
.select,.search,.t{padding:8px 10px;border:1px solid #d7ecec;border-radius:10px;background:#fff}
.toolbar-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;width:100%}
.controls-row{width:100%;display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:8px;padding-top:6px;border-top:1px dashed #e5efef}
.controls-row .block{display:flex;align-items:center;gap:6px}
.controls-row .pack{display:flex;align-items:center;gap:4px}

/* Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
.page{padding:6mm 0 10mm;display:grid;place-items:center}
.content{width:var(--content);margin:0 auto}

/* Ø¹Ù†ÙˆØ§Ù† */
.notice-center{width:var(--content);margin:5mm auto 2mm;display:flex;flex-direction:column;align-items:center;gap:6px}
.notice-center .title{font-weight:900;font-size:28px;line-height:1.1;color:#0b5e63;filter:contrast(120%)}
.seg{display:inline-flex;background:#eef7f7;border:1px solid #d7ecec;border-radius:999px;overflow:hidden}
.seg input{display:none}
.seg label{padding:10px 16px;cursor:pointer;font-weight:800;color:#0b5e63;user-select:none}
.seg input:checked+label{background:#0b7e88;color:#fff}

/* Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… */
.table-wrap{width:var(--content);margin:4mm auto 0;display:flex;justify-content:center;overflow-x:auto}
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl thead th{ background:#0b5e63;color:#fff;border:1.2px solid #244a4a;
  padding:6px 7px;text-align:center;font-weight:900;font-size:13px}
.tbl td{ border:1.2px solid #3f5b57;padding:5px 7px;vertical-align:middle;
  height:12mm;font-size:13.2px;line-height:1.55;background:#fff;text-align:center}
.tbl thead th.name,.tbl td.name{width:38%}
.tbl thead th.spec,.tbl td.spec{width:14%}
.tbl thead th.level,.tbl td.level{width:16%}
.tbl thead th.job,.tbl td.job{width:16%}
.tbl thead th.work,.tbl td.work{width:16%}
.tbl td span[contenteditable]{display:block;outline:none;overflow-wrap:anywhere;word-break:break-word;font-weight:700}
.tbl td.name span[contenteditable]{font-size:15.5px;font-weight:900}

/* Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ â€” Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
.below-flex{width:var(--content);margin:2mm auto 0;display:flex;flex-direction:row-reverse;justify-content:flex-end}
.civil-badge{ width:38%;display:flex;align-items:center;gap:10px;justify-content:center;
  border:1.5px solid var(--moe);background:#fff;color:#0b3340;border-radius:12px;min-height:9.5mm;padding:3px 6px}
.civil-badge .labTag{background:var(--moe);color:#fff;font-weight:900;padding:2px 10px;border-radius:8px;white-space:nowrap}
.civil-badge .civilValue{background:#fff;padding:0 6px;border-radius:6px;min-width:42mm;display:inline-block;text-align:center;font-weight:900}

/* Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
.sec{width:var(--content);margin:6mm auto;padding:0}
.sec h3{margin:0 0 8px;color:#0b5e63}
.sec h3 .kind{color:#0b7e88}
.rule-row{display:flex;align-items:center;gap:8px;margin-top:4px}
.rule-row .label{font-weight:900;white-space:nowrap}
.rule-row .dots{flex:1;border-bottom:1px dotted #9fb7b3;height:0}
.rule-row .leftnote{white-space:nowrap}
.dotfield{display:inline-block;min-width:28mm;border-bottom:1px dotted #9fb7b3;text-align:center;padding:0 2mm}
.checks{margin:6px 0 8px}
.checkline{display:flex;align-items:flex-start;gap:8px;margin:6px 0}
.checkline input{margin-top:4px;transform:scale(1.15)}
.checkline .text{flex:1}
.calc{font-weight:900;color:#0b5e63}
.timebox{display:inline-block;min-width:28mm;text-align:center;padding:.5mm 3mm;background:#fff;color:#111;font-weight:900;border-radius:6px;border:1px solid #000;font-family:ui-monospace,Consolas,monospace}
.timebox.empty{color:#777;border-color:#bbb}

/* Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨ */
.abs-pack{width:var(--content);margin:6mm auto}
.abs-pack h3{margin:0 0 8px;color:#0b5e63}
.abs-pack .para{margin:0 0 6px}
.abs-pack .lines{min-height:28mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe}
.abs-pack .lines div{height:10mm;border-bottom:1px dotted #9fb7b3}
.abs-pack .lines div:last-child{border-bottom:0}
.abs-pack .choices label{display:block;margin:6px 0}
.abs-pack .note{color:#374151;font-size:11.2px;line-height:1.85;margin-top:6mm}

/* Ù„ÙØª Ø§Ù„Ù†Ø¸Ø± */
.reason-wrap{display:inline;padding:0;border:0;vertical-align:middle}
.reason-wrap select{
  width:22px;height:22px;border:none;background:transparent;color:transparent;
  appearance:auto;-webkit-appearance:auto;-moz-appearance:auto;vertical-align:-2px;cursor:pointer;padding:0;margin-inline-start:6px;
}
#noteReasonText{font-weight:900}

/* Ù…Ù„Ø§Ø­Ø¸Ø© ØµØºÙŠØ±Ø© */
.small-muted{font-size:11px;color:#6b7280;margin-top:6px}

/* Ù„Ø§ ØªÙØ·Ø¨Ø¹ */
.rights{width:var(--content);margin:2mm auto 8mm;text-align:center;font-size:9.2px;color:#6b7280;font-weight:700}
@media print{ .rights{display:none !important} }
body.exporting .rights{display:none !important}
body.exporting .seg{display:none !important}

/* Ø·Ø¨Ø§Ø¹Ø© */
@media print{
  @page{size:A4;margin:9mm}
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  body{background:#fff;color:#000}
  .toolbar{display:none !important}
  .sheet-wrap{margin:0}
  .sheet{margin:0;transform:translateX(var(--nudgeX)) scale(1) !important;filter:none !important}
  .page{padding:0;display:block}
  :root{--content:190mm}
  .content,.notice-center,.table-wrap,.below-flex,.sec,.abs-pack{width:var(--content) !important;margin:0 auto !important}
  .tbl td,.tbl th{border-color:#000 !important}
  .reason-wrap{display:none !important}
}

/* Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
#importDialog{display:none;position:fixed;inset:0;z-index:400;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:12px}
#importCard{background:#fff;border-radius:14px;min-width:320px;max-width:900px;width:90%;padding:16px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.25)}
#previewTable th,#previewTable td{border:1px solid #e5efef;padding:6px 8px;text-align:center}
#previewTable{border-collapse:collapse;width:100%}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
#statsDialog{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:300;align-items:center;justify-content:center;padding:12px}
#statsCard{background:#fff;border-radius:14px;min-width:320px;max-width:1100px;width:96%;padding:14px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.25)}
#statsCard h3{margin:0 0 8px;color:#0b5e63}
.stats-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
.stats-actions button{border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
.stats-actions .primary{background:var(--moe);color:#fff}
.stats-actions .ghost{background:#eef7f7;color:#0b5e63;border:1px solid #d7ecec}
.stats-grid{display:grid;grid-template-columns:1fr;gap:10px}
.stats-table{width:100%;border-collapse:collapse}
.stats-table th{background:#0b5e63;color:#fff;border:1px solid #2e4a4a;padding:6px 7px}
.stats-table td{border:1px solid #3f5b57;padding:5px 7px;background:#fff;text-align:center}
@media (min-width:900px){ .stats-grid{grid-template-columns: 1fr 1fr;}}
</style>
</head>
<body>

<!-- Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
<div class="toolbar">
  <div class="toolbar-row">
    <button id="btnMakePDF" class="secondary">ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ PDF</button>
    <button id="btnWA" class="secondary">ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨</button>
    <button id="btnOpenStats" class="secondary" title="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ£Ø±Ø´ÙŠÙ">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    <button id="btnClearImport" class="secondary" title="Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡/Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>

    <div class="drop" id="dropZone" style="display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px dashed #d7ecec;border-radius:10px;cursor:pointer">
      <button id="btnImport" class="secondary">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.ods,.csv,.tsv,.txt,.json">
      <span class="hint">Ø£ÙÙ„Øª Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</span>
    </div>

    <span class="hint">Ø§Ø¨Ø­Ø« ÙˆØ§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹:</span>
    <input id="teacherSearch" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦">
    <select id="teacherSelect" class="select" style="min-width:220px">
      <option value="">â€” Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ â€”</option>
    </select>
  </div>

  <div class="controls-row">
    <div class="block">
      <span class="hint">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ§Ù‚Ø¹Ø© (Ù‡Ø¬Ø±ÙŠ):</span>
      <div class="pack">
        <select id="hjDay" class="select"></select>
        <select id="hjMonth" class="select"></select>
        <select id="hjYear" class="select"></select>
      </div>
    </div>
    <div class="block"><span class="hint">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…:</span><input id="workStart" class="t" type="time" value="06:45" step="60"></div>
    <div class="block"><span class="hint">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…:</span><input id="workEnd" class="t" type="time" value="13:45" step="60"></div>
  </div>
</div>

<div class="sheet-wrap">
  <div class="sheet" id="sheet">
    <!-- ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== -->
    <div class="header">
      <div class="hdr-grid">

        <!-- ÙŠØ³Ø§Ø±: Ø§Ù„Ù…Ù…Ù„ÙƒØ© / Ø§Ù„ÙˆØ²Ø§Ø±Ø© / Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© / Ø§Ù„Ù…Ø¯Ø±Ø³Ø© -->
        <div class="hdr-left-org">
          <div class="org">
            <div class="l1">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
            <div class="l2">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
            <div class="l3">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</div>
            <div class="l3" id="schoolNameHdr">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</div>
          </div>
        </div>

        <!-- Ø§Ù„ÙˆØ³Ø·: Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø© -->
        <div class="hdr-center">
          <img src="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ….png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" id="moeLogo" draggable="false" crossOrigin="anonymous">
        </div>

        <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø±Ù‚Ù… + Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ -->
        <div class="hdr-right-info meta">
          <div class="meta-item"><span class="label">Ø§Ù„Ø±Ù‚Ù…:</span><span class="value" id="serialNo">01</span></div>
          <div class="meta-item"><span class="label"> Ø§Ù„ØªØ§Ø±ÙŠØ® :</span><span class="value" id="hdrHijri">Ù¡Ù¤Ù¤Ù§/Ù Ù¤/Ù¡Ù£ Ù‡Ù€</span></div>
          <div class="case-total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø§Ø¡Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…: <strong id="caseTotal">0</strong></div>
        </div>

      </div>
    </div>
    <!-- ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‡ÙŠØ¯Ø± ===== -->

    <div class="page">
      <div class="content">

        <!-- Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ -->
        <div class="notice-center">
          <div class="title" id="mainTitle">ØªÙ†Ø¨ÙŠÙ‡</div>
          <div class="seg" id="noticeSeg">
            <input type="radio" name="nt" id="nt-note"  value="note"><label for="nt-note">Ù„ÙØª Ù†Ø¸Ø±</label>
            <input type="radio" name="nt" id="nt-gaib"  value="gaib"><label for="nt-gaib">ØºÙŠØ§Ø¨</label>
            <input type="radio" name="nt" id="nt-late"  value="late" checked><label for="nt-late">ØªØ£Ø®Ø±</label>
            <input type="radio" name="nt" id="nt-abs"   value="absent"><label for="nt-abs">Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯</label>
            <input type="radio" name="nt" id="nt-early" value="early"><label for="nt-early">Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±</label>
          </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… -->
        <div class="table-wrap">
          <table class="tbl" aria-label="Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù">
            <thead>
              <tr>
                <th class="name">Ø§Ù„Ø§Ø³Ù…</th>
                <th class="spec">Ø§Ù„ØªØ®ØµØµ</th>
                <th class="level">Ø§Ù„Ù…Ø±ØªØ¨Ø©</th>
                <th class="job">Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ©</th>
                <th class="work">Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="name"><span id="t_name"  contenteditable="true"></span></td>
                <td class="spec"><span id="t_spec"  contenteditable="true"></span></td>
                <td class="level"><span id="t_level" contenteditable="true"></span></td>
                <td class="job"><span  id="t_job"   contenteditable="true"></span></td>
                <td class="work"><span id="t_work"  contenteditable="true"></span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ -->
        <div class="below-flex">
          <div class="civil-badge">
            <span class="labTag">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</span>
            <span id="t_civil" class="civilValue" contenteditable="true"></span>
          </div>
        </div>

        <!-- (Ø£) Ø­Ø²Ù…Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
        <div id="alertPack">
          <div class="sec">
            <h3>( 1 ) Ø®Ø·Ø§Ø¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ â€” <span class="kind" id="kindTitle">ØªØ£Ø®Ø±</span></h3>

            <div class="rule-row">
              <span class="label">Ø§Ù„Ù…ÙƒØ±Ù… Ø§Ù„Ù…Ø¹Ù„Ù… :</span>
              <span class="dots"></span>
              <span class="leftnote">ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡</span>
            </div>

            <p style="margin:6px 0 2px"><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡</strong></p>
            <p style="margin:0 0 6px">ÙˆØ¨Ø¹Ø¯ :</p>

            <p style="margin:0 0 6px">
              Ø¥Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ…
              <span class="dotfield" id="dayField"><span id="dynDay">â€”</span></span>
              Ø§Ù„Ù…ÙˆØ§ÙÙ‚
              <span class="dotfield" id="hijriField"><span id="dynHijri">â€”</span> Ù‡Ù€</span>
              :
            </p>

            <div class="checks">
              <label id="lineLate" class="checkline">
                <input type="checkbox" checked>
                <span class="text">
                  ØªØ£Ø®Ø±ÙƒÙ… Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ØŒ ÙˆØ­Ø¶ÙˆØ±ÙƒÙ… Ø§Ù„Ø³Ø§Ø¹Ø© ( <span id="tLateIn" class="timebox empty">--:--</span> ).
                  <span class="calc">â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®Ø±: <span id="lateTotal">0 Ø¯Ù‚ÙŠÙ‚Ø©</span></span>
                </span>
              </label>

              <label id="lineAbs" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯ÙƒÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© : ( <span id="tAbsFrom" class="timebox empty">--:--</span> )
                  Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© : ( <span id="tAbsTo" class="timebox empty">--:--</span> ).
                  <span class="calc">â€” Ù…Ø¯Ø© Ø¹Ø¯Ù… Ø§Ù„ØªÙˆØ§Ø¬Ø¯: <span id="absTotal">0 Ø¯Ù‚ÙŠÙ‚Ø©</span></span>
                </span>
              </label>

              <label id="lineEarly" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  Ø§Ù†ØµØ±Ø§ÙÙƒÙ… Ù…Ø¨ÙƒØ±Ù‹Ø§ Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© : ( <span id="tEarlyFrom" class="timebox empty">--:--</span> ).
                  <span class="calc">â€” Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±: <span id="earlyTotal">0 Ø¯Ù‚ÙŠÙ‚Ø©</span></span>
                </span>
              </label>
            </div>

            <p>Ø¹Ù„ÙŠÙ‡ Ù†Ø£Ù…Ù„ ØªÙˆØ¶ÙŠØ­ Ø£Ø³Ø¨Ø§Ø¨ Ø°Ù„Ùƒ Ù…Ø¹ Ø¥Ø±ÙØ§Ù‚ Ù…Ø§ ÙŠØ¤ÙŠØ¯ Ø¹Ø°Ø±ÙƒÙ… â€¦ ÙˆÙ„ÙƒÙ… ØªØ­ÙŠØ§ØªÙŠ.</p>

            <p style="margin-top:8px">
              <strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© :</strong>
              <span id="managerName1" class="dotfield" style="min-width:45mm">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
              &nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> <span class="dotfield" style="min-width:30mm"></span>
              &nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> <span class="dotfield" style="min-width:22mm"></span> Ù‡Ù€
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) Ø§Ù„Ø¥ÙØ§Ø¯Ø©</h3>
            <p><strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© :</strong> <span id="managerName2">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span></p>
            <p><strong>Ø§Ù„Ù…ÙƒØ±Ù… / Ù…Ø¯ÙŠØ± Ù…Ø¯Ø±Ø³Ø©.</strong></p>
            <p>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ ÙˆØ¨Ø¹Ø¯ :</p>
            <div style="min-height:38mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe">
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;"></div>
            </div>
            <p><span>Ø§Ù„Ø§Ø³Ù… :</span> <strong id="afadaName">â€”</strong>
               &nbsp;&nbsp;&nbsp; <span>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</span> ____________________
               &nbsp;&nbsp;&nbsp; <span>Ø§Ù„ØªØ§Ø±ÙŠØ® :</span> ____________________ Ù‡Ù€</p>
          </div>

          <div class="sec">
            <h3>( 3 ) Ø±Ø£ÙŠ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
            <p><label><input type="radio" name="opinion"> Ø¹Ø°Ø±Ù‡ Ù…Ù‚Ø¨ÙˆÙ„</label>
               &nbsp;&nbsp;<label><input type="radio" name="opinion"> Ø¹Ø°Ø±Ù‡ ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„ ÙˆÙŠÙØ­Ø³Ù… Ø¹Ù„ÙŠÙ‡</label></p>
            <p><strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© :</strong> <span id="managerName3">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span></p>
            <p><span>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</span> ____________________ &nbsp;&nbsp; <span>Ø§Ù„ØªØ§Ø±ÙŠØ® :</span> ____________________ Ù‡Ù€</p>
          </div>
        </div>

        <!-- (Ø¨) Ø­Ø²Ù…Ø© Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨ -->
        <div id="absencePack" class="abs-pack" style="display:none">
          <div class="sec" style="margin-top:0">
            <p class="para" id="absIntro">
              Ø¥Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ… <strong><span id="absDayP">â€”</span></strong>
              Ø§Ù„Ù…ÙˆØ§ÙÙ‚ <strong><span id="absDateYMD">â€”</span></strong>
              ØªØºÙŠØ¨Øª Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„.
            </p>
            <h3>( 1 ) Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙØ§Ø¯Ø©</h3>
            <p class="para"><strong>Ø§Ù„Ù…ÙƒØ±Ù… /</strong> <span id="abs-name-top">â€”</span> <span>ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡</span></p>
            <p class="para"><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡</strong> ÙˆØ¨Ø¹Ø¯ ØŒØŒØŒ</p>
            <p class="para">
              Ù…Ù† Ø®Ù„Ø§Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙˆØ§Ù… ØªØ¨ÙŠÙ† ØºÙŠØ§Ø¨ÙƒÙ… Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…ÙˆØ¶Ø­Ø© Ø¨Ø¹Ø§Ù„ÙŠØ©ØŒ Ø¢Ù…Ù„ Ø§Ù„Ø¥ÙØ§Ø¯Ø© Ø¹Ù† Ø³Ø¨Ø¨ Ø°Ù„Ùƒ
              ÙˆØ¹Ù„ÙŠÙƒÙ… ØªÙ‚Ø¯ÙŠÙ… Ù…Ø§ ÙŠØ¤ÙŠØ¯ Ø¹Ø°Ø±ÙƒÙ… Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ ÙÙ‚Ø· Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡ØŒ Ø¹Ù„Ù…Ø§Ù‹ Ø¨Ø£Ù†Ù‡ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø¥Ù„ØªØ²Ø§Ù… Ø³ÙŠØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ù„Ø§Ø²Ù… Ø­Ø³Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª.
            </p>
            <p class="para">
              <strong>Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± :</strong> <span id="managerName4">ÙÙ‡Ø¯ Ø¨Ù† Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______ Ù‡Ù€
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) Ø§Ù„Ø¥ÙØ§Ø¯Ø©</h3>
            <p class="para"><strong>Ø§Ù„Ù…ÙƒØ±Ù… / Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</strong> ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡</p>
            <p class="para"><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡</strong> ÙˆØ¨Ø¹Ø¯:</p>
            <p class="para">Ø£ÙÙŠØ¯ÙƒÙ… Ø£Ù† ØºÙŠØ§Ø¨ÙŠ ÙƒØ§Ù† Ù„Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
            <div class="lines"><div></div><div></div><div></div></div>
            <p class="para">ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ØªÙ‚Ø¯ÙŠÙ… Ù…Ø§ ÙŠØ«Ø¨Øª Ø°Ù„Ùƒ Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡.</p>
            <p class="para">
              <strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… :</strong> <span id="abs-teacher-name">â€”</span>
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______ Ù‡Ù€
            </p>
          </div>

          <div class="sec">
            <h3>( 3 ) Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
            <div class="choices">
              <label><input type="checkbox"> ØªÙØ­ØªØ³Ø¨ Ù„Ù‡ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø¸Ø§Ù…ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±.</label>
              <label><input type="checkbox"> ÙŠÙØ­ØªØ³Ø¨ ØºÙŠØ§Ø¨Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ù‡ Ù„Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø¥Ø¶Ø·Ø±Ø§Ø±ÙŠØ© Ù„Ù‚Ø¨ÙˆÙ„ Ø¹Ø°Ø±Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±ØµÙŠØ¯Ù‡ ÙŠØ³Ù…Ø­ ÙˆÙ„Ø§ ÙŠÙØ­Ø³Ù… Ø¹Ù„ÙŠÙ‡.</label>
              <label><input type="checkbox"> ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„Ø­Ø³Ù… Ù„Ø¹Ø¯Ù… Ù‚Ø¨ÙˆÙ„ Ø¹Ø°Ø±Ù‡.</label>
            </div>
            <p class="para">
              <strong>Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± :</strong> <span id="managerName5">ÙÙ‡Ø¯ Ø¨Ù† Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______ Ù‡Ù€
            </p>
          </div>

          <div class="note">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©</strong><br>
            1- ØªÙØ³ØªÙƒÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© ÙˆØªÙØ³Ù„Ù… Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ù…Ø§ ÙŠØ¬Ø¨ Ø­ÙŠØ§Ù„Ù‡Ø§.<br>
            2- Ø¥Ø°Ø§ Ø³Ø¨Ù‚ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© ØºÙŠØ§Ø¨ ÙˆÙ„Ø­Ù‚Ù‡Ø§ ØºÙŠØ§Ø¨ ØªÙØ­ØªØ³Ø¨ Ù…Ø¯Ø© Ø§Ù„ØºÙŠØ§Ø¨ ÙƒØ§Ù…Ù„Ø© Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©.<br>
            3- ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ¶Ø­ Ø§Ù„Ù…ØªØºÙŠØ¨ Ø£Ø³Ø¨Ø§Ø¨ ØºÙŠØ§Ø¨Ù‡ ÙÙˆØ± ØªØ³Ù„Ù…Ù‡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© ÙˆÙŠØ¹ÙŠØ¯Ù‡Ø§ Ù„Ø±Ø¦ÙŠØ³Ù‡.<br>
            4- ÙŠÙØ¹Ø·Ù‰ Ø§Ù„Ù…ØªØºÙŠØ¨ Ù…Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹ Ù„ØªÙ‚Ø¯ÙŠÙ… Ù…Ø§ ÙŠØ¤ÙŠØ¯ Ø¹Ø°Ø±Ù‡ ÙØ¥Ø°Ø§ Ø§Ù†Ù‚Ø¶Øª Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© ØªÙØ³ØªÙƒÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© ÙˆÙŠØªÙ… Ø§Ù„Ø­Ø³Ù….
          </div>
        </div>

        <!-- (Ø¬) Ù†Ù…ÙˆØ°Ø¬ Ù„ÙØª Ø§Ù„Ù†Ø¸Ø± -->
        <div id="notePack" class="sec" style="display:none">
          <h3>Ù†Ù…ÙˆØ°Ø¬ Ù„ÙØª Ø§Ù„Ù†Ø¸Ø±</h3>

          <p style="margin:0 0 4px">
            Ø§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„ÙØ§Ø¶Ù„/
            <span id="noteTeacherName" contenteditable="true" style="font-weight:900"></span>
            Ø­ÙØ¸Ù‡ Ø§Ù„Ù„Ù‡
          </p>
          <p style="margin:0 0 6px"><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ØŒ ÙˆØ¨Ø¹Ø¯ ØŒØŒØŒ</strong></p>

          <p id="noteParagraph" style="margin:0 0 8px">
            Ø¥Ø´Ø§Ø±Ø©Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©Ø› Ù„ÙˆØ­ÙØ¸
            <span id="noteReasonText" style="font-weight:900">Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span>.
            ÙˆÙ†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°Ù„ÙƒØŒ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ØªØ§Ù… Ø¨Ù…Ø§ ÙŠÙÙˆÙƒÙ„ Ø¥Ù„ÙŠÙƒÙ… Ù…Ù† Ù…Ù‡Ø§Ù…Ø› Ø¯Ø¹Ù…Ù‹Ø§ Ù„Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ù…Ù‡Ù†ÙŠ ÙˆØ±ÙØ¹Ù‹Ø§ Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡.
            <span class="reason-wrap" title="Ø§Ø®ØªØ± Ø³Ø¨Ø¨ Ù„ÙØª Ø§Ù„Ù†Ø¸Ø±">
              <select id="noteReasonSelect">
                <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨ â€”</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø§Ù„ØµØ¨Ø§Ø­ÙŠ Ø§Ù„Ù…ÙƒÙ„Ù‘Ù Ø¨Ù‡ ÙˆÙÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ØŒ Ù…Ù…Ø§ Ø£Ø«Ù‘Ø± Ø¹Ù„Ù‰ Ø§Ù†ØªØ¸Ø§Ù… Ø³ÙŠØ± Ø§Ù„Ø·Ø§Ø¨ÙˆØ± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ ÙˆØ§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø·Ù„Ø§Ø¨.</option>
                <option>Ø¹Ø¯Ù… Ø£Ø¯Ø§Ø¡ Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØŒ ÙˆÙ…Ø§ ÙŠØªØ±ØªØ¨ Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ø¶Ø¹Ù ÙÙŠ ØªÙ†Ø¸ÙŠÙ… Ø®Ø±ÙˆØ¬ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ¶Ù…Ø§Ù† Ø³Ù„Ø§Ù…ØªÙ‡Ù….</option>
                <option>Ø§Ù„ØªÙ‚ØµÙŠØ± ÙÙŠ Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø£Ø«Ù†Ø§Ø¡ ÙØªØ±Ø© Ø§Ù„ÙØ³Ø­Ø©ØŒ Ù…Ù…Ø§ Ù†ØªØ¬ Ø¹Ù†Ù‡ ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ© Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©.</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ØµÙ„Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø±ØºÙ… Ø¥Ø¯Ø±Ø§Ø¬Ù‡ Ø¶Ù…Ù† Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙˆÙƒÙ„Ø©.</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø£Ùˆ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³ØªÙŠ ÙˆÙÙ‚ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©.</option>
                <option>Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚ØªÙ‡Ø§ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¯ÙˆÙ† Ù…Ø¨Ø±Ø± Ù†Ø¸Ø§Ù…ÙŠØŒ Ù…Ù…Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©.</option>
                <option>Ø§Ù„ØªØ£Ø®Ø± ÙÙŠ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø¹Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠØŒ Ù…Ù…Ø§ ÙŠØ®Ù„Ù‘Ù Ø¨Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…Ø¯Ø±Ø³Ø©.</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ø·Ø§Ø¨ÙˆØ± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ Ø¯ÙˆÙ† Ø¹Ø°Ø± Ø±Ø³Ù…ÙŠØŒ ÙˆÙ‡Ùˆ Ù…Ø§ ÙŠÙØ¹Ø¯ ØªÙ‚ØµÙŠØ±Ù‹Ø§ ÙÙŠ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø·Ø© Ø¨Ø§Ù„Ù…Ø¹Ù„Ù….</option>
                <option>Ø¹Ø¯Ù… Ø­Ø¶ÙˆØ± Ù…Ø¬Ù„Ø³ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ø¨Ø§Ù„Ø±ØºÙ… Ù…Ù† ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ©ØŒ Ù…Ù…Ø§ ÙÙˆÙ‘Øª ÙØ±ØµØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„ÙØ¹Ù‘Ø§Ù„ Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± ÙˆØ¯Ø¹Ù… Ø§Ù„Ø´Ø±Ø§ÙƒØ© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©.</option>
                <option>Ø§Ù„ØªØºÙŠØ¨ Ø¹Ù† Ø§Ø¬ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±Ø³Ù…ÙŠ Ø¯ÙˆÙ† Ø¹Ø°Ø± Ù†Ø¸Ø§Ù…ÙŠØŒ ÙˆÙ‡Ùˆ Ù…Ø§ ÙŠÙØ¹Ø¯ Ù…Ø®Ø§Ù„ÙØ© Ù„Ù„Ø£Ù†Ø¸Ù…Ø© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©.</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¡Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ØŒ Ù…Ù…Ø§ ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ©.</option>
                <option>Ø±ÙØ¶ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§Ø¶Ø± Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„ØµØ§Ø¯Ø±Ø© Ù…Ù† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©ØŒ ÙˆÙ‡Ùˆ Ù…Ø§ ÙŠØ®Ø§Ù„Ù Ù…Ù‚ØªØ¶Ù‰ Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†ÙŠ.</option>
                <option>Ø±ÙØ¶ ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø£Ùˆ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„ØµØ§Ø¯Ø± Ù…Ù† Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø¯ÙˆÙ† Ù…Ø¨Ø±Ø± Ù†Ø¸Ø§Ù…ÙŠ.</option>
                <option>Ø¹Ø¯Ù… Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø¹Ù„Ù‰ Ù…Ù†ØµØ© (ÙØ§Ø±Ø³) ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙˆÙÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø¸Ù…Ø©.</option>
                <option>Ø¹Ø¯Ù… Ø¯Ø®ÙˆÙ„ÙƒÙ… Ø­ØµØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙƒÙ„Ù‘ÙÙ Ø¨Ù‡Ø§ ÙˆÙÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø¸Ù…Ø©ØŒ ÙˆÙ…Ø§ ØªØ±ØªÙ‘Ø¨ Ø¹Ù„Ù‰ Ø°Ù„Ùƒ Ù…Ù† ØªØ£Ø«ÙŠØ±Ù ÙÙŠ Ø§Ù†Ø¶Ø¨Ø§Ø· Ø³ÙŠØ± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨.</option>
                <option>ØªØ£Ø®Ù‘ÙØ±ÙƒÙ… Ø¹Ù† Ù…Ø¨Ø§Ø´Ø±Ø© Ø­ØµØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙƒÙ„Ù‘ÙÙ Ø¨Ù‡Ø§ ÙÙŠ ÙˆÙ‚ØªÙ‡Ø§ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙˆÙÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ØŒ Ø¨Ù…Ø§ ÙŠØ¤Ø«Ù‘Ø± ÙÙŠ Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø­ØµØµ ÙˆØªØ³Ù„Ø³Ù„Ù‡Ø§ ÙˆØ§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„ØªØ¹Ù„Ù‘Ù….</option>
              </select>
            </span>
          </p>

          <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª -->
          <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
            <div style="flex:1">
              <p style="margin:0 0 4px"><strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ù„Ø§Ø·Ù„Ø§Ø¹:</strong> ...............................</p>
              <p style="margin:0 0 4px"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ...............................</p>
              <p style="margin:0"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ______ / ______ / 14Ù‡Ù€</p>
              <p class="small-muted">Ù‡Ø°Ø§ Ø§Ù„ØªØ¨Ù„ÙŠØº Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø±Ø¯.</p>
            </div>
            <div style="flex:1">
              <p style="margin:0 0 4px"><strong>ØªÙˆÙ‚ÙŠØ¹ Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</strong> <span id="managerNameNote">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span></p>
            </div>
          </div>
        </div>

        <div class="rights">Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ â€” ØªØ·ÙˆÙŠØ±: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>

      </div>
    </div>
  </div>
</div>

<!-- Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
<div id="importDialog" role="dialog" aria-modal="true">
  <div id="importCard">
    <h3 style="margin-top:0;color:#0b5e63">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
    <div class="map-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0">
      <label>ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ (Sheet)</label><select id="sheetSelect"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù…</label><select id="mapName"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ / Ø§Ù„Ù‡ÙˆÙŠØ©</label><select id="mapCivil"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ®ØµØµ</label><select id="mapSpec"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø±ØªØ¨Ø© / Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label><select id="mapLevel"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ©</label><select id="mapJob"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</label><select id="mapWork"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><select id="mapSchool"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬ÙˆØ§Ù„ / ÙˆØ§ØªØ³Ø§Ø¨</label><select id="mapPhone"></select>
    </div>
    <div class="preview" style="max-height:260px;overflow:auto;border:1px solid #e5efef;border-radius:10px;margin-top:8px">
      <table id="previewTable"></table>
    </div>
    <div class="dlg-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn-ghost" id="btnCancelImport" style="border:1px solid #d7ecec;background:#eef7f7;color:#0b5e63;border-radius:10px;padding:9px 12px;font-weight:800">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-primary" id="btnConfirmImport" style="background:#0b7e88;color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div id="statsDialog" role="dialog" aria-modal="true">
  <div id="statsCard">
    <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ¥Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø³Ø§Ø¡Ù„Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
    <div class="stats-actions">
      <button id="btnExportArchive" class="ghost">ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        â¤´ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø©
        <input id="restoreInput" type="file" accept=".json" style="display:none">
      </label>
      <button id="btnResetAll" class="ghost">â†º ØªØµÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¡Ù„Ø§Øª</button>
      <span class="hint">ÙŠÙ…ÙƒÙ† ØªØµÙÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…:</span>
      <input id="statsFilter" class="search" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ø¹Ù„Ù…â€¦">
      <button id="btnCloseStats" class="primary">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="stats-grid">
      <div>
        <h3 style="margin-top:0">Ø§Ù„Ø£Ø±Ø´ÙŠÙ (ØªÙØµÙŠÙ„ÙŠ)</h3>
        <table class="stats-table" id="tblArchive">
          <thead><tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ)</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</th>
            <th>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h3 style="margin-top:0">Ù…Ù„Ø®Øµ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
        <table class="stats-table" id="tblSummary">
          <thead><tr>
            <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
            <th>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</th>
            <th>Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨</th>
            <th>ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±</th>
            <th>ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯</th>
            <th>ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±</th>
            <th>Ù„ÙØª Ù†Ø¸Ø±</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¤Ù‚Ù‘Øª -->
<div id="timePad" style="display:none;position:fixed;background:#fff;border:1px solid #e6eeee;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.25);padding:10px;z-index:200">
  <div class="display" id="timePadDisplay" style="font:700 18px ui-monospace,Consolas,monospace;text-align:center;margin-bottom:6px">--:--</div>
  <div class="grid" style="display:grid;grid-template-columns:repeat(3,44px);gap:6px;justify-content:center">
    <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
    <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
    <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
    <button data-k=":">:</button><button data-k="0">0</button><button class="del">âŒ«</button>
  </div>
  <div class="row" style="display:flex;gap:8px;justify-content:center;margin-top:8px">
    <button class="action" id="timePadSave">Ø­ÙØ¸</button><button id="timePadClose">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<script>
/* ===== Ù‡ÙˆÙŠØ© ÙˆØ«ÙˆØ§Ø¨Øª ===== */
const BASE_TITLE='Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©';
const DEFAULT_WA='966504532489';
const AR='Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©', EN='0123456789';
const en2ar = s => (s+'').replace(/[0-9]/g,d=>AR[d]);
const ar2en = s => (s+'').replace(/[Ù -Ù©]/g,d=>EN[AR.indexOf(d)]);

/* ===== ØªÙ†Ø§Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ ===== */
function fitSheet(){
  const sheet=document.getElementById('sheet');
  if(!sheet) return;
  const avail = Math.max(320, window.innerWidth - 16);
  const scale = Math.min(1, avail / sheet.offsetWidth);
  document.documentElement.style.setProperty('--scale', String(scale));
}
addEventListener('resize', fitSheet);
addEventListener('orientationchange', fitSheet);
document.addEventListener('DOMContentLoaded', fitSheet);

/* ===== ØªØ§Ø±ÙŠØ® Ø£Ù…Ù‘ Ø§Ù„Ù‚Ø±Ù‰ ===== */
function fmtHijriNoSuffix(d){
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  const DD=en2ar(parts.find(p=>p.type==='day').value.padStart(2,'0'));
  const MM=en2ar(parts.find(p=>p.type==='month').value.padStart(2,'0'));
  const YY=en2ar(parts.find(p=>p.type==='year').value);
  return `${DD}/${MM}/${YY}`;
}
function fmtHijriYMDNoSuffix(d){
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  const DD=en2ar(parts.find(p=>p.type==='day').value.padStart(2,'0'));
  const MM=en2ar(parts.find(p=>p.type==='month').value.padStart(2,'0'));
  const YY=en2ar(parts.find(p=>p.type==='year').value);
  return `${YY}/${MM}/${DD}`;
}
const wdHijri = d => new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(d);

function hijriToGregorian(y,m,d){
  const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'});
  const parts = dt => { const p=fmt.formatToParts(dt); let yy,mm,dd;
    p.forEach(q=>{ if(q.type==='year') yy=parseInt(ar2en(q.value),10);
                   if(q.type==='month') mm=parseInt(ar2en(q.value),10);
                   if(q.type==='day') dd=parseInt(ar2en(q.value),10); });
    return {yy,mm,dd}; };
  let t=new Date(1937,0,1);
  for(let i=0;i<60000;i++){
    const a=parts(t);
    if(a.yy===y && a.mm===m && a.dd===d) return new Date(t.getFullYear(),t.getMonth(),t.getDate());
    t.setDate(t.getDate()+1);
  }
  return null;
}

(function buildHijriPicker(){
  const dSel=document.getElementById('hjDay'), mSel=document.getElementById('hjMonth'), ySel=document.getElementById('hjYear');
  for(let d=1; d<=30; d++) dSel.add(new Option(en2ar(String(d).padStart(2,'0')), d));
  for(let m=1; m<=12; m++) mSel.add(new Option(en2ar(String(m).padStart(2,'0')), m));
  const now=new Date();
  const curAH=parseInt(ar2en(new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric'}).format(now)),10);
  for(let y=curAH-10; y<=curAH+10; y++) ySel.add(new Option(en2ar(y), y));
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
  dSel.value=parseInt(ar2en(parts.find(p=>p.type==='day').value),10);
  mSel.value=parseInt(ar2en(parts.find(p=>p.type==='month').value),10);
  ySel.value=parseInt(ar2en(parts.find(p=>p.type==='year').value),10);
  function update(){
    const y=+ySel.value,m=+mSel.value,d=+dSel.value;
    const g=hijriToGregorian(y,m,d); if(!g){ alert('ØªØ¹Ø°Ù‘Ø± ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ'); return; }
    const hijYMD=fmtHijriYMDNoSuffix(g);
    document.getElementById('hdrHijri').textContent = `${hijYMD} Ù‡Ù€`;
    const hijNo=fmtHijriNoSuffix(g);
    const dayName = wdHijri(g);
    document.getElementById('dynDay').textContent = dayName;
    document.getElementById('dynHijri').textContent = hijNo;
    document.getElementById('absDayP').textContent  = dayName;
    document.getElementById('absDateYMD').textContent = hijYMD;
  }
  dSel.onchange=mSel.onchange=ySel.onchange=update; update();
})();

/* ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (cache) ===== */
let TEACHERS=JSON.parse(localStorage.getItem('teachersCache')||'[]');
let currentIdx = null;
function pad2(n){return String(n).padStart(2,'0');}

/* Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± â€” ØªØ®Ø²ÙŠÙ† */
const MANAGER_KEY='managerName';
function getManagerName(){ return localStorage.getItem(MANAGER_KEY) || 'ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ'; }
function setManagerName(v){
  if(!v) return; localStorage.setItem(MANAGER_KEY, v);
  ['managerName1','managerName2','managerName3','managerName4','managerName5','managerNameNote'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent=v;
  });
}

/* ===== Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ===== */
const ARCHIVE_KEY='caseArchive_v1';
let ARCHIVE = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');

function teacherKeyFromObj(obj){
  const civil=(obj.civil||'').trim();
  const name=(obj.name||'').trim();
  return civil? ('id:'+civil) : ('name:'+name);
}
function getCurrentTeacher(){ if(currentIdx==null) return null; return TEACHERS[currentIdx] || null; }
function computeCountsFor(key){
  let total=0, byType={gaib:0, late:0, absent:0, early:0, note:0};
  for(const e of ARCHIVE){ if(e.tkey===key){ total++; if(byType[e.kind]!=null) byType[e.kind]++; } }
  return {total, byType};
}
function nextSerialFor(key){ return computeCountsFor(key).total + 1; }
function refreshHeaderCounts(){
  const t=getCurrentTeacher(); 
  if(!t){ document.getElementById('serialNo').textContent='01'; document.getElementById('caseTotal').textContent='0'; return; }
  const key=teacherKeyFromObj(t);
  document.getElementById('serialNo').textContent = pad2(nextSerialFor(key));
  document.getElementById('caseTotal').textContent = computeCountsFor(key).total;
}
function saveArchive(){ localStorage.setItem(ARCHIVE_KEY, JSON.stringify(ARCHIVE)); refreshHeaderCounts(); }

/* ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ */
function recordCase(kind, source){
  const t=getCurrentTeacher();
  if(!t){ alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ù„Ù‘Ù… Ø£ÙˆÙ„Ø§Ù‹.'); return; }
  const key=teacherKeyFromObj(t);
  const serial = nextSerialFor(key);
  const hj=document.getElementById('hdrHijri').textContent.replace('Ù‡Ù€','').trim();
  const day=document.getElementById('dynDay').textContent.trim();
  ARCHIVE.push({
    ts: Date.now(), hj, day, kind, serial, source: source || 'manual',
    tkey: key, name: (t.name||'').trim(), civil: (t.civil||'').trim()
  });
  saveArchive();
}

/* Ø±Ø¨Ø· Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ */
function refreshCaseNo(){ refreshHeaderCounts(); }

/* ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø®ØªØ§Ø± */
function applyTeacher(t, idx){
  currentIdx = idx;
  document.getElementById('schoolNameHdr').textContent = t.school || 'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©';
  const set=(id,v)=>document.getElementById(id).textContent=v||'';
  set('t_name',t.name); set('t_spec',t.spec); set('t_level',t.level||t.rank); set('t_job',t.job); set('t_work',t.work);
  document.getElementById('t_civil').textContent = t.civil || '';
  document.getElementById('afadaName').textContent = t.name || 'â€”';
  document.getElementById('abs-name-top').textContent = t.name || 'â€”';
  document.getElementById('abs-teacher-name').textContent = t.name || 'â€”';
  document.getElementById('noteTeacherName').textContent = t.name || '';
  refreshCaseNo();
}
function refillSelect(){
  const sel=document.getElementById('teacherSelect');
  sel.innerHTML='<option value="">â€” Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ â€”</option>';
  TEACHERS.forEach((t,i)=> sel.add(new Option(t.name? t.name : `Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… ${i+1}`, i)));
}
refillSelect();
document.getElementById('teacherSelect').addEventListener('change',e=>{
  const i=+e.target.value; if(Number.isInteger(i)&&TEACHERS[i]) applyTeacher(TEACHERS[i], i);
});
document.getElementById('teacherSearch').addEventListener('input',e=>{
  const q=e.target.value.trim(); const sel=document.getElementById('teacherSelect');
  for(const o of sel.options){ if(!o.value){o.hidden=false;continue;} o.hidden=q && !o.text.includes(q); }
});
['t_name','t_spec','t_level','t_job','t_work','t_civil','noteTeacherName'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('blur',()=>{
    if(currentIdx==null || !TEACHERS[currentIdx]) return;
    const v=el.textContent.trim();
    if(id==='t_name' || id==='noteTeacherName'){ 
      TEACHERS[currentIdx].name=v;
      document.getElementById('t_name').textContent=v;
      document.getElementById('noteTeacherName').textContent=v;
      document.getElementById('afadaName').textContent=v||'â€”';
      document.getElementById('abs-name-top').textContent=v||'â€”';
      document.getElementById('abs-teacher-name').textContent=v||'â€”';
    } else if(id==='t_spec'){ TEACHERS[currentIdx].spec=v; }
    else if(id==='t_level'){ TEACHERS[currentIdx].level=v; }
    else if(id==='t_job'){ TEACHERS[currentIdx].job=v; }
    else if(id==='t_work'){ TEACHERS[currentIdx].work=v; }
    else if(id==='t_civil'){ TEACHERS[currentIdx].civil=v; }
    localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
    refreshCaseNo();
  });
});

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± â€” ÙŠØ¯ÙˆÙŠ */
['managerName1','managerName2','managerName3','managerName4','managerName5','managerNameNote'].forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
  el.setAttribute('contenteditable','true');
  el.addEventListener('blur', ()=> setManagerName(el.textContent.trim()||''));
});
setManagerName(getManagerName());

/* ØªØµÙÙŠØ± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
document.getElementById('btnClearImport').addEventListener('click', ()=>{
  if(!confirm('Ø³ÙŠØªÙ… ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  TEACHERS=[]; localStorage.removeItem('teachersCache'); refillSelect();
  ['t_name','t_spec','t_level','t_job','t_work','t_civil','afadaName','abs-name-top','abs-teacher-name','noteTeacherName'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent='';
  });
  document.getElementById('afadaName').textContent='â€”';
  document.getElementById('abs-name-top').textContent='â€”';
  document.getElementById('abs-teacher-name').textContent='â€”';
  currentIdx=null;
  refreshCaseNo();
});

/* ===== Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ===== */
const fileInput=document.getElementById('fileInput');
const drop=document.getElementById('dropZone');
const importDialog=document.getElementById('importDialog');
document.getElementById('btnImport').addEventListener('click',()=>fileInput.click());
drop.addEventListener('click', (e)=>{ if(e.target.id!=='btnImport') fileInput.click();});
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background='#f7ffff';}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background='transparent';}));
drop.addEventListener('drop',e=>{e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(f) beginImport(f);});
fileInput.addEventListener('change',e=>{if(e.target.files && e.target.files[0]) beginImport(e.target.files[0]);});

let IMPORT_CTX = {workbook:null, sheets:[], arrays:{}, headers:{}};

function detectSeparator(txt){
  const cTab=(txt.match(/\t/g)||[]).length, cSemi=(txt.match(/;/g)||[]).length, cComma=(txt.match(/,/g)||[]).length;
  if(cTab>cSemi && cTab>cComma) return '\t';
  if(cSemi>cComma) return ';';
  return ',';
}
async function readTextAllEnc(file){
  const buf=await file.arrayBuffer();
  try{ return new TextDecoder('utf-8',{fatal:false}).decode(buf); }catch{}
  try{ return new TextDecoder('windows-1256',{fatal:false}).decode(buf); }catch{}
  try{ return new TextDecoder('iso-8859-6',{fatal:false}).decode(buf); }catch{}
  return await file.text();
}
function sheetToAOA(ws){ return XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:''}); }
function pickHeaderRow(A){
  const rowsToCheck = Math.min(5, A.length);
  let bestIdx = 0, bestScore = -1;
  const keywords = ['Ø§Ù„Ø§Ø³Ù…','Ø§Ø³Ù…','name','Ø§Ù„Ù…Ø¹Ù„Ù…','Ø§Ù„Ù…ÙˆØ¸Ù','Ø§Ù„Ø³Ø¬Ù„','Ø§Ù„Ù‡ÙˆÙŠØ©','Ø§Ù„ØªØ®ØµØµ','Ø§Ù„Ù…Ø±ØªØ¨Ø©','Ø§Ù„Ù…Ø³ØªÙˆÙ‰','Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ©','Ø§Ù„Ø¹Ù…Ù„','Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ù‡Ø§ØªÙ','whatsapp','mobile','phone','Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„','Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„','Ø§Ù„Ø¨Ø±ÙŠØ¯'];
  for(let r=0;r<rowsToCheck;r++){
    const row=(A[r]||[]).join(' ').toLowerCase();
    let score=0; keywords.forEach(k=>{ if(row.includes(k)) score++; });
    if(score>bestScore){ bestScore=score; bestIdx=r; }
  }
  return bestIdx;
}
function guess(header){
  const h=(header||'').toString().trim().toLowerCase();
  const norm=h.replace(/[^\u0600-\u06FFa-z0-9 ]/g,'');
  const tests={
    name:['name','Ø§Ù„Ø§Ø³Ù…','Ø§Ø³Ù…','Ø§Ù„Ù…Ø¹Ù„Ù…','Ù…Ø¹Ù„Ù…','Ø§Ù„Ù…ÙˆØ¸Ù','Ù…ÙˆØ¸Ù'],
    civil:['civil','national','id','identity','Ø§Ù„Ø³Ø¬Ù„','Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ','Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©','Ø§Ù„Ù‡ÙˆÙŠØ©','Ù‡ÙˆÙŠØ©','Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„'],
    spec:['Ø§Ù„ØªØ®ØµØµ','ØªØ®ØµØµ','subject','spec','specialty'],
    level:['Ø§Ù„Ù…Ø±ØªØ¨Ø©','Ø±ØªØ¨Ø©','rank','grade','level','Ø§Ù„Ù…Ø³ØªÙˆÙ‰','Ù…Ø³ØªÙˆÙ‰','Ø§Ù„Ø±ØªØ¨Ù‡'],
    job:['Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ©','ÙˆØ¸ÙŠÙØ©','job','employee id','ÙƒÙˆØ¯','Ø±Ù‚Ù… ÙˆØ¸ÙŠÙÙŠ'],
    work:['Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ','Ø§Ù„Ø¹Ù…Ù„','work','job title','Ø§Ù„Ù…Ø³Ù…Ù‰'],
    school:['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©','school'],
    phone:['Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ù‡Ø§ØªÙ','ÙˆØ§ØªØ³Ø§Ø¨','whatsapp','mobile','phone','Ø±Ù‚Ù…','Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„','Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ','contact'],
    email:['Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„','Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„','Ø§Ù„Ø¨Ø±ÙŠØ¯','email','e-mail','mail']
  };
  for(const k in tests){ if(tests[k].some(key=>norm.includes(key))) return k; }
  return null;
}

/* === beginImport === */
async function beginImport(file){
  try{
    const lower=(file.name||'').toLowerCase();
    let wb=null;

    if(/\.(csv|tsv|txt)$/.test(lower)){
      const text=await readTextAllEnc(file);
      const sep = detectSeparator(text);
      const rows = text.split(/\r?\n/).map(line=> line.split(sep));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wbNew = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wbNew, ws, 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      wb = wbNew;
    } else if(/\.json$/.test(lower)){
      const text=await readTextAllEnc(file);
      const data = Array.isArray(JSON.parse(text)) ? JSON.parse(text) : [];
      const ws = XLSX.utils.json_to_sheet(data);
      const wbNew = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wbNew, ws, 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      wb = wbNew;
    } else {
      const buf=await file.arrayBuffer();
      wb = XLSX.read(buf, {type:'array'});
    }

    if(!wb || !wb.SheetNames || !wb.SheetNames.length) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙˆØ±Ø§Ù‚ ÙÙŠ Ø§Ù„Ù…Ù„Ù.');

    IMPORT_CTX.workbook=wb;
    IMPORT_CTX.sheets=wb.SheetNames.slice();
    IMPORT_CTX.arrays={};
    wb.SheetNames.forEach(sh=>{
      const ws=wb.Sheets[sh];
      IMPORT_CTX.arrays[sh]=sheetToAOA(ws);
    });

    openImportDialog();
  }catch(err){
    console.error(err);
    alert('ØªØ¹Ø°Ù‘Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒÙ‘Ø¯ Ù…Ù† Ø§Ù„ØµÙŠØºØ© ÙˆØ£Ù† Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±.\nØ§Ù„ØªÙØ§ØµÙŠÙ„: ' + (err.message||err));
  }
}

function openImportDialog(){
  const sheetSel=document.getElementById('sheetSelect');
  sheetSel.innerHTML='';
  (IMPORT_CTX.sheets.length?IMPORT_CTX.sheets:['Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª']).forEach(sh=>sheetSel.add(new Option(sh,sh)));
  sheetSel.onchange=refreshMappingUI;

  ['mapName','mapCivil','mapSpec','mapLevel','mapJob','mapWork','mapSchool','mapPhone'].forEach(id=>document.getElementById(id).innerHTML='');
  refreshMappingUI();
  importDialog.style.display='flex';
  document.getElementById('btnCancelImport').onclick=()=>{ importDialog.style.display='none'; };
  document.getElementById('btnConfirmImport').onclick=confirmImport;
}
function refreshMappingUI(){
  const sheetSel=document.getElementById('sheetSelect');
  const sh=sheetSel.value || IMPORT_CTX.sheets[0] || 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
  const A=(IMPORT_CTX.arrays[sh]||[]).slice(); if(!A.length){ return; }

  const headerRowIdx = pickHeaderRow(A);
  const HEADS = (A[headerRowIdx]||[]).map(x=>String(x||'').trim());
  const ROWS  = A.slice(headerRowIdx+1, headerRowIdx+1+20);

  const fillSel=id=>{ const el=document.getElementById(id); el.innerHTML='<option value="">â€” Ø§Ø®ØªØ± Ø¹Ù…ÙˆØ¯Ù‹Ø§ â€”</option>'; HEADS.forEach((h,i)=>el.add(new Option(h||`Ø¹Ù…ÙˆØ¯ ${i+1}`, i))); return el; };
  const sName=fillSel('mapName'), sCivil=fillSel('mapCivil'), sSpec=fillSel('mapSpec'),
        sLevel=fillSel('mapLevel'), sJob=fillSel('mapJob'), sWork=fillSel('mapWork'),
        sSchool=fillSel('mapSchool'), sPhone=fillSel('mapPhone');

  const idxByRole={}; HEADS.forEach((h,i)=>{ const r=guess(h); if(r && idxByRole[r]==null) idxByRole[r]=i; });
  if(idxByRole.name!=null) sName.value=idxByRole.name;
  if(idxByRole.civil!=null) sCivil.value=idxByRole.civil;
  if(idxByRole.spec!=null) sSpec.value=idxByRole.spec;
  if(idxByRole.level!=null) sLevel.value=idxByRole.level;
  if(idxByRole.job!=null) sJob.value=idxByRole.job;
  if(idxByRole.work!=null) sWork.value=idxByRole.work;
  if(idxByRole.school!=null) sSchool.value=idxByRole.school;
  if(idxByRole.phone!=null) sPhone.value=idxByRole.phone;

  const table=document.getElementById('previewTable');
  table.innerHTML='';
  const thead=document.createElement('thead'); const hr=document.createElement('tr');
  HEADS.forEach(h=>{const th=document.createElement('th'); th.textContent=h||''; hr.appendChild(th);});
  thead.appendChild(hr); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  ROWS.forEach(r=>{
    const tr=document.createElement('tr');
    HEADS.forEach((_,i)=>{const td=document.createElement('td'); td.textContent=(r[i]!=null?r[i]:''); tr.appendChild(td);});
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  IMPORT_CTX.headers={sheet:sh, headerRowIdx, heads:HEADS};
}
function normalizePhone(raw){
  if(!raw) return '';
  let s = String(raw).trim();
  s = ar2en(s).replace(/[^\d]/g,'');
  if(s.startsWith('00966')) s = s.slice(2);
  if(s.startsWith('00')) s = s.slice(2);
  if(s.startsWith('966')) { if(s.length===13 && s[3]==='0') s='966'+s.slice(4); return s; }
  if(s.startsWith('05') && s.length===10) return '966'+s.slice(1);
  if(s.startsWith('5')  && s.length===9 ) return '966'+s;
  return s;
}
function confirmImport(){
  try{
    const ctx=IMPORT_CTX.headers||{};
    const A=IMPORT_CTX.arrays[ctx.sheet]||[];
    if(!A.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.'); return; }

    const getIdx = id => { const v=document.getElementById(id).value; return v? parseInt(v,10): -1; };
    const ixName=getIdx('mapName'), ixCivil=getIdx('mapCivil'), ixSpec=getIdx('mapSpec'),
          ixLevel=getIdx('mapLevel'), ixJob=getIdx('mapJob'), ixWork=getIdx('mapWork'),
          ixSchool=getIdx('mapSchool'), ixPhone=getIdx('mapPhone');

    const start = (ctx.headerRowIdx!=null? ctx.headerRowIdx+1 : 1);
    const out=[];
    for(let r=start;r<A.length;r++){
      const row=A[r]||[]; if(!row.some(c=>String(c||'').trim())) continue;
      const pick=i=> (i>=0 && i<row.length)? String(row[i]??'').trim() : '';
      out.push({
        name:pick(ixName),
        civil:pick(ixCivil),
        spec:pick(ixSpec),
        level:pick(ixLevel),
        job:pick(ixJob),
        work:pick(ixWork),
        school:pick(ixSchool),
        phone:normalizePhone(pick(ixPhone))
      });
    }
    TEACHERS=out.filter(t=> (t.name||t.civil||t.spec||t.level||t.job||t.work||t.phone));
    localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
    refillSelect();
    importDialog.style.display='none';
    if(TEACHERS.length){ document.getElementById('teacherSelect').value='0'; applyTeacher(TEACHERS[0],0); }
    else alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙÙˆÙ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø±Ø§Ø¦Ø·.');
  }catch(err){
    console.error(err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + (err.message||err));
  }
}

/* ===== ØªØ¨Ø¯ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ===== */
const segEl   = document.getElementById('noticeSeg');
const radios  = segEl.querySelectorAll('input[name="nt"]');
const kindLbl = document.getElementById('kindTitle');
const mainTitle = document.getElementById('mainTitle');
const alertPack = document.getElementById('alertPack');
const absencePack = document.getElementById('absencePack');
const notePack = document.getElementById('notePack');
const rowLate  = document.getElementById('lineLate');
const rowAbs   = document.getElementById('lineAbs');
const rowEarly = document.getElementById('lineEarly');

function setNotice(kind){
  alertPack.style.display   = (kind==='late' || kind==='absent' || kind==='early') ? 'block':'none';
  absencePack.style.display = (kind==='gaib') ? 'block':'none';
  notePack.style.display    = (kind==='note') ? 'block':'none';

  if(kind==='gaib'){ mainTitle.textContent = 'Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨'; }
  else if(kind==='note'){ mainTitle.textContent = 'Ù„ÙØª Ù†Ø¸Ø±'; }
  else{ mainTitle.textContent = 'ØªÙ†Ø¨ÙŠÙ‡'; }

  if(kind==='late'){ kindLbl.textContent='ØªØ£Ø®Ø±'; }
  else if(kind==='absent'){ kindLbl.textContent='Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯'; }
  else if(kind==='early'){ kindLbl.textContent='Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±'; }

  rowLate.style.display  = (kind==='late')   ? 'flex' : 'none';
  rowAbs.style.display   = (kind==='absent') ? 'flex' : 'none';
  rowEarly.style.display = (kind==='early')  ? 'flex' : 'none';

  refreshCaseNo();
}
radios.forEach(r => r.addEventListener('change', e => setNotice(e.target.value)));
setNotice(segEl.querySelector('input[name="nt"]:checked')?.value || 'late');

/* ===== PDF Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© ===== */
async function exportPDFBlob(){
  const root=document.documentElement;
  const prevScale = getComputedStyle(root).getPropertyValue('--scale');
  root.style.setProperty('--scale','1'); document.body.classList.add('exporting');
  const sheet=document.getElementById('sheet');
  const canvas = await html2canvas(sheet,{scale:4,useCORS:true,background:'#ffffff',logging:false,letterRendering:true});
  document.body.classList.remove('exporting'); root.style.setProperty('--scale', prevScale||'1');
  const img = canvas.toDataURL('image/jpeg',1.0);
  const {jsPDF}=window.jspdf; const pdf=new jsPDF('p','mm','a4');
  const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
  const px2mm=px=>px*25.4/96, imgWmm=px2mm(canvas.width), imgHmm=px2mm(canvas.height);
  const s=Math.min(pageW/imgWmm,pageH/imgHmm), w=imgWmm*s, h=imgHmm*s;
  pdf.addImage(img,'JPEG',(pageW-w)/2,(pageH-h)/2,w,h);
  return pdf.output('blob');
}
document.getElementById('btnMakePDF').addEventListener('click', async ()=>{
  try{
    const kind=document.querySelector('input[name="nt"]:checked')?.value || 'late';
    recordCase(kind,'PDF');
    const name=(document.getElementById('t_name').textContent||document.getElementById('noteTeacherName').textContent||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…').trim();
    const hj=(document.getElementById('hdrHijri').textContent||'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ').trim();
    const fileName=`${BASE_TITLE} â€” ${document.getElementById('mainTitle').textContent} â€” ${name} â€” ${hj}.pdf`;
    const blob=await exportPDFBlob();
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=fileName; a.click(); URL.revokeObjectURL(url);
  }catch(err){
    alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.\nØ§Ù„ØªÙØ§ØµÙŠÙ„: ' + (err.message||err));
  }
});

/* ===== Ù…Ø¤Ù‚Ù‘Øª ÙˆØ­Ø³Ø§Ø¨Ø§Øª ===== */
let active=null; const pad=document.getElementById('timePad'),disp=document.getElementById('timePadDisplay');
document.querySelectorAll('.timebox').forEach(el=>el.addEventListener('click',()=>openPad(el)));
function openPad(el){active=el;disp.textContent=el.dataset.value||'--:--';pad.style.display='block';const r=el.getBoundingClientRect();pad.style.left=Math.min(window.innerWidth-220,r.left)+'px';pad.style.top=(r.bottom+8)+'px';}
function closePad(){pad.style.display='none';active=null;}
document.getElementById('timePadClose').addEventListener('click',closePad);
document.getElementById('timePadSave').addEventListener('click',()=>{if(!active) return; const v=disp.textContent; active.textContent=v; active.classList.toggle('empty',!/\d{2}:\d{2}/.test(v)); active.dataset.value=v; recalc(); closePad();});
document.querySelectorAll('#timePad .grid button').forEach(b=>b.addEventListener('click',()=>{
  if(b.classList.contains('del')){disp.textContent=disp.textContent.slice(0,-1)||'--:--';return;}
  const k=b.dataset.k; let v=disp.textContent.replace(/-/g,'').replace(/:/g,''); if(disp.textContent==='--:--') v='';
  if(k===':'){if(v.length>=2 && !v.includes(':')) disp.textContent=v.slice(0,2)+':'+v.slice(2); return;}
  if(/[0-9]/.test(k)){v+=k; if(v.length<=4){disp.textContent=(v.padEnd(4,'-').slice(0,2))+':'+(v.padEnd(4,'-').slice(2,4));}}
}));
const t2m=t=>{ if(!/^\d{2}:\d{2}$/.test(t||'')) return null; const [h,m]=t.split(':').map(Number); return h*60+m; };
const fmtDur=mins=>{ mins=Math.max(0,Math.round(mins||0)); const h=Math.floor(mins/60),m=mins%60; return h?(m?`${h} Ø³Ø§Ø¹Ø© Ùˆ ${m} Ø¯Ù‚ÙŠÙ‚Ø©`:`${h} Ø³Ø§Ø¹Ø©`):`${m} Ø¯Ù‚ÙŠÙ‚Ø©`; };
function recalc(){
  const ws=document.getElementById('workStart')?.value||'06:45';
  const we=document.getElementById('workEnd')?.value||'13:45';
  const mWS=t2m(ws), mWE=t2m(we);
  const mLate=t2m((document.getElementById('tLateIn')?.dataset.value)||'');
  const late = (mWS!=null && mLate!=null) ? Math.max(0, mLate - mWS) : 0;
  const mAF=t2m((document.getElementById('tAbsFrom')?.dataset.value)||'');
  const mAT=t2m((document.getElementById('tAbsTo')?.dataset.value)||'');
  const abs = (mAF!=null && mAT!=null) ? Math.max(0, mAT - mAF) : 0;
  const mEF=t2m((document.getElementById('tEarlyFrom')?.dataset.value)||'');
  const early = (mWE!=null && mEF!=null) ? Math.max(0, mWE - mEF) : 0;
  document.getElementById('lateTotal').textContent  = fmtDur(late);
  document.getElementById('absTotal').textContent   = fmtDur(abs);
  document.getElementById('earlyTotal').textContent = fmtDur(early);
}
recalc();

/* ===== ÙˆØ§ØªØ³Ø§Ø¨ ===== */
function beautifyTime(t){ return en2ar((t||'--:--')); }
function buildWhatsAppMessage(){
  const school = (document.getElementById('schoolNameHdr').textContent||'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©').trim();
  const name   = (document.getElementById('t_name').textContent||document.getElementById('noteTeacherName').textContent||'â€”').trim();
  const kind   = document.querySelector('input[name="nt"]:checked')?.value || 'late';
  const hj     = (document.getElementById('hdrHijri').textContent||'â€”').replace(/\s+/g,' ').trim();
  const dayName= (document.getElementById('dynDay').textContent||'â€”').trim();
  const serial = (document.getElementById('serialNo').textContent||'01').trim();
  const total  = (document.getElementById('caseTotal').textContent||'0').trim();
  const ws     = beautifyTime(document.getElementById('workStart')?.value||'--:--');
  const we     = beautifyTime(document.getElementById('workEnd')?.value||'--:--');

  if(kind==='note'){
    const reason = document.getElementById('noteReasonText').textContent.trim();
    return `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡

Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${name} Ø­ÙØ¸Ù‡ Ø§Ù„Ù„Ù‡ØŒ

Ù†ÙÙŠØ¯ÙƒÙ… Ø¨ØµØ¯ÙˆØ± Â«Ù„ÙØª Ù†Ø¸Ø±Â» Ø±Ù‚Ù… (${en2ar(serial)}) ÙÙŠ ${school} ÙŠÙˆÙ… ${dayName} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${hj}.
Ø§Ù„Ù†Øµ: Ù„ÙˆØ­Ø¸ ${reason}.

Ù†Ø£Ù…Ù„ ØªÙ„Ø§ÙÙŠ Ø°Ù„Ùƒ Ù…Ø³ØªÙ‚Ø¨Ù„Ù‹Ø§ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©. Ù…Ø¹ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±.

Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:
${getManagerName()}

Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®Ù‡: ${en2ar(total)}.`;
  }

  let body='';
  if(kind==='gaib'){
    body =
`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡

Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${name} ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡ØŒ

Ù†ÙÙŠØ¯ÙƒÙ… Ø¨ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨ Ø¨Ø±Ù‚Ù… (${en2ar(serial)}) ÙÙŠ ${school}.
ÙŠÙˆÙ… ${dayName} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${hj}.

Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:
${getManagerName()}

Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø§Ø¡Ù„Ø§ØªÙƒÙ… Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®Ù‡: ${en2ar(total)}.`;
  }
  else if(kind==='late'){
    const tIn = beautifyTime(document.getElementById('tLateIn').dataset.value||'--:--');
    const dur = (document.getElementById('lateTotal').textContent||'â€”');
    body =
`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡

Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${name} ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡ØŒ

ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø± Ø±Ù‚Ù… (${en2ar(serial)}) ÙÙŠ ${school}.
Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…: (${ws}) â€” Ø­Ø¶ÙˆØ±ÙƒÙ…: (${tIn}) â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®Ø±: ${dur}.

Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:
${getManagerName()}

Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø§Ø¡Ù„Ø§ØªÙƒÙ… Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®Ù‡: ${en2ar(total)}.`;
  }
  else if(kind==='absent'){
    const from = beautifyTime(document.getElementById('tAbsFrom').dataset.value||'--:--');
    const to   = beautifyTime(document.getElementById('tAbsTo').dataset.value||'--:--');
    const dur  = (document.getElementById('absTotal').textContent||'â€”');
    body =
`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡

Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${name} ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡ØŒ

ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯ Ø±Ù‚Ù… (${en2ar(serial)}) ÙÙŠ ${school}.
Ù…Ù† (${from}) Ø¥Ù„Ù‰ (${to}) â€” Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${dur}.

Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:
${getManagerName()}

Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø§Ø¡Ù„Ø§ØªÙƒÙ… Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®Ù‡: ${en2ar(total)}.`;
  }
  else { // early
    const from = beautifyTime(document.getElementById('tEarlyFrom').dataset.value||'--:--');
    const dur  = (document.getElementById('earlyTotal').textContent||'â€”');
    body =
`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡

Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${name} ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡ØŒ

ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ± Ø±Ù‚Ù… (${en2ar(serial)}) ÙÙŠ ${school}.
ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù: (${from}) â€” Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±: ${dur}.

Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:
${getManagerName()}

Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø§Ø¡Ù„Ø§ØªÙƒÙ… Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®Ù‡: ${en2ar(total)}.`;
  }

  return body;
}
function getCurrentTeacherPhone(){
  if(currentIdx==null || !TEACHERS[currentIdx]) return '';
  return TEACHERS[currentIdx].phone || '';
}
document.getElementById('btnWA').addEventListener('click', ()=>{
  if(currentIdx==null){ alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ù„Ù‘Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.'); return; }
  const kind=document.querySelector('input[name="nt"]:checked')?.value || 'late';
  recordCase(kind,'WA');

  let phone = getCurrentTeacherPhone();
  if(!phone){
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù„Ù„Ù…Ø¹Ù„Ù‘Ù… ÙÙŠ Ø§Ù„Ù…Ù„ÙØ› Ø³ÙŠÙØ³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø¤Ù‚ØªÙ‹Ø§.');
    phone = DEFAULT_WA;
  }
  const msg=buildWhatsAppMessage();
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
});

/* ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ£Ø±Ø´ÙŠÙ ===== */
const dlgStats=document.getElementById('statsDialog');
const btnOpenStats=document.getElementById('btnOpenStats');
const btnCloseStats=document.getElementById('btnCloseStats');
const statsFilter=document.getElementById('statsFilter');
const tblArchiveBody=document.querySelector('#tblArchive tbody');
const tblSummaryBody=document.querySelector('#tblSummary tbody');

btnOpenStats.addEventListener('click',()=>{ renderStatsTables(); dlgStats.style.display='flex'; });
btnCloseStats.addEventListener('click',()=>{ dlgStats.style.display='none'; });

document.getElementById('btnExportArchive').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(ARCHIVE,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Ø§Ø±Ø´ÙŠÙ_Ù…Ø³Ø§Ø¡Ù„Ø§Øª_Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('restoreInput').parentElement.addEventListener('click', ()=> document.getElementById('restoreInput').click());
document.getElementById('restoreInput').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(Array.isArray(data)){ ARCHIVE=data; saveArchive(); renderStatsTables(); alert('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­.'); }
      else alert('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.');
    }catch{ alert('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.'); }
  };
  r.readAsText(f);
});
document.getElementById('btnResetAll').addEventListener('click', ()=>{
  if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  ARCHIVE=[]; saveArchive(); renderStatsTables(); alert('ØªÙ… Ø§Ù„ØªØµÙÙŠØ±.');
});
statsFilter.addEventListener('input', renderStatsTables);

function renderStatsTables(){
  const q=(statsFilter.value||'').trim();
  const filtered = ARCHIVE.slice().sort((a,b)=>b.ts-a.ts).filter(e=> !q || (e.name||'').includes(q));

  // Ø£Ø±Ø´ÙŠÙ ØªÙØµÙŠÙ„ÙŠ
  tblArchiveBody.innerHTML='';
  filtered.forEach(e=>{
    const tr=document.createElement('tr');
    const typeText = e.kind==='gaib'?'Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨': e.kind==='late'?'ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±': e.kind==='absent'?'ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯': e.kind==='early'?'ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±':'Ù„ÙØª Ù†Ø¸Ø±';
    tr.innerHTML = `<td>${e.hj}</td><td>${e.name||''}</td><td>${e.civil||''}</td><td>${typeText}</td><td>${pad2(e.serial)}</td>`;
    tblArchiveBody.appendChild(tr);
  });

  // Ù…Ù„Ø®Øµ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…
  const map=new Map();
  for(const e of ARCHIVE){
    const k=e.tkey; if(!map.has(k)) map.set(k,{name:e.name||'',civil:e.civil||'',gaib:0,late:0,absent:0,early:0,note:0,total:0});
    const row=map.get(k); row[e.kind]=(row[e.kind]||0)+1; row.total++;
  }
  const rows=[...map.values()].sort((a,b)=> b.total-a.total);
  tblSummaryBody.innerHTML='';
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.civil}</td><td>${r.gaib||0}</td><td>${r.late||0}</td><td>${r.absent||0}</td><td>${r.early||0}</td><td>${r.note||0}</td><td><strong>${r.total||0}</strong></td>`;
    tblSummaryBody.appendChild(tr);
  }
  refreshHeaderCounts();
}

/* ===== Ù„ÙØª Ø§Ù„Ù†Ø¸Ø± â€” Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø¨Ø¨ ===== */
const noteSelect = document.getElementById('noteReasonSelect');
const noteText   = document.getElementById('noteReasonText');
noteSelect.addEventListener('change', ()=>{
  const v = (noteSelect.value||'').trim();
  noteText.textContent = v ? v : 'Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©';
});

/* ===== Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ ===== */
refreshHeaderCounts();
</script>
</body>
</html>
