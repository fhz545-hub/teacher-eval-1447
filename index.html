<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>الشؤون الإدارية والمتابعة</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
:root{--moe:#0b7e88;--ink:#111;--sidebarW:350px;--b:#e6eeee}
*{box-sizing:border-box}
html,body{margin:0;background:#f6fafb;color:var(--ink);font:12.6px/1.75 Tajawal,system-ui;-webkit-font-smoothing:antialiased}
.app{display:grid;grid-template-columns:var(--sidebarW) 1fr;min-height:100vh}

/* لوحة التعليمات */
.sidebar{position:sticky;top:0;height:100vh;background:#fff;border-inline-end:1px solid #e8f2f2;box-shadow:0 0 24px rgba(0,0,0,.04);display:flex;flex-direction:column}
.sb-head{padding:12px;border-bottom:1px solid #eef4f4;font-weight:900;color:#064b50}
.sb-body{padding:10px;overflow:auto}
.f{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.f label{font-weight:800;color:#03636a;font-size:11.6px}
.sel,.inp,.btn{height:34px;border:1px solid #dbe9e9;border-radius:10px;background:#fff;padding:6px 9px;font-weight:800}
.sel{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#89a 0),linear-gradient(135deg,#89a 50%,transparent 0);background-position:calc(100% - 18px) 50%,calc(100% - 12px) 50%;background-size:6px 6px,6px 6px;background-repeat:no-repeat;cursor:pointer}
.row{display:flex;gap:6px}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{border:1px solid #dbe9e9;border-radius:12px;background:#f2fafb;color:#0b5e63;font-weight:900;padding:6px 10px;cursor:pointer}
.chip.active{background:var(--moe);color:#fff;border-color:transparent}
.btn{cursor:pointer}.btn.ghost{background:#eef7f7}.btn.primary{background:var(--moe);color:#fff;border-color:transparent}.btn.wh{background:#25D366;color:#fff;border-color:#1aae53}
.sb-actions{margin-top:8px;display:flex;flex-direction:column;gap:8px}
.rights{font-size:10px;color:#7a8790;text-align:center;padding:8px 10px;border-top:1px dashed #eef4f4;margin-top:auto}

/* محتوى A4 */
.content{padding:16px}
.sheet-wrap{display:flex;justify-content:center}
.sheet{width:210mm;min-height:297mm;background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.04)}
.pad{padding:9mm 10mm}

/* الهيدر */
.hdr{position:relative;margin:0 0 6mm}
.hdr img{width:100%;display:block;border-radius:12px}
.meta-stack{position:absolute;inset-inline-end:12px;top:12px;display:flex;flex-direction:column;gap:6px;min-width:130px;transform:translateX(4px)}
.meta-stack .rowB{background:transparent;border:0;border-radius:10px;padding:6px 10px;font-weight:900;text-align:center}

/* عنوان مركزي */
.title-center{text-align:center;margin:5mm 0 3mm}
.title-center .t{font-weight:900;font-size:22px;color:#064b50}

/* جدول بيانات المعلم */
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl th{background:#0b5e63;color:#fff;border:1px solid #244a4a;padding:6px 7px;font-weight:900}
.tbl td{border:1px solid #3f5b57;padding:5px 7px;height:10mm;text-align:center}
.tbl .name{width:38%}.tbl .spec{width:14%}.tbl .level{width:16%}.tbl .job{width:16%}.tbl .work{width:16%}

/* شارة تحت جدول الاسم */
.badges-under{margin:6px auto 0;display:flex;gap:10px;justify-content:flex-start;align-items:center;width:100%}
.badge{display:inline-flex;align-items:center;gap:8px;border:1px solid #0b7e88;border-radius:10px;padding:2px 10px;background:#fff;font-weight:900}
.badge .tag{background:var(--moe);color:#fff;border-radius:8px;padding:2px 8px}

/* أقسام النماذج */
.sec{margin-top:6mm}
.sec h3{margin:0 0 6px;color:#0b5e63;font-size:14px}
.rule-row{display:flex;align-items:center;gap:6px;margin-top:3px}
.rule-row .label{font-weight:900;white-space:nowrap}
.dotfield{display:inline-block;min-width:25mm;border-bottom:1px dotted #9fb7b3;text-align:center;padding:0 2mm}
.timebox{display:inline-block;min-width:26mm;text-align:center;padding:.4mm 2.5mm;background:#fff;color:#111;font-weight:900;border-radius:6px;border:1px solid #000;font-family:ui-monospace,Consolas,monospace;font-size:12px}
.timebox.empty{color:#777;border-color:#bbb}
.checks{margin:5px 0 6px}
.checkline{display:flex;align-items:flex-start;gap:6px;margin:5px 0}
.checkline input{margin-top:3px;transform:scale(1.05)}
.checkline .text{flex:1}
.calc{font-weight:900;color:#0b5e63}

/* خطوط كتابة */
.lines{min-height:26mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe}
.lines div{height:9mm;border-bottom:1px dotted #9fb7b3}
.lines div:last-child{border-bottom:0}

/* عبارة “تحفظ …” */
.footer-note{margin-top:10mm}
.footer-note span{display:inline-block;margin-inline-end:auto;color:#333;font-size:10.5px;font-weight:800}

/* نافذة الإحصائيات */
#statsDlg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:50;align-items:center;justify-content:center;padding:12px}
.stats-card{background:#fff;border-radius:16px;max-width:1100px;width:96%;max-height:90vh;overflow:auto;border:1px solid var(--b)}
.stats-card .h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef4f4}
.tbl2{width:100%;border-collapse:collapse}
.tbl2 th{background:#0b5e63;color:#fff;border:1px solid #2b4949;padding:6px 8px;position:sticky;top:0}
.tbl2 td{border:1px solid #d1dddd;padding:6px 8px}

/* طباعة */
@media print{
  @page{size:A4;margin:8mm}
  .sidebar,.rights{display:none !important}
  body{background:#fff}
  .sheet{border:0;box-shadow:none}
}
</style>
</head>
<body>
<div class="app">

  <!-- لوحة التعليمات (دون أي تغيير) -->
  <aside class="sidebar">
    <div class="sb-head">لوحة التعليمات</div>
    <div class="sb-body">
      <div class="f">
        <label>نوع الإجراء</label>
        <div class="chips" id="kindChips">
          <button class="chip active" data-k="late">تأخر</button>
          <button class="chip" data-k="absent">عدم تواجد</button>
          <button class="chip" data-k="early">انصراف</button>
          <button class="chip" data-k="gaib">مساءلة غياب</button>
          <button class="chip" data-k="note">لفت نظر</button>
        </div>
      </div>

      <div class="f">
        <label>المعلّم</label>
        <select id="selTeacher" class="sel"></select>
      </div>

      <!-- أسباب لفت النظر (ثابتة وتنعكس للصفحة) -->
      <div class="f">
        <label>سبب لفت النظر</label>
        <select id="noteReason" class="sel">
          <option value="">— اختر السبب —</option>
          <option>عدم المشاركة في الإشراف الصباحي وفق الجدول المعتمد.</option>
          <option>التقصير في مناوبة نهاية الدوام مما أثّر على انضباط خروج الطلاب.</option>
          <option>ضعف الإشراف أثناء الفسحة وعدم متابعة السلوك.</option>
          <option>عدم الإشراف على صلاة الظهر في المصلى المدرسي.</option>
          <option>عدم التحضير الإلكتروني في منصة مدرستي حسب المتطلبات.</option>
          <option>الخروج من الحصة قبل انتهائها دون مبرر نظامي.</option>
          <option>التأخر عن دخول الحصة وفق الجدول الزمني.</option>
          <option>عدم الحضور للطابور الصباحي دون عذر.</option>
          <option>التغيب عن اجتماع المدرسة الرسمي دون عذر.</option>
          <option>عدم الرد على مساءلة إدارية في الموعد المحدد.</option>
          <option>رفض التوقيع على النماذج أو المحاضر الرسمية.</option>
          <option>رفض تنفيذ توجيه إداري أو تربوي دون مبرر.</option>
          <option>عدم رفع بيانات الغياب في (فارس) بالوقت المحدد.</option>
          <option>عدم دخول حصة الانتظار المكلَّف بها.</option>
          <option>التقصير في إدخال الدرجات في (نور) ضمن الإطار الزمني المعتمد.</option>
        </select>
      </div>

      <!-- الموحّد: العذر/القبول/فارس -->
      <div class="f">
        <label>العذر/القبول/فارس</label>
        <button id="btnUnified" class="btn ghost" style="width:100%;display:flex;justify-content:space-between;align-items:center">
          <span id="unifiedText">بدون عذر • غير مقبول • لم يُرفع</span><span>▾</span>
        </button>
        <div id="unifiedPanel" style="display:none;border:1px solid #dbe9e9;border-radius:10px;padding:8px;margin-top:6px">
          <div class="f" style="margin:0">
            <label>العذر</label>
            <div class="chips">
              <button class="chip" data-exc="with">بعذر</button>
              <button class="chip active" data-exc="without">بدون عذر</button>
            </div>
          </div>
          <div class="f" style="margin:6px 0 0">
            <label>قبول العذر</label>
            <div class="chips">
              <button class="chip" data-acc="accepted">مقبول</button>
              <button class="chip active" data-acc="rejected">غير مقبول</button>
            </div>
          </div>
          <div class="f" style="margin:6px 0 0">
            <label>فارس</label>
            <div class="chips">
              <button class="chip" data-fr="raised">مرفوع</button>
              <button class="chip active" data-fr="not">لم يُرفع</button>
            </div>
          </div>
        </div>
      </div>

      <!-- التاريخ -->
      <div class="f">
        <label>التاريخ</label>
        <div class="row"><button id="btnCalToggle" class="btn" style="flex:1">🗓️ هجري</button></div>
        <div id="pickHijri" class="row" style="margin-top:6px">
          <select id="hY" class="sel" style="width:33%"></select>
          <select id="hM" class="sel" style="width:33%"></select>
          <select id="hD" class="sel" style="width:34%"></select>
        </div>
        <div id="pickGreg" class="row" style="display:none;margin-top:6px">
          <input id="gY" class="inp" type="number" min="1900" max="2100" placeholder="YYYY" style="width:40%">
          <input id="gM" class="inp" type="number" min="1" max="12" placeholder="MM" style="width:30%">
          <input id="gD" class="inp" type="number" min="1" max="31" placeholder="DD" style="width:30%">
        </div>
      </div>

      <div class="sb-actions">
        <button id="btnStats" class="btn ghost">الإحصائيات 📊</button>
        <button id="btnWA" class="btn wh">واتساب</button>
        <button id="btnPDF" class="btn primary">PDF و حفظ</button>
      </div>
    </div>
    <div class="rights">مبادرة اليعقوبي — تطوير: فهد حامد الزهراني (لا تظهر في الطباعة)</div>
  </aside>

  <!-- صفحة A4 -->
  <main class="content">
    <div class="sheet-wrap">
      <div class="sheet" id="sheet">
        <div class="pad">

          <!-- الهيدر -->
          <div class="hdr">
            <img id="hdrImg" src="هيدر اعلى الصفحه .png" alt="هيدر">
            <div class="meta-stack">
              <div class="rowB" id="metaDay">—</div>
              <div class="rowB" id="metaHijri">—</div>
              <div class="rowB">الرقم: <span id="metaNo">01</span></div>
            </div>
          </div>

          <div class="title-center"><div class="t" id="mainTitle">تنبيه</div></div>

          <!-- بيانات المعلم -->
          <table class="tbl">
            <thead><tr>
              <th class="name">الاسم</th><th class="spec">التخصص</th><th class="level">المرتبة</th>
              <th class="job">رقم الوظيفة</th><th class="work">العمل الحالي</th>
            </tr></thead>
            <tbody><tr>
              <td id="t_name">—</td><td id="t_spec">—</td><td id="t_level">—</td><td id="t_job">—</td><td id="t_work">—</td>
            </tr></tbody>
          </table>

          <!-- شارة السجل المدني -->
          <div class="badges-under">
            <div class="badge"><span class="tag">السجل المدني</span><span id="t_civil">—</span></div>
          </div>

          <!-- (1) خطاب التنبيه -->
          <div id="alertPack" class="sec">
            <h3>( 1 ) خطاب التنبيه — <span id="kindTitle">تأخر</span></h3>
            <div class="rule-row"><span class="label">المكرم المعلم :</span>
              <strong id="teacherNameInline" style="min-width:38mm;text-align:center;border-bottom:1px dotted #9fb7b3;display:inline-block;padding:0 2mm">—</strong>
              <span>وفقه الله</span></div>
            <p><strong>السلام عليكم ورحمة الله وبركاته</strong></p>
            <p>وبعد :</p>
            <p>إنه في يوم <span class="dotfield"><span id="dynDay">—</span></span>
              الموافق <span class="dotfield"><span id="dynHijri">—</span></span> :</p>

            <div class="checks">
              <label id="lineLate" class="checkline">
                <input type="checkbox" checked>
                <span class="text">
                  تأخركم من بداية العمل، وحضوركم الساعة ( <span id="tLateIn" class="timebox empty">--:--</span> ).
                  <span class="calc">— إجمالي التأخر: <span id="lateTotal">0 دقيقة</span> (<span id="lateHH">00:00</span> س)</span>
                </span>
              </label>

              <label id="lineAbs" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  عدم تواجدكم أثناء العمل من الساعة : ( <span id="tAbsFrom" class="timebox empty">--:--</span> )
                  إلى الساعة : ( <span id="tAbsTo" class="timebox empty">--:--</span> ).
                  <span class="calc">— مدة عدم التواجد: <span id="absTotal">0 دقيقة</span> (<span id="absHH">00:00</span> س)</span>
                </span>
              </label>

              <label id="lineEarly" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  انصرافكم مبكرًا قبل نهاية العمل من الساعة : ( <span id="tEarlyFrom" class="timebox empty">--:--</span> ).
                  <span class="calc">— مدة الانصراف المبكر: <span id="earlyTotal">0 دقيقة</span> (<span id="earlyHH">00:00</span> س)</span>
                </span>
              </label>
            </div>

            <p id="workRangeLine" style="margin:6px 0 8px; font-weight:800; color:#064b50">
              يُرجى التقيد بمواعيد الدوام الرسمية: <span id="workRangeText">—</span>.
            </p>

            <p>عليه نأمل توضيح أسباب ذلك مع إرفاق ما يؤيد عذركم … ولكم تحياتنا.</p>
            <p style="margin-top:6px"><strong>مدير المدرسة :</strong> <span>فهد حامد علي الزهراني</span>
              &nbsp;&nbsp; <strong>التوقيع :</strong> <span class="dotfield" style="min-width:26mm"></span>
              &nbsp;&nbsp; <strong>التاريخ :</strong> <span class="dotfield" style="min-width:20mm"></span></p>
          </div>

          <!-- (2) إفادة المعلم -->
          <div id="affidavitPack" class="sec">
            <h3>( 2 ) إفادة المعلم</h3>
            <p>أُفيدكم بأن سبب <span id="affKind">التأخر</span> الموضّح أعلاه هو:</p>
            <div class="lines"><div></div><div></div><div></div></div>
            <p style="margin-top:6px">
              <strong>اسم المعلم :</strong> <span id="affTeacher">—</span>
              &nbsp;&nbsp; <strong>التوقيع :</strong> ____________________
              &nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______
            </p>
          </div>

          <!-- (3) رأي مدير المدرسة -->
          <div id="principalPack" class="sec">
            <h3>( 3 ) رأي مدير المدرسة</h3>
            <label class="checkline"><input type="checkbox"> تمّ تنبيه الموظف شفهيًا بالأخذ بأسباب الانضباط.</label>
            <label class="checkline"><input type="checkbox"> يُكتفى بهذا التنبيه مع المتابعة خلال الفترة القادمة.</label>
            <label class="checkline"><input type="checkbox"> يُرفع لجهة الاختصاص عند تكرار المخالفة.</label>
            <p style="margin-top:6px">
              <strong>اسم المدير :</strong> <span>فهد حامد علي الزهراني</span>
              &nbsp;&nbsp; <strong>التوقيع :</strong> ____________________
              &nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______
            </p>
          </div>

          <!-- مساءلة الغياب (كما هي) -->
          <div id="absencePack" class="sec" style="display:none">
            <p>إنه في يوم <strong><span id="absDayP">—</span></strong>
              الموافق <strong><span id="absDateYMD">—</span></strong> تغيبت عن العمل.</p>
            <h3>( 1 ) طلب الإفادة</h3>
            <p><strong>المكرم /</strong> <span id="abs-name-top">—</span> <span>وفقه الله</span></p>
            <p><strong>السلام عليكم ورحمة الله وبركاته</strong> وبعد ،،،</p>
            <p>من خلال متابعة سجل الدوام تبين غيابكم خلال الفترة الموضحة بعالية، آمل الإفادة عن سبب ذلك
              وتقديم ما يؤيد عذركم خلال أسبوع من تاريخه؛ علماً بأنه في حالة عدم الالتزام سيتم اتخاذ اللازم حسب التعليمات.</p>
            <p><strong>اسم الرئيس المباشر :</strong> <span>فهد بن حامد علي الزهراني</span>
               &nbsp;&nbsp; <strong>التوقيع :</strong> ________ &nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______</p>

            <h3>( 2 ) الإفادة</h3>
            <p><strong>المكرم / مدير المدرسة</strong> وفقه الله</p>
            <p><strong>السلام عليكم ورحمة الله وبركاته</strong> وبعد:</p>
            <p>أفيدكم أن غيابي كان للأسباب التالية:</p>
            <div class="lines"><div></div><div></div><div></div></div>
            <p>وسأقوم بتقديم ما يثبت ذلك خلال أسبوع من تاريخه.</p>
            <p><strong>اسم المعلم :</strong> <span id="abs-teacher-name">—</span> &nbsp;&nbsp; <strong>التوقيع :</strong> ________ &nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______</p>

            <h3>( 3 ) مدير المدرسة</h3>
            <label><input type="checkbox"> تُحتسب له إجازة مرضية بعد التأكد من نظامية التقرير.</label><br>
            <label><input type="checkbox"> يُحتسب غيابه من رصيده للإجازات الإضطرارية لقبول عذره إذا كان رصيده يسمح ولا يُحسم عليه.</label><br>
            <label><input type="checkbox"> يعتمد الحسم لعدم قبول عذره.</label>
          </div>

          <!-- لفت نظر (كما هو) -->
          <div id="notePack" class="sec" style="display:none">
            <h3>نموذج لفت نظر</h3>
            <p>الأستاذ الفاضل/ <span id="noteTeacherName" style="font-weight:900">—</span> حفظه الله</p>
            <p><strong>السلام عليكم ورحمة الله وبركاته، وبعد ،،،</strong></p>
            <p>في يوم <span id="noteDay" style="font-weight:900;border-bottom:1px dotted #9fb7ب3;padding:0 3mm">—</span>
              الموافق <span id="noteHijri" style="font-weight:900;border-bottom:1px dotted #9fb7b3;padding:0 3mm">—</span></p>
            <p id="noteParagraph">
              إشارةً إلى التعليمات والأنظمة المعتمدة في المدرسة؛ لوحِظ
              <span id="noteReasonText" style="font-weight:900">المهمة المحددة</span>.
              ونأمل منكم المبادرة بمعالجة ذلك، والالتزام التام بما يُوكل إليكم من مهام؛ دعمًا للانضباط المهني ورفعًا لجودة الأداء.
            </p>
            <p><strong>توقيع الموظف بالاطلاع:</strong> ............................... &nbsp;&nbsp; <strong>الاسم:</strong> ............................... &nbsp;&nbsp; <strong>التاريخ:</strong> ______ / ______ / 14</p>
            <p><strong>توقيع قائد المدرسة:</strong> فهد حامد علي الزهراني</p>
          </div>

          <div class="footer-note"><span>تحفظ في ملف المتابعة</span></div>

        </div>
      </div>
    </div>
  </main>
</div>

<!-- نافذة الإحصائيات -->
<div id="statsDlg">
  <div class="stats-card">
    <div class="h">
      <div style="font-weight:900;color:#064b50">ملخص الإحصائيات</div>
      <div style="display:flex;gap:6px">
        <button id="btnStatsPDF" class="btn primary">PDF الملخص</button>
        <button id="btnCloseStats" class="btn ghost">إغلاق</button>
      </div>
    </div>
    <div style="padding:12px">
      <table id="tblStats" class="tbl2">
        <thead>
          <tr>
            <th>المعلّم</th><th>النوع</th><th>اليوم</th><th>التاريخ (هـ)</th><th>بعذر/قبول</th><th>فارس</th><th>تفاصيل</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* أرقام عربية/إنجليزية */
const AR='٠١٢٣٤٥٦٧٨٩', EN='0123456789';
const en2ar=s=>(''+s).replace(/[0-9]/g,d=>AR[d]); const ar2en=s=>(''+s).replace(/[٠-٩]/g,d=>EN[AR.indexOf(d)]);

/* قائمة المعلمين (الاسم\tالهوية\tالجوال\tالتخصص\tالمرتبة) */
const TEACHERS_CSV=`موسى صلبان عبده عسيري	1093013116	966507058931	فيزيا	معلم ممارس
مبارك عوضه سفر آل ثابت	1056464405	966597233399	كيميا	معلم ممارس
فرج عبدالعلي يوسف ال سيف	1000397735	966504113707	احياء	معلم ممارس
منذر عامر حمود زميع	1065913053	966541188974	انجليزي	معلم ممارس
عماد محمد جمعان الزهراني	1048667289	966542203039	مكتبات	معلم ممارس
ابراهيم حبيب عبدالغني الميمني	1072815481	966530163027	رياضيات	معلم ممارس
بندر عبدالعزيز محمد الغامدي	1046853881	966546135135	حاسب	معلم ممارس
حسين بن محمد بن فهد القحطاني	1014268567	966504988086	احياء	معلم ممارس
ناصر علي ناصر الراشد	1008303370	966542933888	حاسب	معلم ممارس
حسين بن محمد بن حسين الأحمد	1060369202	966563740777	اللغة العربية	معلم ممارس
علي سعد سعيد الاصلعي الاحمري	1023999780	966590986464	احياء	معلم ممارس
محمد حمد عبدالرحمن التويجري	1064745944	966541381105	اللغة العربية	معلم ممارس
عبدالله فيصل بن فطيس الهذلي	1094733290	966591585407	رياضيات	معلم ممارس
احمد عبدالرحيم عبدالحميد ابوعصيده	1033584234	966546623431	انجليزي	معلم ممارس
عبدالله بن عبدالعزيز بن سيف السهلي	1063175010	966546221133	علم اجتماع	معلم ممارس
بشير بن أحمد بن عبدالله آل سليم	1019783917	966500126925	مكتبات	معلم ممارس
ابراهيم بن محمد بن ابراهيم الربيع	1004182687	966548638056	انجليزي	معلم ممارس
عبدالمجيد عبدالله سالم آل حبشان	1004581359	966500223640	اجتماعيات	معلم ممارس
فيصل فهد علي الزهراني	1086115373	966508448455	رياضيات	معلم ممارس
زياد عواض ابن عيضه العمري	1092156742	966557530102	علم إدارة	معلم ممارس
عبدالرحمن عبدالجبار حمود العتيبي	1089635724	966555741488	فيزيا	معلم ممارس
عبد الله حسن عمر الادريسي	1081556910	966533025505	رياضيات	معلم ممارس
تقي عبد الهادي تقي العلي	1026472363	966543219321	كيميا	معلم ممارس
صالح بن محمد بن صالح السميحي	1003535422	966506921115	دين	معلم ممارس
عادل بن علي بن ناصر البارقي	1007370701	966530667666	رياضه	معلم ممارس
ابراهيم بن أحمد بن ابراهيم العجلان	1001082179	966559999808	دين	معلم ممارس
خالد أحمد محمد الشهري	1034318301	966560687900	كيميا	معلم ممارس
خالد سعد راشد المرضي	1025640010	966505877238	اجتماعيات	معلم ممارس
عبدالله بن خلوفة بن عبدالله ال مرعي	1029490875	966533225515	دين	معلم ممارس
يحيى بن محمد بن سعيد القحطاني	1048978892	966555751385	اجتماعيات	معلم ممارس
حسين بن سعيد سلمان المدن	1022616799	966556336875	مكتبات	معلم ممارس
يوسف عيسى عيسى العيد	1012646822	966592038351	اللغة العربية	معلم ممارس
نبيل بن محسن محمد القلاف	1025472604	966562962766	رياضه	معلم ممارس
عبدالمجيد عبدالرحمن عبدالله السالمي	1073861831	966558151033	انجليزي	معلم ممارس
حسن علي حسن الشهري	1037273594	966500677015	اللغة العربية	معلم ممارس
جميل عبدالمجيد جواد العلي	1029281589	966566712113	فيزيا	معلم ممارس
حسن يوسف حسين الخليفة	1056994203	966506907431	كيميا	معلم ممارس
حسن عبدالله علي العبدالله	1005472780	966543705512	احياء	معلم ممارس
عادل بن علي بن سليمان السبعان	1005472780	966504836200	موجه طلابي	معلم ممارس
ياسر عبدالله محمد النمر	1001443397	966543705512	مدخل بيانات	مساعد معلم
علي بن حسن بن علي آل قمبر	1004780860	966502085389	سكرتاريه	مساعد معلم
حسن بن عامربن احمد الشهري	1013124175	966598893731	محضر مختبر	مساعد معلم
عدنان علي حسين الزريق	1015776766	966505808451	وكيل	معلم ممارس
فهد حامد علي الزهراني	1024193532	966504532489	مدير المدرسة	معلم ممارس`;

function parseTeachersCSV(csv){
  return csv.trim().split(/\r?\n/).map(line=>{
    const parts=line.split(/\t+/);
    const [name,civil,phone,spec,level]=[parts[0]||'',parts[1]||'',parts[2]||'',parts[3]||'',parts[4]||''];
    return {name:name.trim(), civil:(civil||'').trim(), phone:(phone||'').replace(/[^\d]/g,''), spec:spec.trim(), level:level.trim(), job:'', work:'معلم'};
  }).filter(r=>r.name);
}
const TEACHERS=parseTeachersCSV(TEACHERS_CSV);

/* تعبئة قائمة المعلمين */
const selTeacher=document.getElementById('selTeacher');
function fillTeachers(){ selTeacher.innerHTML='<option value="">— اختر معلماً —</option>'; TEACHERS.forEach((t,i)=>selTeacher.add(new Option(t.name,i))) }
fillTeachers();

/* حالة عامة + أرشيف */
let STATE={kind:'late',excuse:'without',accept:'rejected',faris:'not'};
const KEY_ARCH='followup_archive_v4'; let ARCH=JSON.parse(localStorage.getItem(KEY_ARCH)||'[]');
function saveARCH(){ localStorage.setItem(KEY_ARCH, JSON.stringify(ARCH)); }
function nextSerialFor(civil){ const n=ARCH.filter(e=>e.civil===civil).length+1; return en2ar(String(n).padStart(2,'0')); }

/* عناصر أقسام */
const alertPack=document.getElementById('alertPack');
const absencePack=document.getElementById('absencePack');
const notePack=document.getElementById('notePack');
const lineLate=document.getElementById('lineLate');
const lineAbs=document.getElementById('lineAbs');
const lineEarly=document.getElementById('lineEarly');
const kindTitle=document.getElementById('kindTitle');

/* نطاق دوام توضيحي (لا يغيّر التصميم) */
const WORK = { winter:{start:'06:45',end:'13:45',label:'الشتوي (06:45–13:45)'}, summer:{start:'07:00',end:'14:00',label:'الصيفي (07:00–14:00)'} };
let SEASON='winter';
function refreshWorkRangeLine(){ document.getElementById('workRangeText').textContent=WORK[SEASON].label; }

/* تبديل نوع الإجراء */
function setPack(kind){
  STATE.kind=kind;
  document.getElementById('mainTitle').textContent=({late:'تنبيه',absent:'تنبيه',early:'تنبيه',gaib:'مساءلة غياب',note:'لفت نظر'})[kind];
  alertPack.style.display=(kind==='gaib'||kind==='note')?'none':'';
  document.getElementById('affidavitPack').style.display=(kind==='gaib'||kind==='note')?'none':'';  // إفادة المعلم للتنبيهات
  document.getElementById('principalPack').style.display=(kind==='gaib'||kind==='note')?'none':'';   // رأي المدير للتنبيهات
  absencePack.style.display=(kind==='gaib')?'':'none';
  notePack.style.display=(kind==='note')?'':'none';
  lineLate.style.display=(kind==='late')?'':'none';
  lineAbs.style.display=(kind==='absent')?'':'none';
  lineEarly.style.display=(kind==='early')?'':'none';
  kindTitle.textContent=({late:'تأخر',absent:'عدم تواجد',early:'انصراف مبكر'})[kind]||'—';
  document.getElementById('affKind').textContent=({late:'التأخر',absent:'عدم التواجد',early:'الانصراف المبكر'})[kind]||'المخالفة';
}
document.getElementById('kindChips').addEventListener('click',e=>{
  const b=e.target.closest('.chip'); if(!b) return;
  [...e.currentTarget.children].forEach(x=>x.classList.remove('active')); b.classList.add('active');
  setPack(b.dataset.k); recalc();
});

/* الموحّد: العذر/القبول/فارس */
const unifiedPanel=document.getElementById('unifiedPanel'), unifiedText=document.getElementById('unifiedText');
document.getElementById('btnUnified').onclick=()=> unifiedPanel.style.display=unifiedPanel.style.display?'':'block';
unifiedPanel.addEventListener('click',e=>{
  const c=e.target.closest('.chip'); if(!c) return;
  const gp=c.dataset.exc?'[data-exc]':(c.dataset.acc?'[data-acc]':'[data-fr]');
  c.parentElement.querySelectorAll(gp).forEach(x=>x.classList.remove('active')); c.classList.add('active');
  if(c.dataset.exc) STATE.excuse=c.dataset.exc;
  if(c.dataset.acc) STATE.accept=c.dataset.acc;
  if(c.dataset.fr)  STATE.faris=c.dataset.fr;
  unifiedText.textContent=`${STATE.excuse==='with'?'بعذر':'بدون عذر'} • ${STATE.accept==='accepted'?'مقبول':'غير مقبول'} • ${STATE.faris==='raised'?'مرفوع':'لم يُرفع'}`;
});

/* التاريخ: هجري/ميلادي */
let CAL_MODE='h';
const pickHijri=document.getElementById('pickHijri'), pickGreg=document.getElementById('pickGreg');
document.getElementById('btnCalToggle').onclick=()=>{
  CAL_MODE=CAL_MODE==='h'?'g':'h';
  document.getElementById('btnCalToggle').textContent=(CAL_MODE==='h'?'🗓️ هجري':'🗓️ ميلادي');
  pickHijri.style.display=CAL_MODE==='h'?'flex':'none';
  pickGreg.style.display=CAL_MODE==='g'?'flex':'none';
  if(CAL_MODE==='h') syncFromHijri(); else syncFromGregInputs();
};
function hijriToGregorian(y,m,d){
  let lo=new Date(1937,0,1), hi=new Date(2077,11,31);
  const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'numeric',day:'numeric'});
  const parts=dt=>{const p=fmt.formatToParts(dt);return{y:+ar2en(p.find(x=>x.type==='year').value),m:+ar2en(p.find(x=>x.type==='month').value),d:+ar2en(p.find(x=>x.type==='day').value)}};
  while(lo<=hi){const mid=new Date((lo.getTime()+hi.getTime())/2),v=parts(mid);
    if(v.y===y&&v.m===m&&v.d===d) return new Date(mid.getFullYear(),mid.getMonth(),mid.getDate());
    if(v.y<y||(v.y===y&&v.m<m)||(v.y===y&&v.m===m&&v.d<d)) lo=new Date(mid.getFullYear(),mid.getMonth(),mid.getDate()+1);
    else hi=new Date(mid.getFullYear(),mid.getMonth(),mid.getDate()-1);}
  return new Date();
}
function buildHijriPicker(){
  const y=document.getElementById('hY'),m=document.getElementById('hM'),d=document.getElementById('hD');
  y.innerHTML=m.innerHTML=d.innerHTML='';
  const now=new Date(); const currAH=parseInt(ar2en(new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric'}).format(now)),10);
  for(let i=currAH-1;i<=currAH+1;i++) y.add(new Option(en2ar(i),i));
  for(let i=1;i<=12;i++) m.add(new Option(en2ar(String(i).padStart(2,'0')),i));
  for(let i=1;i<=30;i++) d.add(new Option(en2ar(String(i).padStart(2,'0')),i));
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
  d.value=+ar2en(parts.find(p=>p.type==='day').value); m.value=+ar2en(parts.find(p=>p.type==='month').value); y.value=+ar2en(parts.find(p=>p.type==='year').value);
  y.onchange=m.onchange=d.onchange=syncFromHijri; syncFromHijri();
}
function syncFromHijri(){
  const y=+hY.value, m=+hM.value, d=+hD.value;
  const g=hijriToGregorian(y,m,d);
  const dayName=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(g);
  const hij=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).format(g);
  metaDay.textContent=dayName; metaHijri.textContent=hij;
  dynDay.textContent=dayName; dynHijri.textContent=hij;
  noteDay.textContent=dayName; noteHijri.textContent=hij;
  document.getElementById('affTeacher').textContent=document.getElementById('t_name').textContent||'—';
  document.getElementById('absDayP').textContent=dayName;
  document.getElementById('absDateYMD').textContent=hij;
}
['gY','gM','gD'].forEach(id=>document.getElementById(id).addEventListener('change',syncFromGregInputs));
function syncFromGregInputs(){
  const y=+gY.value||new Date().getFullYear(), m=+gM.value||new Date().getMonth()+1, d=+gD.value||new Date().getDate();
  const g=new Date(y,m-1,d);
  const dayName=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(g);
  const hij=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).format(g);
  metaDay.textContent=dayName; metaHijri.textContent=hij;
  dynDay.textContent=dayName; dynHijri.textContent=hij;
  noteDay.textContent=dayName; noteHijri.textContent=hij;
  document.getElementById('affTeacher').textContent=document.getElementById('t_name').textContent||'—';
  document.getElementById('absDayP').textContent=dayName;
  document.getElementById('absDateYMD').textContent=hij;
}

/* حسابات */
function toMin(hhmm){ const m=/^(\d{1,2}):(\d{2})$/.exec(ar2en(hhmm||'')); if(!m) return null; const h=+m[1], mi=+m[2]; if(h>23||mi>59) return null; return h*60+mi; }
function fmtHM(mins){ const h=Math.floor(mins/60), m=mins%60; return en2ar(String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')); }
const WORK_RANGE={winter:{start:'06:45',end:'13:45'},summer:{start:'07:00',end:'14:00'}};
function recalc(){
  const wsM=toMin(WORK_RANGE[SEASON].start), weM=toMin(WORK_RANGE[SEASON].end);
  const tLate=tLateIn.textContent.trim(), tLateM=toMin(tLate);
  if(tLateM!=null&&wsM!=null&&tLateM>wsM){const mins=tLateM-wsM; lateTotal.textContent=en2ar(mins)+' دقيقة'; lateHH.textContent=fmtHM(mins); tLateIn.classList.remove('empty');}
  const aF=tAbsFrom.textContent.trim(), aT=tAbsTo.textContent.trim(), aFM=toMin(aF), aTM=toMin(aT);
  if(aFM!=null&&aTM!=null&&aTM>aFM){const mins=aTM-aFM; absTotal.textContent=en2ar(mins)+' دقيقة'; absHH.textContent=fmtHM(mins); tAbsFrom.classList.remove('empty'); tAbsTo.classList.remove('empty');}
  const eF=tEarlyFrom.textContent.trim(), eFM=toMin(eF);
  if(eFM!=null&&weM!=null&&weM>eFM){const mins=weM-eFM; earlyTotal.textContent=en2ar(mins)+' دقيقة'; earlyHH.textContent=fmtHM(mins); tEarlyFrom.classList.remove('empty');}
}

/* انعكاس سبب لفت النظر */
document.getElementById('noteReason').addEventListener('change', e=>{
  const txt=e.target.value||'المهمة المحددة';
  document.getElementById('noteReasonText').textContent=txt;
});

/* تطبيق بيانات المعلم + الرقم */
selTeacher.addEventListener('change',e=>{
  const i=+e.target.value; const t=Number.isInteger(i)?TEACHERS[i]:null; if(!t) return;
  t_name.textContent=t.name||'—'; t_spec.textContent=t.spec||'—'; t_level.textContent=t.level||'—';
  t_job.textContent=t.job||'—'; t_work.textContent=t.work||'—'; t_civil.textContent=t.civil||'—';
  teacherNameInline.textContent=t.name||'—'; noteTeacherName.textContent=t.name||'—'; document.getElementById('affTeacher').textContent=t.name||'—';
  document.getElementById('abs-name-top').textContent=t.name||'—'; document.getElementById('abs-teacher-name').textContent=t.name||'—';
  metaNo.textContent=nextSerialFor(t.civil);
});

/* واتساب (أسلوب تربوي) */
document.getElementById('btnWA').addEventListener('click', ()=>{
  const i=+selTeacher.value; if(!Number.isInteger(i)) return alert('اختر معلماً أولاً');
  const t=TEACHERS[i];
  const kind=STATE.kind;
  const kindLabel={late:'تنبيه تأخر',absent:'تنبيه عدم تواجد',early:'تنبيه انصراف مبكر',gaib:'مساءلة غياب',note:'لفت نظر'}[kind];
  let details='';
  if(kind==='late'){ details=`تأخّر عن بداية الدوام، ووقت الحضور: ${document.getElementById('tLateIn').textContent.trim()}؛ نأمل معالجة السبب والالتزام بمواعيد العمل.`; }
  else if(kind==='absent'){ details=`عدم تواجد خلال ساعات الدوام؛ نأمل إيضاح السبب وإرفاق ما يؤيده.`; }
  else if(kind==='early'){ details=`انصراف قبل نهاية الدوام؛ نأمل الالتزام بالوقت الرسمي.`; }
  else if(kind==='gaib'){ details=`تم تسجيل مساءلة غياب لليوم الموضّح.`; }
  else if(kind==='note'){ details=`لفت نظر بسبب: ${document.getElementById('noteReasonText').textContent.trim()}`; }
  const msg=`السلام عليكم
${kindLabel}
الاسم: ${t.name}
اليوم: ${metaDay.textContent}
التاريخ (هـ): ${metaHijri.textContent}
${details}
*نظام الشؤون الإدارية والمتابعة*`;
  const num=t.phone||'966500000000';
  window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`,'_blank');
});

/* ===== إصلاح PDF دون أي تغيير بصري ===== */
async function inlineHeaderImage(){
  const img=document.getElementById('hdrImg'); if(!img) return;
  try{
    img.setAttribute('crossorigin','anonymous');
    const resp=await fetch(img.getAttribute('src'),{cache:'no-store',mode:'cors'});
    if(!resp.ok) return;
    const blob=await resp.blob();
    const reader=new FileReader();
    await new Promise(res=>{ reader.onload=()=>{ img.src=reader.result; res(); }; reader.readAsDataURL(blob); });
  }catch(e){ /* إن تعذر، نتركه كما هو */ }
}

/* زر PDF و حفظ */
document.getElementById('btnPDF').addEventListener('click', async ()=>{
  const i=+selTeacher.value; if(!Number.isInteger(i)) { alert('اختر معلماً أولاً'); return; }
  const t=TEACHERS[i];

  ARCH.push({ ts:Date.now(), civil:t.civil, name:t.name, kind:STATE.kind, excuse:STATE.excuse, accept:STATE.accept, faris:STATE.faris, hijri:metaHijri.textContent, day:metaDay.textContent });
  saveARCH();

  const { jsPDF }=window.jspdf;
  const btn=this; btn.disabled=true; btn.textContent='جارٍ إنشاء PDF...';
  try{
    await inlineHeaderImage(); // منع تلوّث الـcanvas
    const canvas=await html2canvas(document.getElementById('sheet'),{
      scale:2, background:'#fff', useCORS:true, allowTaint:false, imageTimeout:0
    });
    const pdf=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
    const w=210,h=canvas.height*210/canvas.width;
    pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,w,h);
    pdf.save(`إجراء - ${t.name}.pdf`);
  }catch(err){ alert('تعذّر إنشاء PDF: '+(err.message||err)); }
  finally{ btn.disabled=false; btn.textContent='PDF و حفظ'; }
});

/* PDF لملخص الإحصائيات */
document.getElementById('btnStatsPDF').onclick=async()=>{
  const { jsPDF }=window.jspdf;
  const card=document.querySelector('#statsDlg .stats-card');
  const canvas=await html2canvas(card,{scale:2,background:'#fff',useCORS:true,allowTaint:false});
  const pdf=new jsPDF({orientation:'l',unit:'mm',format:'a4'});
  const w=297,h=canvas.height*297/canvas.width;
  pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,w,h);
  pdf.save('ملخص-الإحصائيات.pdf');
};

/* إحصائيات */
document.getElementById('btnStats').onclick=openStats;
document.getElementById('btnCloseStats').onclick=()=>statsDlg.style.display='none';
function shortDetails(r){
  if(r.kind==='late'){ const txt=document.getElementById('lateTotal')?.textContent||'0 دقيقة'; return `تأخر ${txt.replace(/[^\d٠-٩]/g,'').trim()}د`; }
  if(r.kind==='absent'){ const a=document.getElementById('absTotal')?.textContent||'0 دقيقة'; return `عدم تواجد ${a.replace(/[^\d٠-٩]/g,'').trim()}د`; }
  if(r.kind==='early'){ const e=document.getElementById('earlyTotal')?.textContent||'0 دقيقة'; return `انصراف ${e.replace(/[^\d٠-٩]/g,'').trim()}د`; }
  if(r.kind==='gaib'){ return `غياب`; }
  if(r.kind==='note'){ const rs=document.getElementById('noteReasonText')?.textContent||'—'; return `لفت نظر — ${rs}`; }
  return '—';
}
function openStats(){
  const tb=document.querySelector('#tblStats tbody'); tb.innerHTML='';
  const byTeacher=new Map(); ARCH.forEach(r=>{const k=r.civil||r.name; if(!byTeacher.has(k)) byTeacher.set(k,{name:r.name,rows:[]}); byTeacher.get(k).rows.push(r);});
  for(const {name,rows} of byTeacher.values()){
    rows.sort((a,b)=>a.ts-b.ts);
    rows.forEach((r,idx)=>{
      const tr=document.createElement('tr');
      if(idx===0) tr.innerHTML=`<td rowspan="${rows.length}" style="font-weight:900">${name}</td>`;
      tr.innerHTML+=`
        <td>${({late:'تنبيه تأخر',absent:'تنبيه عدم تواجد',early:'تنبيه انصراف مبكر',gaib:'مساءلة غياب',note:'لفت نظر'})[r.kind]}</td>
        <td>${r.day}</td>
        <td>${r.hijri}</td>
        <td>${({with:'بعذر',without:'بدون'})[r.excuse]||'—'} / ${({accepted:'مقبول',rejected:'غير مقبول'})[r.accept]||'—'}</td>
        <td>${({raised:'مرفوع',not:'لم يُرفع'})[r.faris]||'—'}</td>
        <td>${shortDetails(r)}</td>`;
      tb.appendChild(tr);
    });
  }
  statsDlg.style.display='flex';
}

/* تهيئة */
function init(){
  buildHijriPicker();
  refreshWorkRangeLine();
  setPack('late');
}
init();
</script>
</body>
</html>
