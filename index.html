<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</title>
<meta name="theme-color" content="#0b7e88">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">

<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{ --moe:#0b7e88; --ink:#111; --label:#064c50; --bg:#f7fafc; --content:190mm; --nudgeX:0mm; --scale:1; }

*{box-sizing:border-box}
html,body{ margin:0;background:var(--bg);color:var(--ink);
  font:13.8px/1.9 "Tajawal","Noto Sans Arabic","Noto Naskh Arabic",system-ui;
  -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility; }

.sheet-wrap{display:grid;place-items:center;margin:10mm 0;padding:8px}
.sheet{ width:210mm;min-height:297mm;background:#fff;
  transform:translateX(var(--nudgeX)) scale(var(--scale));
  transform-origin: top center; filter: contrast(1.06); }

/* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== */
.header{padding:8mm 12mm 6mm;border-bottom:2px solid #eaf1f1}
.hdr-grid{ display:grid; grid-template-columns: 1fr 150px 1fr; align-items:center; gap:12mm; }
.hdr-left-org{ justify-self:start; display:flex; align-items:center; justify-content:center; text-align:center; }
.org{ display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--label); line-height:1.25; gap: 2mm; max-width:100%; }
.org .l1{font-weight:900;font-size:13.2px}
.org .l2{font-weight:900;font-size:12.8px}
.org .l3{font-weight:800;font-size:12.4px}
.org .l4{font-weight:800;font-size:12.4px}
.hdr-center{ justify-self:center; text-align:center; }
.hdr-center img{ width:150px;height:150px;object-fit:contain;display:block;margin:0 auto; image-rendering:-webkit-optimize-contrast; }
.hdr-right-info{ justify-self:end; text-align:right; transform: translateX(-8mm); }
.meta-item{display:block;white-space:nowrap;margin:0 0 2px}
.meta-item .label{font-weight:900;color:var(--label);margin-left:4px}
.meta-item .value{font-weight:900}
.case-total{margin-top:4px;font-size:12px;color:#2f4f4b}

/* ===== Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª (ØµÙ ÙˆØ§Ø­Ø¯ Ù…ØªÙ‚Ø§Ø±Ø¨) ===== */
.toolbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee;padding:8px 10px}
.toolbar-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.toolbar .left,.toolbar .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.hint{font-size:12px;color:#6b7280}
.search,.select,.t{padding:9px 12px;border:1px solid #d7ecec;border-radius:12px;background:#fff}
.search{min-width:160px}
.select{min-width:160px}

/* Chips + Ripple */
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{
  --bg:#eef7f7; --fg:#0b5e63;
  border:1px solid #d7ecec;background:var(--bg);color:var(--fg);
  padding:8px 12px;border-radius:12px;font-weight:900;cursor:pointer;
  display:inline-flex;align-items:center;gap:8px;position:relative;overflow:hidden;user-select:none
}
.chip.primary{ --bg:var(--moe); --fg:#fff; border:0; }
.chip.warn{ --bg:#fff5f5; --fg:#b91c1c; border-color:#fecaca; }
.chip .ico{font-size:16px;line-height:1}
.chip input[type=file]{display:none}
.ripple{position:absolute;border-radius:50%;transform:scale(0);animation:ripple .6s linear;background:rgba(255,255,255,.5);pointer-events:none}
@keyframes ripple{to{transform:scale(12);opacity:0}}

.split{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:6px;padding-top:6px;border-top:1px dashed #e5efef}
.pack{display:flex;align-items:center;gap:6px;flex-wrap:wrap}

/* Ø§Ù„ØµÙØ­Ø© */
.page{padding:6mm 0 10mm;display:grid;place-items:center}
.content{width:var(--content);margin:0 auto}

/* Ø¹Ù†ÙˆØ§Ù† */
.notice-center{width:var(--content);margin:5mm auto 2mm;display:flex;flex-direction:column;align-items:center;gap:6px}
.notice-center .title{font-weight:900;font-size:28px;line-height:1.1;color:#0b5e63;filter:contrast(120%)}
.seg{display:inline-flex;background:#eef7f7;border:1px solid #d7ecec;border-radius:999px;overflow:hidden}
.seg input{display:none}
.seg label{padding:10px 16px;cursor:pointer;font-weight:800;color:#0b5e63;user-select:none}
.seg input:checked+label{background:#0b7e88;color:#fff}

/* Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… */
.table-wrap{width:var(--content);margin:4mm auto 0;display:flex;justify-content:center;overflow-x:auto}
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl thead th{ background:#0b5e63;color:#fff;border:1.2px solid #244a4a;
  padding:6px 7px;text-align:center;font-weight:900;font-size:13px}
.tbl td{ border:1.2px solid #3f5b57;padding:5px 7px;vertical-align:middle;
  height:12mm;font-size:13.2px;line-height:1.55;background:#fff;text-align:center}
.tbl thead th.name,.tbl td.name{width:38%}
.tbl thead th.spec,.tbl td.spec{width:14%}
.tbl thead th.level,.tbl td.level{width:16%}
.tbl thead th.job,.tbl td.job{width:16%}
.tbl thead th.work,.tbl td.work{width:16%}
.tbl td span[contenteditable]{display:block;outline:none;overflow-wrap:anywhere;word-break:break-word;font-weight:700}
.tbl td.name span[contenteditable]{font-size:15.5px;font-weight:900}

/* Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ */
.below-flex{width:var(--content);margin:2mm auto 0;display:flex;flex-direction:row-reverse;justify-content:flex-end}
.civil-badge{ width:38%;display:flex;align-items:center;gap:10px;justify-content:center;
  border:1.5px solid var(--moe);background:#fff;color:#0b3340;border-radius:12px;min-height:9.5mm;padding:3px 6px}
.civil-badge .labTag{background:var(--moe);color:#fff;font-weight:900;padding:2px 10px;border-radius:8px;white-space:nowrap}
.civil-badge .civilValue{background:#fff;padding:0 6px;border-radius:6px;min-width:42mm;display:inline-block;text-align:center;font-weight:900}

/* Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
.sec{width:var(--content);margin:6mm auto;padding:0}
.sec h3{margin:0 0 8px;color:#0b5e63}
.sec h3 .kind{color:#0b7e88}
.rule-row{display:flex;align-items:center;gap:8px;margin-top:4px}
.rule-row .label{font-weight:900;white-space:nowrap}
.rule-row .dots{flex:1;border-bottom:1px dotted #9fb7b3;height:0}
.rule-row .leftnote{white-space:nowrap}
.dotfield{display:inline-block;min-width:28mm;border-bottom:1px dotted #9fb7b3;text-align:center;padding:0 2mm}
.checks{margin:6px 0 8px}
.checkline{display:flex;align-items:flex-start;gap:8px;margin:6px 0}
.checkline input{margin-top:4px;transform:scale(1.15)}
.checkline .text{flex:1}
.calc{font-weight:900;color:#0b5e63}
.timebox{display:inline-block;min-width:28mm;text-align:center;padding:.5mm 3mm;background:#fff;color:#111;font-weight:900;border-radius:6px;border:1px solid #000;font-family:ui-monospace,Consolas,monospace}
.timebox.empty{color:#777;border-color:#bbb}

/* Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨ */
.abs-pack{width:var(--content);margin:6mm auto}
.abs-pack h3{margin:0 0 8px;color:#0b5e63}
.abs-pack .para{margin:0 0 6px}
.abs-pack .lines{min-height:28mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe}
.abs-pack .lines div{height:10mm;border-bottom:1px dotted #9fb7b3}
.abs-pack .lines div:last-child{border-bottom:0}
.abs-pack .choices label{display:block;margin:6px 0}
.abs-pack .note{color:#374151;font-size:11.2px;line-height:1.85;margin-top:6mm}

/* Ù„ÙØª Ø§Ù„Ù†Ø¸Ø± */
.reason-wrap{display:inline;padding:0;border:0;vertical-align:middle}
.reason-wrap select{
  width:22px;height:22px;border:none;background:transparent;color:transparent;
  appearance:auto;-webkit-appearance:auto;-moz-appearance:auto;vertical-align:-2px;cursor:pointer;padding:0;margin-inline-start:6px;
}
#noteReasonText{font-weight:900}

/* Ù…Ù„Ø§Ø­Ø¸Ø§Øª + Ø­Ù‚ÙˆÙ‚ */
.small-muted{font-size:11px;color:#6b7280;margin-top:6px}
.rights{width:var(--content);margin:2mm auto 8mm;text-align:center;font-size:9.2px;color:#6b7280;font-weight:700}
@media print{ .rights{display:none !important} }
body.exporting .rights{display:none !important}
body.exporting .seg{display:none !important}

/* Ø·Ø¨Ø§Ø¹Ø© */
@media print{
  @page{size:A4;margin:9mm}
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  body{background:#fff;color:#000}
  .toolbar{display:none !important}
  .sheet-wrap{margin:0}
  .sheet{margin:0;transform:translateX(var(--nudgeX)) scale(1) !important;filter:none !important}
  .page{padding:0;display:block}
  :root{--content:190mm}
  .content,.notice-center,.table-wrap,.below-flex,.sec,.abs-pack{width:var(--content) !important;margin:0 auto !important}
  .tbl td,.tbl th{border-color:#000 !important}
  .reason-wrap{display:none !important}
}

/* Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
#importDialog{display:none;position:fixed;inset:0;z-index:400;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:12px}
#importCard{background:#fff;border-radius:14px;min-width:320px;max-width:900px;width:90%;padding:16px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.25)}
#previewTable th,#previewTable td{border:1px solid #e5efef;padding:6px 8px;text-align:center}
#previewTable{border-collapse:collapse;width:100%}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù…ÙØ­Ø³Ù‘Ù†Ø©) */
#statsDialog{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:300;align-items:center;justify-content:center;padding:12px}
#statsCard{background:#fff;border-radius:14px;min-width:320px;max-width:1100px;width:96%;padding:14px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.25)}
#statsCard h3{margin:0 0 8px;color:#0b5e63}
.stats-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
.stats-actions button{border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
.stats-actions .primary{background:var(--moe);color:#fff}
.stats-actions .ghost{background:#eef7f7;color:#0b5e63;border:1px solid #d7ecec}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:899px){ .stats-grid{grid-template-columns:1fr;} }

.stats-box{max-height:60vh;overflow:auto;border:1px solid #e6eeee;border-radius:10px}
.stats-table{width:100%;border-collapse:collapse}
.stats-table th{position:sticky;top:0;background:#0b5e63;color:#fff;border:1px solid #2e4a4a;padding:6px 7px;z-index:1}
.stats-table td{border:1px solid #3f5b57;padding:5px 7px;background:#fff;text-align:center}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef7f7;border:1px solid #d7ecec;font-weight:900;color:#0b5e63}
.kpi{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.kpi .card{padding:10px 12px;border:1px solid #e6eeee;border-radius:12px;background:#f8fcfc;font-weight:900}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ­ÙˆÙ‘ÙÙ„ */
#convDialog{display:none;position:fixed;inset:0;z-index:350;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:12px}
.conv-card{background:#fff;border-radius:14px;min-width:320px;max-width:700px;width:92%;padding:16px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.conv-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:680px){ .conv-grid{grid-template-columns:1fr;} }
.conv-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.conv-row .select{min-width:100px}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¤Ù‚Ù‘Øª ÙˆØ­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ */
#timePad{display:none;position:fixed;background:#fff;border:1px solid #e6eeee;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.25);padding:10px;z-index:200}
#adderPad{display:none;position:fixed;background:#fff;border:1px solid #e6eeee;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.25);padding:10px;z-index:200}
</style>
</head>
<body>

<!-- ===== Ø§Ù„Ø£Ø¯ÙˆØ§Øª (ÙƒÙ„Ù‡Ø§ ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ Ù…ØªÙ‚Ø§Ø±Ø¨) ===== -->
<div class="toolbar">
  <div class="toolbar-row">
    <div class="left">
      <div class="chips">
        <button id="btnMakePDF" class="chip" title="Ø¥Ù†Ø´Ø§Ø¡ PDF"><span class="ico">ğŸ“„</span><span>PDF</span></button>
        <button id="btnWA" class="chip" title="Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨"><span class="ico">ğŸ“²</span><span>ÙˆØ§ØªØ³Ø§Ø¨</span></button>
        <button id="btnOpenStats" class="chip" title="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ£Ø±Ø´ÙŠÙ"><span class="ico">ğŸ“Š</span><span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span></button>
        <label class="chip" id="dropZone" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ø¥ÙƒØ³Ù„/CSV)">
          <span class="ico">â¬†ï¸</span><span>Ø§Ø³ØªÙŠØ±Ø§Ø¯</span>
          <input id="fileInput" type="file" accept=".xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.ods,.csv,.tsv,.txt,.json">
        </label>
        <button id="btnClearImport" class="chip warn" title="ØªØµÙÙŠØ± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"><span class="ico">ğŸ§¹</span><span>ØªØµÙÙŠØ±</span></button>

        <button id="btnToggleCal" class="chip" title="Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ù…Ù†ØªÙ‚ÙŠ Ù‡Ø¬Ø±ÙŠ/Ù…ÙŠÙ„Ø§Ø¯ÙŠ"><span class="ico">ğŸ—“ï¸</span><span id="calModeTxt">Ù‡Ø¬Ø±ÙŠ</span></button>
        <button id="btnDateConv" class="chip" title="Ù…Ø­ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ â†”ï¸ Ù…ÙŠÙ„Ø§Ø¯ÙŠ)"><span class="ico">ğŸ”</span><span>Ù…Ø­ÙˆÙ„</span></button>

        <button id="btnAddLate" class="chip" title="Ø¥Ø¶Ø§ÙØ© Ø¯Ù‚Ø§Ø¦Ù‚ ØªØ£Ø®Ø± ÙŠØ¯ÙˆÙŠØ© Ù„Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ"><span class="ico">â±ï¸</span><span>Ø¥Ø¶Ø§ÙØ© ØªØ£Ø®Ø±</span></button>
      </div>
    </div>

    <div class="right">
      <span class="hint">Ø§Ø¨Ø­Ø« ÙˆØ§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹:</span>
      <input id="teacherSearch" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦">
      <select id="teacherSelect" class="select" style="min-width:240px">
        <option value="">â€” Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ â€”</option>
      </select>
    </div>
  </div>

  <div class="split">
    <!-- Ù…ÙÙ†ØªÙ‚ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠØªØ¨Ø¯Ù‘Ù„ Ù‡Ø¬Ø±ÙŠ/Ù…ÙŠÙ„Ø§Ø¯ÙŠ) -->
    <div class="pack" id="pickHijri">
      <span class="hint">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ§Ù‚Ø¹Ø© (Ù‡Ø¬Ø±ÙŠ Ø±Ø³Ù…ÙŠ):</span>
      <select id="hjDay" class="select"></select>
      <select id="hjMonth" class="select"></select>
      <select id="hjYear" class="select"></select>
    </div>

    <div class="pack" id="pickGreg" style="display:none">
      <span class="hint">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ§Ù‚Ø¹Ø© (Ù…ÙŠÙ„Ø§Ø¯ÙŠ):</span>
      <select id="gy" class="select"></select>
      <select id="gm" class="select"></select>
      <select id="gd" class="select"></select>
    </div>

    <div class="pack">
      <span class="hint">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…:</span><input id="workStart" class="t" type="time" value="06:45" step="60">
      <span class="hint">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…:</span><input id="workEnd" class="t" type="time" value="13:45" step="60">
    </div>
  </div>
</div>

<!-- Ø­ÙˆØ§Ø± Ù…ÙØ­ÙˆÙ‘Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
<div id="convDialog">
  <div class="conv-card">
    <h3 style="margin:0 0 10px;color:#0b5e63">Ù…Ø­ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ â†”ï¸ Ù…ÙŠÙ„Ø§Ø¯ÙŠ â€” Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª)</h3>
    <div class="conv-grid">
      <div>
        <div class="conv-row"><span class="hint">Ù‡Ø¬Ø±ÙŠ:</span>
          <select id="c_hy" class="select"></select>
          <select id="c_hm" class="select"></select>
          <select id="c_hd" class="select"></select>
        </div>
        <div id="convOutH" style="margin-top:8px;padding:10px;border:1px dashed #d7ecec;border-radius:10px;background:#fafefe;font-weight:800"></div>
      </div>
      <div>
        <div class="conv-row"><span class="hint">Ù…ÙŠÙ„Ø§Ø¯ÙŠ:</span>
          <select id="c_gy" class="select"></select>
          <select id="c_gm" class="select"></select>
          <select id="c_gd" class="select"></select>
        </div>
        <div id="convOutG" style="margin-top:8px;padding:10px;border:1px dashed #d7ecec;border-radius:10px;background:#fafefe;font-weight:800"></div>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="convCopy" class="chip"><span>Ù†Ø³Ø® Ø§Ù„Ù†ØªØ§Ø¦Ø¬</span></button>
      <button id="convClose" class="chip primary"><span>Ø¥ØºÙ„Ø§Ù‚</span></button>
    </div>
  </div>
</div>

<div class="sheet-wrap">
  <div class="sheet" id="sheet">
    <!-- ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== -->
    <div class="header">
      <div class="hdr-grid">
        <div class="hdr-left-org">
          <div class="org">
            <div class="l1">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
            <div class="l2">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
            <div class="l3">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</div>
            <div class="l4" id="schoolNameHdr">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±</div>
          </div>
        </div>

        <div class="hdr-center">
          <img src="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ….png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" id="moeLogo" draggable="false" crossOrigin="anonymous">
        </div>

        <div class="hdr-right-info meta">
          <div class="meta-item"><span class="label">Ø§Ù„Ø±Ù‚Ù…:</span><span class="value" id="serialNo">01</span></div>
          <div class="meta-item"><span class="label"> Ø§Ù„ØªØ§Ø±ÙŠØ® :</span><span class="value" id="hdrHijri">â€”</span></div>
          <div class="case-total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø§Ø¡Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…: <strong id="caseTotal">0</strong></div>
        </div>
      </div>
    </div>

    <div class="page">
      <div class="content">

        <!-- Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ -->
        <div class="notice-center">
          <div class="title" id="mainTitle">ØªÙ†Ø¨ÙŠÙ‡</div>
          <div class="seg" id="noticeSeg">
            <input type="radio" name="nt" id="nt-note"  value="note"><label for="nt-note">Ù„ÙØª Ù†Ø¸Ø±</label>
            <input type="radio" name="nt" id="nt-gaib"  value="gaib"><label for="nt-gaib">ØºÙŠØ§Ø¨</label>
            <input type="radio" name="nt" id="nt-late"  value="late" checked><label for="nt-late">ØªØ£Ø®Ø±</label>
            <input type="radio" name="nt" id="nt-abs"   value="absent"><label for="nt-abs">Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯</label>
            <input type="radio" name="nt" id="nt-early" value="early"><label for="nt-early">Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±</label>
          </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… -->
        <div class="table-wrap">
          <table class="tbl" aria-label="Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù">
            <thead>
              <tr>
                <th class="name">Ø§Ù„Ø§Ø³Ù…</th>
                <th class="spec">Ø§Ù„ØªØ®ØµØµ</th>
                <th class="level">Ø§Ù„Ù…Ø±ØªØ¨Ø©</th>
                <th class="job">Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ©</th>
                <th class="work">Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="name"><span id="t_name"  contenteditable="true"></span></td>
                <td class="spec"><span id="t_spec"  contenteditable="true"></span></td>
                <td class="level"><span id="t_level" contenteditable="true"></span></td>
                <td class="job"><span  id="t_job"   contenteditable="true"></span></td>
                <td class="work"><span id="t_work"  contenteditable="true"></span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ -->
        <div class="below-flex">
          <div class="civil-badge">
            <span class="labTag">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</span>
            <span id="t_civil" class="civilValue" contenteditable="true"></span>
          </div>
        </div>

        <!-- (Ø£) Ø­Ø²Ù…Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
        <div id="alertPack">
          <div class="sec">
            <h3>( 1 ) Ø®Ø·Ø§Ø¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ â€” <span class="kind" id="kindTitle">ØªØ£Ø®Ø±</span></h3>

            <div class="rule-row">
              <span class="label">Ø§Ù„Ù…ÙƒØ±Ù… Ø§Ù„Ù…Ø¹Ù„Ù… :</span>
              <span class="dots"></span>
              <span class="leftnote">ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡</span>
            </div>

            <p style="margin:6px 0 2px"><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡</strong></p>
            <p style="margin:0 0 6px">ÙˆØ¨Ø¹Ø¯ :</p>

            <p style="margin:0 0 6px">
              Ø¥Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ…
              <span class="dotfield" id="dayField"><span id="dynDay">â€”</span></span>
              Ø§Ù„Ù…ÙˆØ§ÙÙ‚
              <span class="dotfield" id="hijriField"><span id="dynHijri">â€”</span> Ù‡Ù€</span>
              :
            </p>

            <div class="checks">
              <label id="lineLate" class="checkline">
                <input type="checkbox" checked>
                <span class="text">
                  ØªØ£Ø®Ø±ÙƒÙ… Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ØŒ ÙˆØ­Ø¶ÙˆØ±ÙƒÙ… Ø§Ù„Ø³Ø§Ø¹Ø© ( <span id="tLateIn" class="timebox empty">--:--</span> ).
                  <span class="calc">â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®Ø±: <span id="lateTotal">0 Ø¯Ù‚ÙŠÙ‚Ø©</span> (<span id="lateHH">00:00</span> Ø³)</span>
                </span>
              </label>

              <label id="lineAbs" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯ÙƒÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© : ( <span id="tAbsFrom" class="timebox empty">--:--</span> )
                  Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© : ( <span id="tAbsTo" class="timebox empty">--:--</span> ).
                  <span class="calc">â€” Ù…Ø¯Ø© Ø¹Ø¯Ù… Ø§Ù„ØªÙˆØ§Ø¬Ø¯: <span id="absTotal">0 Ø¯Ù‚ÙŠÙ‚Ø©</span> (<span id="absHH">00:00</span> Ø³)</span>
                </span>
              </label>

              <label id="lineEarly" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  Ø§Ù†ØµØ±Ø§ÙÙƒÙ… Ù…Ø¨ÙƒØ±Ù‹Ø§ Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© : ( <span id="tEarlyFrom" class="timebox empty">--:--</span> ).
                  <span class="calc">â€” Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±: <span id="earlyTotal">0 Ø¯Ù‚ÙŠÙ‚Ø©</span> (<span id="earlyHH">00:00</span> Ø³)</span>
                </span>
              </label>
            </div>

            <p>Ø¹Ù„ÙŠÙ‡ Ù†Ø£Ù…Ù„ ØªÙˆØ¶ÙŠØ­ Ø£Ø³Ø¨Ø§Ø¨ Ø°Ù„Ùƒ Ù…Ø¹ Ø¥Ø±ÙØ§Ù‚ Ù…Ø§ ÙŠØ¤ÙŠØ¯ Ø¹Ø°Ø±ÙƒÙ… â€¦ ÙˆÙ„ÙƒÙ… ØªØ­ÙŠØ§ØªÙŠ.</p>

            <p style="margin-top:8px">
              <strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© :</strong>
              <span id="managerName1" class="dotfield" style="min-width:45mm">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
              &nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> <span class="dotfield" style="min-width:30mm"></span>
              &nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> <span class="dotfield" style="min-width:22mm"></span> Ù‡Ù€
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) Ø§Ù„Ø¥ÙØ§Ø¯Ø©</h3>
            <p><strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© :</strong> <span id="managerName2">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span></p>
            <p><strong>Ø§Ù„Ù…ÙƒØ±Ù… / Ù…Ø¯ÙŠØ± Ù…Ø¯Ø±Ø³Ø©.</strong></p>
            <p>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ ÙˆØ¨Ø¹Ø¯ :</p>
            <div style="min-height:38mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe">
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;"></div>
            </div>
            <p><span>Ø§Ù„Ø§Ø³Ù… :</span> <strong id="afadaName">â€”</strong>
               &nbsp;&nbsp;&nbsp; <span>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</span> ____________________
               &nbsp;&nbsp;&nbsp; <span>Ø§Ù„ØªØ§Ø±ÙŠØ® :</span> ____________________ Ù‡Ù€</p>
          </div>

          <div class="sec">
            <h3>( 3 ) Ø±Ø£ÙŠ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
            <p><label><input type="radio" name="opinion"> Ø¹Ø°Ø±Ù‡ Ù…Ù‚Ø¨ÙˆÙ„</label>
               &nbsp;&nbsp;<label><input type="radio" name="opinion"> Ø¹Ø°Ø±Ù‡ ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„ ÙˆÙŠÙØ­Ø³Ù… Ø¹Ù„ÙŠÙ‡</label></p>
            <p><strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© :</strong> <span id="managerName3">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span></p>
            <p><span>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</span> ____________________ &nbsp;&nbsp; <span>Ø§Ù„ØªØ§Ø±ÙŠØ® :</span> ____________________ Ù‡Ù€</p>
          </div>
        </div>

        <!-- (Ø¨) Ø­Ø²Ù…Ø© Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨ -->
        <div id="absencePack" class="abs-pack" style="display:none">
          <div class="sec" style="margin-top:0">
            <p class="para" id="absIntro">
              Ø¥Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ… <strong><span id="absDayP">â€”</span></strong>
              Ø§Ù„Ù…ÙˆØ§ÙÙ‚ <strong><span id="absDateYMD">â€”</span></strong>
              ØªØºÙŠØ¨Øª Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„.
            </p>
            <h3>( 1 ) Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙØ§Ø¯Ø©</h3>
            <p class="para"><strong>Ø§Ù„Ù…ÙƒØ±Ù… /</strong> <span id="abs-name-top">â€”</span> <span>ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡</span></p>
            <p class="para"><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡</strong> ÙˆØ¨Ø¹Ø¯ ØŒØŒØŒ</p>
            <p class="para">
              Ù…Ù† Ø®Ù„Ø§Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙˆØ§Ù… ØªØ¨ÙŠÙ† ØºÙŠØ§Ø¨ÙƒÙ… Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…ÙˆØ¶Ø­Ø© Ø¨Ø¹Ø§Ù„ÙŠØ©ØŒ Ø¢Ù…Ù„ Ø§Ù„Ø¥ÙØ§Ø¯Ø© Ø¹Ù† Ø³Ø¨Ø¨ Ø°Ù„Ùƒ
              ÙˆØ¹Ù„ÙŠÙƒÙ… ØªÙ‚Ø¯ÙŠÙ… Ù…Ø§ ÙŠØ¤ÙŠØ¯ Ø¹Ø°Ø±ÙƒÙ… Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ ÙÙ‚Ø· Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡ØŒ Ø¹Ù„Ù…Ø§Ù‹ Ø¨Ø£Ù†Ù‡ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø³ÙŠØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ù„Ø§Ø²Ù… Ø­Ø³Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª.
            </p>
            <p class="para">
              <strong>Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± :</strong> <span id="managerName4">ÙÙ‡Ø¯ Ø¨Ù† Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______ Ù‡Ù€
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) Ø§Ù„Ø¥ÙØ§Ø¯Ø©</h3>
            <p class="para"><strong>Ø§Ù„Ù…ÙƒØ±Ù… / Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</strong> ÙˆÙÙ‚Ù‡ Ø§Ù„Ù„Ù‡</p>
            <p class="para"><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡</strong> ÙˆØ¨Ø¹Ø¯:</p>
            <p class="para">Ø£ÙÙŠØ¯ÙƒÙ… Ø£Ù† ØºÙŠØ§Ø¨ÙŠ ÙƒØ§Ù† Ù„Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
            <div class="lines"><div></div><div></div><div></div></div>
            <p class="para">ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ØªÙ‚Ø¯ÙŠÙ… Ù…Ø§ ÙŠØ«Ø¨Øª Ø°Ù„Ùƒ Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡.</p>
            <p class="para">
              <strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… :</strong> <span id="abs-teacher-name">â€”</span>
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______ Ù‡Ù€
            </p>
          </div>

          <div class="sec">
            <h3>( 3 ) Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
            <div class="choices">
              <label><input type="checkbox"> ØªÙØ­ØªØ³Ø¨ Ù„Ù‡ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø¸Ø§Ù…ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±.</label>
              <label><input type="checkbox"> ÙŠÙØ­ØªØ³Ø¨ ØºÙŠØ§Ø¨Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ù‡ Ù„Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø¥Ø¶Ø·Ø±Ø§Ø±ÙŠØ© Ù„Ù‚Ø¨ÙˆÙ„ Ø¹Ø°Ø±Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±ØµÙŠØ¯Ù‡ ÙŠØ³Ù…Ø­ ÙˆÙ„Ø§ ÙŠÙØ­Ø³Ù… Ø¹Ù„ÙŠÙ‡.</label>
              <label><input type="checkbox"> ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„Ø­Ø³Ù… Ù„Ø¹Ø¯Ù… Ù‚Ø¨ÙˆÙ„ Ø¹Ø°Ø±Ù‡.</label>
            </div>
            <p class="para">
              <strong>Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± :</strong> <span id="managerName5">ÙÙ‡Ø¯ Ø¨Ù† Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® :</strong> ______ / ______ / ______ Ù‡Ù€
            </p>
          </div>

          <div class="note">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©</strong><br>
            1- ØªÙØ³ØªÙƒÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© ÙˆØªÙØ³Ù„Ù… Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ù…Ø§ ÙŠØ¬Ø¨ Ø­ÙŠØ§Ù„Ù‡Ø§.<br>
            2- Ø¥Ø°Ø§ Ø³Ø¨Ù‚ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© ØºÙŠØ§Ø¨ ÙˆÙ„Ø­Ù‚Ù‡Ø§ ØºÙŠØ§Ø¨ ØªÙØ­ØªØ³Ø¨ Ù…Ø¯Ø© Ø§Ù„ØºÙŠØ§Ø¨ ÙƒØ§Ù…Ù„Ø© Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©.<br>
            3- ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ¶Ø­ Ø§Ù„Ù…ØªØºÙŠØ¨ Ø£Ø³Ø¨Ø§Ø¨ ØºÙŠØ§Ø¨Ù‡ ÙÙˆØ± ØªØ³Ù„Ù…Ù‡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© ÙˆÙŠØ¹ÙŠØ¯Ù‡Ø§ Ù„Ø±Ø¦ÙŠØ³Ù‡.<br>
            4- ÙŠÙØ¹Ø·Ù‰ Ø§Ù„Ù…ØªØºÙŠØ¨ Ù…Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹ Ù„ØªÙ‚Ø¯ÙŠÙ… Ù…Ø§ ÙŠØ¤ÙŠØ¯ Ø¹Ø°Ø±Ù‡ ÙØ¥Ø°Ø§ Ø§Ù†Ù‚Ø¶Øª Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© ØªÙØ³ØªÙƒÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© ÙˆÙŠØªÙ… Ø§Ù„Ø­Ø³Ù….
          </div>
        </div>

        <!-- (Ø¬) Ù†Ù…ÙˆØ°Ø¬ Ù„ÙØª Ø§Ù„Ù†Ø¸Ø± -->
        <div id="notePack" class="sec" style="display:none">
          <h3>Ù†Ù…ÙˆØ°Ø¬ Ù„ÙØª Ø§Ù„Ù†Ø¸Ø±</h3>

          <p style="margin:0 0 4px">
            Ø§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„ÙØ§Ø¶Ù„/
            <span id="noteTeacherName" contenteditable="true" style="font-weight:900"></span>
            Ø­ÙØ¸Ù‡ Ø§Ù„Ù„Ù‡
          </p>
          <p style="margin:0 0 6px"><strong>Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ØŒ ÙˆØ¨Ø¹Ø¯ ØŒØŒØŒ</strong></p>

          <p id="noteParagraph" style="margin:0 0 8px">
            Ø¥Ø´Ø§Ø±Ø©Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©Ø› Ù„ÙˆØ­ÙØ¸
            <span id="noteReasonText" style="font-weight:900">Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span>.
            ÙˆÙ†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°Ù„ÙƒØŒ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ØªØ§Ù… Ø¨Ù…Ø§ ÙŠÙÙˆÙƒÙ„ Ø¥Ù„ÙŠÙƒÙ… Ù…Ù† Ù…Ù‡Ø§Ù…Ø› Ø¯Ø¹Ù…Ù‹Ø§ Ù„Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ù…Ù‡Ù†ÙŠ ÙˆØ±ÙØ¹Ù‹Ø§ Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡.
            <span class="reason-wrap" title="Ø§Ø®ØªØ± Ø³Ø¨Ø¨ Ù„ÙØª Ø§Ù„Ù†Ø¸Ø±">
              <select id="noteReasonSelect">
                <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨ â€”</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø§Ù„ØµØ¨Ø§Ø­ÙŠ Ø§Ù„Ù…ÙƒÙ„Ù‘Ù Ø¨Ù‡ ÙˆÙÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ØŒ Ù…Ù…Ø§ Ø£Ø«Ù‘Ø± Ø¹Ù„Ù‰ Ø§Ù†ØªØ¸Ø§Ù… Ø³ÙŠØ± Ø§Ù„Ø·Ø§Ø¨ÙˆØ± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ ÙˆØ§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø·Ù„Ø§Ø¨.</option>
                <option>Ø¹Ø¯Ù… Ø£Ø¯Ø§Ø¡ Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØŒ ÙˆÙ…Ø§ ÙŠØªØ±ØªØ¨ Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ø¶Ø¹Ù ÙÙŠ ØªÙ†Ø¸ÙŠÙ… Ø®Ø±ÙˆØ¬ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ¶Ù…Ø§Ù† Ø³Ù„Ø§Ù…ØªÙ‡Ù….</option>
                <option>Ø§Ù„ØªÙ‚ØµÙŠØ± ÙÙŠ Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø£Ø«Ù†Ø§Ø¡ ÙØªØ±Ø© Ø§Ù„ÙØ³Ø­Ø©ØŒ Ù…Ù…Ø§ Ù†ØªØ¬ Ø¹Ù†Ù‡ ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ© Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©.</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ØµÙ„Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø±ØºÙ… Ø¥Ø¯Ø±Ø§Ø¬Ù‡ Ø¶Ù…Ù† Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙˆÙƒÙ„Ø©.</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø£Ùˆ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³ØªÙŠ ÙˆÙÙ‚ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©.</option>
                <option>Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚ØªÙ‡Ø§ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¯ÙˆÙ† Ù…Ø¨Ø±Ø± Ù†Ø¸Ø§Ù…ÙŠØŒ Ù…Ù…Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©.</option>
                <option>Ø§Ù„ØªØ£Ø®Ø± ÙÙŠ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø¹Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠØŒ Ù…Ù…Ø§ ÙŠØ®Ù„Ù‘Ù Ø¨Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…Ø¯Ø±Ø³Ø©.</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ø·Ø§Ø¨ÙˆØ± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ Ø¯ÙˆÙ† Ø¹Ø°Ø± Ø±Ø³Ù…ÙŠØŒ ÙˆÙ‡Ùˆ Ù…Ø§ ÙŠÙØ¹Ø¯ ØªÙ‚ØµÙŠØ±Ù‹Ø§ ÙÙŠ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø·Ø© Ø¨Ø§Ù„Ù…Ø¹Ù„Ù….</option>
                <option>Ø¹Ø¯Ù… Ø­Ø¶ÙˆØ± Ù…Ø¬Ù„Ø³ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ø¨Ø§Ù„Ø±ØºÙ… Ù…Ù† ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ©ØŒ Ù…Ù…Ø§ ÙÙˆÙ‘Øª ÙØ±ØµØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„ÙØ¹Ù‘Ø§Ù„ Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± ÙˆØ¯Ø¹Ù… Ø§Ù„Ø´Ø±Ø§ÙƒØ© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©.</option>
                <option>Ø§Ù„ØªØºÙŠØ¨ Ø¹Ù† Ø§Ø¬ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±Ø³Ù…ÙŠ Ø¯ÙˆÙ† Ø¹Ø°Ø± Ù†Ø¸Ø§Ù…ÙŠØŒ ÙˆÙ‡Ùˆ Ù…Ø§ ÙŠÙØ¹Ø¯ Ù…Ø®Ø§Ù„ÙØ© Ù„Ù„Ø£Ù†Ø¸Ù…Ø© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©.</option>
                <option>Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¡Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ØŒ Ù…Ù…Ø§ ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ©.</option>
                <option>Ø±ÙØ¶ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§Ø¶Ø± Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„ØµØ§Ø¯Ø±Ø© Ù…Ù† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©ØŒ ÙˆÙ‡Ùˆ Ù…Ø§ ÙŠØ®Ø§Ù„Ù Ù…Ù‚ØªØ¶Ù‰ Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†ÙŠ.</option>
                <option>Ø±ÙØ¶ ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø£Ùˆ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„ØµØ§Ø¯Ø± Ù…Ù† Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø¯ÙˆÙ† Ù…Ø¨Ø±Ø± Ù†Ø¸Ø§Ù…ÙŠ.</option>
                <option>Ø¹Ø¯Ù… Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø¹Ù„Ù‰ Ù…Ù†ØµØ© (ÙØ§Ø±Ø³) ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙˆÙÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø¸Ù…Ø©.</option>
                <option>Ø¹Ø¯Ù… Ø¯Ø®ÙˆÙ„ÙƒÙ… Ø­ØµØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙƒÙ„Ù‘ÙÙ Ø¨Ù‡Ø§ ÙˆÙÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø¸Ù…Ø©ØŒ ÙˆÙ…Ø§ ØªØ±ØªÙ‘Ø¨ Ø¹Ù„Ù‰ Ø°Ù„Ùƒ Ù…Ù† ØªØ£Ø«ÙŠØ±Ù ÙÙŠ Ø§Ù†Ø¶Ø¨Ø§Ø· Ø³ÙŠØ± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨.</option>
                <option>ØªØ£Ø®Ù‘ÙØ±ÙƒÙ… Ø¹Ù† Ù…Ø¨Ø§Ø´Ø±Ø© Ø­ØµØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙƒÙ„Ù‘ÙÙ Ø¨Ù‡Ø§ ÙÙŠ ÙˆÙ‚ØªÙ‡Ø§ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙˆÙÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ØŒ Ø¨Ù…Ø§ ÙŠØ¤Ø«Ù‘Ø± ÙÙŠ Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø­ØµØµ ÙˆØªØ³Ù„Ø³Ù„Ù‡Ø§ ÙˆØ§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„ØªØ¹Ù„Ù‘Ù….</option>
              </select>
            </span>
          </p>

          <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
            <div style="flex:1">
              <p style="margin:0 0 4px"><strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ù„Ø§Ø·Ù„Ø§Ø¹:</strong> ...............................</p>
              <p style="margin:0 0 4px"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ...............................</p>
              <p style="margin:0"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ______ / ______ / 14Ù‡Ù€</p>
              <p class="small-muted">Ù‡Ø°Ø§ Ø§Ù„ØªØ¨Ù„ÙŠØº Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø±Ø¯.</p>
            </div>
            <div style="flex:1">
              <p style="margin:0 0 4px"><strong>ØªÙˆÙ‚ÙŠØ¹ Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</strong> <span id="managerNameNote">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span></p>
            </div>
          </div>
        </div>

        <div class="rights">Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ â€” ØªØ·ÙˆÙŠØ±: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>

      </div>
    </div>
  </div>
</div>

<!-- Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
<div id="importDialog" role="dialog" aria-modal="true">
  <div id="importCard">
    <h3 style="margin-top:0;color:#0b5e63">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
    <div class="map-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0">
      <label>ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ (Sheet)</label><select id="sheetSelect"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù…</label><select id="mapName"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ / Ø§Ù„Ù‡ÙˆÙŠØ©</label><select id="mapCivil"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ®ØµØµ</label><select id="mapSpec"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø±ØªØ¨Ø© / Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label><select id="mapLevel"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ©</label><select id="mapJob"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</label><select id="mapWork"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><select id="mapSchool"></select>
      <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬ÙˆØ§Ù„ / ÙˆØ§ØªØ³Ø§Ø¨</label><select id="mapPhone"></select>
    </div>
    <div class="preview" style="max-height:260px;overflow:auto;border:1px solid #e5efef;border-radius:10px;margin-top:8px">
      <table id="previewTable"></table>
    </div>
    <div class="dlg-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn-ghost" id="btnCancelImport" style="border:1px solid #d7ecec;background:#eef7f7;color:#0b5e63;border-radius:10px;padding:9px 12px;font-weight:800">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-primary" id="btnConfirmImport" style="background:#0b7e88;color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div id="statsDialog" role="dialog" aria-modal="true">
  <div id="statsCard">
    <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ¥Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø³Ø§Ø¡Ù„Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
    <div class="kpi" id="kpiRow"></div>

    <div class="stats-actions">
      <button id="btnExportArchive" class="ghost">ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        â¤´ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø©
        <input id="restoreInput" type="file" accept=".json" style="display:none">
      </label>
      <button id="btnResetAll" class="ghost">â†º ØªØµÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¡Ù„Ø§Øª</button>

      <span class="hint">ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø§Ø³Ù…:</span>
      <input id="statsFilter" class="search" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ø¹Ù„Ù…â€¦">

      <span class="hint">Ø§Ù„ÙØªØ±Ø© (Ù‡Ø¬Ø±ÙŠ YYYY/MM/DD):</span>
      <input id="fromHijri" class="search" placeholder="Ù…Ù† Ù‡Ù€">
      <input id="toHijri"   class="search" placeholder="Ø¥Ù„Ù‰ Ù‡Ù€">
      <button id="btnApplyRange" class="ghost">ØªØ·Ø¨ÙŠÙ‚</button>

      <button id="btnCloseStats" class="primary">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="stats-grid">
      <div>
        <h3 style="margin-top:0">Ø§Ù„Ø£Ø±Ø´ÙŠÙ (ØªÙØµÙŠÙ„ÙŠ)</h3>
        <div class="stats-box">
          <table class="stats-table" id="tblArchive">
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ)</th>
                <th>Ø§Ù„ÙŠÙˆÙ…</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                <th>Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</th>
                <th>Ø§Ù„Ù…Ø¯Ø© (Ø³Ø§Ø¹Ø§Øª:Ø¯Ù‚Ø§Ø¦Ù‚)</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div>
        <h3 style="margin-top:0">Ù…Ù„Ø®Øµ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
        <div class="stats-box">
          <table class="stats-table" id="tblSummary">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</th>
                <th>Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨</th>
                <th>ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±</th>
                <th>Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ£Ø®Ø±</th>
                <th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ£Ø®Ø±</th>
                <th>Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯</th>
                <th>Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±</th>
                <th>Ù„ÙØª Ù†Ø¸Ø±</th>
                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¤Ù‚Ù‘Øª -->
<div id="timePad">
  <div class="display" id="timePadDisplay" style="font:700 18px ui-monospace,Consolas,monospace;text-align:center;margin-bottom:6px">--:--</div>
  <div class="grid" style="display:grid;grid-template-columns:repeat(3,44px);gap:6px;justify-content:center">
    <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
    <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
    <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
    <button data-k=":">:</button><button data-k="0">0</button><button class="del">âŒ«</button>
  </div>
  <div class="row" style="display:flex;gap:8px;justify-content:center;margin-top:8px">
    <button class="action" id="timePadSave">Ø­ÙØ¸</button><button id="timePadClose">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø¥Ø¶Ø§ÙØ© Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ£Ø®Ø± -->
<div id="adderPad">
  <div style="font-weight:900;margin-bottom:6px">Ø¥Ø¶Ø§ÙØ© Ø¯Ù‚Ø§Ø¦Ù‚ ØªØ£Ø®Ø± Ù„Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
  <div class="row" style="display:flex;gap:6px;align-items:center">
    <input id="adderMins" class="search" type="number" min="0" step="1" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚">
    <button id="adderSave" class="chip primary">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
    <button id="adderClose" class="chip">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <div class="hint" style="margin-top:6px">ØªÙØ¶Ø§Ù ÙƒØ³Ø¬Ù„ ØªØ£Ø®Ø± ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±.</div>
</div>

<script>
/* ========= Ù…Ø¤Ø«Ø± Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø£Ø²Ø±Ø§Ø± ========= */
function addRipple(e){
  const btn=e.currentTarget; if(!btn.classList.contains('chip')) return;
  const wave=document.createElement('span'); wave.className='ripple';
  const r=btn.getBoundingClientRect(); const size=Math.max(r.width,r.height);
  wave.style.width=wave.style.height=size+'px';
  wave.style.left=(e.clientX-r.left-size/2)+'px'; wave.style.top=(e.clientY-r.top-size/2)+'px';
  btn.appendChild(wave); setTimeout(()=>wave.remove(),600);
}
document.addEventListener('click',ev=>{ const b=ev.target.closest('.chip'); if(b) addRipple(ev); });

/* ========= Ø¶Ø¨Ø· Ù‚ÙŠØ§Ø³ ÙˆØ±Ù‚Ø© A4 ========= */
function fitSheet(){
  const sheet=document.getElementById('sheet'); if(!sheet) return;
  const avail=Math.max(320, window.innerWidth-16);
  const scale=Math.min(1, avail/sheet.offsetWidth);
  document.documentElement.style.setProperty('--scale', String(scale));
}
window.addEventListener('resize',fitSheet);
window.addEventListener('orientationchange',fitSheet);
document.addEventListener('DOMContentLoaded',fitSheet);

/* ========= Ø£Ø¯ÙˆØ§Øª Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ©/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ========= */
const AR='Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©', EN='0123456789';
const en2ar = s => (''+s).replace(/[0-9]/g, d => AR[d]);
const ar2en = s => (''+s).replace(/[Ù -Ù©]/g, d => EN[AR.indexOf(d)]);

/* ========= ØªØ­ÙˆÙŠÙ„ Ù‡Ø¬Ø±ÙŠ/Ù…ÙŠÙ„Ø§Ø¯ÙŠ (Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰) ========= */
function fmtHijriNoSuffix(dateObj){
  const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'});
  const parts=fmt.formatToParts(dateObj);
  const day = parts.find(p=>p.type==='day').value.padStart(2,'0');
  const mon = parts.find(p=>p.type==='month').value.padStart(2,'0');
  const yr = parts.find(p=>p.type==='year').value;
  return `${day}/${mon}/${yr}`;
}
function fmtHijriYMDNoSuffix(dateObj){
  const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'});
  const parts=fmt.formatToParts(dateObj);
  const day = parts.find(p=>p.type==='day').value.padStart(2,'0');
  const mon = parts.find(p=>p.type==='month').value.padStart(2,'0');
  const yr = parts.find(p=>p.type==='year').value;
  return `${yr}/${mon}/${day}`;
}
function wdHijri(dateObj){
  return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(dateObj);
}
function hijriToGregorian(y, m, d){
  let lo = new Date(1937,0,1), hi = new Date(2077,11,31);
  const fmt = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'numeric',day:'numeric'});
  const parts = dt => {
    const ps = fmt.formatToParts(dt);
    return {
      y: +ar2en(ps.find(p=>p.type==='year').value),
      m: +ar2en(ps.find(p=>p.type==='month').value),
      d: +ar2en(ps.find(p=>p.type==='day').value)
    };
  };
  while(lo <= hi){
    const mid = new Date((lo.getTime()+hi.getTime())/2);
    const v = parts(mid);
    if(v.y===y && v.m===m && v.d===d) {
      return new Date(mid.getFullYear(), mid.getMonth(), mid.getDate());
    }
    if(v.y < y || (v.y===y && v.m < m) || (v.y===y && v.m===m && v.d < d)) {
      lo = new Date(mid.getFullYear(), mid.getMonth(), mid.getDate()+1);
    } else {
      hi = new Date(mid.getFullYear(), mid.getMonth(), mid.getDate()-1);
    }
  }
  return null;
}
function gregorianToHijri(dateObj){
  const fmt = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'});
  const parts = fmt.formatToParts(dateObj);
  const day = parts.find(p=>p.type==='day').value.padStart(2,'0');
  const mon = parts.find(p=>p.type==='month').value.padStart(2,'0');
  const yr = parts.find(p=>p.type==='year').value;
  return `${day}/${mon}/${yr}`;
}

/* ========= Ù…ÙÙ†ØªÙ‚ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ + Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ ========= */
let CAL_MODE = 'h'; // h=Hijri, g=Gregorian

function buildHijriPicker(){
  const dSel = document.getElementById('hjDay'),
        mSel = document.getElementById('hjMonth'),
        ySel = document.getElementById('hjYear');
  dSel.innerHTML = mSel.innerHTML = ySel.innerHTML = '';
  for(let d=1; d<=30; d++) dSel.add(new Option(en2ar(String(d).padStart(2,'0')), d));
  for(let m=1; m<=12; m++) mSel.add(new Option(en2ar(String(m).padStart(2,'0')), m));
  const now = new Date();
  const curAH = parseInt(ar2en(new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric'}).format(now)),10);
  for(let y = curAH - 10; y <= curAH + 10; y++) ySel.add(new Option(en2ar(String(y)), y));
  const parts = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
  dSel.value = parseInt(ar2en(parts.find(p=>p.type==='day').value),10);
  mSel.value = parseInt(ar2en(parts.find(p=>p.type==='month').value),10);
  ySel.value = parseInt(ar2en(parts.find(p=>p.type==='year').value),10);

  function update(){
    const y = +ySel.value, m = +mSel.value, d = +dSel.value;
    const g = hijriToGregorian(y, m, d);
    if(!g) return;
    const hijYMD = fmtHijriYMDNoSuffix(g);
    const hijDMY = fmtHijriNoSuffix(g);
    const dayName = wdHijri(g);
    document.getElementById('hdrHijri').textContent = `${hijYMD} Ù‡Ù€`;
    document.getElementById('dynDay').textContent = dayName;
    document.getElementById('dynHijri').textContent = hijDMY;
    document.getElementById('absDayP').textContent = dayName;
    document.getElementById('absDateYMD').textContent = hijYMD;

    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ÙÙ†ØªÙ‚ÙŠ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
    setGregFromDate(g);
  }
  dSel.onchange = mSel.onchange = ySel.onchange = update;
  update();
}

function buildGregPicker(){
  const ySel = document.getElementById('gy'),
        mSel = document.getElementById('gm'),
        dSel = document.getElementById('gd');
  ySel.innerHTML = mSel.innerHTML = dSel.innerHTML = '';
  const now = new Date();
  const yNow = now.getFullYear();
  for(let y=yNow-10; y<=yNow+10; y++) ySel.add(new Option(en2ar(String(y)), y));
  for(let m=1; m<=12; m++) mSel.add(new Option(en2ar(String(m).padStart(2,'0')), m));
  function daysIn(y,m){ return new Date(y, m, 0).getDate(); }
  function fillDays(){
    const y=+ySel.value, m=+mSel.value;
    const n=daysIn(y,m);
    dSel.innerHTML='';
    for(let d=1; d<=n; d++) dSel.add(new Option(en2ar(String(d).padStart(2,'0')), d));
  }
  ySel.onchange = ()=>{ fillDays(); updateFromGreg(); };
  mSel.onchange = ()=>{ fillDays(); updateFromGreg(); };
  dSel.onchange = updateFromGreg;
  // Ø¶Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…
  ySel.value = yNow; mSel.value = now.getMonth()+1; fillDays(); dSel.value = now.getDate();
  updateFromGreg();
}

function setGregFromDate(g){
  const ySel = document.getElementById('gy'),
        mSel = document.getElementById('gm'),
        dSel = document.getElementById('gd');
  if(!ySel) return;
  const y = g.getFullYear(), m = g.getMonth()+1, d = g.getDate();
  // Ù…Ù„Ø¡ Ø§Ù„Ø£ÙŠØ§Ù… Ø¥Ù† Ù„Ø²Ù…
  function daysIn(y,m){ return new Date(y, m, 0).getDate(); }
  const needFill = (+mSel.value||0)!==m || (+ySel.value||0)!==y || (dSel.options.length!==daysIn(y,m));
  if(needFill){
    ySel.value = y; mSel.value = m;
    dSel.innerHTML=''; const n=daysIn(y,m);
    for(let i=1;i<=n;i++) dSel.add(new Option(en2ar(String(i).padStart(2,'0')), i));
  }
  dSel.value = d;
}

function updateFromGreg(){
  const y=+document.getElementById('gy').value,
        m=+document.getElementById('gm').value,
        d=+document.getElementById('gd').value;
  const g = new Date(y, m-1, d);
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø¬Ø±ÙŠØ© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©
  const hijYMD = fmtHijriYMDNoSuffix(g);
  const hijDMY = fmtHijriNoSuffix(g);
  const dayName = wdHijri(g);
  document.getElementById('hdrHijri').textContent = `${hijYMD} Ù‡Ù€`;
  document.getElementById('dynDay').textContent = dayName;
  document.getElementById('dynHijri').textContent = hijDMY;
  document.getElementById('absDayP').textContent = dayName;
  document.getElementById('absDateYMD').textContent = hijYMD;

  // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ÙÙ†ØªÙ‚ÙŠ Ø§Ù„Ù‡Ø¬Ø±ÙŠ
  const fmt = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'numeric',day:'numeric'});
  const ps = fmt.formatToParts(g);
  document.getElementById('hjYear').value  = +ar2en(ps.find(p=>p.type==='year').value);
  document.getElementById('hjMonth').value = +ar2en(ps.find(p=>p.type==='month').value);
  document.getElementById('hjDay').value   = +ar2en(ps.find(p=>p.type==='day').value);
}

/* ØªØ¨Ø¯ÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙÙ†ØªÙ‚ÙŠ */
function toggleCalMode(){
  CAL_MODE = (CAL_MODE==='h') ? 'g' : 'h';
  document.getElementById('pickHijri').style.display = (CAL_MODE==='h')?'':'none';
  document.getElementById('pickGreg').style.display  = (CAL_MODE==='g')?'':'none';
  document.getElementById('calModeTxt').textContent = (CAL_MODE==='h')?'Ù‡Ø¬Ø±ÙŠ':'Ù…ÙŠÙ„Ø§Ø¯ÙŠ';
}
document.getElementById('btnToggleCal').addEventListener('click', toggleCalMode);

/* ========= Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† / Ø§Ù„ØªØ®Ø²ÙŠÙ† ========= */
let TEACHERS = JSON.parse(localStorage.getItem('teachersCache') || '[]');
let currentIdx = null;
function pad2(n){ return String(n).padStart(2,'0'); }
const MANAGER_KEY = 'managerName';
function getManagerName(){ return localStorage.getItem(MANAGER_KEY) || 'ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ'; }
function setManagerName(v){
  if(!v) return;
  localStorage.setItem(MANAGER_KEY, v);
  ['managerName1','managerName2','managerName3','managerName4','managerName5','managerNameNote'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.textContent = v;
  });
}

/* ========= Ø§Ù„Ø£Ø±Ø´ÙŠÙ ========= */
const ARCHIVE_KEY = 'caseArchive_v3';
let ARCHIVE = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');

function teacherKeyFromObj(obj){
  const c = (obj.civil||'').trim(), n = (obj.name||'').trim();
  return c ? ('id:' + c) : ('name:' + n);
}
function getCurrentTeacher(){
  if(currentIdx === null) return null;
  return TEACHERS[currentIdx] || null;
}
function computeCountsFor(key){
  let total = 0, lateMins=0;
  const byType = {gaib:0, late:0, absent:0, early:0, note:0};
  for(const e of ARCHIVE){
    if(e.tkey === key){
      total++;
      if(byType[e.kind] != null) byType[e.kind]++;
      if(e.kind==='late') lateMins += (e.mins||0);
    }
  }
  return { total, byType, lateMins };
}
function nextSerialFor(key){
  return computeCountsFor(key).total + 1;
}
function refreshHeaderCounts(){
  const t = getCurrentTeacher();
  if(!t){
    document.getElementById('serialNo').textContent = '01';
    document.getElementById('caseTotal').textContent = '0';
    return;
  }
  const key = teacherKeyFromObj(t);
  document.getElementById('serialNo').textContent = pad2(nextSerialFor(key));
  document.getElementById('caseTotal').textContent = computeCountsFor(key).total;
}
function saveArchive(){
  localStorage.setItem(ARCHIVE_KEY, JSON.stringify(ARCHIVE));
  refreshHeaderCounts();
}

/* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø¯ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ */
function recordCase(kind, source, mins){
  const t = getCurrentTeacher();
  if(!t){
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ù„Ù‘Ù… Ø£ÙˆÙ„Ø§Ù‹.');
    return false;
  }
  const key = teacherKeyFromObj(t);
  const serial = nextSerialFor(key);
  const hj = (document.getElementById('hdrHijri').textContent || '').replace('Ù‡Ù€','').trim();
  const day = (document.getElementById('dynDay').textContent || '').trim();
  const ts = Date.now();
  ARCHIVE.push({ ts, hj, day, kind, serial, source: source || 'manual', tkey: key,
                 name: (t.name||'').trim(), civil: (t.civil||'').trim(), mins: Math.max(0, mins|0) });
  saveArchive();
  return true;
}

/* ========= ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù„Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ========= */
function applyTeacher(t, idx){
  currentIdx = idx;
  document.getElementById('schoolNameHdr').textContent = t.school || 'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©';
  function set(id, v){
    const el = document.getElementById(id);
    if(el) el.textContent = v || '';
  }
  set('t_name', t.name);
  set('t_spec', t.spec);
  set('t_level', t.level || t.rank);
  set('t_job', t.job);
  set('t_work', t.work);
  set('t_civil', t.civil);
  document.getElementById('afadaName').textContent = t.name || 'â€”';
  document.getElementById('abs-name-top').textContent = t.name || 'â€”';
  document.getElementById('abs-teacher-name').textContent = t.name || 'â€”';
  document.getElementById('noteTeacherName').textContent = t.name || '';
  refreshHeaderCounts();
}
function refillSelect(){
  const sel = document.getElementById('teacherSelect');
  sel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ â€”</option>';
  TEACHERS.forEach((t,i)=> {
    sel.add(new Option(t.name || `Ù…Ø¹Ù„Ù… ${i+1}`, i));
  });
}
refillSelect();
document.getElementById('teacherSelect').addEventListener('change', e=>{
  const i = +e.target.value;
  if(Number.isInteger(i) && TEACHERS[i]){
    applyTeacher(TEACHERS[i], i);
  }
});
document.getElementById('teacherSearch').addEventListener('input', e=>{
  const q = e.target.value.trim();
  const sel = document.getElementById('teacherSelect');
  for(const opt of sel.options){
    if(!opt.value){ opt.hidden = false; continue; }
    opt.hidden = q && !opt.text.includes(q);
  }
});
['t_name','t_spec','t_level','t_job','t_work','t_civil','noteTeacherName'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('blur', ()=>{
    if(currentIdx === null || !TEACHERS[currentIdx]) return;
    const v = el.textContent.trim();
    if(id === 't_name' || id === 'noteTeacherName'){
      TEACHERS[currentIdx].name = v;
      document.getElementById('t_name').textContent = v;
      document.getElementById('noteTeacherName').textContent = v;
      document.getElementById('afadaName').textContent = v || 'â€”';
      document.getElementById('abs-name-top').textContent = v || 'â€”';
      document.getElementById('abs-teacher-name').textContent = v || 'â€”';
    } else if(id === 't_spec'){ TEACHERS[currentIdx].spec = v; }
    else if(id === 't_level'){ TEACHERS[currentIdx].level = v; }
    else if(id === 't_job'){ TEACHERS[currentIdx].job = v; }
    else if(id === 't_work'){ TEACHERS[currentIdx].work = v; }
    else if(id === 't_civil'){ TEACHERS[currentIdx].civil = v; }
    localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
    refreshHeaderCounts();
  });
});

/* Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ + Ø­ÙØ¸ */
['managerName1','managerName2','managerName3','managerName4','managerName5','managerNameNote'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.setAttribute('contenteditable','true');
  el.addEventListener('blur', ()=> setManagerName(el.textContent.trim() || ''));
});
setManagerName(getManagerName());

/* ØªØµÙÙŠØ± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
document.getElementById('btnClearImport').addEventListener('click', ()=>{
  if(!confirm('Ø³ÙŠØªÙ… ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  TEACHERS = [];
  localStorage.removeItem('teachersCache');
  refillSelect();
  ['t_name','t_spec','t_level','t_job','t_work','t_civil','afadaName','abs-name-top','abs-teacher-name','noteTeacherName']
    .forEach(id=>{ const el = document.getElementById(id); if(el) el.textContent = ''; });
  currentIdx = null;
  ARCHIVE = [];
  saveArchive();
});

/* ========= Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ========= */
const fileInput = document.getElementById('fileInput');
const drop = document.getElementById('dropZone');
const importDialog = document.getElementById('importDialog');

drop.addEventListener('click', e=>{
  if(e.target.id !== 'fileInput') fileInput.click();
});
['dragenter','dragover'].forEach(ev=>{
  drop.addEventListener(ev, e=>{
    e.preventDefault();
    drop.style.outline = '2px dashed #0b7e88';
  });
});
['dragleave','drop'].forEach(ev=>{
  drop.addEventListener(ev, e=>{
    e.preventDefault();
    drop.style.outline = 'none';
  });
});
drop.addEventListener('drop', e=>{
  e.preventDefault();
  const f = e.dataTransfer.files?.[0];
  if(f) beginImport(f);
});
fileInput.addEventListener('change', e=>{
  if(e.target.files && e.target.files[0]) beginImport(e.target.files[0]);
});

let IMPORT_CTX = { workbook: null, sheets: [], arrays: {}, headers: {} };

function detectSeparator(txt){
  const cTab = (txt.match(/\t/g)||[]).length;
  const cSemi = (txt.match(/;/g)||[]).length;
  const cComma = (txt.match(/,/g)||[]).length;
  if(cTab > cSemi && cTab > cComma) return '\t';
  if(cSemi > cComma) return ';';
  return ',';
}
async function readTextAllEnc(file){
  const buf = await file.arrayBuffer();
  try { return new TextDecoder('utf-8',{fatal:false}).decode(buf); } catch {}
  try { return new TextDecoder('windows-1256',{fatal:false}).decode(buf); } catch {}
  try { return new TextDecoder('iso-8859-6',{fatal:false}).decode(buf); } catch {}
  return await file.text();
}
function sheetToAOA(ws){ return XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval: '' }); }
function pickHeaderRow(A){
  const rowsToCheck = Math.min(5, A.length);
  let bestIdx = 0, bestScore = -1;
  const keywords = ['Ø§Ù„Ø§Ø³Ù…','name','Ø§Ù„Ù…Ø¹Ù„Ù…','Ø³Ø¬Ù„','Ø§Ù„ØªØ®ØµØµ','Ø§Ù„Ù…Ø±ØªØ¨Ø©','ÙˆØ¸ÙŠÙØ©','Ø§Ù„Ø¹Ù…Ù„','Ø¬ÙˆØ§Ù„','phone'];
  for(let r=0; r<rowsToCheck; r++){
    const row = (A[r]||[]).join(' ').toLowerCase();
    let score=0;
    for(const k of keywords) if(row.includes(k)) score++;
    if(score > bestScore){ bestScore = score; bestIdx = r; }
  }
  return bestIdx;
}
function guess(header){
  if(!header) return null;
  const h = header.toString().trim().toLowerCase();
  const tests = {
    name: ['name','Ø§Ù„Ø§Ø³Ù…','Ù…Ø¹Ù„Ù…','Ù…ÙˆØ¸Ù'],
    civil: ['Ø³Ø¬Ù„','Ù‡ÙˆÙŠØ©','id','national'],
    spec: ['ØªØ®ØµØµ','subject'],
    level: ['Ù…Ø±ØªØ¨Ø©','rank','level'],
    job: ['ÙˆØ¸ÙŠÙØ©','job','ÙˆØ¸Ø§Ø¦Ù'],
    work: ['Ø§Ù„Ø¹Ù…Ù„','work'],
    school: ['Ù…Ø¯Ø±Ø³Ø©','school'],
    phone: ['Ø¬ÙˆØ§Ù„','Ù‡Ø§ØªÙ','mobile','phone']
  };
  for(const k in tests){ for(const w of tests[k]){ if(h.includes(w)) return k; } }
  return null;
}

async function beginImport(file){
  try {
    const lower = (file.name || '').toLowerCase();
    let wb = null;
    if(/\.(csv|tsv|txt)$/.test(lower)){
      const text = await readTextAllEnc(file);
      const sep = detectSeparator(text);
      const rows = text.split(/\r?\n/).map(line => line.split(sep));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    } else if(/\.json$/.test(lower)){
      const text = await readTextAllEnc(file);
      const data = JSON.parse(text);
      const ws = XLSX.utils.json_to_sheet(data);
      wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    } else {
      const buf = await file.arrayBuffer();
      wb = XLSX.read(buf, { type:'array' });
    }
    if(!wb || !wb.SheetNames || wb.SheetNames.length === 0){
      throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙˆØ±Ø§Ù‚ ÙÙŠ Ø§Ù„Ù…Ù„Ù.');
    }
    IMPORT_CTX.workbook = wb;
    IMPORT_CTX.sheets = wb.SheetNames.slice();
    IMPORT_CTX.arrays = {};
    for(const sh of wb.SheetNames){
      IMPORT_CTX.arrays[sh] = sheetToAOA(wb.Sheets[sh]);
    }
    openImportDialog();
  } catch(err){
    alert('ØªØ¹Ø°Ù‘Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: ' + (err.message || err));
  }
}

function openImportDialog(){
  const sheetSel = document.getElementById('sheetSelect');
  sheetSel.innerHTML = '';
  (IMPORT_CTX.sheets.length ? IMPORT_CTX.sheets : ['Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª']).forEach(sh=>{
    sheetSel.add(new Option(sh, sh));
  });
  sheetSel.onchange = refreshMappingUI;
  ['mapName','mapCivil','mapSpec','mapLevel','mapJob','mapWork','mapSchool','mapPhone']
    .forEach(id => document.getElementById(id).innerHTML = '');
  refreshMappingUI();
  importDialog.style.display = 'flex';
  document.getElementById('btnCancelImport').onclick = ()=> importDialog.style.display = 'none';
  document.getElementById('btnConfirmImport').onclick = confirmImport;
}

function refreshMappingUI(){
  const sheetSel = document.getElementById('sheetSelect');
  const sh = sheetSel.value || IMPORT_CTX.sheets[0];
  const A = (IMPORT_CTX.arrays[sh] || []).slice();
  if(!A.length) return;
  const headerRowIdx = pickHeaderRow(A);
  const HEADS = (A[headerRowIdx]||[]).map(x => (x||'').toString().trim());
  const ROWS = A.slice(headerRowIdx+1, headerRowIdx+1+20);
  function fillSel(id){
    const el = document.getElementById(id);
    el.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø¹Ù…ÙˆØ¯Ù‹Ø§ â€”</option>';
    HEADS.forEach((h,i)=> el.add(new Option(h || `Ø¹Ù…ÙˆØ¯ ${i+1}`, i)));
    return el;
  }
  const sName = fillSel('mapName'),
        sCivil = fillSel('mapCivil'),
        sSpec = fillSel('mapSpec'),
        sLevel = fillSel('mapLevel'),
        sJob = fillSel('mapJob'),
        sWork = fillSel('mapWork'),
        sSchool = fillSel('mapSchool'),
        sPhone = fillSel('mapPhone');

  const idxByRole = {};
  HEADS.forEach((h,i)=>{ const r = guess(h); if(r && idxByRole[r] == null) idxByRole[r] = i; });
  if(idxByRole.name != null) sName.value = idxByRole.name;
  if(idxByRole.civil != null) sCivil.value = idxByRole.civil;
  if(idxByRole.spec != null) sSpec.value = idxByRole.spec;
  if(idxByRole.level != null) sLevel.value = idxByRole.level;
  if(idxByRole.job != null) sJob.value = idxByRole.job;
  if(idxByRole.work != null) sWork.value = idxByRole.work;
  if(idxByRole.school != null) sSchool.value = idxByRole.school;
  if(idxByRole.phone != null) sPhone.value = idxByRole.phone;

  const table = document.getElementById('previewTable');
  table.innerHTML = '';
  const thead = document.createElement('thead');
  const hr = document.createElement('tr');
  HEADS.forEach(h=>{ const th = document.createElement('th'); th.textContent = h; hr.appendChild(th); });
  thead.appendChild(hr); table.appendChild(thead);

  const tbody = document.createElement('tbody');
  ROWS.forEach(r=>{
    const tr = document.createElement('tr');
    HEADS.forEach((_, i)=>{ const td = document.createElement('td'); td.textContent = (r[i] != null ? r[i] : ''); tr.appendChild(td); });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  IMPORT_CTX.headers = { sheet: sh, headerRowIdx, heads: HEADS };
}

function normalizePhone(raw){
  if(!raw) return '';
  let s = ('' + raw).trim();
  s = ar2en(s).replace(/[^\d]/g, '');
  if(s.startsWith('00966')) s = s.slice(2);
  if(s.startsWith('00')) s = s.slice(2);
  if(s.startsWith('966')){
    if(s.length === 13 && s[3] === '0') s = '966' + s.slice(4);
    return s;
  }
  if(s.startsWith('05') && s.length === 10) return '966' + s.slice(1);
  if(s.startsWith('5') && s.length === 9) return '966' + s;
  return s;
}

function confirmImport(){
  try {
    const ctx = IMPORT_CTX.headers || {};
    const A = IMPORT_CTX.arrays[ctx.sheet] || [];
    if(!A.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.'); return; }
    function getIdx(id){ const v = document.getElementById(id).value; return v ? parseInt(v,10) : -1; }
    const cName = getIdx('mapName'),
          cCivil = getIdx('mapCivil'),
          cSpec = getIdx('mapSpec'),
          cLevel = getIdx('mapLevel'),
          cJob = getIdx('mapJob'),
          cWork = getIdx('mapWork'),
          cSchool = getIdx('mapSchool'),
          cPhone = getIdx('mapPhone');

    if(cName < 0 && cCivil < 0){ alert('Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„: Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ.'); return; }
    const startRow = (ctx.headerRowIdx || 0) + 1;
    const out = [];
    for(let r = startRow; r < A.length; r++){
      const row = A[r] || [];
      const name = cName >= 0 ? (row[cName] || '').toString().trim() : '';
      const civil = cCivil >= 0 ? (row[cCivil] || '').toString().trim() : '';
      const spec = cSpec >= 0 ? (row[cSpec] || '').toString().trim() : '';
      const level = cLevel >= 0 ? (row[cLevel] || '').toString().trim() : '';
      const job = cJob >= 0 ? (row[cJob] || '').toString().trim() : '';
      const work = cWork >= 0 ? (row[cWork] || '').toString().trim() : '';
      const school = cSchool >= 0 ? (row[cSchool] || '').toString().trim() : '';
      const phoneRaw = cPhone >= 0 ? row[cPhone] : '';
      const phone = normalizePhone(phoneRaw);
      if(!(name || civil)) continue;
      out.push({ name, civil, spec, level, job, work, school, phone });
    }
    if(!out.length){ alert('Ù„Ù… ÙŠÙØ³ØªØ®Ø±Ø¬ Ø³Ø¬Ù„Ø§Øª ØµØ§Ù„Ø­Ø©.'); return; }
    TEACHERS = out;
    localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
    refillSelect(); importDialog.style.display = 'none';
    alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${out.length} Ù…Ø¹Ù„Ù…Ø§Ù‹ Ø¨Ù†Ø¬Ø§Ø­.`);
  } catch(err){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + (err.message || err)); }
}

/* ========= Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø­Ø²Ù… ========= */
function setPack(kind){
  const alertPack = document.getElementById('alertPack');
  const absencePack = document.getElementById('absencePack');
  const notePack = document.getElementById('notePack');
  const mainTitle = document.getElementById('mainTitle');
  const kindTitle = document.getElementById('kindTitle');
  const lineLate = document.getElementById('lineLate');
  const lineAbs = document.getElementById('lineAbs');
  const lineEarly = document.getElementById('lineEarly');

  if(kind === 'gaib'){
    alertPack.style.display = 'none';
    absencePack.style.display = '';
    notePack.style.display = 'none';
    mainTitle.textContent = 'Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨';
  } else if(kind === 'note'){
    alertPack.style.display = 'none';
    absencePack.style.display = 'none';
    notePack.style.display = '';
    mainTitle.textContent = 'Ù„ÙØª Ù†Ø¸Ø±';
  } else {
    alertPack.style.display = '';
    absencePack.style.display = 'none';
    notePack.style.display = 'none';
    mainTitle.textContent = 'ØªÙ†Ø¨ÙŠÙ‡';
    lineLate.style.display = (kind==='late') ? '' : 'none';
    lineAbs.style.display = (kind==='absent') ? '' : 'none';
    lineEarly.style.display = (kind==='early') ? '' : 'none';
    const mapT = { late:'ØªØ£Ø®Ø±', absent:'Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯', early:'Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±' };
    kindTitle.textContent = mapT[kind] || 'â€”';
  }
}
document.querySelectorAll('#noticeSeg input[name="nt"]').forEach(r=> r.addEventListener('change', ()=> setPack(r.value)));
setPack(document.querySelector('#noticeSeg input[name="nt"]:checked').value);

/* ========= ØªØ­ÙˆÙŠÙ„ Ø¯Ù‚Ø§Ø¦Ù‚ â†”ï¸ Ø³Ø§Ø¹Ø§Øª:Ø¯Ù‚Ø§Ø¦Ù‚ ========= */
function toMin(hhmm){
  const m = /^(\d{1,2}):(\d{2})$/.exec(ar2en(hhmm||'').trim());
  if(!m) return null;
  const h = +m[1], mi = +m[2];
  if(h > 23 || mi > 59) return null;
  return h*60 + mi;
}
function fmtHM(mins){
  const h = Math.floor(mins/60), m = mins % 60;
  return en2ar(String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0'));
}

/* ========= Ù„ÙˆØ­Ø© Ø§Ù„ÙˆÙ‚Øª + Ø§Ù„Ø­Ø³Ø§Ø¨ ========= */
const timeTargets = ['tLateIn','tAbsFrom','tAbsTo','tEarlyFrom'];
let timePadTarget = null;

function recalc(){
  const ws = document.getElementById('workStart').value || '06:45';
  const we = document.getElementById('workEnd').value || '13:45';
  const wsM = toMin(ws), weM = toMin(we);

  // ØªØ£Ø®Ø±
  const tLate = document.getElementById('tLateIn').textContent.trim();
  const tLateM = toMin(tLate);
  if(tLateM != null && wsM != null && tLateM > wsM){
    const mins = tLateM - wsM;
    document.getElementById('lateTotal').textContent = en2ar(String(mins)) + ' Ø¯Ù‚ÙŠÙ‚Ø©';
    document.getElementById('lateHH').textContent = fmtHM(mins);
    document.getElementById('tLateIn').classList.remove('empty');
  } else {
    document.getElementById('lateTotal').textContent = '0 Ø¯Ù‚ÙŠÙ‚Ø©';
    document.getElementById('lateHH').textContent = '00:00';
    if(!tLate) document.getElementById('tLateIn').classList.add('empty');
  }

  // Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯
  const aF = document.getElementById('tAbsFrom').textContent.trim();
  const aT = document.getElementById('tAbsTo').textContent.trim();
  const aFM = toMin(aF), aTM = toMin(aT);
  if(aFM != null && aTM != null && aTM > aFM){
    const mins = aTM - aFM;
    document.getElementById('absTotal').textContent = en2ar(String(mins)) + ' Ø¯Ù‚ÙŠÙ‚Ø©';
    document.getElementById('absHH').textContent = fmtHM(mins);
    document.getElementById('tAbsFrom').classList.remove('empty');
    document.getElementById('tAbsTo').classList.remove('empty');
  } else {
    document.getElementById('absTotal').textContent = '0 Ø¯Ù‚ÙŠÙ‚Ø©';
    document.getElementById('absHH').textContent = '00:00';
    if(!aF) document.getElementById('tAbsFrom').classList.add('empty');
    if(!aT) document.getElementById('tAbsTo').classList.add('empty');
  }

  // Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±
  const eF = document.getElementById('tEarlyFrom').textContent.trim();
  const eFM = toMin(eF);
  if(eFM != null && weM != null && weM > eFM){
    const mins = weM - eFM;
    document.getElementById('earlyTotal').textContent = en2ar(String(mins)) + ' Ø¯Ù‚ÙŠÙ‚Ø©';
    document.getElementById('earlyHH').textContent = fmtHM(mins);
    document.getElementById('tEarlyFrom').classList.remove('empty');
  } else {
    document.getElementById('earlyTotal').textContent = '0 Ø¯Ù‚ÙŠÙ‚Ø©';
    document.getElementById('earlyHH').textContent = '00:00';
    if(!eF) document.getElementById('tEarlyFrom').classList.add('empty');
  }
}
['workStart','workEnd'].forEach(id=> document.getElementById(id).addEventListener('change', recalc));
timeTargets.forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.style.cursor = 'pointer';
  el.addEventListener('click', ()=>{
    timePadTarget = el;
    document.getElementById('timePadDisplay').textContent = el.textContent.trim() || '--:--';
    const r = el.getBoundingClientRect();
    const pad = document.getElementById('timePad');
    pad.style.left = Math.min(window.innerWidth - 260, Math.max(8, r.left)) + 'px';
    pad.style.top = (r.bottom + 8 + window.scrollY) + 'px';
    pad.style.display = 'block';
  });
});
document.querySelectorAll('#timePad .grid button[data-k]').forEach(b=>{
  b.addEventListener('click', ()=>{
    const disp = document.getElementById('timePadDisplay');
    let t = disp.textContent.replace(/-/g, '').trim();
    if(t === ':') t = '';
    t = (t === '--:--') ? '' : t;
    t += b.getAttribute('data-k');
    if((t.match(/:/g)||[]).length > 1) t = t.replace(/:+$/, '');
    disp.textContent = t;
  });
});
document.querySelector('#timePad .del').addEventListener('click', ()=>{
  const disp = document.getElementById('timePadDisplay');
  let t = disp.textContent;
  if(!t || t === '--:--') return;
  disp.textContent = t.slice(0,-1) || '--:--';
});
document.getElementById('timePadClose').addEventListener('click', ()=> document.getElementById('timePad').style.display = 'none');
document.getElementById('timePadSave').addEventListener('click', ()=>{
  if(!timePadTarget) return;
  const val = document.getElementById('timePadDisplay').textContent.trim();
  if(!/^(\d{1,2}):(\d{2})$/.test(ar2en(val))){ alert('ØµÙŠØºØ© Ø§Ù„ÙˆÙ‚Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§ÙƒØªØ¨ Ù…Ø«Ù„Ø§Ù‹ 07:15'); return; }
  timePadTarget.textContent = val;
  timePadTarget.classList.remove('empty');
  document.getElementById('timePad').style.display = 'none';
  recalc();
});

/* ========= Ù„ÙØª Ø§Ù„Ù†Ø¸Ø±: Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø¨Ø¨ ========= */
document.getElementById('noteReasonSelect').addEventListener('change', e=>{
  const v = e.target.value || '';
  if(v) document.getElementById('noteReasonText').textContent = v;
});

/* ========= Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª / Ø¹Ø±Ø¶ Ø£Ø±Ø´ÙŠÙ ========= */
function buildKPI(){
  const total = ARCHIVE.length;
  const by = { gaib:0, late:0, absent:0, early:0, note:0 };
  let lateMins = 0;
  ARCHIVE.forEach(e=>{ if(by[e.kind] != null) by[e.kind]++; if(e.kind==='late') lateMins += (e.mins||0); });
  const row = document.getElementById('kpiRow');
  row.innerHTML = '';
  const add = (label, val)=>{
    const d = document.createElement('div');
    d.className = 'card';
    d.textContent = `${label}: ${en2ar(val)}`;
    row.appendChild(d);
  };
  add('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', total);
  add('Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨', by.gaib);
  add('ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±', by.late);
  add('Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯', by.absent);
  add('Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±', by.early);
  add('Ù„ÙØª Ù†Ø¸Ø±', by.note);
  add('Ù…Ø¬Ù…Ù‘Ø¹ Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ£Ø®Ø±', lateMins);
  add('Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ£Ø®Ø±', fmtHM(lateMins));
}

function withinRange(hj, from, to){
  const norm = s => (s||'').trim();
  const H = norm(ar2en(hj));
  const F = norm(ar2en(from));
  const T = norm(ar2en(to));
  if(F && H < F) return false;
  if(T && H > T) return false;
  return true;
}

function renderArchive(){
  buildKPI();
  const nameFilter = (document.getElementById('statsFilter').value || '').trim();
  const fromH = (document.getElementById('fromHijri').value || '').trim();
  const toH = (document.getElementById('toHijri').value || '').trim();

  const tb = document.querySelector('#tblArchive tbody');
  tb.innerHTML = '';

  ARCHIVE
    .filter(e => !nameFilter || (e.name || '').includes(nameFilter))
    .filter(e => withinRange(e.hj, fromH, toH))
    .sort((a,b) => a.ts - b.ts)
    .forEach(e=>{
      const mins = e.mins|0;
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${e.hj}</td>
         <td>${e.day || ''}</td>
         <td>${e.name || ''}</td>
         <td>${e.civil || ''}</td>
         <td>${({gaib:'Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨', late:'ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±', absent:'Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯', early:'Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±', note:'Ù„ÙØª Ù†Ø¸Ø±'})[e.kind] || e.kind}</td>
         <td>${en2ar(mins)}</td>
         <td>${fmtHM(mins)}</td>
         <td>${en2ar(String(e.serial).padStart(2,'0'))}</td>`;
      tb.appendChild(tr);
    });

  const map = new Map();
  ARCHIVE
    .filter(e => !nameFilter || (e.name || '').includes(nameFilter))
    .filter(e => withinRange(e.hj, fromH, toH))
    .forEach(e=>{
      const k = e.tkey;
      if(!map.has(k)){
        map.set(k, { name: e.name || '', civil: e.civil || '', gaib:0, late:0, absent:0, early:0, note:0, lateMins:0 });
      }
      map.get(k)[e.kind] = (map.get(k)[e.kind] || 0) + 1;
      if(e.kind==='late') map.get(k).lateMins += (e.mins||0);
    });

  const tb2 = document.querySelector('#tblSummary tbody');
  tb2.innerHTML = '';
  for(const r of map.values()){
    const total = r.gaib + r.late + r.absent + r.early + r.note;
    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td>${r.name}</td>
       <td>${r.civil}</td>
       <td>${en2ar(r.gaib)}</td>
       <td>${en2ar(r.late)}</td>
       <td>${en2ar(r.lateMins)}</td>
       <td>${fmtHM(r.lateMins)}</td>
       <td>${en2ar(r.absent)}</td>
       <td>${en2ar(r.early)}</td>
       <td>${en2ar(r.note)}</td>
       <td><span class="badge">${en2ar(total)}</span></td>`;
    tb2.appendChild(tr);
  }
}

document.getElementById('btnOpenStats').addEventListener('click', ()=>{ renderArchive(); document.getElementById('statsDialog').style.display = 'flex'; });
document.getElementById('btnCloseStats').addEventListener('click', ()=> document.getElementById('statsDialog').style.display = 'none');
document.getElementById('btnApplyRange').addEventListener('click', renderArchive);
document.getElementById('statsFilter').addEventListener('input', renderArchive);
document.getElementById('btnExportArchive').addEventListener('click', ()=>{
  const obj = { ver:3, date: new Date().toISOString(), archive: ARCHIVE };
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'archive-backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById('restoreInput').addEventListener('change', async e=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try {
    const txt = await f.text();
    const obj = JSON.parse(txt);
    if(Array.isArray(obj)) ARCHIVE = obj;
    else if(obj && Array.isArray(obj.archive)) ARCHIVE = obj.archive;
    else throw new Error('ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
    saveArchive();
    renderArchive();
    alert('ØªÙ…Ù‘Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­.');
  } catch(err){
    alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: ' + (err.message || err));
  } finally { e.target.value = ''; }
});
document.getElementById('btnResetAll').addEventListener('click', ()=>{
  if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  ARCHIVE = [];
  saveArchive();
  renderArchive();
});

/* ========= Ø¥Ù†Ø´Ø§Ø¡ PDF (Ø­Ù„ Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ Ø¨ØµÙØ­Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©) ========= */
async function exportSheetToPDF(){
  document.body.classList.add('exporting');
  const sheet = document.getElementById('sheet');
  const canvas = await html2canvas(sheet, { scale:2, useCORS:true, background:'#ffffff' });
  const imgWidthMM = 210;  // Ø¹Ø±Ø¶ A4
  const imgHeightMM = imgWidthMM * canvas.height / canvas.width; // Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„ØµÙØ­Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© Ù„Ùˆ ÙˆØ¶Ø¹Øª ÙƒØ§Ù…Ù„Ø©
  const pageHeightMM = 297; // Ø§Ø±ØªÙØ§Ø¹ A4
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });

  // Ù†Ø­Ø³Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…ÙƒØ§ÙØ¦ Ù„ÙƒÙ„ ØµÙØ­Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
  const pageHeightPx = Math.floor(canvas.width * pageHeightMM / imgWidthMM);
  let yPx = 0;
  let first = true;

  while (yPx < canvas.height) {
    const slice = document.createElement('canvas');
    slice.width = canvas.width;
    slice.height = Math.min(pageHeightPx, canvas.height - yPx);
    const ctx = slice.getContext('2d');
    ctx.drawImage(canvas, 0, yPx, canvas.width, slice.height, 0, 0, canvas.width, slice.height);
    const img = slice.toDataURL('image/png');
    if(!first) pdf.addPage();
    pdf.addImage(img, 'PNG', 0, 0, imgWidthMM, slice.height * imgWidthMM / canvas.width);
    yPx += pageHeightPx;
    first = false;
  }

  const t = getCurrentTeacher();
  const kind = document.querySelector('#noticeSeg input[name="nt"]:checked')?.value || 'late';
  const namePart = t?.name ? (' - ' + t.name) : '';
  const kindLabel = { late:'ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±', absent:'ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯', early:'ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±', gaib:'Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨', note:'Ù„ÙØª Ù†Ø¸Ø±' }[kind] || 'ØªÙ†Ø¨ÙŠÙ‡';
  pdf.save(`${kindLabel}${namePart}.pdf`);
  document.body.classList.remove('exporting');
}

document.getElementById('btnMakePDF').addEventListener('click', ()=>{
  // Ù†Ø­Ø³Ø¨ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø¹Ù†Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù„Ø£Ø±Ø´ÙØ©
  const kind = document.querySelector('#noticeSeg input[name="nt"]:checked')?.value || 'late';
  let mins = 0;
  if(kind==='late'){ const m = parseInt(ar2en((document.getElementById('lateTotal').textContent||'').replace(/\D/g,''))||'0',10); mins = m||0; }
  if(kind==='absent'){ const m = parseInt(ar2en((document.getElementById('absTotal').textContent||'').replace(/\D/g,''))||'0',10); mins = m||0; }
  if(kind==='early'){ const m = parseInt(ar2en((document.getElementById('earlyTotal').textContent||'').replace(/\D/g,''))||'0',10); mins = m||0; }
  recordCase(kind, 'pdf', mins);
  exportSheetToPDF().catch(err=>{ document.body.classList.remove('exporting'); alert('ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF: ' + (err.message || err)); });
});

/* ========= Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨: Ù…Ø¹ Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø¯Ø© ========= */
const DEFAULT_WA = '966504532489';
document.getElementById('btnWA').addEventListener('click', ()=>{
  const t = getCurrentTeacher();
  const num = (t?.phone && /^\d{11,13}$/.test(t.phone)) ? t.phone : DEFAULT_WA;
  const kind = document.querySelector('#noticeSeg input[name="nt"]:checked')?.value || 'late';
  const hj = (document.getElementById('hdrHijri').textContent || '').trim();
  const day = (document.getElementById('dynDay').textContent || '').trim();
  const serial = (document.getElementById('serialNo').textContent || '').trim();
  const name = t?.name || 'â€”';
  let details = ''; let mins = 0;
  if(kind === 'late'){
    details = `ØªØ£Ø®Ø± Ø¹Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…. Ø³Ø§Ø¹Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: ${document.getElementById('tLateIn').textContent.trim()} â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®Ø±: ${document.getElementById('lateTotal').textContent} (${document.getElementById('lateHH').textContent} Ø³)`;
    mins = parseInt(ar2en((document.getElementById('lateTotal').textContent||'').replace(/\D/g,''))||'0',10);
  } else if(kind === 'absent'){
    details = `Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù… Ù…Ù† ${document.getElementById('tAbsFrom').textContent.trim()} Ø¥Ù„Ù‰ ${document.getElementById('tAbsTo').textContent.trim()} â€” Ø§Ù„Ù…Ø¯Ø©: ${document.getElementById('absTotal').textContent} (${document.getElementById('absHH').textContent} Ø³)`;
    mins = parseInt(ar2en((document.getElementById('absTotal').textContent||'').replace(/\D/g,''))||'0',10);
  } else if(kind === 'early'){
    details = `Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ± Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… Ù…Ù† ${document.getElementById('tEarlyFrom').textContent.trim()} â€” Ø§Ù„Ù…Ø¯Ø©: ${document.getElementById('earlyTotal').textContent} (${document.getElementById('earlyHH').textContent} Ø³)`;
    mins = parseInt(ar2en((document.getElementById('earlyTotal').textContent||'').replace(/\D/g,''))||'0',10);
  } else if(kind === 'gaib'){
    details = `Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø°ÙƒÙˆØ±.`;
  } else if(kind === 'note'){
    details = `Ù„ÙØª Ù†Ø¸Ø± Ø¨Ø³Ø¨Ø¨: ${document.getElementById('noteReasonText').textContent.trim()}`;
  }
  const kindLabel = { late:'ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ø®Ø±', absent:'ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ØªÙˆØ§Ø¬Ø¯', early:'ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±', gaib:'Ù…Ø³Ø§Ø¡Ù„Ø© ØºÙŠØ§Ø¨', note:'Ù„ÙØª Ù†Ø¸Ø±' }[kind] || 'ØªÙ†Ø¨ÙŠÙ‡';
  const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…
${kindLabel} â€” Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ${serial}
Ø§Ù„Ø§Ø³Ù…: ${name}
Ø§Ù„ÙŠÙˆÙ…: ${day}
Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ: ${hj}
${details}

*Ø£ÙØ±Ø³Ù„ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©*`;
  recordCase(kind, 'whatsapp', mins);
  const url = `https://wa.me/${num}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
});

/* ========= Ù…Ø­ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù†Ø§ÙØ°Ø©) ========= */
function openConv(){
  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
  const now = new Date();
  function fillRange(sel, from, to){
    sel.innerHTML=''; for(let v=from; v<=to; v++) sel.add(new Option(en2ar(String(v).padStart(2,'0')), v));
  }
  const c_hy = document.getElementById('c_hy'), c_hm=document.getElementById('c_hm'), c_hd=document.getElementById('c_hd');
  const curAH = parseInt(ar2en(new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric'}).format(now)),10);
  fillRange(c_hy, curAH-10, curAH+10); fillRange(c_hm,1,12); fillRange(c_hd,1,30);

  const c_gy = document.getElementById('c_gy'), c_gm=document.getElementById('c_gm'), c_gd=document.getElementById('c_gd');
  const yNow = now.getFullYear(); fillRange(c_gy,yNow-10,yNow+10); fillRange(c_gm,1,12);
  function fillGD(){ const y=+c_gy.value, m=+c_gm.value; const n=new Date(y,m,0).getDate(); c_gd.innerHTML=''; for(let i=1;i<=n;i++) c_gd.add(new Option(en2ar(String(i).padStart(2,'0')), i)); }
  c_gy.onchange=()=>{ fillGD(); updateConvG(); }; c_gm.onchange=()=>{ fillGD(); updateConvG(); }; c_gd.onchange=updateConvG;
  c_hy.onchange=updateConvH; c_hm.onchange=updateConvH; c_hd.onchange=updateConvH;

  // Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ù† Ø§Ù„Ù…ÙÙ†ØªÙ‚ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  const hy = +document.getElementById('hjYear').value;
  const hm = +document.getElementById('hjMonth').value;
  const hd = +document.getElementById('hjDay').value;
  c_hy.value=hy; c_hm.value=hm; c_hd.value=hd;

  const gy = +document.getElementById('gy').value || now.getFullYear();
  const gm = +document.getElementById('gm').value || (now.getMonth()+1);
  c_gy.value = gy; c_gm.value = gm; fillGD(); c_gd.value = +document.getElementById('gd').value || now.getDate();

  updateConvH(); updateConvG();
  document.getElementById('convDialog').style.display = 'flex';
}
function updateConvH(){
  const y=+document.getElementById('c_hy').value, m=+document.getElementById('c_hm').value, d=+document.getElementById('c_hd').value;
  const g = hijriToGregorian(y,m,d);
  const out = document.getElementById('convOutH');
  if(!g){ out.textContent='â€”'; return; }
  const gd = new Intl.DateTimeFormat('ar-SA',{year:'numeric',month:'2-digit',day:'2-digit'}).format(g);
  out.innerHTML = `Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„: <strong>${gd}</strong>`;
}
function updateConvG(){
  const y=+document.getElementById('c_gy').value, m=+document.getElementById('c_gm').value, d=+document.getElementById('c_gd').value;
  const g = new Date(y,m-1,d);
  const hijYMD = fmtHijriYMDNoSuffix(g) + ' Ù‡Ù€';
  const hijDMY = fmtHijriNoSuffix(g);
  document.getElementById('convOutG').innerHTML = `Ø§Ù„Ù‡Ø¬Ø±ÙŠ (Y/M/D): <strong>${hijYMD}</strong><br>Ø§Ù„Ù‡Ø¬Ø±ÙŠ (D/M/Y): <strong>${hijDMY}</strong>`;
}
document.getElementById('btnDateConv').addEventListener('click', openConv);
document.getElementById('convClose').addEventListener('click', ()=> document.getElementById('convDialog').style.display = 'none');
document.getElementById('convDialog').addEventListener('click', e=> { if(e.target.id === 'convDialog') e.currentTarget.style.display = 'none'; });
document.getElementById('convCopy').addEventListener('click', ()=>{
  const t = (document.getElementById('convOutH').innerText||'') + '\n' + (document.getElementById('convOutG').innerText||'');
  navigator.clipboard.writeText(t);
});

/* ========= Ø­Ø§Ø³Ø¨Ø© Ø¥Ø¶Ø§ÙØ© Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ£Ø®Ø± ========= */
function openAdder(){
  const ad = document.getElementById('adderPad');
  const r = document.getElementById('btnAddLate').getBoundingClientRect();
  ad.style.left = Math.min(window.innerWidth - 320, Math.max(8, r.left)) + 'px';
  ad.style.top = (r.bottom + 8 + window.scrollY) + 'px';
  ad.style.display = 'block';
}
document.getElementById('btnAddLate').addEventListener('click', openAdder);
document.getElementById('adderClose').addEventListener('click', ()=> document.getElementById('adderPad').style.display='none');
document.getElementById('adderSave').addEventListener('click', ()=>{
  const mins = parseInt(document.getElementById('adderMins').value||'0',10);
  if(!Number.isFinite(mins) || mins<=0){ alert('Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø¯Ù‚Ø§Ø¦Ù‚ ØµØ­ÙŠØ­Ù‹Ø§.'); return; }
  if(recordCase('late', 'manual-add', mins)){
    document.getElementById('adderMins').value='';
    document.getElementById('adderPad').style.display='none';
    alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ ÙˆØªÙˆØ«ÙŠÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.');
  }
});

/* ========= Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  buildHijriPicker();
  buildGregPicker();
  refreshHeaderCounts();
  recalc();
});
</script>
</body>
</html>
