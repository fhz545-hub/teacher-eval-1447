<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>استمارة دعم وتطوير الهيئة التعليمية (زيارة معلم) ١٤٤٧هـ</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&family=Cairo:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --moe-dark:#0c594e; --moe-green:#0f7a66; --moe-lite:#e8f4f1;
  --ink:#123b37; --line:#cfe1dd; --border:#e6efec; --bg:#fbfdfc;
  --good:#16a34a; --mid:#f59e0b; --bad:#ef4444;
  --strip:#f1fbf7;
  --base: clamp(14px, 1.15vw + 10px, 16.5px);

  --soft-green:#e9f7ee; --soft-green-b:#b9e4c8; --soft-green-t:#0f6a3b;
}
*{box-sizing:border-box}
html,body{margin:0;background:#fff;color:var(--ink);font-family:"Tajawal",system-ui;font-size:var(--base);min-height:100%}
#page{width:min(1200px,100vw);margin-inline:auto}
.wrap{padding:clamp(8px,2vw,16px)}
.hidden{display:none}

/* إبراز النواقص */
.input-error{border-color:#ef4444 !important;background:#fff5f5 !important; box-shadow:0 0 0 2px #fde2e2 inset}
.section-error{box-shadow:0 0 0 2px #fde2e2 inset}

/* رأس */
.govern-head{display:flex;flex-direction:column;gap:4px;align-items:center;margin-top:6px}
.govern-head .hl{font-family:"Cairo";font-weight:700;color:#0a5b50;text-align:center;display:inline-flex;gap:6px;align-items:center}
.govern-head .hl.small{font-size:clamp(13px,1.1vw + 10px,16px)}
.govern-head .hl.big{font-size:clamp(14px,1.2vw + 10px,18px)}
.govern-head .editable{padding:2px 6px;border-radius:8px;background:var(--moe-lite);border:1px dashed transparent;cursor:text}
.govern-head .editable[contenteditable="true"]{border-color:#b6d8d1;background:#fffef5}
.inline-pen{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 6px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;color:#0b5e54}
.inline-pen svg{width:14px;height:14px}
h1{margin:10px 0 8px;color:#0f7a66;font-family:"Cairo","Tajawal";font-size:clamp(18px,1.6vw + 14px,26px);text-align:center}
.badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:10px;background:#eaf7f4;color:#0b6256;font-weight:700;font-size:12px}

/* صناديق */
.box{border:1px solid var(--border);border-radius:14px;background:var(--bg);margin-top:10px;overflow:hidden}
.box h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:15px;color:#0c594e;display:flex;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:8px}
.fld{height:38px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff;font:inherit;text-align:center}
.col-3{grid-column:span 3/span 3}.col-12{grid-column:span 12/span 12}

/* أزرار عامة */
.btn-ic{display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0b5e54;font-weight:800;cursor:pointer;font-size:clamp(12px,.6vw + 10px,14px);transition:transform .12s ease}
.btn-ic:hover{transform:translateY(-1px)}
.btn-ic svg{width:18px;height:18px}
.btn-ic.tiny{padding:6px 8px}

/* الأزرار السفلية */
.bottom-actions .btn-ic{background:var(--soft-green);border-color:var(--soft-green-b);color:var(--soft-green-t)}

/* زيارات */
.visits{display:flex;gap:clamp(12px,2vw,24px);align-items:flex-start;justify-content:center;flex-wrap:wrap}
.visitCard{display:flex;flex-direction:column;align-items:center;gap:8px;position:relative}
.donut{width:clamp(84px, 10vw + 40px, 140px);height:auto;cursor:pointer}
.donut .ring{transform:rotate(-90deg);transform-origin:50% 50%}
.donut text{font-weight:800;fill:var(--moe-dark);font-size:14px}
.done-badge{position:absolute;top:-6px;right:-6px;background:#16a34a;color:#fff;border-radius:999px;padding:4px 6px;font-size:11px;display:none;box-shadow:0 2px 6px rgba(0,0,0,.15)}
.chip{background:#eaf7f4;border:1px dashed #cfe1dd;padding:4px 10px;border-radius:999px;font-size:clamp(11px,.6vw + 9px,12px);color:#0b6256;cursor:pointer}
.visitLabel{font-family:"Cairo";font-weight:700;color:#0f685a;font-size:clamp(13px,.8vw + 10px,16px)}

/* المؤشرات */
.hmeterTop{margin:8px auto 4px;text-align:center}
.tooltip{position:relative;display:inline-block;cursor:help;margin-bottom:6px;font-weight:700;color:#0b534a}
.tooltip .tiptext{visibility:hidden;width:290px;background:#0a5b50;color:#fff;text-align:center;border-radius:6px;padding:6px;position:absolute;z-index:2;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .3s}
.tooltip:hover .tiptext{visibility:visible;opacity:1}
.globalInline{margin-inline-start:8px;font-family:"Cairo";font-size:clamp(14px,1vw + 11px,18px);font-weight:800;transition:color .15s ease}
.globalInline.good{color:#0f6a3b}.globalInline.mid{color:#a8620a}.globalInline.bad{color:#b42318}
.visitPercents{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin-bottom:4px}
.visitPercents .badge{background:#f0faf6}
.globalRow{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
.hbar{position:relative;width:min(700px,95vw);height:14px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#16a34a 100%);margin:4px auto 6px}
.hthumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid #0a5b50}
.hmeter{display:flex;flex-direction:column;gap:6px;align-items:center;margin:6px 0 8px}
.hbarSmall{position:relative;width:min(680px,95vw);height:12px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#16a34a 100%)}
.hthumbSmall{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid #0a5b50}
.hlbl{display:flex;gap:8px;align-items:center;color:#0a5b50;font-weight:800}

/* الجداول */
.table-responsive{width:100%;overflow:auto}
.tbl{width:100%;border-collapse:collapse;table-layout:auto}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px 8px;background:#fff;vertical-align:middle;text-align:center}
.tbl thead th{background:var(--moe-dark)!important;color:#fff!important}
.tbl .w{width:clamp(280px,26vw,380px);text-align:center}
.tbl tbody td.seq{background:#f2fbf7;text-align:center;font-weight:700;color:#0c5e55}
.tbl tbody td.domain-cell{background:#f3faf8;text-align:center;vertical-align:middle;font-weight:800}
.group-colored td{background:var(--strip)!important}
.group-white   td{background:#fff!important}
.group-colored td.domain-cell{background:var(--strip)!important}
.group-white   td.domain-cell{background:#fff!important}

/* العنصر + التعريف */
.item-cell{display:flex;flex-direction:column;gap:3px;text-align:right}
.item-cell b{display:block}
.item-brief{display:block;margin-top:2px;padding-top:4px;border-top:1px dashed #dbe9e6;color:#2b5e57;opacity:.9;font-size:12px;line-height:1.55}

/* مستوى الأداء */
.level{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;align-items:stretch;width:100%}
.level button{--dot:#ddd;border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer;font-weight:800;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:all .12s;width:100%;padding:10px 0}
.level button::before{content:"";width:10px;height:10px;border-radius:50%;background:var(--dot)}
.level button[data-v="1"]{--dot: var(--bad)}
.level button[data-v="2"]{--dot: var(--mid)}
.level button[data-v="3"]{--dot: var(--good)}
.level button.active{box-shadow:0 0 0 2px #cfe8df inset}
.level button.active[data-v="1"]{background:#ffe3e3;border-color:#f2bcbc;color:#b42318}
.level button.active[data-v="2"]{background:#fff1dc;border-color:#f2d3a2;color:#a8620a}
.level button.active[data-v="3"]{background:#e9f7ee;border-color:#b9e4c8;color:#0f6a3b}

/* الأدوات + الأسباب */
.bar-wrap{position:relative;margin:8px 12px 10px}
.gradbar{height:12px;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#eef3f2}
.bar-nums{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;font-size:12px;font-weight:700;color:#0a5b50;padding:0 8px}
.pills{display:grid;grid-template-columns:repeat(3, minmax(84px,1fr));gap:8px;align-items:center}
.pill{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer;font-weight:700;font-size:12px;width:100%}
.pill[data-v="2"].active{background:#e9f7ee;color:#0f6a3b;border-color:#b9e4c8}
.pill[data-v="1"].active{background:#fff1dc;color:#a8620a;border-color:#f2d3a2}
.pill[data-v="0"].active{background:#ffe3e3;color:#b42318;border-color:#f2bcbc}
.tool-desc{display:block;opacity:.9;font-size:11px;line-height:1.6;margin-top:2px;text-align:right}
.tool-reason{width:100%;min-height:48px;border:1px dashed var(--line);border-radius:10px;background:#fff;padding:6px;font:inherit;resize:vertical;white-space:pre-wrap}
.tool-reason:disabled{opacity:.5;background:#f8faf9}
.textarea-print{white-space:pre-wrap;border:1px dashed var(--line);border-radius:10px;background:#fff;padding:6px;font-size:inherit;min-height:48px;text-align:right}

/* التوصيات */
.rec-wrap{padding:10px}
.recTbl{width:100%;border-collapse:collapse}
.recTbl th,.recTbl td{border:1px solid var(--line);padding:8px;background:#fff;vertical-align:top;text-align:right}
.recTbl thead th{background:var(--moe-dark)!important;color:#fff!important}

/* الدعم 3+3 */
.support-grid{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:8px}
.support-card{border:1px solid var(--soft-green-b);background:var(--soft-green);color:var(--soft-green-t);border-radius:12px;padding:10px}
.support-card h4{margin:0 0 6px;font-family:"Cairo";font-size:14px}
.support-list{list-style:disc;margin:0 1.2em; padding:0; display:flex; flex-direction:column; gap:4px}
.support-list li{background:#fff;border:1px dashed var(--soft-green-b);border-radius:10px;padding:6px 8px}
.support-list li[contenteditable="true"]{outline:none}

/* إشعار (مستطيل طولي جذاب) */
.toast{
  position:fixed; right:12px; bottom:12px; z-index:1400;
  width:min(720px,96vw); min-height:62px;
  background:linear-gradient(90deg,#e6fff5,#eaf7f4);
  border:1px solid #b9e4c8; color:#0b5e54; border-radius:26px;
  padding:10px 14px; box-shadow:0 12px 32px rgba(0,0,0,.12);
  display:flex; align-items:center; gap:12px; direction:rtl;
}
.toast .dot{width:10px;height:10px;border-radius:50%;background:#0f7a66;opacity:.85}
.toast .line{flex:1;text-align:center;overflow:hidden;text-overflow:ellipsis;font-size:13px;font-weight:700;white-space:nowrap}
.toast .close{border:none;background:#fff;color:#0f7a66;border:1px solid #b9e4c8;border-radius:999px;padding:4px 10px;cursor:pointer;font-size:13px}

/* بقية التنسيقات */
.bottom-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;padding:10px;border:1px solid var(--border);border-radius:14px;background:var(--bg);margin-top:12px}
.signs{margin:10px 0}
.signs table{width:100%;border-collapse:collapse}
.signs th,.signs td{border:1px solid var(--line);padding:8px;background:#fff}
.sign-line{display:block;height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px}
#approvedPanel{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;min-width:min(520px,92vw);max-width:92vw;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.15);padding:12px;display:none;z-index:1000}
#approvedPanel h4{margin:0 0 8px;color:#0c594e;font-family:"Cairo"}
#approvedList{display:flex;flex-wrap:wrap;gap:6px}
.name-chip{padding:6px 10px;border-radius:999px;border:1px dashed var(--line);background:#fafafa}
#teachersPanel{position:fixed;inset:auto 0 0 0;margin:auto;max-width:min(780px,96vw);background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 16px 48px rgba(0,0,0,.2);display:none;z-index:1200}
.tp-head{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border)}
.tp-body{padding:10px;max-height:60vh;overflow:auto}
.tp-search{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.tp-list{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
.tp-item{padding:8px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.tp-item b{color:#0b5e54}
.tp-close{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
.printMark{display:none;text-align:center;margin:6px 0 2px;color:#184b44;font-size:10px}
#toTop,#toBottom{position:fixed;bottom:20px;padding:12px;border:none;border-radius:50%;background:#0f7a66;color:#fff;font-size:18px;cursor:pointer;display:none;z-index:999;box-shadow:0 8px 20px rgba(0,0,0,.18);transition:transform .18s ease, box-shadow .18s ease, opacity .18s ease;opacity:.95}
#toTop{left:20px} #toBottom{right:20px}
#toTop:hover,#toBottom:hover{transform:translateY(-2px) scale(1.04); box-shadow:0 12px 28px rgba(0,0,0,.22)}
.footer-rights{margin:8px 0 14px;text-align:center;font-size:11.5px;color:#0b534a}
body.snapshot .no-print{ display:none !important }

/* تجاوب */
@media (max-width:980px){ .tbl .w{width:auto} .grid{gap:6px} }
@media (max-width:780px){ .support-grid{grid-template-columns:repeat(2,minmax(200px,1fr));} }
@media (max-width:540px){ .support-grid{grid-template-columns:1fr;} .fld{height:40px} }

/* طباعة */
@page{ size:A4 portrait; margin:5mm }
@media print{
  :root{--base:12px}
  h1{font-size:16px}
  .donut{width:92px;height:auto}
  .tbl th,.tbl td{padding:5px;font-size:11.5px}
  .item-brief{font-size:10.5px}
  .no-print, .bottom-actions, #approvedPanel, #teachersPanel, .footer-rights, .toast { display:none !important }
  .printMark{display:block !important}
  #page{width:210mm}
}
</style>
</head>
<body>
<div id="page"><div class="wrap" id="sheet">

  <!-- رأس -->
  <div class="govern-head">
    <div class="hl small" id="h-sa">المملكة العربية السعودية</div>
    <div class="hl small" id="h-moed">وزارة التعليم</div>
    <div class="hl big">
      <span class="editable" id="h-dir" contenteditable="false">الإدارة العامة للتعليم بالمنطقة الشرقية</span>
      <button class="inline-pen no-print" id="penDir" title="تعديل"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button>
    </div>
    <div class="hl big">
      <span class="editable" id="h-school" contenteditable="false">مدرسة اليعقوبي الثانوية</span>
      <button class="inline-pen no-print" id="penSchool" title="تعديل"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button>
    </div>
  </div>

  <h1>استمارة دعم وتطوير الهيئة التعليمية (زيارة معلم) ١٤٤٧هـ</h1>
  <div style="text-align:center"><span class="badge" id="hijriChip">التاريخ الهجري: —</span></div>

  <!-- المعلومات العامة -->
  <div class="box" id="boxInfo">
    <h3>المعلومات العامة</h3>
    <div class="grid" style="padding:10px">
      <input class="fld col-3" id="tName" placeholder="اسم المعلم">
      <input class="fld col-3" id="tId" placeholder="رقم الهوية (10 أرقام)" inputmode="numeric" maxlength="10">
      <input class="fld col-3" id="tSpec" placeholder="التخصص / المادة">
      <input class="fld col-3" id="lesson" placeholder="عنوان الدرس">
      <input class="fld col-3" id="degree" placeholder="المؤهل">
      <input class="fld col-3" id="exp" placeholder="سنوات الخبرة">
      <input class="fld col-3" id="class" placeholder="الفصل">

      <div class="col-3" style="display:flex;gap:6px;align-items:center;justify-content:center">
        <button class="btn-ic tiny no-print" id="btnShowList" title="كشف الأسماء">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </button>
        <button class="btn-ic tiny no-print" id="btnExportTemplate" title="تصدير قالب Excel">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="14" height="16" rx="2"/><path d="M7 8h6M7 12h6M7 16h6"/>
            <path d="M17 12l4 4m0-4-4 4"/>
          </svg>قوالب
        </button>
      </div>
    </div>
  </div>

  <!-- المؤشرات الشاملة -->
  <div class="hmeterTop">
    <div class="tooltip">المؤشر الشامل للأداء <b id="globalPctInline" class="globalInline">0%</b>
      <span class="tiptext">مقياس تجميعي يُلخص نتائج الزيارات الثلاث (يشمل 15% لتفعيل الأدوات).</span>
    </div>
    <div class="visitPercents">
      <span class="badge">الأولى: <b id="p1">0%</b></span>
      <span class="badge">الثانية: <b id="p2">0%</b></span>
      <span class="badge">الثالثة: <b id="p3">0%</b></span>
    </div>
    <div class="globalRow">
      <div class="hbar"><div class="hthumb" id="globalThumb" style="left:0%"></div></div>
    </div>
  </div>

  <!-- دوائر الزيارات -->
  <div class="visits">
    <div class="visitCard">
      <span id="done1" class="done-badge">منتهية</span>
      <svg class="donut" id="v1" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/><circle cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/><text x="60" y="64" text-anchor="middle" id="v1t">0%</text></svg>
      <div class="chip" id="v1h">—</div><div class="visitLabel">الزيارة الأولى</div>
    </div>
    <div class="visitCard">
      <span id="done2" class="done-badge">منتهية</span>
      <svg class="donut" id="v2" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/><circle cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/><text x="60" y="64" text-anchor="middle" id="v2t">0%</text></svg>
      <div class="chip" id="v2h">—</div><div class="visitLabel">الزيارة الثانية</div>
    </div>
    <div class="visitCard">
      <span id="done3" class="done-badge">منتهية</span>
      <svg class="donut" id="v3" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/><circle cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/><text x="60" y="64" text-anchor="middle" id="v3t">0%</text></svg>
      <div class="chip" id="v3h">—</div><div class="visitLabel">الزيارة الثالثة</div>
    </div>
  </div>

  <!-- مؤشر الزيارة -->
  <div class="hmeter">
    <div class="hbarSmall"><div class="hthumbSmall" id="hThumb" style="left:0%"></div></div>
    <div class="hlbl"><span>مؤشر أداء الزيارة الحالية:</span> <span id="kpiPct">0%</span></div>
  </div>

  <!-- عملية التعليم والتعلّم -->
  <div class="box" id="learningBox">
    <h3>عملية التعليم والتعلّم</h3>
    <div class="table-responsive">
      <table class="tbl">
        <thead>
          <tr><th style="width:44px">م</th><th style="width:260px">المجالات</th><th>العناصر</th><th class="w">مستوى الأداء</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- الأدوات المساندة -->
  <div class="box" id="toolsBox">
    <h3><span>الأدوات المساندة لعملية التعليم والتعلّم</span><small id="toolsMeta">—</small></h3>
    <div class="bar-wrap"><div class="gradbar" id="gradbar"></div><div class="bar-nums"><span id="tU">غير محدد: 0</span><span id="tR">غير مُفعل: 0</span><span id="tA">إلى حد ما: 0</span><span id="tG">مُفعل: 0</span></div></div>
    <div class="table-responsive">
      <table class="tbl">
        <thead>
          <tr>
            <th>م</th><th>الأدوات</th><th>الشواهد</th>
            <th style="min-width:160px">التفعيل</th>
            <th style="min-width:200px">أسباب عدم التفعيل</th>
          </tr>
        </thead>
        <tbody id="toolsRows"></tbody>
      </table>
    </div>
  </div>

  <!-- التوصيات -->
  <div class="box">
    <h3>التوصيات المقدّمة</h3>
    <div class="rec-wrap">
      <table class="recTbl">
        <thead><tr><th>جوانب التميّز</th><th>احتياجات التنمية المهنية</th></tr></thead>
        <tbody><tr><td id="strengthBox">—</td><td id="devBox">—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- الدعم المقدم للمعلم (3+3) -->
  <div class="box" id="supportBox">
    <h3>الدعم المقدّم للمعلم</h3>
    <div class="support-grid" id="supportGrid"></div>
  </div>

  <!-- التوقيعات -->
  <div class="signs">
    <table>
      <tr><th>الزيارة الأولى</th><th>الزيارة الثانية</th><th>الزيارة الثالثة</th></tr>
      <tr>
        <td>اسم المعلم: <span id="sn1">—</span><span class="sign-line"></span>توقيع المعلم:</td>
        <td>اسم المعلم: <span id="sn2">—</span><span class="sign-line"></span>توقيع المعلم:</td>
        <td>اسم المعلم: <span id="sn3">—</span><span class="sign-line"></span>توقيع المعلم:</td>
      </tr>
      <tr>
        <td>تاريخ الزيارة: <span id="sh1">—</span></td>
        <td>تاريخ الزيارة: <span id="sh2">—</span></td>
        <td>تاريخ الزيارة: <span id="sh3">—</span></td>
      </tr>
      <tr>
        <td>اسم مدير المدرسة: <span id="pn1">فهد حامد علي الزهراني</span><button class="inline-pen no-print" id="penPrin1" title="تعديل" style="margin-inline-start:6px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button></td>
        <td>اسم مدير المدرسة: <span id="pn2">فهد حامد علي الزهراني</span><button class="inline-pen no-print" id="penPrin2" title="تعديل" style="margin-inline-start:6px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button></td>
        <td>اسم مدير المدرسة: <span id="pn3">فهد حامد علي الزهراني</span><button class="inline-pen no-print" id="penPrin3" title="تعديل" style="margin-inline-start:6px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button></td>
      </tr>
    </table>
  </div>

  <!-- لوحة المعتمدين -->
  <div id="approvedPanel" class="no-print">
    <h4>زيارات المعلمين المعتمدة</h4>
    <div id="approvedList">—</div>
  </div>

  <!-- الأزرار السفلية -->
  <div class="bottom-actions no-print">
    <button class="btn-ic" id="finishVisitBtn" title="اعتماد"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>اعتماد</button>
    <button class="btn-ic" id="printBtn" title="طباعة A4"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>طباعة</button>
    <button class="btn-ic" id="saveBtn" title="حفظ PDF"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2Z"/><path d="M17 21V13H7v8"/><path d="M7 3v4h8"/></svg>حفظ PDF</button>

    <span style="display:inline-flex;align-items:center;gap:6px">
      <button class="btn-ic" id="waBtn" title="واتساب">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 12.1A9.5 9.5 0 1 1 12 2.5a9.5 9.5 0 0 1 9.5 9.6Z"/><path d="m3.5 20.5 1.6-5.6"/><path d="M8.5 8.5c1 2.5 3.5 4.5 6 5l1.5-1.5"/></svg>
      </button>
      <button class="inline-pen" id="waEdit" title="تعديل رقم واتساب">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
      </button>
    </span>

    <button class="btn-ic" id="btnApproved" title="المعتمدون"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-8 0v2"/><circle cx="12" cy="7" r="4"/><path d="M20 8v6m3-3h-6"/></svg>المعتمدون</button>
    <button class="btn-ic" id="btnDeleteVisit" title="حذف هذه الزيارة لهذا المعلم"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4h8v2"/></svg>حذف زيارة (لهذا المعلم)</button>
    <button class="btn-ic" id="btnClearAll" title="مسح الجميع"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 6 3 1 2 13h8l2-13 3-1"/><path d="M5 6h14"/><path d="M10 11v6M14 11v6"/></svg>مسح الجميع</button>
  </div>

  <div id="printMark" class="printMark">مبادرة دعم اليعقوبي الثانوي — تاريخ الطباعة: <span id="printHijri">—</span></div>

  <div class="footer-rights no-print">مبادرة مدرسة اليعقوبي الثانوية بالخبر — تنفيذ وتصميم: فهد حامد الزهراني</div>

</div></div>

<!-- لوحة الأسماء -->
<div id="teachersPanel" class="no-print">
  <div class="tp-head">
    <b>كشف أسماء المعلمين</b>
    <div style="display:flex;gap:6px;align-items:center">
      <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none">
      <button class="btn-ic tiny" id="btnImportInPanel" title="استيراد Excel/CSV">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 16v3a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-3"/><path d="M8 12l4 4 4-4M12 4v12"/></svg>
        استيراد
      </button>
      <button class="tp-close" id="tpClose">إغلاق</button>
    </div>
  </div>
  <div class="tp-body">
    <div class="tp-search">
      <input id="tpQuery" class="fld" style="flex:1" placeholder="ابحث بالاسم أو الهوية">
    </div>
    <div id="tpList" class="tp-list"></div>
  </div>
</div>

<button id="toTop" class="no-print" title="أعلى">↑</button>
<button id="toBottom" class="no-print" title="أسفل">↓</button>

<!-- إشعار -->
<div class="toast no-print" id="toast">
  <div class="dot"></div>
  <div class="line">رحلة تطوير حيّة… حيث يتحوّل التقييم من أرقام جامدة إلى دعم تفاعلي يضيء مسار المعلّم.</div>
  <button class="close" id="toastClose" title="إغلاق">×</button>
</div>

<script>
/* ==============================
   تخزين دائم: IndexedDB
   ============================== */
const DB_NAME='yaqoobi_observations';
const DB_VER=3; // ترقية لإجبار تحديث البنية
const STORE='teachers';

function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VER);
    req.onupgradeneeded=(e)=>{
      const db=e.target.result;
      let os;
      if(!db.objectStoreNames.contains(STORE)){
        os=db.createObjectStore(STORE,{keyPath:'teacherId'});
      }else{
        os=req.transaction.objectStore(STORE);
      }
      if(os && !os.indexNames.contains('by_name')){
        os.createIndex('by_name','name',{unique:false});
      }
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function dbGetTeacher(id){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,'readonly');
    const os=tx.objectStore(STORE);
    const r=os.get(id);
    r.onsuccess=()=>resolve(r.result||null);
    r.onerror=()=>reject(r.error);
  });
}
async function dbPutTeacher(record){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,'readwrite');
    const os=tx.objectStore(STORE);
    const r=os.put(record);
    r.onsuccess=()=>resolve(true);
    r.onerror=()=>reject(r.error);
  });
}
async function dbClearAll(){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,'readwrite');
    const os=tx.objectStore(STORE);
    const r=os.clear();
    r.onsuccess=()=>resolve(true);
    r.onerror=()=>reject(r.error);
  });
}

/* مفاتيح محلية */
const LS_HEAD='moe_header_v14';
const LS_TEACHERS='moe_teacher_list_v1';
const LS_LAST='moe_last_teacher';
const LS_WA='moe_wa_num_v1';

/* معرف المعلّم */
function normalizedTeacherId(){
  const id=(document.getElementById('tId').value||'').replace(/\D+/g,'');
  if(/^\d{10}$/.test(id)) return id;
  const name=(document.getElementById('tName').value||'').trim();
  return name?('name:'+name.replace(/\s+/g,' ').trim()):'';
}

/* رأس قابل للتحرير */
function saveHead(){
  const o={
    hsa:document.getElementById('h-sa').textContent.trim(),
    hmo:document.getElementById('h-moed').textContent.trim(),
    hdir:document.getElementById('h-dir').textContent.trim(),
    hschool:document.getElementById('h-school').textContent.trim()
  };
  localStorage.setItem(LS_HEAD,JSON.stringify(o));
}
(function loadHead(){
  const raw=localStorage.getItem(LS_HEAD); if(!raw) return;
  try{
    const o=JSON.parse(raw);
    if(o.hsa)document.getElementById('h-sa').textContent=o.hsa;
    if(o.hmo)document.getElementById('h-moed').textContent=o.hmo;
    if(o.hdir)document.getElementById('h-dir').textContent=o.hdir;
    if(o.hschool)document.getElementById('h-school').textContent=o.hschool;
  }catch{}
})();
document.getElementById('penDir').addEventListener('click',()=>toggleEdit('h-dir'));
document.getElementById('penSchool').addEventListener('click',()=>toggleEdit('h-school'));
function toggleEdit(id){
  const el=document.getElementById(id);
  const on=el.getAttribute('contenteditable')==='true';
  el.setAttribute('contenteditable', on?'false':'true');
  if(on) saveHead();
  el.focus();
}

/* التاريخ الهجري */
function hijriNow(){
  try{const opt={weekday:'long',day:'numeric',month:'long',year:'numeric'};
    return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',opt).format(new Date());
  }catch{return '—';}
}
function hijriDateStr(d){
  try{const opt={weekday:'long',day:'numeric',month:'long',year:'numeric'};
    return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',opt).format(d);
  }catch{return '—';}
}
document.getElementById('hijriChip').textContent='التاريخ الهجري: '+hijriNow();

/* مزامنة تاريخ التوقيع */
function syncSignatureDates(){
  ['1','2','3'].forEach(v=>{
    const val=document.getElementById('v'+v+'h').textContent||'—';
    document.getElementById('sh'+v).textContent = val && val.trim()? val : '—';
  });
}
['v1h','v2h','v3h'].forEach(id=>{
  const el=document.getElementById(id);
  const obs=new MutationObserver(syncSignatureDates);
  obs.observe(el,{characterData:true,subtree:true,childList:true});
});

/* واتساب */
let waNumber=localStorage.getItem(LS_WA)||'9665XXXXXXXX';
document.getElementById('waEdit').addEventListener('click',()=>{
  const v=prompt('رقم واتساب الافتراضي (مع مفتاح الدولة):',waNumber);
  if(v && /^\d{8,15}$/.test(v)){waNumber=v;localStorage.setItem(LS_WA,waNumber);alert('تم حفظ رقم واتساب.');}
});
document.getElementById('waBtn').addEventListener('click',()=>{
  const name=(tName.value||'—').trim(), spec=(tSpec.value||'—').trim(), id=(tId.value||'—').trim();
  const p1=visitPctAdjusted(1), p2=visitPctAdjusted(2), p3=visitPctAdjusted(3);
  const school=document.getElementById('h-school').textContent.trim();
  const {lbl,d}=activeVisitHijri();
  const ok=(document.getElementById('strengthBox').innerText||'—').trim();
  const dv=(document.getElementById('devBox').innerText||'—').trim();
  const supportLines = getSupportStateFromUI().flatMap(x=>x.items||[]).filter(Boolean).slice(0,8);
  const reasons = getToolReasonsFromUI().filter(Boolean);
  const supportBlock = supportLines.length?('\nالدعم المقترح:\n- '+supportLines.join('\n- ')):'';
  const reasonsBlock = reasons.length?('\nأسباب عدم التفعيل:\n- '+reasons.join('\n- ')):'';
  const msg=`السلام عليكم،
${school}
الاسم: ${name} | الهوية: ${id} | التخصص: ${spec}
الزيارة ${lbl}: بتاريخ ${d}
نِسب الزيارات: الأولى %${p1}، الثانية %${p2}، الثالثة %${p3}
جوانب التميز:
${ok}
احتياجات التنمية المهنية:
${dv}${supportBlock}${reasonsBlock}`;
  window.open('https://api.whatsapp.com/send?phone='+waNumber+'&text='+encodeURIComponent(msg),'_blank');
});

/* كشف الأسماء */
let teacherList=[];
const tName=document.getElementById('tName'), tId=document.getElementById('tId'), tSpec=document.getElementById('tSpec');
const degree=document.getElementById('degree'), exp=document.getElementById('exp');
const tp=document.getElementById('teachersPanel'), tpList=document.getElementById('tpList'), tpQuery=document.getElementById('tpQuery');
document.getElementById('btnShowList').addEventListener('click',()=>{openTeachersPanel();});
document.getElementById('tpClose').addEventListener('click',()=>tp.style.display='none');
document.getElementById('btnImportInPanel').addEventListener('click',()=>document.getElementById('excelInput').click());
document.getElementById('excelInput').addEventListener('change', handleExcelImport);
tpQuery.addEventListener('input',()=>renderTeachers(tpQuery.value));

document.getElementById('btnExportTemplate').addEventListener('click', ()=>{
  const headers = [["اسم المعلم","رقم الهوية","التخصص","المؤهل","سنوات الخبرة"]];
  const ws = XLSX.utils.aoa_to_sheet(headers);
  ws['!cols'] = [{wch:24},{wch:14},{wch:18},{wch:14},{wch:14}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "قائمة المعلمين");
  XLSX.writeFile(wb, "قالب_كشف_المعلمين.xlsx");
});
function handleExcelImport(e){
  const file=e.target.files[0]; if(!file) return;
  file.arrayBuffer().then(data=>{
    const wb=XLSX.read(data,{type:'array'}); const sh=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
    if(!rows.length){alert('الملف فارغ');return;}
    const headers=rows[0].map(h=>String(h).trim().toLowerCase());
    const norm=(h)=>h.replace(/\s+/g,' ').replace(/[^\u0600-\u06FFa-z0-9 ]/gi,'').trim();
    const findIdx=(...keys)=>headers.findIndex(h=>{const n=norm(h); return keys.some(k=> n===norm(k) || n.includes(norm(k)));});
    const ixName=findIdx('الاسم','name','fullname','اسم المعلم','اسم');
    const ixId=findIdx('الهوية','id','national id','رقم الهوية','رقم السجل','هوية');
    const ixSpec=findIdx('التخصص','subject','المادة','مادة');
    const ixDeg=findIdx('المؤهل','qualification','degree');
    const ixExp=findIdx('سنوات الخبرة','الخبرة','experience','years');
    function tenDigitsFallback(row){for(const c of row){const s=String(c||'').replace(/\D+/g,''); if(/^\d{10}$/.test(s)) return s;} return '';}
    teacherList=rows.slice(1).filter(r=>r.some(x=>String(x).trim()!=='')).map(r=>{
      const name=(ixName>-1? r[ixName] : (r[0]||'')).toString().trim();
      let id=(ixId>-1? String(r[ixId]) : '').replace(/\D+/g,''); if(!/^\d{10}$/.test(id)) id=tenDigitsFallback(r);
      const spec=(ixSpec>-1? r[ixSpec] : (r[2]||'')).toString().trim();
      const deg=(ixDeg>-1? r[ixDeg] : '').toString().trim();
      const ex =(ixExp>-1? r[ixExp] : '').toString().trim();
      return {name,id:id.slice(0,10),spec,degree:deg,exp:ex};
    }).filter(x=>x.name);
    localStorage.setItem(LS_TEACHERS, JSON.stringify(teacherList));
    renderTeachers('');
    alert('تم الاستيراد، استخدم البحث لاختيار المعلم.');
    e.target.value='';
  }).catch((err)=>{console.error(err);alert('فشل استيراد الملف.'); e.target.value='';});
}
function openTeachersPanel(){
  if(!teacherList.length){
    try{ const saved=JSON.parse(localStorage.getItem(LS_TEACHERS)||'[]'); if(Array.isArray(saved)) teacherList=saved; }catch{}
  }
  renderTeachers(''); tp.style.display='block'; tpQuery.value='';
}
function renderTeachers(q){
  const query=(q||'').trim(); const rx=query? new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i') : null;
  tpList.innerHTML='';
  if(!teacherList.length){ tpList.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#777">لا توجد قائمة — استورد من زر "استيراد"</div>'; return; }
  teacherList.filter(t=>!rx || rx.test(t.name)||rx.test(t.id)).forEach((t)=>{
    const div=document.createElement('div'); div.className='tp-item';
    div.innerHTML=`<b>${t.name}</b><span style="opacity:.8">${t.id||'—'}</span>`;
    div.addEventListener('click',()=>{ tp.style.display='none'; fillTeacher(t); });
    tpList.appendChild(div);
  });
}

/* المجالات */
const fields=[
  {name:'إعداد وتنفيذ خطة للتعلّم', items:[
    ['تخطيط محكم','تحويل المنهج إلى خطة دروس واضحة بمخرجات قابلة للقياس.'],
    ['استراتيجيات مبتكرة','توظيف أساليب تدريس حديثة تعزز الإبداع وحل المشكلات.'],
    ['التزام زمني منظم','تنظيم زمن التعلم بما يحقق التوازن بين الخطة الدراسية واحتياجات الطلاب.'],
    ['تقويم هادف','استخدام أدوات تقييم مرتبطة بالأهداف لتوجيه التحسين المستمر.']
  ]},
  {name:'التنوع في استراتيجيات التدريس', items:[
    ['تنويع الأساليب','اختيار طرق تدريس متنوعة تلائم المحتوى وأهداف الدرس.'],
    ['مراعاة الفروق','تكييف الأنشطة لمستويات وسرعات تعلم مختلفة.'],
    ['دمج التعليم المباشر والرقمي','التكامل بين التدريس الوجاهي والأدوات الرقمية الحديثة.'],
    ['تحفيز التفاعل','توظيف أساليب تشاركية وأسئلة مثيرة للتفكير لتنمية الحوار.']
  ]},
  {name:'إدارة الفصل', items:[
    ['تنظيم البيئة','تهيئة مكان تعليمي محفز وآمن يسهّل التعلم.'],
    ['ضبط السلوك','وضع قواعد واضحة وتطبيقها بعدالة لتحقيق الانضباط.'],
    ['تعزيز المشاركة','إشراك جميع الطلاب في الأنشطة الصفية بفاعلية.'],
    ['توظيف الوقت','استثمار زمن الحصة بكفاءة واستمرارية دون هدر.']
  ]},
  {name:'توظيف التقنية', items:[
    ['أدوات رقمية','استخدام منصات وموارد تفاعلية مناسبة للتعلم.'],
    ['دمج التقنية','توظيف الوسائل الرقمية لدعم تنفيذ الأنشطة التعليمية.'],
    ['دعم الفروق','الاستفادة من التقنية لتخصيص التعليم وفق احتياجات الطلاب.'],
    ['تعزيز النواتج','متابعة تقدم الطلاب وتحسين مخرجات التعلم عبر أدوات رقمية.']
  ]},
  {name:'البيئة التعليمية', items:[
    ['تهيئة مكان آمن','توفير بيئة صفية آمنة تعزز الطمأنينة والانتماء.'],
    ['موارد تعلم','توفير مواد وأنشطة متنوعة تسهّل الفهم.'],
    ['علاقات إيجابية','بناء تواصل فعّال واحترام متبادل بين المعلم والمتعلم.'],
    ['دافعية المتعلمين','تحفيز الطلاب بالأنشطة والإنجازات لبذل أقصى جهد.']
  ]},
  {name:'أساليب وأدوات التقويم', items:[
    ['تنويع أدوات','استخدام اختبارات تحريرية وشفهية وعملية ورقمية.'],
    ['مراعاة الفروق','تصميم مهام تقييم تناسب مستويات متعددة.'],
    ['التقويم البنائي والنهائي','متابعة تقدم مستمر واختبارات ختامية معيارية.'],
    ['استثمار النتائج','تحليل النتائج لتطوير التدريس وتحسين مخرجات التعلم.']
  ]}
];
function zeroMatrix(){ return fields.map(f=>Array(f.items.length).fill(0)); }
function clone(o){ return JSON.parse(JSON.stringify(o)); }

let store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()};
let activeVisit=1;
let loadedRecord=null;

/* بنك دعم منوّع */
const supportLib = {
  'إعداد وتنفيذ خطة للتعلّم': {
    3:['مواءمة الهدف والنشاط بدقة.','مراجعة ختامية بدقيقة واحدة.','مؤشر بصري لتتبّع التقدّم.','انتقال واضح بين أجزاء الدرس.','تفكيك المهمة إلى خطوات.','إسناد التلخيص لطالب.'],
    2:['صياغة ناتج تعلم قابل للقياس.','سؤال انتقال قبل كل نشاط.','مهمة قصيرة موجّهة.','توازن الشرح والتطبيق.','خطة مصغّرة للحصة التالية.','ربط الواجب بالمخرج.'],
    1:['هيكل (تمهيد-شرح-تقويم).','سؤال تحقق بعد كل فكرة.','ناتج تعلم واحد صريح.','زمن مراجعة ختامي ثابت.','تقويم قبلي سريع.','واجهة بصرية للأهداف.']
  },
  'التنوع في استراتيجيات التدريس': {
    3:['حوار سقراطي لسؤال عميق.','نشاط تعاوني دقيقتين.','عصف ذهني يتبعه تلخيص طالب.','تبادل أدوار (مشاهد/مفسر).','محطات تعلم متنقلة.','تسليم راية الحديث.'],
    2:['تعليم أقران سريع.','عمل ثنائي موجّه.','بطاقة خروج دقيقة.','س/ج بالتتابع.','لعب أدوار مصغّر.','ترتيب أفكار على لوحة.'],
    1:['استراتيجية واحدة واضحة.','نشاط تشاركي قصير.','صور وأمثلة ملموسة.','تدرّج فردي ثم ثنائي.','إشارات للمداخلة.','نموذج حلّ مختصر.']
  },
  'إدارة الفصل': {
    3:['مديح فردي موجّه.','توزيع أدوار صفّية.','إشارة بصرية للانتقال.','روتين دخول/خروج منضبط.','تعزيز للسلوك المنتج.','تدوير فرق العمل.'],
    2:['بطاقات مشاركة بسيطة.','مقاعد للعمل الثنائي.','تعليمات مرئية للحركة.','تعزيز فوري للالتزام.','مؤقّت للأنشطة.','جدول مسؤوليات.'],
    1:['قواعد واضحة ومعلنة.','روتين انتقال بين الأنشطة.','تعزيز إيجابي مستمر.','تقسيم المهام.','تذكير سلوكي مختصر.','مخطط جلوس واضح.']
  },
  'توظيف التقنية': {
    3:['سؤال تفاعلي لقياس الفهم.','عرض مرئي موجز.','مهمة رقمية فردية قصيرة.','لوحة متابعة إلكترونية.','تقرير فوري للنتائج.','مسح QR لنشاط.'],
    2:['أداة تفاعلية واحدة.','واجب رقمي مرتبط بالهدف.','تغذية راجعة إلكترونية.','استطلاع رأي قصير.','اختيار متعدد سريع.','جدول على المنصة.'],
    1:['تمهيد بمقطع قصير.','نشاط رقمي بسيط.','سؤال تحقق داخل المنصة.','عرض للنقاط الرئيسة.','رابط مورد موثوق.','حفظ ملفات الطلاب.']
  },
  'البيئة التعليمية': {
    3:['نشاط جماعي قصير.','عبارات تشجيع بالاسم.','ركن عرض طلابي.','لوحة إنجازات.','قاعدة «وقت هادئ».','مسار حركة واضح.'],
    2:['بطاقات تشجيعية.','مواد بصرية مساعدة.','إعادة تنظيم المقاعد.','تعليمات مرئية للاستعداد.','مؤشرات صوت/هدوء.','صندوق اقتراحات.'],
    1:['تهيئة صفية أساسية.','توفير موارد ملموسة.','تحديد قواعد التعامل.','تقليل المشتتات.','إضاءة ومقاعد مناسبة.','لوحة تعليمات.']
  },
  'أساليب وأدوات التقويم': {
    3:['سؤال ختامي للتحقق.','بطاقة ملاحظة قصيرة.','تحليل نتائج موجز.','قائمة تقدير مبسطة.','تقويم ذاتي سريع.','مقارنة إجابتين.'],
    2:['سؤال شفهي سريع.','معيار نجاح قبل النشاط.','تقويم بنائي منتصف الحصة.','تصحيح فوري لعينة.','مراجعة جماعية إجمالية.','تظليل مفاهيم.'],
    1:['أداة تقويم واحدة واضحة.','سجل متابعة بسيط.','سؤال تحقق بعد كل جزء.','نقطة فحص منتصف الدرس.','بطاقة خروج فردية.','تصحيح بالنموذج.']
  }
};
const toolPhrases = {
  strong:[
    'استدامة «{tool}» ضمن الروتين تعمّق الأثر.',
    'مواءمة «{tool}» مع المخرجات تعزّز النتائج.',
    'تثبيت «{tool}» في محطات الدرس يضمن الاتساق.'
  ],
  partial:[
    'ترقية «{tool}» تدريجيًّا بمهام وجيزة يحسّن التطبيق.',
    'توسيع مساحة «{tool}» بخطوات صغيرة متتابعة.',
    'تثبيت توقيت محدد لـ«{tool}» يرفع كفاءة التنفيذ.'
  ],
  off:[
    'بدء «{tool}» بنشاط تجريبي قصير يغلق فجوة التنفيذ.',
    'تفعيل أولي لـ«{tool}» في خاتمة الدرس لقياس الأثر.',
    'إطلاق «{tool}» على مجموعة صغيرة تمهيدًا للتعميم.'
  ]
};

/* دعم 3×3 لكل مجال */
function buildSupport(){
  const grid = document.getElementById('supportGrid');
  grid.innerHTML = '';
  fields.forEach(f=>{
    const card = document.createElement('div');
    card.className = 'support-card';
    card.innerHTML = `
      <h4>${f.name}</h4>
      <ul class="support-list" data-domain="${f.name}">
        <li contenteditable="true"></li>
        <li contenteditable="true"></li>
        <li contenteditable="true"></li>
      </ul>`;
    grid.appendChild(card);
  });
  document.querySelectorAll('.support-list').forEach(ul=>{
    ul.addEventListener('input',()=>saveDraftActiveVisit());
  });
}
function getSupportStateFromUI(){
  return [...document.querySelectorAll('.support-list')].map(ul=>{
    const items=[...ul.querySelectorAll('li')].map(li=>li.textContent.trim()).filter(Boolean);
    return {domain:ul.dataset.domain, items};
  });
}
function setSupportStateToUI(arr){
  const map = new Map((arr||[]).map(x=>[x.domain,x.items||[]]));
  document.querySelectorAll('.support-list').forEach(ul=>{
    const items = map.get(ul.dataset.domain)||[];
    const lis = ul.querySelectorAll('li');
    for(let i=0;i<lis.length;i++){ lis[i].textContent = items[i]||''; }
  });
}
function pickUnique(pool, n, globalUsed){
  const res=[];
  const available = pool.slice();
  while(res.length<n && available.length){
    const i=Math.floor(Math.random()*available.length);
    const cand=available.splice(i,1)[0];
    if(!globalUsed.has(cand)){ res.push(cand); globalUsed.add(cand); }
  }
  // إن لم يتوفر بدائل كافية، نولّد صيغة مميّزة بإضافة علامة المجال (لتفادي التكرار الحرفي)
  while(res.length<n){
    res.push(pool[res.length%pool.length] + ' — تكييف سياقي');
    globalUsed.add(res[res.length-1]);
  }
  return res;
}
function domainLevelForVisit(visit, fieldIndex){
  const arr = store[visit][fieldIndex] || [];
  const filled = arr.filter(v=>v>0);
  if(!filled.length) return 0;
  const avg = filled.reduce((a,b)=>a+b,0)/filled.length;
  if(avg >= 2.5) return 3;
  if(avg >= 1.5) return 2;
  return 1;
}
function toolLine(toolTitle, kind){
  const bank = kind===2? toolPhrases.strong : (kind===1? toolPhrases.partial : toolPhrases.off);
  const idx = Math.floor(Math.random()*bank.length);
  return bank[idx].replace('{tool}', toolTitle);
}
function generateSupportFromLevels(){
  if(!document.getElementById('supportGrid').children.length) buildSupport();
  const toolStatus = getToolsStateFromUI();
  const toolReasons = getToolReasonsFromUI();
  const globalUsed = new Set(); // منع تكرار الجمل بين كل المربعات

  fields.forEach((f,fi)=>{
    const lvl = domainLevelForVisit(activeVisit, fi);
    const pool = (supportLib[f.name] && supportLib[f.name][lvl]) ? supportLib[f.name][lvl] : [];
    let lines = pickUnique(pool, 3, globalUsed);

    const weakIdx = toolStatus.findIndex(v=>v===0||v===1);
    if(weakIdx>-1){
      const kind = toolStatus[weakIdx];
      let tip = toolLine(toolsData[weakIdx].title, kind);
      const why = (toolReasons[weakIdx]||'').trim();
      if(why) tip += ` (${why.slice(0,40)})`;
      // استبدل آخر عنصر لضمان تنوّع وعدم تكرار
      lines[lines.length-1] = tip;
      globalUsed.add(tip);
    }

    const ul = document.querySelector(`.support-list[data-domain="${f.name}"]`);
    if(ul){
      const lis = ul.querySelectorAll('li');
      for(let i=0;i<lis.length;i++){ lis[i].textContent = lines[i]||''; }
    }
  });
}

/* بناء جدول المؤشرات */
function buildTable(){
  const tbody=document.getElementById('rows'); tbody.innerHTML='';
  fields.forEach((f,fi)=>{
    const groupClass=(fi%2===0)?'group-colored':'group-white';
    f.items.forEach((pair,ii)=>{
      const [label,brief]=pair; const tr=document.createElement('tr'); tr.classList.add(groupClass);
      if(ii===0){ tr.innerHTML+=`<td class="seq" rowspan="${f.items.length}">${fi+1}</td><td rowspan="${f.items.length}" class="domain-cell">${f.name}</td>`; }
      tr.innerHTML+=`<td class="item-cell"><b>${label}</b><span class="item-brief">${brief}</span></td>
        <td class="w"><div class="level">
          <button data-v="1">ضعيف</button><button data-v="2">متوسط</button><button data-v="3">متميز</button>
        </div></td>`;
      tbody.appendChild(tr);
      const btns=[...tr.querySelectorAll('button')];
      const saved=store[activeVisit][fi][ii];
      if(saved>0) btns.forEach(b=>b.classList.toggle('active', Number(b.dataset.v)===saved));
      btns.forEach(b=> b.addEventListener('click',()=>{
        btns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        store[activeVisit][fi][ii]=Number(b.dataset.v);
        saveDraftActiveVisit();
        calcAll();
      }));
    });
  });
}

/* الأدوات + الأسباب */
const toolsData=[
  {title:'تحسين نواتج التعلّم باستراتيجيات مبنية على الأدلة',desc:'رفع تحصيل الطلاب بأساليب متنوعة تراعي الفروق.'},
  {title:'تفعيل منصة مدرستي بفاعلية',desc:'إدارة التعلم ومتابعة الواجبات والتواصل.'},
  {title:'الشراكة مع المجتمع المهني',desc:'البرامج التدريبية والرخص المهنية لتطوير الأداء.'},
  {title:'التواصل مع أولياء الأمور',desc:'قنوات فعّالة للدعم الأكاديمي والسلوكي.'},
  {title:'تحليل نواتج التعلم',desc:'قراءة البيانات لاتخاذ قرارات علاجية.'},
  {title:'توظيف كتاب الطالب',desc:'ربط الكتاب بالأنشطة والواجبات.'}
];
function buildTools(){
  const tBody=document.getElementById('toolsRows'); tBody.innerHTML='';
  toolsData.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="seq">${i+1}</td>
      <td style="text-align:right">
        <span class="tool-name" style="font-weight:800">${t.title}</span>
        <span class="tool-desc">${t.desc}</span>
      </td>
      <td style="text-align:center"><input type="checkbox" class="tool-proof" title="شاهد مُتاح؟"></td>
      <td>
        <div class="pills">
          <div class="pill" data-v="2">مُفعل</div>
          <div class="pill" data-v="1">إلى حد ما</div>
          <div class="pill" data-v="0">غير مُفعل</div>
        </div>
      </td>
      <td>
        <textarea class="tool-reason" placeholder="اكتب السبب عند (غير مُفعل/إلى حد ما)"></textarea>
      </td>`;
    tBody.appendChild(tr);
  });

  [...document.querySelectorAll('.pills')].forEach((set)=>{
    const pills=set.querySelectorAll('.pill');
    const reason = set.parentElement.nextElementSibling.querySelector('.tool-reason');
    const enableReason = (v)=>{ reason.disabled = (v===2); if(v===2) reason.value=''; };
    pills.forEach(p=>p.addEventListener('click',()=>{
      const wasActive = p.classList.contains('active');
      pills.forEach(x=>x.classList.remove('active'));
      if(!wasActive){ p.classList.add('active'); enableReason(Number(p.dataset.v)); }
      else{ enableReason(null); } // غير محدد
      updateToolsSummary(); saveDraftActiveVisit(); calcAll();
    }));
    reason.addEventListener('input',()=>{ saveDraftActiveVisit(); });
  });
  updateToolsSummary();
}
function getToolsStateFromUI(){
  return [...document.querySelectorAll('.pills')].map(set=>{
    const act=set.querySelector('.pill.active'); return act? Number(act.dataset.v):null;
  });
}
function getToolReasonsFromUI(){
  return [...document.querySelectorAll('.tool-reason')].map(t=>(t.value||'').trim());
}
function setToolsStateToUI(arr){
  const sets=[...document.querySelectorAll('.pills')];
  sets.forEach((set,i)=>{
    set.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
    const v=(arr&&typeof arr[i]!=='undefined')?arr[i]:null;
    if(v===0||v===1||v===2){ const el=set.querySelector(`.pill[data-v="${v}"]`); if(el) el.classList.add('active'); }
    const reason = set.parentElement.nextElementSibling.querySelector('.tool-reason');
    reason.disabled = (v===2);
    if(v===2) reason.value='';
  });
  updateToolsSummary();
}
function setToolReasonsToUI(arr){
  const areas=[...document.querySelectorAll('.tool-reason')];
  areas.forEach((t,i)=>{ t.value = (arr && typeof arr[i]!=='undefined')? arr[i] : ''; });
}

/* شريط ملخص الأدوات */
const gradbar=document.getElementById('gradbar'), meta=document.getElementById('toolsMeta');
const tU=document.getElementById('tU'), tR=document.getElementById('tR'), tA=document.getElementById('tA'), tG=document.getElementById('tG');
function updateToolsSummary(){
  const sets=[...document.querySelectorAll('.pills')];
  let g=0,a=0,r=0,u=0;
  sets.forEach(set=>{
    const act=set.querySelector('.pill.active');
    if(!act) u++;
    else if(act.dataset.v==='2') g++;
    else if(act.dataset.v==='1') a++;
    else r++;
  });
  const total=toolsData.length||1;
  const pg=(g/total)*100, pa=(a/total)*100, pr=(r/total)*100;
  const startU=(u/total)*100;
  gradbar.style.background=`linear-gradient(90deg,#e5e7eb 0% ${startU}%,#fecaca ${startU}% ${startU+pr}%,#fde68a ${startU+pr}% ${startU+pr+pa}%,#bbf7d0 ${startU+pr+pa}% 100%)`;
  tU.textContent=`غير محدد: ${u}`; tR.textContent=`غير مُفعل: ${r}`; tA.textContent=`إلى حد ما: ${a}`; tG.textContent=`مُفعل: ${g}`;
  meta.textContent=`${total} أداة • محدد: ${total-u} • غير محدد: ${u}`;
}

/* توصيات مختصرة منوّعة */
function buildRecommendationsFor(visit){
  const ok=[], dev=[];
  const strongV=['إتقان','إبداع','تمكّن'];
  const goodV=['تقدّم','تحسّن','نمو ملحوظ'];
  const weakV=['تطوير','معالجة','تحسين عاجل'];

  fields.forEach((f,fi)=>{
    const vals=store[visit][fi]; if(!vals) return;
    const filled=vals.filter(v=>v>0); if(!filled.length) return;
    const avg=filled.reduce((a,b)=>a+b,0)/filled.length;
    if(avg>=2.5) ok.push(`${strongV[Math.floor(Math.random()*strongV.length)]} في «${f.name}» ينعكس على تعلم الطلاب.`);
    else if(avg>=1.5) ok.push(`${goodV[Math.floor(Math.random()*goodV.length)]} في «${f.name}» يحتاج تثبيت الاستمرارية.`);
    else dev.push(`${weakV[Math.floor(Math.random()*weakV.length)]} عناصر «${f.name}» بخطوات قصيرة متتابعة.`);
  });

  const toolVals=getToolsArrayForVisit(visit), toolReasons=getToolReasonsForVisit(visit);
  const seenTools=new Set();
  toolVals.forEach((v,i)=>{
    if(seenTools.has(i)) return; seenTools.add(i);
    const tt=toolsData[i].title; const why=(toolReasons[i]||'').trim();
    const tail = why? ` (مانع: ${why.slice(0,40)})` : '';
    if(v===2) ok.push(`مواءمة «${tt}» مع الأهداف تعمّق الأثر.`);
    if(v===1) dev.push(`تطوير «${tt}» بخطوات وجيزة متتابعة.`);
    if(v===0) dev.push(`بدء «${tt}» تجريبيًّا${tail}.`);
  });

  const uniq=(arr)=>[...new Set(arr)];
  return {ok:uniq(ok), dev:uniq(dev)};
}

/* مؤشرات */
function getToolsArrayForVisit(v){
  const snap=loadedRecord?.visits?.[v];
  if(snap?.finalized && Array.isArray(snap.tools)) return snap.tools.slice();
  if(snap?.draft?.tools) return snap.draft.tools.slice();
  if(v===activeVisit){ return getToolsStateFromUI(); }
  return Array(toolsData.length).fill(null);
}
function getToolReasonsForVisit(v){
  const snap=loadedRecord?.visits?.[v];
  if(snap?.finalized && Array.isArray(snap.toolReasons)) return snap.toolReasons.slice();
  if(snap?.draft?.toolReasons) return snap.draft.toolReasons.slice();
  if(v===activeVisit){ return getToolReasonsFromUI(); }
  return Array(toolsData.length).fill('');
}
function toolPctFromArray(arr){
  const total=arr.length||1;
  const score=arr.reduce((acc,v)=>acc+(v===2?1:(v===1?0.5:0)),0)/total;
  return Math.round(score*100);
}
function visitPctLevels(v){
  const flat=store[v].flat(), rated=flat.filter(x=>x>0);
  const s=rated.reduce((a,b)=>a+(b-1),0);
  return rated.length?Math.round((s/(rated.length*2))*100):0;
}
function toolPctForVisit(v){ return toolPctFromArray(getToolsArrayForVisit(v)); }
function visitPctAdjusted(v){ const L=visitPctLevels(v), T=toolPctForVisit(v); return Math.round(L*0.85 + T*0.15); }
function setVisitMeter(p){document.getElementById('kpiPct').textContent=p+'%'; document.getElementById('hThumb').style.left=p+'%';}
function setDonut(v,p){const C=314; const ring=document.querySelector('#v'+v+' .ring'); const txt=document.getElementById('v'+v+'t'); ring.setAttribute('stroke', p>=80?'#16a34a':(p>=50?'#f59e0b':'#ef4444')); ring.setAttribute('stroke-dasharray',`${(p/100)*C} ${C}`); txt.textContent=p+'%';}
function setGlobalMeter(p){document.getElementById('globalThumb').style.left=p+'%'; const gi=document.getElementById('globalPctInline'); gi.textContent=p+'%'; gi.className='globalInline '+(p>=80?'good':(p>=50?'mid':'bad')); }
function setVisitPercents(p1,p2,p3){document.getElementById('p1').textContent=p1+'%';document.getElementById('p2').textContent=p2+'%';document.getElementById('p3').textContent=p3+'%';}

/* تبديل الزيارة */
['v1','v2','v3'].forEach((id,i)=>{
  const el=document.getElementById(id);
  el.addEventListener('click',()=>{
    saveDraftActiveVisit();
    activeVisit=i+1;
    toggleChipVisibility();
    buildTable(); buildTools(); buildSupport();
    renderToolsForVisit(); renderSupportForVisit();
    calcAll();
  });
});
['v1h','v2h','v3h'].forEach((id,i)=>{document.getElementById(id).addEventListener('click',()=>{const d=hijriDateStr(new Date()); setChip(i+1,d); saveSoft();});});
function setChip(v,txt){document.getElementById('v'+v+'h').textContent=txt; document.getElementById('sh'+v).textContent=txt;}
function toggleChipVisibility(){[1,2,3].forEach(v=>document.getElementById('v'+v+'h').classList.toggle('hidden', v!==activeVisit));}
function activeVisitHijri(){ const lbl=activeVisit===1?'الأولى':activeVisit===2?'الثانية':'الثالثة'; const d=document.getElementById('v'+activeVisit+'h').textContent||'—'; return {lbl,d}; }

/* ربط الأدوات/الدعم بالزيارة */
function renderToolsForVisit(){
  const snap=loadedRecord?.visits?.[activeVisit]||null;
  const st = snap?.finalized? (snap.tools||[]) : (snap?.draft?.tools||[]);
  const rs = snap?.finalized? (snap.toolReasons||[]) : (snap?.draft?.toolReasons||[]);
  setToolsStateToUI(st||[]);
  setToolReasonsToUI(rs||[]);
}
function renderSupportForVisit(){
  const snap=loadedRecord?.visits?.[activeVisit] || null;
  if(!document.getElementById('supportGrid').children.length) buildSupport();
  const supp = snap?.finalized? (snap.support||[]) : (snap?.draft?.support||[]);
  if(supp && supp.length && supp[0]?.items) setSupportStateToUI(supp);
  else setSupportStateToUI([]);
}

/* حفظ مسودة */
function saveDraftActiveVisit(){
  if(!loadedRecord) return;
  if(!loadedRecord.visits) loadedRecord.visits={1:{},2:{},3:{}};
  const v = activeVisit;
  const draft = {
    ratings: clone(store[v]),
    tools: getToolsStateFromUI(),
    toolReasons: getToolReasonsFromUI(),
    support: getSupportStateFromUI(),
    date: document.getElementById('v'+v+'h').textContent||'—'
  };
  if(!loadedRecord.visits[v]) loadedRecord.visits[v]={finalized:false,date:'—'};
  loadedRecord.visits[v].draft = draft;
  loadedRecord.visits[v].date = draft.date;
  dbPutTeacher(loadedRecord);
}

/* تحميل/تهيئة معلم */
function clearUIBeforeLoad(){
  store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()};
  buildTable(); buildTools(); buildSupport();
  setToolsStateToUI([]); setToolReasonsToUI([]); setSupportStateToUI([]);
  [1,2,3].forEach(v=>{setChip(v,'—'); document.getElementById('done'+v).style.display='none'; setDonut(v,0);});
  calcAll();
}
async function loadRecordForCurrentTeacher(){
  const id=normalizedTeacherId();
  loadedRecord=null;
  clearUIBeforeLoad();
  if(!id){ return; }

  loadedRecord=await dbGetTeacher(id);
  if(!loadedRecord){
    loadedRecord={teacherId:id,name:(tName.value||'').trim(),nationalId:(tId.value||'').replace(/\D+/g,''),spec:tSpec.value||'',degree:degree.value||'',exp:exp.value||'',school:document.getElementById('h-school').textContent||'',visits:{1:{finalized:false,date:'—'},2:{finalized:false,date:'—'},3:{finalized:false,date:'—'}},savedAt:new Date().toISOString()};
    await dbPutTeacher(loadedRecord);
  }
  [1,2,3].forEach(v=>{
    const snap=loadedRecord.visits?.[v];
    if(snap){
      setChip(v,snap.date||'—');
      if(snap.finalized){
        document.getElementById('done'+v).style.display='inline-block';
        if(snap.ratings) store[v]=clone(snap.ratings);
      }else if(snap.draft?.ratings){
        store[v]=clone(snap.draft.ratings);
      }
    }
  });
  const lastFinal=[3,2,1].find(v=>loadedRecord.visits?.[v]?.finalized);
  activeVisit=lastFinal || 1;

  buildTable(); buildTools(); buildSupport();
  renderToolsForVisit(); renderSupportForVisit(); calcAll();
}

/* حفظ رؤوس بسيطة */
async function saveSoft(){
  if(!loadedRecord) return;
  loadedRecord.name=(tName.value||'').trim();
  loadedRecord.nationalId=(tId.value||'').replace(/\D+/g,'');
  [1,2,3].forEach(v=>{
    if(!loadedRecord.visits[v]) loadedRecord.visits[v]={finalized:false,date:'—'};
    const chip=document.getElementById('v'+v+'h').textContent||'—';
    loadedRecord.visits[v].date = chip && chip.trim()? chip : loadedRecord.visits[v].date || '—';
  });
  await dbPutTeacher(loadedRecord);
}

/* إبراز الأخطاء */
function clearErrors(){ document.getElementById('boxInfo').classList.remove('section-error'); [tName,tId].forEach(el=>el.classList.remove('input-error')); }
function mark(el){ el.classList.add('input-error'); }

/* تحقق قبل الاعتماد */
function validateCurrentVisit(){
  clearErrors();
  const nm=(tName.value||'').trim();
  const nid=(tId.value||'').replace(/\D+/g,'');
  const missing=[];
  if(!nm){ missing.push('اسم المعلم'); mark(tName); }
  if(!(/^\d{10}$/.test(nid))){ missing.push('رقم الهوية (10 أرقام)'); mark(tId); }
  if(missing.length){
    document.getElementById('boxInfo').classList.add('section-error');
    alert('تنبيه: سجِّل الاسم والهوية قبل الاعتماد:\n- '+missing.join('\n- '));
    return false;
  }
  return true;
}

/* اعتماد زيارة — (إصلاح جذري: لا نستدعي loadRecordForCurrentTeacher داخل الاعتماد حتى لا تُصفَّر الواجهة) */
document.getElementById('finishVisitBtn').addEventListener('click', async ()=>{
  if(!validateCurrentVisit()) return;

  // ضمان وجود سجل دون مسح الواجهة
  if(!loadedRecord){
    const id=normalizedTeacherId(); if(!id) return alert('أدخل بيانات المعلم أولًا.');
    loadedRecord={teacherId:id,name:(tName.value||'').trim(),nationalId:(tId.value||'').replace(/\D+/g,''),spec:tSpec.value||'',degree:degree.value||'',exp:exp.value||'',school:document.getElementById('h-school').textContent||'',visits:{1:{finalized:false,date:'—'},2:{finalized:false,date:'—'},3:{finalized:false,date:'—'}},savedAt:new Date().toISOString()};
  }

  const chip=document.getElementById('v'+activeVisit+'h');
  if(!chip.textContent || chip.textContent==='—'){ chip.textContent=hijriDateStr(new Date()); }
  setChip(activeVisit, chip.textContent);
  syncSignatureDates();

  if(!loadedRecord.visits) loadedRecord.visits={1:{},2:{},3:{}};
  const snap=loadedRecord.visits[activeVisit]||{};
  loadedRecord.name=(tName.value||'').trim();
  snap.ratings=clone(store[activeVisit]);
  snap.tools=getToolsStateFromUI().slice();
  snap.toolReasons=getToolReasonsFromUI().slice();
  snap.support=getSupportStateFromUI();
  snap.date=chip.textContent;
  snap.finalized=true;
  snap.savedAt=new Date().toISOString();
  delete snap.draft;
  loadedRecord.visits[activeVisit]=snap;
  await dbPutTeacher(loadedRecord);

  document.getElementById('done'+activeVisit).style.display='inline-block';
  await refreshApprovedPanel(true);

  calcAll();
  alert('تم اعتماد الزيارة وحفظ جميع البيانات لهذا المعلم.');
});

/* حذف زيارة محددة */
document.getElementById('btnDeleteVisit').addEventListener('click', async ()=>{
  const id=normalizedTeacherId(); if(!id) return alert('اختر معلمًا أولًا.');
  if(!confirm('سيتم تصفير المؤشرات والاختيارات والأسباب والتاريخ لهذه الزيارة فقط. متابعة؟')) return;
  try{
    if(!loadedRecord) loadedRecord=await dbGetTeacher(id);
    loadedRecord.visits[activeVisit]={finalized:false,date:'—'};
    store[activeVisit]=zeroMatrix();
    await dbPutTeacher(loadedRecord);
    setChip(activeVisit,'—'); setDonut(activeVisit,0); document.getElementById('done'+activeVisit).style.display='none';
    renderToolsForVisit(); renderSupportForVisit(); calcAll();
    await refreshApprovedPanel(true);
  }catch(e){ alert('تعذر حذف الزيارة، حاول مجددًا.'); }
});

/* مسح الجميع */
document.getElementById('btnClearAll').addEventListener('click', async ()=>{
  if(!confirm('سيتم مسح كل شيء: المؤشرات والاختيارات والأسباب والتوصيات والدعم وقوائم الأسماء. متابعة؟')) return;
  try{
    await dbClearAll();
    localStorage.removeItem(LS_TEACHERS);
    localStorage.removeItem(LS_LAST);
    store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()};
    [1,2,3].forEach((_,v)=>{setChip(v+1,'—'); setDonut(v+1,0); document.getElementById('done'+(v+1)).style.display='none';});
    document.getElementById('strengthBox').innerHTML='—'; document.getElementById('devBox').innerHTML='—';
    document.getElementById('approvedList').innerHTML='—'; document.getElementById('approvedPanel').style.display='none';
    tName.value=''; tId.value=''; tSpec.value=''; degree.value=''; exp.value='';
    buildSupport(); renderSupportForVisit(); updateSignNames(); calcAll();
    alert('تم مسح جميع البيانات بنجاح.');
  }catch(e){ alert('تعذر المسح العام، تأكد من سماح المتصفح بالتخزين.'); }
});

/* لوحة المعتمدين */
async function refreshApprovedPanel(openIfHidden=false){
  const db=await openDB();
  const arr=[];
  await new Promise((res)=>{
    const tx=db.transaction(STORE,'readonly'); const os=tx.objectStore(STORE);
    const req=os.openCursor();
    req.onsuccess=()=>{ const c=req.result; if(c){arr.push(c.value); c.continue();} else res(); };
    req.onerror=()=>res();
  });

  const entries=[];
  arr.forEach(rec=>{
    [1,2,3].forEach(v=>{
      if(rec.visits?.[v]?.finalized){
        entries.push({name:(rec.name||rec.teacherId), visit:v});
      }
    });
  });
  entries.sort((a,b)=> a.name.localeCompare(b.name,'ar') || a.visit-b.visit);

  const box=document.getElementById('approvedList');
  box.innerHTML = entries.length? '' : '—';
  entries.forEach(e=>{
    const s=document.createElement('span'); s.className='name-chip';
    s.textContent=`${e.name} (الزيارة ${e.visit})`;
    box.appendChild(s);
  });

  const panel=document.getElementById('approvedPanel');
  if(openIfHidden && (panel.style.display==='none'||!panel.style.display)){ panel.style.display='block'; }
}
document.getElementById('btnApproved').addEventListener('click',async ()=>{
  const panel=document.getElementById('approvedPanel');
  if(panel.style.display==='none'||!panel.style.display){ await refreshApprovedPanel(); panel.style.display='block'; }
  else panel.style.display='none';
});

/* أسماء التوقيع + هوية المعلم */
function updateSignNames(){const n=(tName.value||'—');['sn1','sn2','sn3'].forEach(id=>document.getElementById(id).textContent=n);}
tName.addEventListener('input',()=>{tName.classList.remove('input-error'); updateSignNames(); saveDraftActiveVisit();});
tId.addEventListener('input',()=>{
  const digits=(tId.value||'').replace(/\D+/g,'').slice(0,10);
  if(tId.value!==digits) tId.value=digits;
  tId.classList.remove('input-error');
  saveDraftActiveVisit();
});

/* تبديل المعلم */
let idDebounce=null;
function onIdentityChange(){
  clearTimeout(idDebounce);
  idDebounce=setTimeout(async ()=>{
    await loadRecordForCurrentTeacher();
    localStorage.setItem(LS_LAST, normalizedTeacherId());
  },220);
}
tId.addEventListener('change',onIdentityChange);
tId.addEventListener('blur',onIdentityChange);
tName.addEventListener('change',onIdentityChange);
tName.addEventListener('blur',onIdentityChange);

/* تعديل اسم المدير */
function editPrincipal(id){
  const el=document.getElementById(id);
  const v=prompt('اسم مدير المدرسة:', el.textContent.trim() || 'فهد حامد علي الزهراني');
  if(v){ el.textContent=v; saveSoft(); }
}
document.getElementById('penPrin1').addEventListener('click',()=>editPrincipal('pn1'));
document.getElementById('penPrin2').addEventListener('click',()=>editPrincipal('pn2'));
document.getElementById('penPrin3').addEventListener('click',()=>editPrincipal('pn3'));

/* حسابات + تحديث واجهة + دعم تلقائي */
function calcAll(){
  const p1=visitPctAdjusted(1), p2=visitPctAdjusted(2), p3=visitPctAdjusted(3);
  [1,2,3].forEach(v=> setDonut(v, v===1?p1:(v===2?p2:p3)));
  const gpct=Math.round((p1+p2+p3)/3); setGlobalMeter(gpct); setVisitPercents(p1,p2,p3);
  setVisitMeter(visitPctAdjusted(activeVisit));
  const {ok,dev}=buildRecommendationsFor(activeVisit);
  document.getElementById('strengthBox').innerHTML=ok.length?ok.join('<br>'):'—';
  document.getElementById('devBox').innerHTML=dev.length?dev.join('<br>'):'—';
  generateSupportFromLevels();
  saveDraftActiveVisit();
}

/* طباعة / حفظ PDF — استبدال textareas بكتل نصية لضمان ظهور الأسباب */
function updatePrintHijri(){ document.getElementById('printHijri').textContent = hijriNow(); }
function cloneForSnapshot(){
  const node=document.getElementById('page');
  const cloned=node.cloneNode(true);
  // استبدال textareas
  cloned.querySelectorAll('textarea.tool-reason').forEach((ta,idx)=>{
    const val = document.querySelectorAll('textarea.tool-reason')[idx].value || '';
    const div=document.createElement('div');
    div.className='textarea-print';
    div.textContent=val;
    ta.parentNode.replaceChild(div,ta);
  });
  return cloned;
}
async function snapshotToImg(){
  updatePrintHijri();
  const clone = cloneForSnapshot();
  // إضافة للDOM مؤقتًا
  const holder=document.createElement('div');
  holder.style.position='fixed'; holder.style.left='-99999px'; holder.style.top='-99999px';
  holder.appendChild(clone);
  document.body.appendChild(holder);
  const canvas=await html2canvas(clone,{scale:2,background:'#ffffff',scrollX:0,scrollY:0,useCORS:true});
  document.body.removeChild(holder);
  return canvas;
}
document.getElementById('printBtn').addEventListener('click', async ()=>{
  const canvas=await snapshotToImg();
  const img=canvas.toDataURL('image/png',1.0);
  const iframe=document.createElement('iframe'); Object.assign(iframe.style,{position:'fixed',right:'0',bottom:'0',width:'0',height:'0',border:'0'});
  document.body.appendChild(iframe);
  const doc=iframe.contentWindow.document;
  doc.open(); doc.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>طباعة</title><style>@page{size:A4 portrait;margin:5mm}html,body{height:auto;margin:0}img{width:100%;height:auto;display:block}</style></head><body><img id="pimg" src="${img}"></body></html>`); doc.close();
  const imgEl=doc.getElementById('pimg'); imgEl.onload=()=>{ setTimeout(()=>{iframe.contentWindow.focus(); iframe.contentWindow.print(); setTimeout(()=>document.body.removeChild(iframe),400);},100); };
});
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const canvas=await snapshotToImg();
  const name=((tName.value||'غير مسمى').trim()).replace(/[\\/:*?"<>|]/g,'-');
  const school=document.getElementById('h-school').textContent.trim();
  const {lbl,d}=activeVisitHijri();
  const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const margin=5; const pdfW=210-2*margin, pdfH=297-2*margin;
  const img=canvas.toDataURL('image/png',1.0); const imgWmm=canvas.width*0.264583, imgHmm=canvas.height*0.264583;
  const ratio=Math.min(pdfW/imgWmm, pdfH/imgHmm); const w=imgWmm*ratio, h=imgHmm*ratio; const x=margin+(pdfW-w)/2, y=margin+(pdfH-h)/2;
  pdf.addImage(img,'PNG',x,y,w,h,'','FAST');
  pdf.save(`استمارة زيارة - ${name} - الزيارة ${lbl} - ${d} - ${school}.pdf`);
});

/* تمرير */
const toTop=document.getElementById('toTop'), toBottom=document.getElementById('toBottom');
window.addEventListener('scroll',()=>{const on=window.scrollY>200; toTop.style.display= on ? "block":"none"; toBottom.style.display= on ? "block":"none";});
toTop.addEventListener('click',()=>window.scrollTo({top:0,behavior:"smooth"}));
toBottom.addEventListener('click',()=>window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}));

/* ملء معلم */
async function fillTeacher(t){
  tName.value=t.name||''; tId.value=(t.id||'').replace(/\D+/g,'').slice(0,10);
  tSpec.value=t.spec||''; degree.value=t.degree||''; exp.value=t.exp||'';
  updateSignNames();
  await loadRecordForCurrentTeacher();
  localStorage.setItem(LS_LAST, normalizedTeacherId());
}

/* إغلاق الإشعار */
document.getElementById('toastClose').addEventListener('click',()=>document.getElementById('toast').style.display='none');

/* تهيئة */
(async function init(){
  document.getElementById('hijriChip').textContent='التاريخ الهجري: '+hijriNow();
  try{ const saved=JSON.parse(localStorage.getItem(LS_TEACHERS)||'[]'); if(Array.isArray(saved)) teacherList=saved; }catch{}

  const last=localStorage.getItem(LS_LAST);
  if(last){
    if(/^\d{10}$/.test(last)){ tId.value=last; }
    else if(last.startsWith('name:')){ tName.value=last.replace(/^name:/,''); }
  }
  updateSignNames();

  buildTable(); buildTools(); buildSupport();
  await loadRecordForCurrentTeacher();
  calcAll();

  setInterval(()=>{ saveDraftActiveVisit(); saveSoft(); }, 60000);
})();
</script>
</body>
</html>
