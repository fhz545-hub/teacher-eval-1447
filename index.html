<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"> <!-- ููู ููุฌูุงู -->
<title>ุงูุดุคูู ุงูุฅุฏุงุฑูุฉ ูุงููุชุงุจุนุฉ</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
:root{--moe:#0b7e88;--ink:#111;--sidebarW:350px;--b:#e6eeee}
*{box-sizing:border-box}
html,body{margin:0;background:#f6fafb;color:var(--ink);font:12.6px/1.8 Tajawal,system-ui;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
p,li,span,strong,b{letter-spacing:0;word-spacing:.25px}

/* ุงูุชุฎุทูุท ุงูุนุงู */
.app{display:grid;grid-template-columns:var(--sidebarW) 1fr;min-height:100vh}
@media (max-width:1024px){ .app{grid-template-columns:1fr} }

/* ููุญุฉ ุงูุชุนูููุงุช */
.sidebar{position:sticky;top:0;height:100vh;background:#fff;border-inline-end:1px solid #e8f2f2;box-shadow:0 0 24px rgba(0,0,0,.04);display:flex;flex-direction:column;z-index:5}
@media (max-width:1024px){
  .sidebar{position:relative;height:auto;top:auto;border-inline-end:0;border-bottom:1px solid #e8f2f2}
}
.sb-head{padding:12px;border-bottom:1px solid #eef4f4;font-weight:900;color:#064b50}
.sb-body{padding:10px;overflow:auto}
.f{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.f label{font-weight:800;color:#03636a;font-size:11.6px}
.sel,.inp,.btn{height:34px;border:1px solid #dbe9e9;border-radius:10px;background:#fff;padding:6px 9px;font-weight:800}
.sel{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#89a 0),linear-gradient(135deg,#89a 50%,transparent 0);background-position:calc(100% - 18px) 50%,calc(100% - 12px) 50%;background-size:6px 6px,6px 6px;background-repeat:no-repeat;cursor:pointer}
.row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{border:1px solid #dbe9e9;border-radius:12px;background:#f2fafb;color:#0b5e63;font-weight:900;padding:6px 10px;cursor:pointer}
.chip.active{background:var(--moe);color:#fff;border-color:transparent}
.btn{cursor:pointer}.btn.ghost{background:#eef7ู7}.btn.primary{background:var(--moe);color:#fff;border-color:transparent}.btn.wh{background:#25D366;color:#fff;border-color:#1aae53}
.sb-actions{margin-top:8px;display:flex;flex-direction:column;gap:8px}
.rights{font-size:10px;color:#7a8790;text-align:center;padding:8px 10px;border-top:1px dashed #eef4f4;margin-top:auto}
.disabled{opacity:.45;pointer-events:none;filter:grayscale(1)}

/* ุงููุญุชูู */
.content{padding:16px}
.sheet-wrap{display:flex;justify-content:center;overflow:auto}
.sheet{width:100%;max-width:210mm;min-height:297mm;background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.04)}
.pad{padding:8mm 10mm 9mm}

/* ุงูููุฏุฑ */
.hdr{position:relative;margin:0 0 5mm}
.hdr img{width:100%;display:block;border-radius:12px;image-rendering:auto}
.meta-stack{position:absolute;inset-inline-end:12px;top:12px;display:flex;flex-direction:column;gap:6px;min-width:130px;transform:translateX(4px)}
.meta-stack .rowB{background:transparent;border:0;border-radius:10px;padding:6px 10px;font-weight:900;text-align:center}

/* ุนููุงู ูุฑูุฒู */
.title-center{text-align:center;margin:5mm 0 3mm}
.title-center .t{font-weight:900;font-size:22px;color:#064b50}

/* ุฌุฏูู ุจูุงูุงุช ุงููุนูู */
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl th{background:#0b5e63;color:#fff;border:1px solid #244a4a;padding:6px 7px;font-weight:900}
.tbl td{border:1px solid #3f5b57;padding:5px 7px;height:10mm;text-align:center}
.tbl .name{width:38%}.tbl .spec{width:14%}.tbl .level{width:16%}.tbl .job{width:16%}.tbl .work{width:16%}

/* ุดุงุฑุฉ ุงูุณุฌู ุงููุฏูู */
.badges-under{margin:6px auto 0;display:flex;gap:10px;justify-content:flex-start;align-items:center;width:100%}
.badge{display:inline-flex;align-items:center;gap:8px;border:1px solid #0b7e88;border-radius:10px;padding:2px 10px;background:#fff;font-weight:900}
.badge .tag{background:var(--moe);color:#fff;border-radius:8px;padding:2px 8px}

/* ุฃูุณุงู */
.sec{margin-top:6mm}
.sec h3{margin:0 0 6px;color:#0b5e63;font-size:14px}
.rule-row{display:flex;align-items:center;gap:6px;margin-top:3px}
.rule-row .label{font-weight:900;white-space:nowrap}
.dotfield{display:inline-block;min-width:25mm;border-bottom:1px dotted #2f4f4c;text-align:center;padding:0 2mm}
.timebox{display:inline-block;min-width:26mm;text-align:center;padding:.4mm 2.5mm;background:#fff;color:#111;font-weight:900;border-radius:6px;border:1px solid #000;font-family:ui-monospace,Consolas,monospace;font-size:12px;cursor:text}
.timebox.empty{color:#777;border-color:#bbb}
.checks{margin:5px 0 6px}
.checkline{display:flex;align-items:flex-start;gap:6px;margin:5px 0}
.checkline input{margin-top:3px;transform:scale(1.05)}
.checkline .text{flex:1}
.calc{font-weight:900;color:#0b5e63}

/* ุฎุทูุท ุงููุชุงุจุฉ */
.lines{min-height:26mm;border:1px dashed #2ู4ู4c;border-radius:10px;padding:8px 10px;background:#fafefe}
.lines div{height:9mm;border-bottom:1px dotted #2f4f4c}
.lines div:last-child{border-bottom:0}
/* ููุท ูููุท ุฎููู ููุฑุงุบ ุงูุฅูุงุฏุฉ */
.lines.dotted{border-color:#cfd8d8}
.lines.dotted div{border-bottom:1px dotted #c7cfd0}

/* ุนุจุงุฑุฉ โุชุญูุธ โฆโ */
.footer-note{margin-top:10mm}
.footer-note span{display:inline-block;margin-inline-end:auto;color:#333;font-size:10.5px;font-weight:800}

/* ูุงูุฐุฉ ุงูุฅุญุตุงุฆูุงุช */
#statsDlg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:50;align-items:center;justify-content:center;padding:12px}
.stats-card{background:#fff;border-radius:16px;max-width:1100px;width:96%;max-height:90vh;overflow:auto;border:1px solid var(--b)}
.stats-card .h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef4f4}
.stats-hdr{position:relative;margin:8px 8px 10px}
.stats-hdr img{width:100%;display:block;border-radius:12px} /* ููุก ุงูููุฏุฑ */
.stats-meta{position:absolute;inset-inline-end:12px;top:12px;display:flex;flex-direction:column;gap:6px;min-width:130px}
.stats-meta .rowB{background:transparent;border:0;border-radius:10px;padding:6px 10px;font-weight:900;text-align:center}
.tbl2{width:100%;border-collapse:collapse}
.tbl2 th{background:#0b5e63;color:#fff;border:1px solid #2b4949;padding:6px 8px;position:sticky;top:0}
.tbl2 td{border:1px solid #2b4949;padding:6px 8px}

/* ุนุฏูุงุฏ ุงูุณุงุนุฉ */
#clockDlg{display:none;position:fixed;inset:0;z-index:60;background:rgba(0,0,0,.35);align-items:center;justify-content:center;padding:16px}
.clock-card{background:#fff;border:1px solid var(--b);border-radius:16px;max-width:360px;width:96%}
.clock-card .h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef4f4}
.clock-card .b{padding:12px}
.clock-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
.clock-row .col{flex:1}
.clock-row input[type=range]{width:100%}
.clock-big{font:900 26px/1 Tajawal,system-ui;text-align:center;color:#064b50;margin:8px 0}
.clock-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.clock-actions .btn{height:auto;padding:7px 10px}

/* ุทุจุงุนุฉ A4 ููู ุงูุตูุญุงุช + ุงูุฅุญุตุงุฆูุงุช โ ุถุบุท ูุฏุฑูุณ ุจุฏูู ุงุฌุชุฒุงุก */
*{-webkit-print-color-adjust:exact; print-color-adjust:exact}
@media print{
  @page{size:A4;margin:10mm}
  html,body{height:auto;background:#fff}
  .content{padding:0}
  .sheet{width:210mm;min-height:auto;border:0;box-shadow:none;page-break-inside:avoid}
  /* ุถุบุท ุทููู ูููุณุงูุงุช ููุญูุงุธ ุนูู ุงููููุฉ ุฏูู ุงุฌุชุฒุงุก */
  .pad{padding:8mm 9mm 9mm}
  .hdr{margin:0 0 4mm}
  .hdr img{max-height:40mm;object-fit:cover;border-radius:8px}
  .title-center{margin:4mm 0 2mm}
  .sec{margin-top:5mm}

  .tbl th{background:#0b5e63 !important;color:#fff !important;border-color:#000 !important}
  .tbl td{border-color:#000 !important}
  .timebox{border-color:#000 !important;color:#000 !important}
  .lines{border-color:#000 !important}
  .lines div{border-color:#000 !important}
  .dotfield{border-bottom:1px dotted #000 !important}

  /* ุทุจุงุนุฉ ูุงูุฐุฉ ุงูุฅุญุตุงุฆูุงุช ูุตูุญุฉ ูุงููุฉ A4 */
  #statsDlg[aria-hidden="false"]{
    display:block !important; position:static !important; inset:auto !important;
    background:#fff !important; padding:0 !important;
  }
  #statsDlg[aria-hidden="false"] ~ .app{visibility:hidden}
  #statsDlg[aria-hidden="false"]{visibility:visible}
  #statsDlg[aria-hidden="false"] .stats-card{
    border:0 !important;border-radius:0 !important;width:210mm !important;max-width:none !important;
    min-height:297mm !important;max-height:none !important;overflow:visible !important;box-shadow:none !important;margin:0 auto !important;
    page-break-inside:avoid;
  }
  #statsDlg[aria-hidden="false"] .stats-card > .h,
  #statsDlg[aria-hidden="false"] .stats-hdr,
  #statsDlg[aria-hidden="false"] .stats-card > div[style^="padding"]{
    padding-inline:9mm !important;
  }
  #statsDlg[aria-hidden="false"] .stats-hdr{margin:7mm 0 6mm !important}
  #statsDlg[aria-hidden="false"] .stats-hdr img{border-radius:8px !important;max-height:40mm;object-fit:cover}
  #statsDlg[aria-hidden="false"] .tbl2{width:100%;border-collapse:collapse;table-layout:auto}
  #statsDlg[aria-hidden="false"] .tbl2 thead{display:table-header-group}
  #statsDlg[aria-hidden="false"] .tbl2 tfoot{display:table-footer-group}
  #statsDlg[aria-hidden="false"] .tbl2 th{position:static !important}
  #statsDlg[aria-hidden="false"] .tbl2 th,
  #statsDlg[aria-hidden="false"] .tbl2 td{padding:6px 8px !important}
  #statsDlg[aria-hidden="false"] .tbl2 tr{page-break-inside:avoid}
  #statsDlg[aria-hidden="false"] .stats-card .h{padding-block:7mm 4mm !important;border:0 !important}
  #statsDlg[aria-hidden="false"] .stats-actions{display:none !important}
  #statsDlg[aria-hidden="false"] .tbl2 th{background:#0b5e63 !important;color:#fff !important;border-color:#000 !important}
  #statsDlg[aria-hidden="false"] .tbl2 td{border-color:#000 !important}

  .sidebar,.rights,#clockDlg{display:none !important}
}
</style>
</head>
<body>
<div class="app">

  <!-- ููุญุฉ ุงูุชุนูููุงุช -->
  <aside class="sidebar" id="sidebar">
    <div class="sb-head">ููุญุฉ ุงูุชุนูููุงุช</div>
    <div class="sb-body">
      <div class="f">
        <label>ููุน ุงูุฅุฌุฑุงุก</label>
        <div class="chips" id="kindChips">
          <button class="chip active" data-k="late">ุชุฃุฎุฑ</button>
          <button class="chip" data-k="absent">ุนุฏู ุชูุงุฌุฏ</button>
          <button class="chip" data-k="early">ุงูุตุฑุงู</button>
          <button class="chip" data-k="gaib">ูุณุงุกูุฉ ุบูุงุจ</button>
          <button class="chip" data-k="note">ููุช ูุธุฑ</button>
        </div>
      </div>

      <div class="f">
        <label>ุงููุนููู</label>
        <select id="selTeacher" class="sel"></select>
      </div>

      <div class="f">
        <label>ุชูููุช ุงูุฏูุงู</label>
        <div class="chips" id="seasonChips">
          <button class="chip active" data-season="winter">ุงูุดุชูู (06:45โ13:45)</button>
          <button class="chip" data-season="summer">ุงูุตููู (07:00โ14:00)</button>
        </div>
      </div>

      <!-- ุฃุณุจุงุจ ููุช ุงููุธุฑ -->
      <div class="f">
        <label>ุณุจุจ ููุช ุงููุธุฑ</label>
        <select id="noteReason" class="sel">
          <option value="">โ ุงุฎุชุฑ ุงูุณุจุจ โ</option>
          <option>ุนุฏู ุงููุดุงุฑูุฉ ูู ุงูุฅุดุฑุงู ุงูุตุจุงุญู ููู ุงูุฌุฏูู ุงููุนุชูุฏ.</option>
          <option>ุงูุชูุตูุฑ ูู ููุงูุจุฉ ููุงูุฉ ุงูุฏูุงู ููุง ุฃุซูุฑ ุนูู ุงูุถุจุงุท ุฎุฑูุฌ ุงูุทูุงุจ.</option>
          <option>ุถุนู ุงูุฅุดุฑุงู ุฃุซูุงุก ุงููุณุญุฉ ูุนุฏู ูุชุงุจุนุฉ ุงูุณููู.</option>
          <option>ุนุฏู ุงูุฅุดุฑุงู ุนูู ุตูุงุฉ ุงูุธูุฑ ูู ุงููุตูู ุงููุฏุฑุณู.</option>
          <option>ุนุฏู ุงูุชุญุถูุฑ ุงูุฅููุชุฑููู ูู ููุตุฉ ูุฏุฑุณุชู ุญุณุจ ุงููุชุทูุจุงุช.</option>
          <option>ุงูุฎุฑูุฌ ูู ุงูุญุตุฉ ูุจู ุงูุชูุงุฆูุง ุฏูู ูุจุฑุฑ ูุธุงูู.</option>
          <option>ุงูุชุฃุฎุฑ ุนู ุฏุฎูู ุงูุญุตุฉ ููู ุงูุฌุฏูู ุงูุฒููู.</option>
          <option>ุนุฏู ุงูุญุถูุฑ ููุทุงุจูุฑ ุงูุตุจุงุญู ุฏูู ุนุฐุฑ.</option>
          <option>ุงูุชุบูุจ ุนู ุงุฌุชูุงุน ุงููุฏุฑุณุฉ ุงูุฑุณูู ุฏูู ุนุฐุฑ.</option>
          <option>ุนุฏู ุงูุฑุฏ ุนูู ูุณุงุกูุฉ ุฅุฏุงุฑูุฉ ูู ุงูููุนุฏ ุงููุญุฏุฏ.</option>
          <option>ุฑูุถ ุงูุชูููุน ุนูู ุงูููุงุฐุฌ ุฃู ุงููุญุงุถุฑ ุงูุฑุณููุฉ.</option>
          <option>ุฑูุถ ุชูููุฐ ุชูุฌูู ุฅุฏุงุฑู ุฃู ุชุฑุจูู ุฏูู ูุจุฑุฑ.</option>
          <option>ุนุฏู ุฑูุน ุจูุงูุงุช ุงูุบูุงุจ ูู (ูุงุฑุณ) ุจุงูููุช ุงููุญุฏุฏ.</option>
          <option>ุนุฏู ุฏุฎูู ุญุตุฉ ุงูุงูุชุธุงุฑ ุงููููููู ุจูุง.</option>
          <option>ุงูุชูุตูุฑ ูู ุฅุฏุฎุงู ุงูุฏุฑุฌุงุช ูู (ููุฑ) ุถูู ุงูุฅุทุงุฑ ุงูุฒููู ุงููุนุชูุฏ.</option>
        </select>
      </div>

      <!-- ุงูููุญูุฏ: ุงูุนุฐุฑ/ูุงุฑุณ -->
      <div class="f">
        <label>ุงูุนุฐุฑ/ูุงุฑุณ</label>
        <button id="btnUnified" class="btn ghost" style="width:100%;display:flex;justify-content:space-between;align-items:center">
          <span id="unifiedText">ุจุฏูู ุนุฐุฑ</span><span>โพ</span>
        </button>

        <div id="unifiedPanel" style="display:none;border:1px solid #dbe9e9;border-radius:10px;padding:8px;margin-top:6px">
          <div class="f" style="margin:0">
            <label>ุงูุนุฐุฑ</label>
            <div class="chips" id="excuseGroup">
              <button class="chip" data-exc="with">ุจุนุฐุฑ</button>
              <button class="chip active" data-exc="without">ุจุฏูู ุนุฐุฑ</button>
            </div>
          </div>

          <div class="f" style="margin:6px 0 0">
            <label>ูุจูู ุงูุนุฐุฑ</label>
            <div class="chips" id="acceptGroup">
              <button class="chip" data-acc="accepted">ููุจูู</button>
              <button class="chip active" data-acc="rejected">ุบูุฑ ููุจูู</button>
            </div>
          </div>

          <div class="f" style="margin:6px 0 0">
            <label>ูุงุฑุณ โ ูุธูุฑ ููุณุงุกูุงุช ุงูุบูุงุจ ููุท</label>
            <div class="chips" id="frGroup">
              <button class="chip" data-fr="raised">ูุฑููุน</button>
              <button class="chip active" data-fr="not">ูู ููุฑูุน</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ุงูุชุงุฑูุฎ -->
      <div class="f">
        <label>ุงูุชุงุฑูุฎ</label>
        <div class="row"><button id="btnCalToggle" class="btn" style="flex:1">๐๏ธ ูุฌุฑู</button></div>
        <div id="pickHijri" class="row" style="margin-top:6px">
          <select id="hY" class="sel" style="width:33%"></select>
          <select id="hM" class="sel" style="width:33%"></select>
          <select id="hD" class="sel" style="width:34%"></select>
        </div>
        <div id="pickGreg" class="row" style="display:none;margin-top:6px">
          <input id="gY" class="inp" type="number" min="1900" max="2100" placeholder="YYYY" style="width:40%">
          <input id="gM" class="inp" type="number" min="1" max="12" placeholder="MM" style="width:30%">
          <input id="gD" class="inp" type="number" min="1" max="31" placeholder="DD" style="width:30%">
        </div>
      </div>

      <div class="sb-actions">
        <button id="btnStats" class="btn ghost">ุงูุฅุญุตุงุฆูุงุช ๐</button>
        <button id="btnWA" class="btn wh">ูุงุชุณุงุจ</button>
        <button id="btnPrintSave" class="btn primary">ุทุจุงุนุฉ / ุญูุธ</button>
      </div>
    </div>
    <div class="rights">ูุจุงุฏุฑุฉ ุงููุนููุจู โ ุชุทููุฑ: ููุฏ ุญุงูุฏ ุงูุฒูุฑุงูู (ูุง ุชุธูุฑ ูู ุงูุทุจุงุนุฉ)</div>
  </aside>

  <!-- ุตูุญุฉ A4 -->
  <main class="content">
    <div class="sheet-wrap">
      <div class="sheet" id="sheet" aria-label="ุตูุญุฉ A4">
        <div class="pad">

          <!-- ุงูููุฏุฑ -->
          <div class="hdr">
            <img id="hdrImg" src="hhh.png" alt="ููุฏุฑ" crossorigin="anonymous">
            <div class="meta-stack">
              <div class="rowB" id="metaDay">โ</div>
              <div class="rowB" id="metaHijri">โ</div>
              <div class="rowB">ุงูุฑูู: <span id="metaNo">01</span></div>
            </div>
          </div>

          <div class="title-center"><div class="t" id="mainTitle">ุชูุจูู</div></div>

          <!-- ุจูุงูุงุช ุงููุนูู -->
          <table class="tbl">
            <thead><tr>
              <th class="name">ุงูุงุณู</th><th class="spec">ุงูุชุฎุตุต</th><th class="level">ุงููุฑุชุจุฉ</th>
              <th class="job">ุฑูู ุงููุธููุฉ</th><th class="work">ุงูุนูู ุงูุญุงูู</th>
            </tr></thead>
            <tbody><tr>
              <td id="t_name">โ</td><td id="t_spec">โ</td><td id="t_level">โ</td><td id="t_job">โ</td><td id="t_work">โ</td>
            </tr></tbody>
          </table>

          <!-- ุดุงุฑุฉ ุงูุณุฌู ุงููุฏูู -->
          <div class="badges-under">
            <div class="badge"><span class="tag">ุงูุณุฌู ุงููุฏูู</span><span id="t_civil">โ</span></div>
          </div>

          <!-- (1) ุฎุทุงุจ ุงูุชูุจูู -->
          <div id="alertPack" class="sec">
            <h3>( 1 ) ุฎุทุงุจ ุงูุชูุจูู โ <span id="kindTitle">ุชุฃุฎุฑ</span></h3>
            <div class="rule-row"><span class="label">ุงูููุฑู ุงููุนูู :</span>
              <strong id="teacherNameInline" style="min-width:38mm;text-align:center;border-bottom:1px dotted #2f4f4c;display:inline-block;padding:0 2mm">โ</strong>
              <span>ูููู ุงููู</span></div>
            <p><strong>ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชูุ ูุจุนุฏ ุุุ</strong></p>
            <p>ุฅูู ูู ููู <span class="dotfield"><span id="dynDay">โ</span></span>
              ุงูููุงูู <span class="dotfield"><span id="dynHijri">โ</span></span> :</p>

            <div class="checks">
              <label id="lineLate" class="checkline">
                <input type="checkbox" checked>
                <span class="text">
                  ุชุฃุฎุฑูู ูู ุจุฏุงูุฉ ุงูุนููุ ูุญุถูุฑูู ุงูุณุงุนุฉ ( <span id="tLateIn" class="timebox empty" contenteditable="true" data-mask>--:--</span> ).
                  <span class="calc">โ ุฅุฌูุงูู ุงูุชุฃุฎุฑ: <span id="lateTotal">0 ุฏูููุฉ</span> (<span id="lateHH">00:00</span> ุณ)</span>
                </span>
              </label>

              <label id="lineAbs" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  ุนุฏู ุชูุงุฌุฏูู ุฃุซูุงุก ุงูุนูู ูู ุงูุณุงุนุฉ : ( <span id="tAbsFrom" class="timebox empty" contenteditable="true" data-mask>--:--</span> )
                  ุฅูู ุงูุณุงุนุฉ : ( <span id="tAbsTo" class="timebox empty" contenteditable="true" data-mask>--:--</span> ).
                  <span class="calc">โ ูุฏุฉ ุนุฏู ุงูุชูุงุฌุฏ: <span id="absTotal">0 ุฏูููุฉ</span> (<span id="absHH">00:00</span> ุณ)</span>
                </span>
              </label>

              <label id="lineEarly" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  ุงูุตุฑุงููู ูุจูุฑูุง ูุจู ููุงูุฉ ุงูุนูู ูู ุงูุณุงุนุฉ : ( <span id="tEarlyFrom" class="timebox empty" contenteditable="true" data-mask>--:--</span> ).
                  <span class="calc">โ ูุฏุฉ ุงูุงูุตุฑุงู ุงููุจูุฑ: <span id="earlyTotal">0 ุฏูููุฉ</span> (<span id="earlyHH">00:00</span> ุณ)</span>
                </span>
              </label>
            </div>

            <p>ุนููู ูุฃูู ุชูุถูุญ ุฃุณุจุงุจ ุฐูู ูุน ุฅุฑูุงู ูุง ูุคูุฏ ุนุฐุฑูู โฆ ูููู ุชุญูุงุชูุง.</p>
            <p style="margin-top:6px"><strong>ูุฏูุฑ ุงููุฏุฑุณุฉ :</strong> <span>ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</span>
              &nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> <span class="dotfield" style="min-width:26mm"></span>
              &nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> <span class="dotfield" style="min-width:20mm"></span></p>
          </div>

          <!-- (2) ุฅูุงุฏุฉ ุงููุนูู โ ุณุทุฑุงู ููุท -->
          <div id="affidavitPack" class="sec">
            <h3>( 2 ) ุฅูุงุฏุฉ ุงููุนูู</h3>
            <p>ุฃูููุฏูู ุจุฃู ุณุจุจ <span id="affKind">ุงูุชุฃุฎุฑ</span> ุงูููุถูุญ ุฃุนูุงู ูู:</p>
            <div class="lines"><div></div><div></div></div>
            <p style="margin-top:6px">
              <strong>ุงุณู ุงููุนูู :</strong> <span id="affTeacher">โ</span>
              &nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> ____________________
              &nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> ______ / ______ / ______
            </p>
          </div>

          <!-- (3) ุฑุฃู ูุฏูุฑ ุงููุฏุฑุณุฉ -->
          <div id="principalPack" class="sec">
            <h3>( 3 ) ุฑุฃู ูุฏูุฑ ุงููุฏุฑุณุฉ</h3>
            <label class="checkline"><input type="checkbox"> ุชูู ุชูุจูู ุงูููุธู ุดููููุง ุจุงูุฃุฎุฐ ุจุฃุณุจุงุจ ุงูุงูุถุจุงุท.</label>
            <label class="checkline"><input type="checkbox"> ูููุชูู ุจูุฐุง ุงูุชูุจูู ูุน ุงููุชุงุจุนุฉ ุฎูุงู ุงููุชุฑุฉ ุงููุงุฏูุฉ.</label>
            <label class="checkline"><input type="checkbox"> ููุฑูุน ูุฌูุฉ ุงูุงุฎุชุตุงุต ุนูุฏ ุชูุฑุงุฑ ุงููุฎุงููุฉ.</label>
            <p style="margin-top:6px">
              <strong>ุงุณู ุงููุฏูุฑ :</strong> <span>ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</span>
              &nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> ____________________
              &nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> ______ / ______ / ______
            </p>
          </div>

          <!-- ูุณุงุกูุฉ ุงูุบูุงุจ -->
          <div id="absencePack" class="sec" style="display:none">
            <p>ุฅูู ูู ููู <strong><span id="absDayP">โ</span></strong>
              ุงูููุงูู <strong><span id="absDateYMD">โ</span></strong> ุชุบูุจุช ุนู ุงูุนูู.</p>

            <h3>( 1 ) ุทูุจ ุงูุฅูุงุฏุฉ</h3>
            <p><strong>ุงูููุฑู /</strong> <span id="abs-name-top">โ</span> <span>ูููู ุงููู</span></p>
            <p><strong>ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชูุ ูุจุนุฏ ุุุ</strong></p>
            <p>ูู ุฎูุงู ูุชุงุจุนุฉ ุณุฌู ุงูุฏูุงู ุชุจูู ุบูุงุจูู ุฎูุงู ุงููุชุฑุฉ ุงูููุถุญุฉ ุจุนุงููุฉุ ุขูู ุงูุฅูุงุฏุฉ ุนู ุณุจุจ ุฐูู
              ูุชูุฏูู ูุง ูุคูุฏ ุนุฐุฑูู ุฎูุงู ุฃุณุจูุน ูู ุชุงุฑูุฎูุ ุนููุงู ุจุฃูู ูู ุญุงูุฉ ุนุฏู ุงูุงูุชุฒุงู ุณูุชู ุงุชุฎุงุฐ ุงููุงุฒู ุญุณุจ ุงูุชุนูููุงุช.</p>
            <p><strong>ุงุณู ุงูุฑุฆูุณ ุงููุจุงุดุฑ :</strong> <span>ููุฏ ุจู ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</span>
               &nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> ________ &nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> ______ / ______ / ______</p>

            <h3>( 2 ) ุงูุฅูุงุฏุฉ โ ุณุทุฑุงู ููุท</h3>
            <p><strong>ุงูููุฑู / ูุฏูุฑ ุงููุฏุฑุณุฉ</strong> ูููู ุงููู</p>
            <p><strong>ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชูุ ูุจุนุฏ ุุุ</strong></p>
            <p>ุฃููุฏูู ุฃู ุบูุงุจู ูุงู ููุฃุณุจุงุจ ุงูุชุงููุฉ:</p>
            <div class="lines dotted"><div></div><div></div></div>
            <p>ูุณุฃููู ุจุชูุฏูู ูุง ูุซุจุช ุฐูู ุฎูุงู ุฃุณุจูุน ูู ุชุงุฑูุฎู.</p>
            <p><strong>ุงุณู ุงููุนูู :</strong> <span id="abs-teacher-name">โ</span> &nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> ________ &nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> ______ / ______ / ______</p>

            <h3>( 3 ) ูุฏูุฑ ุงููุฏุฑุณุฉ</h3>
            <label><input type="checkbox"> ุชูุญุชุณุจ ูู ุฅุฌุงุฒุฉ ูุฑุถูุฉ ุจุนุฏ ุงูุชุฃูุฏ ูู ูุธุงููุฉ ุงูุชูุฑูุฑ.</label><br>
            <label><input type="checkbox"> ููุญุชุณุจ ุบูุงุจู ูู ุฑุตูุฏู ููุฅุฌุงุฒุงุช ุงูุฅุถุทุฑุงุฑูุฉ ููุจูู ุนุฐุฑู ุฅุฐุง ูุงู ุฑุตูุฏู ูุณูุญ ููุง ููุญุณู ุนููู.</label><br>
            <label><input type="checkbox"> ูุนุชูุฏ ุงูุญุณู ูุนุฏู ูุจูู ุนุฐุฑู.</label>

            <!-- ( 4 ) ุชูููุน ุงููุฏูุฑ โ ุชุณุญุจ ุฎูุงุฑุฒููุงู -->
            <div class="sec" id="principalSignPack" style="margin-top:6mm">
              <h3>( 4 ) ุชูููุน ุงููุฏูุฑ</h3>
              <p>
                <strong>ุงุณู ุงูุฑุฆูุณ ุงููุจุงุดุฑ :</strong> <span id="principalNameAbs">โ</span>
                &nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> <span id="principalSignAbs">____________________</span>
                &nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> <span id="principalDateAbs">โ</span>
              </p>
            </div>
          </div>

          <!-- ููุช ูุธุฑ -->
          <div id="notePack" class="sec" style="display:none">
            <h3>ูููุฐุฌ ููุช ูุธุฑ</h3>
            <p>ุงูุฃุณุชุงุฐ ุงููุงุถู/ <span id="noteTeacherName" style="font-weight:900">โ</span> ุญูุธู ุงููู</p>
            <p><strong>ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชูุ ูุจุนุฏ ุุุ</strong></p>
            <p>ูู ููู <span id="noteDay" style="font-weight:900;border-bottom:1px dotted #2f4f4c;padding:0 3mm">โ</span>
              ุงูููุงูู <span id="noteHijri" style="font-weight:900;border-bottom:1px dotted #2f4f4c;padding:0 3mm">โ</span></p>
            <p id="noteParagraph">
              ุฅุดุงุฑุฉู ุฅูู ุงูุชุนูููุงุช ูุงูุฃูุธูุฉ ุงููุนุชูุฏุฉ ูู ุงููุฏุฑุณุฉุ ููุญูุธ
              <span id="noteReasonText" style="font-weight:900">ุงููููุฉ ุงููุญุฏุฏุฉ</span>.
              ููุฃูู ูููู ุงููุจุงุฏุฑุฉ ุจูุนุงูุฌุฉ ุฐููุ ูุงูุงูุชุฒุงู ุงูุชุงู ุจูุง ููููู ุฅูููู ูู ููุงูุ ุฏุนููุง ููุงูุถุจุงุท ุงููููู ูุฑูุนูุง ูุฌูุฏุฉ ุงูุฃุฏุงุก.
            </p>
            <p><strong>ุชูููุน ุงูููุธู ุจุงูุงุทูุงุน:</strong> ............................... &nbsp;&nbsp; <strong>ุงูุงุณู:</strong> ............................... &nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ:</strong> ______ / ______ / 14</p>
            <p><strong>ุชูููุน ูุงุฆุฏ ุงููุฏุฑุณุฉ:</strong> ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</p>
          </div>

          <div class="footer-note"><span>ุชุญูุธ ูู ููู ุงููุชุงุจุนุฉ</span></div>

        </div>
      </div>
    </div>
  </main>
</div>

<!-- ูุงูุฐุฉ ุงูุฅุญุตุงุฆูุงุช -->
<div id="statsDlg" aria-hidden="true" style="display:none">
  <div class="stats-card" id="statsCard">
    <div class="stats-hdr">
      <img id="statsHdrImg" src="hhh.png" alt="ููุฏุฑ ุงูุฅุญุตุงุฆูุงุช" crossorigin="anonymous">
      <div class="stats-meta">
        <div class="rowB" id="statsDay">โ</div>
        <div class="rowB" id="statsHijri">โ</div>
      </div>
    </div>
    <div class="h">
      <div style="font-weight:900;color:#064b50">ููุฎุต ุงูุฅุญุตุงุฆูุงุช</div>
      <div class="stats-actions" style="display:flex;gap:6px">
        <button id="btnResetStats" class="btn ghost" title="ุชุตููุฑ ุงูุฃุฑุดูู">ุชุตููุฑ ุงูุฃุฑุดูู โป๏ธ</button>
        <button id="btnStatsPDF" class="btn primary" title="ุญูุธ/ุทุจุงุนุฉ">ุทุจุงุนุฉ / ุญูุธ</button>
        <button id="btnCloseStats" class="btn ghost">ุฅุบูุงู</button>
      </div>
    </div>
    <div style="padding:12px">
      <table id="tblStats" class="tbl2">
        <thead>
          <tr>
            <th>ุงููุนููู</th><th>ุงูููุน</th><th>ุงูููู</th><th>ุงูุชุงุฑูุฎ (ูู)</th><th>ุงูุนุฐุฑ</th><th>ูุงุฑุณ</th><th>ุชูุงุตูู</th><th>ุฅุฌุฑุงุก</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>
  </div>
</div>

<!-- ูุงูุฐุฉ ุนุฏูุงุฏ ุงูุณุงุนุฉ -->
<div id="clockDlg" aria-hidden="true">
  <div class="clock-card">
    <div class="h">
      <div style="font-weight:900;color:#064b50">ุชุญุฏูุฏ ุงูููุช</div>
      <button id="btnClockClose" class="btn ghost">ุฅุบูุงู</button>
    </div>
    <div class="b">
      <div class="clock-big" id="clockPreview">--:--</div>
      <div class="clock-row">
        <div class="col">
          <label style="font-weight:900;color:#03636a">ุงูุณุงุนุฉ</label>
          <input id="clockHour" type="range" min="0" max="23" step="1" value="7">
        </div>
        <div class="col">
          <label style="font-weight:900;color:#03636a">ุงูุฏูุงุฆู</label>
          <input id="clockMin" type="range" min="0" max="59" step="1" value="30">
        </div>
      </div>
      <div class="clock-actions">
        <button id="btnClockNow" class="btn ghost">ุงูุขู</button>
        <button id="btnClockOk" class="btn primary">ููุงูู</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ุฃุฑูุงู ุนุฑุจูุฉ/ุฅูุฌููุฒูุฉ */
const AR='ููกูขูฃูคูฅูฆูงูจูฉ', EN='0123456789';
const en2ar=s=>(''+s).replace(/[0-9]/g,d=>AR[d]);
const ar2en=s=>(''+s).replace(/[ู-ูฉ]/g,d=>EN[AR.indexOf(d)]);

/* ูุงุฆูุฉ ุงููุนูููู (ุงูุงุณู\tุงููููุฉ\tุงูุฌูุงู\tุงูุชุฎุตุต\tุงููุฑุชุจุฉ) */
const TEACHERS_CSV=`ููุณู ุตูุจุงู ุนุจุฏู ุนุณูุฑู	1093013116	966507058931	ููุฒูุง	ูุนูู ููุงุฑุณ
ูุจุงุฑู ุนูุถู ุณูุฑ ุขู ุซุงุจุช	1056464405	966597233399	ููููุง	ูุนูู ููุงุฑุณ
ูุฑุฌ ุนุจุฏุงูุนูู ููุณู ุงู ุณูู	1000397735	966504113707	ุงุญูุงุก	ูุนูู ููุงุฑุณ
ููุฐุฑ ุนุงูุฑ ุญููุฏ ุฒููุน	1065913053	966541188974	ุงูุฌููุฒู	ูุนูู ููุงุฑุณ
ุนูุงุฏ ูุญูุฏ ุฌูุนุงู ุงูุฒูุฑุงูู	1048667289	966542203039	ููุชุจุงุช	ูุนูู ููุงุฑุณ
ุงุจุฑุงููู ุญุจูุจ ุนุจุฏุงูุบูู ุงูููููู	1072815481	966530163027	ุฑูุงุถูุงุช	ูุนูู ููุงุฑุณ
ุจูุฏุฑ ุนุจุฏุงูุนุฒูุฒ ูุญูุฏ ุงูุบุงูุฏู	1046853881	966546135135	ุญุงุณุจ	ูุนูู ููุงุฑุณ
ุญุณูู ุจู ูุญูุฏ ุจู ููุฏ ุงููุญุทุงูู	1014268567	966504988086	ุงุญูุงุก	ูุนูู ููุงุฑุณ
ูุงุตุฑ ุนูู ูุงุตุฑ ุงูุฑุงุดุฏ	1008303370	966542933888	ุญุงุณุจ	ูุนูู ููุงุฑุณ
ุญุณูู ุจู ูุญูุฏ ุจู ุญุณูู ุงูุฃุญูุฏ	1060369202	966563740777	ุงููุบุฉ ุงูุนุฑุจูุฉ	ูุนูู ููุงุฑุณ
ุนูู ุณุนุฏ ุณุนูุฏ ุงูุงุตูุนู ุงูุงุญูุฑู	1023999780	966590986464	ุงุญูุงุก	ูุนูู ููุงุฑุณ
ูุญูุฏ ุญูุฏ ุนุจุฏุงูุฑุญูู ุงูุชููุฌุฑู	1064745944	966541381105	ุงููุบุฉ ุงูุนุฑุจูุฉ	ูุนูู ููุงุฑุณ
ุนุจุฏุงููู ููุตู ุจู ูุทูุณ ุงููุฐูู	1094733290	966591585407	ุฑูุงุถูุงุช	ูุนูู ููุงุฑุณ
ุงุญูุฏ ุนุจุฏุงูุฑุญูู ุนุจุฏุงูุญููุฏ ุงุจูุนุตูุฏู	1033584234	966546623431	ุงูุฌููุฒู	ูุนูู ููุงุฑุณ
ุนุจุฏุงููู ุจู ุนุจุฏุงูุนุฒูุฒ ุจู ุณูู ุงูุณููู	1063175010	966546221133	ุนูู ุงุฌุชูุงุน	ูุนูู ููุงุฑุณ
ุจุดูุฑ ุจู ุฃุญูุฏ ุจู ุนุจุฏุงููู ุขู ุณููู	1019783917	966500126925	ููุชุจุงุช	ูุนูู ููุงุฑุณ
ุงุจุฑุงููู ุจู ูุญูุฏ ุจู ุงุจุฑุงููู ุงูุฑุจูุน	1004182687	966548638056	ุงูุฌููุฒู	ูุนูู ููุงุฑุณ
ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู ุณุงูู ุขู ุญุจุดุงู	1004581359	966500223640	ุงุฌุชูุงุนูุงุช	ูุนูู ููุงุฑุณ
ููุตู ููุฏ ุนูู ุงูุฒูุฑุงูู	1086115373	966508448455	ุฑูุงุถูุงุช	ูุนูู ููุงุฑุณ
ุฒูุงุฏ ุนูุงุถ ุงุจู ุนูุถู ุงูุนูุฑู	1092156742	966557530102	ุนูู ุฅุฏุงุฑุฉ	ูุนูู ููุงุฑุณ
ุนุจุฏุงูุฑุญูู ุนุจุฏุงูุฌุจุงุฑ ุญููุฏ ุงูุนุชูุจู	1089635724	966555741488	ููุฒูุง	ูุนูู ููุงุฑุณ
ุนุจุฏ ุงููู ุญุณู ุนูุฑ ุงูุงุฏุฑูุณู	1081556910	966533025505	ุฑูุงุถูุงุช	ูุนูู ููุงุฑุณ
ุชูู ุนุจุฏ ุงููุงุฏู ุชูู ุงูุนูู	1026472363	966543219321	ููููุง	ูุนูู ููุงุฑุณ
ุตุงูุญ ุจู ูุญูุฏ ุจู ุตุงูุญ ุงูุณููุญู	1003535422	966506921115	ุฏูู	ูุนูู ููุงุฑุณ
ุนุงุฏู ุจู ุนูู ุจู ุณูููุงู ุงูุณุจุนุงู	1005472780	966504836200	ููุฌู ุทูุงุจู	ูุนูู ููุงุฑุณ
ูุงุณุฑ ุนุจุฏุงููู ูุญูุฏ ุงูููุฑ	1001443397	966543705512	ูุฏุฎู ุจูุงูุงุช	ูุณุงุนุฏ ูุนูู
ุนูู ุจู ุญุณู ุจู ุนูู ุขู ููุจุฑ	1004780860	966502085389	ุณูุฑุชุงุฑูู	ูุณุงุนุฏ ูุนูู
ุญุณู ุจู ุนุงูุฑุจู ุงุญูุฏ ุงูุดูุฑู	1013124175	966598893731	ูุญุถุฑ ูุฎุชุจุฑ	ูุณุงุนุฏ ูุนูู
ุนุฏูุงู ุนูู ุญุณูู ุงูุฒุฑูู	1015776766	966505808451	ูููู	ูุนูู ููุงุฑุณ
ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู	1024193532	966504532489	ูุฏูุฑ ุงููุฏุฑุณุฉ	ูุนูู ููุงุฑุณ`;

function parseTeachersCSV(csv){
  return csv.trim().split(/\r?\n/).map(line=>{
    const parts=line.split(/\t+/);
    const [name,civil,phone,spec,level]=[parts[0]||'',parts[1]||'',parts[2]||'',parts[3]||'',parts[4]||''];
    return {name:name.trim(), civil:(civil||'').trim(), phone:(phone||'').replace(/[^\d]/g,''), spec:spec.trim(), level:level.trim(), job:'', work:'ูุนูู'};
  }).filter(r=>r.name);
}
const TEACHERS=parseTeachersCSV(TEACHERS_CSV);

/* ุชุนุจุฆุฉ ูุงุฆูุฉ ุงููุนูููู */
const selTeacher=document.getElementById('selTeacher');
function fillTeachers(){ selTeacher.innerHTML='<option value="">โ ุงุฎุชุฑ ูุนููุงู โ</option>'; TEACHERS.forEach((t,i)=>selTeacher.add(new Option(t.name,i))) }
fillTeachers();

/* ุญุงูุฉ ุนุงูุฉ + ุฃุฑุดูู */
let STATE={kind:'late',excuse:'without',accept:'rejected',faris:''}; // faris ููุณุชุฎุฏู ููุท ููุบูุงุจ
const KEY_ARCH='followup_archive_v10';
let ARCH=JSON.parse(localStorage.getItem(KEY_ARCH)||'[]');
function saveARCH(){ localStorage.setItem(KEY_ARCH, JSON.stringify(ARCH)); }
function clearARCH(){ ARCH=[]; saveARCH(); }
function nextSerialFor(civil){ const n=ARCH.filter(e=>e.civil===civil).length+1; return en2ar(String(n).padStart(2,'0')); }

/* ุนูุงุตุฑ ุฃูุณุงู */
const alertPack=document.getElementById('alertPack');
const absencePack=document.getElementById('absencePack');
const notePack=document.getElementById('notePack');
const lineLate=document.getElementById('lineLate');
const lineAbs=document.getElementById('lineAbs');
const lineEarly=document.getElementById('lineEarly');
const kindTitle=document.getElementById('kindTitle');
const statsDlg=document.getElementById('statsDlg');

/* ูุทุงู ุฏูุงู + ูุญููู ุงูููุณู */
const WORK={ winter:{start:'06:45',end:'13:45',label:'ุงูุดุชูู (06:45โ13:45)'}, summer:{start:'07:00',end:'14:00',label:'ุงูุตููู (07:00โ14:00)'} };
let SEASON='winter';
document.getElementById('seasonChips').addEventListener('click',e=>{
  const b=e.target.closest('.chip'); if(!b) return;
  [...e.currentTarget.children].forEach(x=>x.classList.remove('active')); b.classList.add('active');
  SEASON=b.dataset.season; recalc();
});

/* ููุน ุงูุฅุฌุฑุงุก + ุงูุชุญูู ุจูุงุฑุณ */
function setPack(kind){
  STATE.kind=kind;
  document.getElementById('mainTitle').textContent=({late:'ุชูุจูู',absent:'ุชูุจูู',early:'ุชูุจูู',gaib:'ูุณุงุกูุฉ ุบูุงุจ',note:'ููุช ูุธุฑ'})[kind];
  alertPack.style.display=(kind==='gaib'||kind==='note')?'none':'';
  document.getElementById('affidavitPack').style.display=(kind==='gaib'||kind==='note')?'none':'';
  document.getElementById('principalPack').style.display=(kind==='gaib'||kind==='note')?'none':'';
  absencePack.style.display=(kind==='gaib')?'':'none';
  notePack.style.display=(kind==='note')?'':'none';
  lineLate.style.display=(kind==='late')?'':'none';
  lineAbs.style.display=(kind==='absent')?'':'none';
  lineEarly.style.display=(kind==='early')?'':'none';
  kindTitle.textContent=({late:'ุชุฃุฎุฑ',absent:'ุนุฏู ุชูุงุฌุฏ',early:'ุงูุตุฑุงู ูุจูุฑ'})[kind]||'โ';
  document.getElementById('affKind').textContent=({late:'ุงูุชุฃุฎุฑ',absent:'ุนุฏู ุงูุชูุงุฌุฏ',early:'ุงูุงูุตุฑุงู ุงููุจูุฑ'})[kind]||'ุงููุฎุงููุฉ';

  // ุชูุนูู/ุชุนุทูู ูุงุฑุณ: ููุท ููุณุงุกูุฉ ุงูุบูุงุจ
  const frF=document.getElementById('frGroup').parentElement; // .f
  if(kind==='gaib'){ frF.classList.remove('disabled'); if(!STATE.faris) STATE.faris='not'; }
  else { frF.classList.add('disabled'); STATE.faris=''; }

  updUnifiedText();
  if(kind==='gaib') updatePrincipalAbs(); // ุชุนุจุฆุฉ ุชูููุน ุงููุฏูุฑ ูู ูููุฐุฌ ุงููุณุงุกูุฉ
}
document.getElementById('kindChips').addEventListener('click',e=>{
  const b=e.target.closest('.chip'); if(!b) return;
  [...e.currentTarget.children].forEach(x=>x.classList.remove('active')); b.classList.add('active');
  setPack(b.dataset.k); recalc();
});

/* ุงูููุญูุฏ: ุงูุนุฐุฑ/ุงููุจูู/ูุงุฑุณ */
const unifiedPanel=document.getElementById('unifiedPanel'), unifiedText=document.getElementById('unifiedText');
document.getElementById('btnUnified').onclick=()=> unifiedPanel.style.display=unifiedPanel.style.display?'':'block';
unifiedPanel.addEventListener('click',e=>{
  const c=e.target.closest('.chip'); if(!c) return;
  if(c.dataset.exc){
    c.parentElement.querySelectorAll('[data-exc]').forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); STATE.excuse=c.dataset.exc;
  }
  if(c.dataset.acc){
    c.parentElement.querySelectorAll('[data-acc]').forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); STATE.accept=c.dataset.acc;
  }
  if(c.dataset.fr && STATE.kind==='gaib'){
    c.parentElement.querySelectorAll('[data-fr]').forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); STATE.faris=c.dataset.fr;
  }
  updUnifiedText();
});
function updUnifiedText(){
  const excTxt = (STATE.excuse==='with')?'ุจุนุฐุฑ':'ุจุฏูู ุนุฐุฑ';
  const frTxt  = (STATE.kind==='gaib') ? (' โข ูุงุฑุณ: ' + (STATE.faris==='raised'?'ูุฑููุน':'ูู ููุฑูุน')) : '';
  unifiedText.textContent = excTxt + frTxt;
}

/* ุงูุชุงุฑูุฎ: ูุฌุฑู/ูููุงุฏู */
let CAL_MODE='h';
const pickHijri=document.getElementById('pickHijri'), pickGreg=document.getElementById('pickGreg');
document.getElementById('btnCalToggle').onclick=()=>{
  CAL_MODE=CAL_MODE==='h'?'g':'h';
  document.getElementById('btnCalToggle').textContent=(CAL_MODE==='h'?'๐๏ธ ูุฌุฑู':'๐๏ธ ูููุงุฏู');
  pickHijri.style.display=CAL_MODE==='h'?'flex':'none';
  pickGreg.style.display=CAL_MODE==='g'?'flex':'none';
  if(CAL_MODE==='h') syncFromHijri(); else syncFromGregInputs();
};
function hijriToGregorian(y,m,d){
  let lo=new Date(1937,0,1), hi=new Date(2077,11,31);
  const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'numeric',day:'numeric'});
  const parts=dt=>{const p=fmt.formatToParts(dt);return{y:+ar2en(p.find(x=>x.type==='year').value),m:+ar2en(p.find(x=>x.type==='month').value),d:+ar2en(p.find(x=>x.type==='day').value)}};
  while(lo<=hi){const mid=new Date((lo.getTime()+hi.getTime())/2),v=parts(mid);
    if(v.y===y&&v.m===m&&v.d===d) return new Date(mid.getFullYear(),mid.getMonth(),mid.getDate());
    if(v.y<y||(v.y===y&&v.m<m)||(v.y===y&&v.m===m&&v.d<d)) lo=new Date(mid.getFullYear(),mid.getMonth(),mid.getDate()+1);
    else hi=new Date(mid.getFullYear(),mid.getMonth(),mid.getDate()-1);}
  return new Date();
}
function buildHijriPicker(){
  const y=document.getElementById('hY'),m=document.getElementById('hM'),d=document.getElementById('hD');
  y.innerHTML=m.innerHTML=d.innerHTML='';
  const now=new Date(); const currAH=parseInt(ar2en(new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric'}).format(now)),10);
  for(let i=currAH-1;i<=currAH+1;i++) y.add(new Option(en2ar(i),i));
  for(let i=1;i<=12;i++) m.add(new Option(en2ar(String(i).padStart(2,'0')),i));
  for(let i=1;i<=30;i++) d.add(new Option(en2ar(String(i).padStart(2,'0')),i));
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
  d.value=+ar2en(parts.find(p=>p.type==='day').value);
  m.value=+ar2en(parts.find(p=>p.type==='month').value);
  y.value=+ar2en(parts.find(p=>p.type==='year').value);
  y.onchange=m.onchange=d.onchange=syncFromHijri; syncFromHijri();
}
function syncFromHijri(){
  const y=+hY.value, m=+hM.value, d=+hD.value;
  const g=hijriToGregorian(y,m,d);
  const dayName=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(g);
  const hij=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).format(g);
  metaDay.textContent=dayName; metaHijri.textContent=hij;
  dynDay.textContent=dayName; dynHijri.textContent=hij;
  noteDay.textContent=dayName; noteHijri.textContent=hij;
  document.getElementById('affTeacher').textContent=document.getElementById('t_name').textContent||'โ';
  document.getElementById('absDayP').textContent=dayName;
  document.getElementById('absDateYMD').textContent=hij;
  document.getElementById('statsDay').textContent=dayName;
  document.getElementById('statsHijri').textContent=hij;
  updatePrincipalAbs(); // ุชุญุฏูุซ ุชุงุฑูุฎ ุชูููุน ุงููุฏูุฑ ูู ุงููุณุงุกูุฉ
}
['gY','gM','gD'].forEach(id=>document.getElementById(id).addEventListener('input',syncFromGregInputs));
function syncFromGregInputs(){
  const y=+gY.value||new Date().getFullYear(), m=+gM.value||new Date().getMonth()+1, d=+gD.value||new Date().getDate();
  const g=new Date(y,m-1,d);
  const dayName=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(g);
  const hij=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).format(g);
  metaDay.textContent=dayName; metaHijri.textContent=hij;
  dynDay.textContent=dayName; dynHijri.textContent=hij;
  noteDay.textContent=dayName; noteHijri.textContent=hij;
  document.getElementById('affTeacher').textContent=document.getElementById('t_name').textContent||'โ';
  document.getElementById('absDayP').textContent=dayName;
  document.getElementById('absDateYMD').textContent=hij;
  document.getElementById('statsDay').textContent=dayName;
  document.getElementById('statsHijri').textContent=hij;
  updatePrincipalAbs(); // ุชุญุฏูุซ ุชุงุฑูุฎ ุชูููุน ุงููุฏูุฑ ูู ุงููุณุงุกูุฉ
}

/* ุชุญูููุงุช ุงูููุช ูุงูุญุณุงุจ */
function toMin(hhmm){ const m=/^(\d{1,2}):(\d{2})$/.exec(ar2en(hhmm||'')); if(!m) return null; const h=+m[1], mi=+m[2]; if(h>23||mi>59) return null; return h*60+mi; }
function fmtHM(mins){ const h=Math.floor(mins/60), m=mins%60; return en2ar(String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')); }
const WORK_RANGE={winter:{start:'06:45',end:'13:45'},summer:{start:'07:00',end:'14:00'}};

/* ููุงุน ุงูุฅุฏุฎุงู + ูุชุญ ุนุฏูุงุฏ ุงูุณุงุนุฉ */
function attachTimeMask(el){
  el.addEventListener('beforeinput',(e)=>{ if(e.inputType==='insertText'){ const ch=e.data; if(!(/[0-9ู-ูฉ:]/.test(ch))) e.preventDefault(); }});
  el.addEventListener('input', ()=>{
    let v=el.textContent.replace(/[^0-9ู-ูฉ]/g,''); v=ar2en(v);
    if(v.length>=3){ v=v.slice(0,4).padEnd(4,'0'); v=v.slice(0,2)+':'+v.slice(2,4);} else if(v.length>0){ v=v.padEnd(2,'0'); }
    el.textContent=en2ar(v.length?v:'--:--'); if(el.textContent.includes(':')) el.classList.remove('empty'); placeCaretAtEnd(el); recalc();
  });
  el.addEventListener('blur', ()=>{ const m=toMin(el.textContent); if(m==null){ el.textContent='--:--'; el.classList.add('empty'); } else { el.textContent=fmtHM(m); el.classList.remove('empty'); } recalc(); });
  el.addEventListener('click', ()=> openClock(el));
}
function placeCaretAtEnd(el){ const r=document.createRange(); r.selectNodeContents(el); r.collapse(false); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); }
['tLateIn','tAbsFrom','tAbsTo','tEarlyFrom'].forEach(id=>attachTimeMask(document.getElementById(id)));

/* ุนุฏูุงุฏ ุงูุณุงุนุฉ */
let CLOCK_TARGET=null;
const clockDlg=document.getElementById('clockDlg');
const clockHour=document.getElementById('clockHour');
const clockMin=document.getElementById('clockMin');
const clockPreview=document.getElementById('clockPreview');
function showClock(){ clockDlg.style.display='flex'; clockDlg.setAttribute('aria-hidden','false'); }
function hideClock(){ clockDlg.style.display='none'; clockDlg.setAttribute('aria-hidden','true'); CLOCK_TARGET=null; }
function updClockPreview(){ clockPreview.textContent=en2ar(String(clockHour.value).padStart(2,'0')+':'+String(clockMin.value).padStart(2,'0')); }
function openClock(target){
  CLOCK_TARGET=target;
  const cur=toMin(target.textContent); const now=new Date();
  const h=(cur!=null)?Math.floor(cur/60):now.getHours();
  const m=(cur!=null)?(cur%60):now.getMinutes();
  clockHour.value=h; clockMin.value=m; updClockPreview(); showClock();
}
clockHour.addEventListener('input',updClockPreview);
clockMin.addEventListener('input',updClockPreview);
document.getElementById('btnClockNow').onclick=()=>{ const now=new Date(); clockHour.value=now.getHours(); clockMin.value=now.getMinutes(); updClockPreview(); };
document.getElementById('btnClockOk').onclick=()=>{ if(!CLOCK_TARGET) return; const m=+clockMin.value, h=+clockHour.value; CLOCK_TARGET.textContent=en2ar(String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')); CLOCK_TARGET.classList.remove('empty'); hideClock(); recalc(); };
document.getElementById('btnClockClose').onclick=hideClock;
clockDlg.addEventListener('click',(e)=>{ if(e.target===clockDlg) hideClock(); });

/* ุฅุนุงุฏุฉ ุงูุญุณุงุจ */
function recalc(){
  const wsM=toMin(WORK_RANGE[SEASON].start), weM=toMin(WORK_RANGE[SEASON].end);
  const tLate=document.getElementById('tLateIn').textContent.trim(); const tLateM=toMin(tLate);
  if(tLateM!=null&&wsM!=null&&tLateM>wsM){ const mins=tLateM-wsM; lateTotal.textContent=en2ar(mins)+' ุฏูููุฉ'; lateHH.textContent=fmtHM(mins); } else { lateTotal.textContent='0 ุฏูููุฉ'; lateHH.textContent='00:00'; }
  const aF=document.getElementById('tAbsFrom').textContent.trim(), aT=document.getElementById('tAbsTo').textContent.trim();
  const aFM=toMin(aF), aTM=toMin(aT);
  if(aFM!=null&&aTM!=null&&aTM>aFM){ const mins=aTM-aFM; absTotal.textContent=en2ar(mins)+' ุฏูููุฉ'; absHH.textContent=fmtHM(mins);} else { absTotal.textContent='0 ุฏูููุฉ'; absHH.textContent='00:00'; }
  const eF=document.getElementById('tEarlyFrom').textContent.trim(); const eFM=toMin(eF);
  if(eFM!=null&&weM!=null&&weM>eFM){ const mins=weM-eFM; earlyTotal.textContent=en2ar(mins)+' ุฏูููุฉ'; earlyHH.textContent=fmtHM(mins);} else { earlyTotal.textContent='0 ุฏูููุฉ'; earlyHH.textContent='00:00'; }
}

/* ุณุจุจ ููุช ุงููุธุฑ */
document.getElementById('noteReason').addEventListener('change', e=>{
  document.getElementById('noteReasonText').textContent=e.target.value||'ุงููููุฉ ุงููุญุฏุฏุฉ';
});

/* ุชุทุจูู ุจูุงูุงุช ุงููุนูู + ุงูุฑูู */
selTeacher.addEventListener('change',e=>{
  const i=+e.target.value; const t=Number.isInteger(i)?TEACHERS[i]:null; if(!t) return;
  t_name.textContent=t.name||'โ'; t_spec.textContent=t.spec||'โ'; t_level.textContent=t.level||'โ';
  t_job.textContent=t.job||'โ'; t_work.textContent=t.work||'โ'; t_civil.textContent=t.civil||'โ';
  teacherNameInline.textContent=t.name||'โ'; noteTeacherName.textContent=t.name||'โ'; document.getElementById('affTeacher').textContent=t.name||'โ';
  document.getElementById('abs-name-top').textContent=t.name||'โ'; document.getElementById('abs-teacher-name').textContent=t.name||'โ';
  metaNo.textContent=nextSerialFor(t.civil);
  updatePrincipalAbs(); // ุนูุฏ ุชุบููุฑ ุงููุนูู ุฃูุถุงู
});

/* ูุงุชุณุงุจ */
document.getElementById('btnWA').addEventListener('click', ()=>{
  const i=+selTeacher.value; if(!Number.isInteger(i)) return alert('ุงุฎุชุฑ ูุนููุงู ุฃููุงู');
  const t=TEACHERS[i]; const kind=STATE.kind;
  const kindLabel={late:'ุชูุจูู ุชุฃุฎุฑ',absent:'ุชูุจูู ุนุฏู ุชูุงุฌุฏ',early:'ุชูุจูู ุงูุตุฑุงู ูุจูุฑ',gaib:'ูุณุงุกูุฉ ุบูุงุจ',note:'ููุช ูุธุฑ'}[kind];
  let details='';
  if(kind==='late'){ details=`ุชุฃุฎูุฑ ุนู ุจุฏุงูุฉ ุงูุฏูุงูุ ูููุช ุงูุญุถูุฑ: ${document.getElementById('tLateIn').textContent.trim()}ุ ูุฃูู ูุนุงูุฌุฉ ุงูุณุจุจ ูุงูุงูุชุฒุงู ุจููุงุนูุฏ ุงูุนูู.`; }
  else if(kind==='absent'){ details=`ุนุฏู ุชูุงุฌุฏ ุฎูุงู ุณุงุนุงุช ุงูุฏูุงูุ ูุฃูู ุฅูุถุงุญ ุงูุณุจุจ ูุฅุฑูุงู ูุง ูุคูุฏู.`; }
  else if(kind==='early'){ details=`ุงูุตุฑุงู ูุจู ููุงูุฉ ุงูุฏูุงูุ ูุฃูู ุงูุงูุชุฒุงู ุจุงูููุช ุงูุฑุณูู.`; }
  else if(kind==='gaib'){ details=`ุชู ุชุณุฌูู ูุณุงุกูุฉ ุบูุงุจ ููููู ุงูููุถูุญ.`; }
  else if(kind==='note'){ details=`ููุช ูุธุฑ ุจุณุจุจ: ${document.getElementById('noteReasonText').textContent.trim()}`; }
  const msg=`ุงูุณูุงู ุนูููู
${kindLabel}
ุงูุงุณู: ${t.name}
ุงูููู: ${metaDay.textContent}
ุงูุชุงุฑูุฎ (ูู): ${metaHijri.textContent}
${details}
*ูุธุงู ุงูุดุคูู ุงูุฅุฏุงุฑูุฉ ูุงููุชุงุจุนุฉ*`;
  window.open(`https://wa.me/${t.phone||'966500000000'}?text=${encodeURIComponent(msg)}`,'_blank');
});

/* ุชุถููู ุงูุตูุฑ ูุธููุฑ ุงูููุฏุฑ */
async function embedImageToDataURL(imgEl){
  try{
    const src=imgEl.getAttribute('src')||''; if(!src) return;
    const u=src.match(/^data:/)? src : encodeURI(src);
    const resp=await fetch(u,{mode:'cors',cache:'no-store'}); if(!resp.ok) return;
    const blob=await resp.blob(); const reader=new FileReader();
    await new Promise(res=>{ reader.onload=()=>{ imgEl.src=reader.result; res(); }; reader.readAsDataURL(blob); });
  }catch(e){}
}
async function ensureAllImagesEmbedded(root){
  const imgs=[...root.querySelectorAll('img')];
  for(const im of imgs){ if(!im.src.startsWith('data:')) await embedImageToDataURL(im); }
}

/* ุทุจุงุนุฉ/ุญูุธ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ */
document.getElementById('btnPrintSave').addEventListener('click', async function(){
  const i=+selTeacher.value;
  if(!Number.isInteger(i)) { alert('ุงุฎุชุฑ ูุนููุงู ุฃููุงู'); return; }
  const t=TEACHERS[i];

  // ุญูุธ ูู ุงูุฃุฑุดูู โ ูุงุฑุณ ููุท ููุบูุงุจ
  ARCH.push({
    ts:Date.now(), civil:t.civil, name:t.name, kind:STATE.kind,
    excuse:STATE.excuse, accept:STATE.accept,
    faris:(STATE.kind==='gaib'? (STATE.faris||'not') : ''), // ููุท ูุณุงุกูุฉ ุบูุงุจ
    hijri:metaHijri.textContent, day:metaDay.textContent
  });
  saveARCH();

  const btn=this; const old=btn.textContent; btn.disabled=true; btn.textContent='ุฌุงุฑู ุงูุญูุธ ูุงูุทุจุงุนุฉ...';
  try{
    const { jsPDF }=window.jspdf;
    const sheet=document.getElementById('sheet');
    await ensureAllImagesEmbedded(sheet);
    const canvas=await html2canvas(sheet,{ scale:2, background:'#fff', useCORS:true, allowTaint:false, imageTimeout:0, logging:false });
    const pdf=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
    const w=210,h=canvas.height*210/canvas.width;
    pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,w,h);
    pdf.save(`ุฅุฌุฑุงุก - ${t.name}.pdf`);
    setTimeout(()=>window.print(), 250);
  }catch(err){ alert('ุชุนุฐูุฑ ุชูููุฐ ุงูุนูููุฉ: '+(err.message||err)); }
  finally{ btn.disabled=false; btn.textContent=old; }
});

/* PDF/ุทุจุงุนุฉ ุงูุฅุญุตุงุฆูุงุช */
document.getElementById('btnStatsPDF').onclick=async()=>{
  await ensureAllImagesEmbedded(document.getElementById('statsCard'));
  setTimeout(()=>window.print(),50);
};

/* ุฅุบูุงู ูุงูุฐุฉ ุงูุฅุญุตุงุฆูุงุช */
document.getElementById('btnCloseStats').onclick=()=>{
  statsDlg.style.display='none';
  statsDlg.setAttribute('aria-hidden','true');
};

/* ุฅุญุตุงุฆูุงุช + ุญุฐู ุตู + ุชุตููุฑ */
document.getElementById('btnStats').onclick=openStats;
document.getElementById('btnResetStats').onclick=()=>{
  if(confirm('ุชุฃููุฏ: ูู ุชุฑูุฏ ุชุตููุฑ ุงูุฃุฑุดูู ูุงูููุงุ')){
    clearARCH(); openStats();
  }
};

/* ูุณุงุนุฏ ูุชูุงุตูู ูุตูุฑุฉ */
function shortDetails(r){
  if(r.kind==='late'){ const txt=document.getElementById('lateTotal')?.textContent||'0 ุฏูููุฉ'; return `ุชุฃุฎุฑ ${txt.replace(/[^\dู-ูฉ]/g,'').trim()}ุฏ`; }
  if(r.kind==='absent'){ const a=document.getElementById('absTotal')?.textContent||'0 ุฏูููุฉ'; return `ุนุฏู ุชูุงุฌุฏ ${a.replace(/[^\dู-ูฉ]/g,'').trim()}ุฏ`; }
  if(r.kind==='early'){ const e=document.getElementById('earlyTotal')?.textContent||'0 ุฏูููุฉ'; return `ุงูุตุฑุงู ${e.replace(/[^\dู-ูฉ]/g,'').trim()}ุฏ`; }
  if(r.kind==='gaib'){ return `ุบูุงุจ`; }
  if(r.kind==='note'){ const rs=document.getElementById('noteReasonText')?.textContent||'โ'; return `ููุช ูุธุฑ โ ${rs}`; }
  return 'โ';
}

/* ุจูุงุก ุฌุฏูู ุงูุฅุญุตุงุฆูุงุช โ ูุงุฑุณ ูุธูุฑ ููุท ููุบูุงุจุ ูุงูุนุฐุฑ ูุงุญุฏุฉ (ุจุนุฐุฑ/ุจุฏูู) */
function openStats(){
  const tb=document.querySelector('#tblStats tbody'); tb.innerHTML='';
  const byTeacher=new Map();
  ARCH.forEach(r=>{
    const k=r.civil||r.name;
    if(!byTeacher.has(k)) byTeacher.set(k,{name:r.name,rows:[]});
    byTeacher.get(k).rows.push(r);
  });

  for(const {name,rows} of byTeacher.values()){
    rows.sort((a,b)=>a.ts-b.ts);
    rows.forEach((r,idx)=>{
      const tr=document.createElement('tr');
      if(idx===0){
        const td=document.createElement('td');
        td.rowSpan=rows.length; td.style.fontWeight='900'; td.textContent=name;
        tr.appendChild(td);
      }
      tr.innerHTML += `
        <td>${({late:'ุชูุจูู ุชุฃุฎุฑ',absent:'ุชูุจูู ุนุฏู ุชูุงุฌุฏ',early:'ุชูุจูู ุงูุตุฑุงู ูุจูุฑ',gaib:'ูุณุงุกูุฉ ุบูุงุจ',note:'ููุช ูุธุฑ'})[r.kind]}</td>
        <td>${r.day}</td>
        <td>${r.hijri}</td>
        <td>${r.excuse==='with'?'ุจุนุฐุฑ':'ุจุฏูู ุนุฐุฑ'}</td>
        <td>${r.kind==='gaib' ? ((r.faris==='raised')?'ูุฑููุน':'ูู ููุฑูุน') : ''}</td>
        <td>${shortDetails(r)}</td>
        <td><button class="btn ghost delRow" data-ts="${r.ts}" title="ุญุฐู ูุฐุง ุงูุณุฌู">ุญุฐู</button></td>`;
      tb.appendChild(tr);
    });
  }

  // ุฅุธูุงุฑ ุงููุงูุฐุฉ + ุชุญุฏูุซ ุงูููุฏุฑ
  statsDlg.style.display='flex';
  statsDlg.setAttribute('aria-hidden','false');
  document.getElementById('statsDay').textContent=document.getElementById('metaDay').textContent;
  document.getElementById('statsHijri').textContent=document.getElementById('metaHijri').textContent;

  // ุถูุงู ุชุถููู ุตูุฑุฉ ุงูููุฏุฑ ููุฅุญุตุงุฆูุงุช ุญุชู ุชูุทุจุน ูุชุธูุฑ ููุชูุฆุฉ
  ensureAllImagesEmbedded(document.getElementById('statsCard'));
}

/* ุญุฐู ุตู ูู ุงูุฃุฑุดูู */
document.getElementById('tblStats').addEventListener('click', (e)=>{
  const btn=e.target.closest('.delRow'); if(!btn) return;
  const ts=+btn.dataset.ts;
  if(!Number.isFinite(ts)) return;
  if(confirm('ุชุฃููุฏ ุญุฐู ูุฐุง ุงูุณุฌูุ')){
    const idx=ARCH.findIndex(r=>r.ts===ts);
    if(idx>-1){ ARCH.splice(idx,1); saveARCH(); openStats(); }
  }
});

/* ุชุนุจุฆุฉ ุชูููุน ุงููุฏูุฑ ูู ูููุฐุฌ ุงููุณุงุกูุฉ โ ุฎูุงุฑุฒููุงู */
const PRINCIPAL_NAME='ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู';
function updatePrincipalAbs(){
  const nameEl=document.getElementById('principalNameAbs');
  const signEl=document.getElementById('principalSignAbs');
  const dateEl=document.getElementById('principalDateAbs');
  if(!nameEl||!dateEl||!signEl) return;
  nameEl.textContent=PRINCIPAL_NAME;
  signEl.textContent='____________________';
  dateEl.textContent=document.getElementById('metaHijri').textContent||'โ';
}

/* ุชููุฆุฉ */
function init(){
  buildHijriPicker();
  setPack('late');
  document.getElementById('sidebar').style.pointerEvents='auto';
  statsDlg.style.display='none';
  document.getElementById('clockDlg').style.display='none';
  updatePrincipalAbs();
}
init();
</script>
</body>
</html>
