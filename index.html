<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ุงูุดุคูู ุงูุฅุฏุงุฑูุฉ ูุงููุชุงุจุนุฉ</title>
<meta name="theme-color" content="#0b7e88">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">

<!-- ููุชุจุงุช -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --moe:#0b7e88; --ink:#111; --label:#064c50;
  --bg:#f7fafc; --content:190mm; --nudgeX:0mm; --scale:1;
}
*{box-sizing:border-box}
html,body{
  margin:0;background:var(--bg);color:var(--ink);
  font:13.8px/1.9 "Tajawal","Noto Sans Arabic","Noto Naskh Arabic",system-ui;
  -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
}
.sheet-wrap{display:grid;place-items:center;margin:10mm 0;padding:8px}
.sheet{
  width:210mm;min-height:297mm;background:#fff;
  transform:translateX(var(--nudgeX)) scale(var(--scale));
  transform-origin: top center;
  filter: contrast(1.06);
}

/* ุงูููุฏุฑ */
.header{padding:9mm 12mm 6mm;border-bottom:2px solid #eaf1f1}
.header .row{display:flex;justify-content:space-between;align-items:center;gap:10mm}
.header .row>div{width:50%}
.org{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  text-align:center;color:var(--label);transform:translateX(12mm)
}
.org .l1{font-weight:900;font-size:16px}
.org .l2{font-weight:900}
.org .l3{font-weight:800}
.meta{text-align:left}
.meta-item{display:block;white-space:nowrap;margin:0 0 2px}
.meta-item .label{font-weight:900;color:var(--label);margin-left:4px}
.meta-item .value{font-weight:900}
.case-total{margin-top:4px;font-size:10.8px;color:#2f4f4b}

/* ุดุฑูุท ุงูุฃุฏูุงุช */
.toolbar{position:sticky;top:0;z-index:10;display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:10px 12px;background:#fff;border-bottom:1px solid #eee}
.toolbar button{border:0;border-radius:10px;padding:9px 12px;cursor:pointer;background:var(--moe);color:#fff;font-weight:800}
.toolbar .secondary{background:#eef7f7;color:#0b5e63;border:1px solid #d7ecec}
.toolbar input[type=file]{display:none}
.toolbar .hint{font-size:12px;color:#6b7280}
.select,.search,.t{padding:8px 10px;border:1px solid #d7ecec;border-radius:10px;background:#fff}
.toolbar-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;width:100%}
.controls-row{width:100%;display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:8px;padding-top:6px;border-top:1px dashed #e5efef}
.controls-row .block{display:flex;align-items:center;gap:6px}
.controls-row .pack{display:flex;align-items:center;gap:4px}

/* ุงูุตูุญุฉ ุงูุฏุงุฎููุฉ */
.page{padding:6mm 0 10mm;display:grid;place-items:center}
.content{width:var(--content);margin:0 auto}

/* ุนููุงู */
.notice-center{width:var(--content);margin:5mm auto 2mm;display:flex;flex-direction:column;align-items:center;gap:6px}
.notice-center .title{font-weight:900;font-size:28px;line-height:1.1;color:#0b5e63;filter:contrast(120%)}
.seg{display:inline-flex;background:#eef7f7;border:1px solid #d7ecec;border-radius:999px;overflow:hidden}
.seg input{display:none}
.seg label{padding:10px 16px;cursor:pointer;font-weight:800;color:#0b5e63;user-select:none}
.seg input:checked+label{background:#0b7e88;color:#fff}

/* ุฌุฏูู ุจูุงูุงุช ุงููุนูู */
.table-wrap{width:var(--content);margin:4mm auto 0;display:flex;justify-content:center;overflow-x:auto}
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl thead th{
  background:#0b5e63;color:#fff;border:1.2px solid #244a4a;
  padding:6px 7px;text-align:center;font-weight:900;font-size:13px
}
.tbl td{
  border:1.2px solid #3f5b57;padding:5px 7px;vertical-align:middle;
  height:12mm;font-size:13.2px;line-height:1.55;background:#fff;text-align:center
}
.tbl thead th.name,.tbl td.name{width:38%}
.tbl thead th.spec,.tbl td.spec{width:14%}
.tbl thead th.level,.tbl td.level{width:16%}
.tbl thead th.job,.tbl td.job{width:16%}
.tbl thead th.work,.tbl td.work{width:16%}
.tbl td span[contenteditable]{display:block;outline:none;overflow-wrap:anywhere;word-break:break-word;font-weight:700}
.tbl td.name span[contenteditable]{font-size:15.5px;font-weight:900}

/* ุงูุณุฌู ุงููุฏูู โ ุฎุงุฑุฌ ุงูุฌุฏูู ุฃุณูู ุงูุงุณู */
.below-flex{width:var(--content);margin:2mm auto 0;display:flex;flex-direction:row-reverse;justify-content:flex-end}
.civil-badge{
  width:38%;display:flex;align-items:center;gap:10px;justify-content:center;
  border:1.5px solid var(--moe);background:#fff;color:#0b3340;border-radius:12px;min-height:9.5mm;padding:3px 6px
}
.civil-badge .labTag{background:var(--moe);color:#fff;font-weight:900;padding:2px 10px;border-radius:8px;white-space:nowrap}
.civil-badge .civilValue{background:#fff;padding:0 6px;border-radius:6px;min-width:42mm;display:inline-block;text-align:center;font-weight:900}

/* ุฃูุณุงู ุงูุชูุจูู */
.sec{width:var(--content);margin:6mm auto;padding:0}
.sec h3{margin:0 0 8px;color:#0b5e63}
.sec h3 .kind{color:#0b7e88}
.rule-row{display:flex;align-items:center;gap:8px;margin-top:4px}
.rule-row .label{font-weight:900;white-space:nowrap}
.rule-row .dots{flex:1;border-bottom:1px dotted #9fb7b3;height:0}
.rule-row .leftnote{white-space:nowrap}
.dotfield{display:inline-block;min-width:28mm;border-bottom:1px dotted #9fb7b3;text-align:center;padding:0 2mm}
.checks{margin:6px 0 8px}
.checkline{display:flex;align-items:flex-start;gap:8px;margin:6px 0}
.checkline input{margin-top:4px;transform:scale(1.15)}
.checkline .text{flex:1}
.calc{font-weight:900;color:#0b5e63}
.timebox{display:inline-block;min-width:28mm;text-align:center;padding:.5mm 3mm;background:#fff;color:#111;font-weight:900;border-radius:6px;border:1px solid #000;font-family:ui-monospace,Consolas,monospace}
.timebox.empty{color:#777;border-color:#bbb}

/* ุญุฒูุฉ ูุณุงุกูุฉ ุงูุบูุงุจ */
.abs-pack{width:var(--content);margin:6mm auto}
.abs-pack h3{margin:0 0 8px;color:#0b5e63}
.abs-pack .para{margin:0 0 6px}
.abs-pack .lines{min-height:28mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe}
.abs-pack .lines div{height:10mm;border-bottom:1px dotted #9fb7b3}
.abs-pack .lines div:last-child{border-bottom:0}
.abs-pack .choices label{display:block;margin:6px 0}
.abs-pack .note{color:#374151;font-size:11.2px;line-height:1.85;margin-top:6mm}

/* ููุช ุงููุธุฑ โ ูุงุฆูุฉ ุงูุณุจุจ ุจุฏูู ุฅุทุงุฑ */
.reason-wrap{display:inline-block;border-bottom:1px dotted #9fb7b3;padding:0 2mm}
.reason-wrap select{
  border:none;outline:none;background:transparent;appearance:none;-webkit-appearance:none;-moz-appearance:none;
  font:inherit;color:inherit;padding:0;margin:0;cursor:pointer
}
.reason-wrap select:focus{outline:none}
#noteReasonText{font-weight:900}

/* ููุงุญุธุฉ (ูุง ุชูุทุจุน) */
.rights{width:var(--content);margin:2mm auto 8mm;text-align:center;font-size:9.2px;color:#6b7280;font-weight:700}
@media print{ .rights{display:none !important} }
body.exporting .rights{display:none !important}
body.exporting .seg{display:none !important}

/* ุทุจุงุนุฉ */
@media print{
  @page{size:A4;margin:9mm}
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  body{background:#fff;color:#000}
  .toolbar{display:none !important}
  .sheet-wrap{margin:0}
  .sheet{margin:0;transform:translateX(var(--nudgeX)) scale(1) !important;filter:none !important}
  .page{padding:0;display:block}
  :root{--content:190mm}
  .content,.notice-center,.table-wrap,.below-flex,.sec,.abs-pack{width:var(--content) !important;margin:0 auto !important}
  .tbl td,.tbl th{border-color:#000 !important}
}

/* ูุงูุฐุฉ ุงูุงุณุชูุฑุงุฏ โ ุชู ุฌุนููุง ุทุจูุฉ Overlay */
#importDialog{display:none;position:fixed;inset:0;z-index:400;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:12px}
#importCard{background:#fff;border-radius:14px;min-width:320px;max-width:900px;width:90%;padding:16px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.25)}
#previewTable th,#previewTable td{border:1px solid #e5efef;padding:6px 8px;text-align:center}
#previewTable{border-collapse:collapse;width:100%}

/* ูุงูุฐุฉ ุงูุฅุญุตุงุฆูุงุช */
#statsDialog{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:300;align-items:center;justify-content:center;padding:12px}
#statsCard{background:#fff;border-radius:14px;min-width:320px;max-width:1100px;width:96%;padding:14px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.25)}
#statsCard h3{margin:0 0 8px;color:#0b5e63}
.stats-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
.stats-actions button{border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
.stats-actions .primary{background:var(--moe);color:#fff}
.stats-actions .ghost{background:#eef7f7;color:#0b5e63;border:1px solid #d7ecec}
.stats-grid{display:grid;grid-template-columns:1fr;gap:10px}
.stats-table{width:100%;border-collapse:collapse}
.stats-table th{background:#0b5e63;color:#fff;border:1px solid #2e4a4a;padding:6px 7px}
.stats-table td{border:1px solid #3f5b57;padding:5px 7px;background:#fff;text-align:center}
@media (min-width:900px){ .stats-grid{grid-template-columns: 1fr 1fr;}}
</style>
</head>
<body>

<!-- ุงูุฃุฏูุงุช -->
<div class="toolbar">
  <div class="toolbar-row">
    <button id="btnMakePDF" class="secondary">๐ ุฅูุดุงุก PDF</button>
    <button id="btnWA" class="secondary">๐ฒ ูุงุชุณุงุจ</button>
    <button id="btnOpenStats" class="secondary" title="ุฅุญุตุงุฆูุงุช ูุฃุฑุดูู">๐ ุฅุญุตุงุฆูุงุช</button>
    <button id="btnClearImport" class="secondary" title="ูุณุญ ุงูุฃุณูุงุก/ุงูุจูุงูุงุช">๐งน ุชุตููุฑ ุงูุงุณุชูุฑุงุฏ</button>

    <div class="drop" id="dropZone" style="display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px dashed #d7ecec;border-radius:10px;cursor:pointer">
      <button id="btnImport" class="secondary">โฌ๏ธ ุงุณุชูุฑุงุฏ ูููุงุช</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.ods,.csv,.tsv,.txt,.json">
      <span class="hint">ุฃููุช ุงูููู ููุง ุฃู ุงุถุบุท ููุงุณุชูุฑุงุฏ</span>
    </div>

    <span class="hint">ุงุจุญุซ ูุงุฎุชุฑ ูุนููุงู:</span>
    <input id="teacherSearch" class="search" placeholder="ุงุจุญุซ ุจุงูุงุณูโฆ">
    <select id="teacherSelect" class="select" style="min-width:220px">
      <option value="">โ ุงุฎุชุฑ ูุนููุงู โ</option>
    </select>
  </div>

  <div class="controls-row">
    <div class="block">
      <span class="hint">ุชุงุฑูุฎ ุงููุงูุนุฉ (ูุฌุฑู):</span>
      <div class="pack">
        <select id="hjDay" class="select"></select>
        <select id="hjMonth" class="select"></select>
        <select id="hjYear" class="select"></select>
      </div>
    </div>
    <div class="block"><span class="hint">ุจุฏุงูุฉ ุงูุฏูุงู:</span><input id="workStart" class="t" type="time" value="06:45" step="60"></div>
    <div class="block"><span class="hint">ููุงูุฉ ุงูุฏูุงู:</span><input id="workEnd" class="t" type="time" value="13:45" step="60"></div>
  </div>
</div>

<div class="sheet-wrap">
  <div class="sheet" id="sheet">
    <!-- ุงูููุฏุฑ -->
    <div class="header">
      <div class="row">
        <div class="org">
          <div class="l1">ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ</div>
          <div class="l2">ูุฒุงุฑุฉ ุงูุชุนููู</div>
          <div class="l3">ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจุงูููุทูุฉ ุงูุดุฑููุฉ</div>
          <div class="l3" id="schoolNameHdr">ูุฏุฑุณุฉ ุงููุนููุจู ุงูุซุงูููุฉ</div>
        </div>
        <div class="meta">
          <div class="meta-item"><span class="label">ุงูุฑูู:</span><span class="value" id="serialNo">01</span></div>
          <div class="meta-item"><span class="label">ุงูุชุงุฑูุฎ:</span><span class="value" id="hdrHijri">ูกูคูคูง/ููค/ูกูฃ ูู</span></div>
          <div class="case-total">ุฅุฌูุงูู ูุณุงุกูุงุช ุงููุนูู: <strong id="caseTotal">0</strong></div>
        </div>
      </div>
    </div>

    <div class="page">
      <div class="content">

        <!-- ุนููุงู ูุงุฎุชูุงุฑ ุงูููุน -->
        <div class="notice-center">
          <div class="title" id="mainTitle">ุชูุจูู</div>
          <div class="seg" id="noticeSeg">
            <input type="radio" name="nt" id="nt-note"  value="note"><label for="nt-note">ููุช ูุธุฑ</label>
            <input type="radio" name="nt" id="nt-gaib"  value="gaib"><label for="nt-gaib">ุบูุงุจ</label>
            <input type="radio" name="nt" id="nt-late"  value="late" checked><label for="nt-late">ุชุฃุฎุฑ</label>
            <input type="radio" name="nt" id="nt-abs"   value="absent"><label for="nt-abs">ุนุฏู ุชูุงุฌุฏ</label>
            <input type="radio" name="nt" id="nt-early" value="early"><label for="nt-early">ุงูุตุฑุงู ูุจูุฑ</label>
          </div>
        </div>

        <!-- ุฌุฏูู ุจูุงูุงุช ุงููุนูู -->
        <div class="table-wrap">
          <table class="tbl" aria-label="ุจูุงูุงุช ุงูููุธู">
            <thead>
              <tr>
                <th class="name">ุงูุงุณู</th>
                <th class="spec">ุงูุชุฎุตุต</th>
                <th class="level">ุงููุฑุชุจุฉ</th>
                <th class="job">ุฑูู ุงููุธููุฉ</th>
                <th class="work">ุงูุนูู ุงูุญุงูู</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="name"><span id="t_name"  contenteditable="true"></span></td>
                <td class="spec"><span id="t_spec"  contenteditable="true"></span></td>
                <td class="level"><span id="t_level" contenteditable="true"></span></td>
                <td class="job"><span  id="t_job"   contenteditable="true"></span></td>
                <td class="work"><span id="t_work"  contenteditable="true"></span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ุงูุณุฌู ุงููุฏูู ุฃุณูู ุงูุงุณู ุฎุงุฑุฌ ุงูุฌุฏูู -->
        <div class="below-flex">
          <div class="civil-badge">
            <span class="labTag">ุงูุณุฌู ุงููุฏูู</span>
            <span id="t_civil" class="civilValue" contenteditable="true"></span>
          </div>
        </div>

        <!-- (ุฃ) ุญุฒูุฉ ุงูุชูุจูู -->
        <div id="alertPack">
          <div class="sec">
            <h3>( 1 ) ุฎุทุงุจ ุงูุชูุจูู โ <span class="kind" id="kindTitle">ุชุฃุฎุฑ</span></h3>

            <div class="rule-row">
              <span class="label">ุงูุฃุณุชุงุฐ ุงููุงุถู :</span>
              <span class="dots"></span>
              <span class="leftnote">ุญูุธู ุงููู</span>
            </div>

            <p style="margin:6px 0 2px"><strong>ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู</strong></p>
            <p style="margin:0 0 6px">ูุจุนุฏ :</p>

            <p style="margin:0 0 6px">
              ุฅูู ูู ููู
              <span class="dotfield" id="dayField"><span id="dynDay">โ</span></span>
              ุงูููุงูู
              <span class="dotfield" id="hijriField"><span id="dynHijri">โ</span> ูู</span>
              :
            </p>

            <div class="checks">
              <label id="lineLate" class="checkline">
                <input type="checkbox" checked>
                <span class="text">
                  ุชุฃุฎุฑูู ูู ุจุฏุงูุฉ ุงูุนููุ ูุญุถูุฑูู ุงูุณุงุนุฉ ( <span id="tLateIn" class="timebox empty">--:--</span> ).
                  <span class="calc">โ ุฅุฌูุงูู ุงูุชุฃุฎุฑ: <span id="lateTotal">0 ุฏูููุฉ</span></span>
                </span>
              </label>

              <label id="lineAbs" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  ุนุฏู ุชูุงุฌุฏูู ุฃุซูุงุก ุงูุนูู ูู ุงูุณุงุนุฉ : ( <span id="tAbsFrom" class="timebox empty">--:--</span> )
                  ุฅูู ุงูุณุงุนุฉ : ( <span id="tAbsTo" class="timebox empty">--:--</span> ).
                  <span class="calc">โ ูุฏุฉ ุนุฏู ุงูุชูุงุฌุฏ: <span id="absTotal">0 ุฏูููุฉ</span></span>
                </span>
              </label>

              <label id="lineEarly" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  ุงูุตุฑุงููู ูุจูุฑูุง ูุจู ููุงูุฉ ุงูุนูู ูู ุงูุณุงุนุฉ : ( <span id="tEarlyFrom" class="timebox empty">--:--</span> ).
                  <span class="calc">โ ูุฏุฉ ุงูุงูุตุฑุงู ุงููุจูุฑ: <span id="earlyTotal">0 ุฏูููุฉ</span></span>
                </span>
              </label>
            </div>

            <p>ุนููู ูุฃูู ุชูุถูุญ ุฃุณุจุงุจ ุฐูู ูุน ุฅุฑูุงู ูุง ูุคูุฏ ุนุฐุฑูู โฆ ูููู ุชุญูุงุชู.</p>

            <p style="margin-top:8px">
              <strong>ูุฏูุฑ ุงููุฏุฑุณุฉ :</strong>
              <span id="managerName1" class="dotfield" style="min-width:45mm">ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</span>
              &nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> <span class="dotfield" style="min-width:30mm"></span>
              &nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> <span class="dotfield" style="min-width:22mm"></span> ูู
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) ุงูุฅูุงุฏุฉ</h3>
            <p><strong>ูุฏูุฑ ุงููุฏุฑุณุฉ :</strong> <span id="managerName2">ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</span></p>
            <p><strong>ุงูุฃุณุชุงุฐ ุงููุงุถู / ูุฏูุฑ ุงููุฏุฑุณุฉ.</strong></p>
            <p>ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู ูุจุนุฏ :</p>
            <div style="min-height:38mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe">
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;"></div>
            </div>
            <p><span>ุงูุงุณู :</span> <strong id="afadaName">โ</strong>
               &nbsp;&nbsp;&nbsp; <span>ุงูุชูููุน :</span> ____________________
               &nbsp;&nbsp;&nbsp; <span>ุงูุชุงุฑูุฎ :</span> ____________________ ูู</p>
          </div>

          <div class="sec">
            <h3>( 3 ) ุฑุฃู ูุฏูุฑ ุงููุฏุฑุณุฉ</h3>
            <p><label><input type="radio" name="opinion"> ุนุฐุฑู ููุจูู</label>
               &nbsp;&nbsp;<label><input type="radio" name="opinion"> ุนุฐุฑู ุบูุฑ ููุจูู ูููุญุณู ุนููู</label></p>
            <p><strong>ูุฏูุฑ ุงููุฏุฑุณุฉ :</strong> <span id="managerName3">ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</span></p>
            <p><span>ุงูุชูููุน :</span> ____________________ &nbsp;&nbsp; <span>ุงูุชุงุฑูุฎ :</span> ____________________ ูู</p>
          </div>
        </div>

        <!-- (ุจ) ุญุฒูุฉ ูุณุงุกูุฉ ุบูุงุจ -->
        <div id="absencePack" class="abs-pack" style="display:none">
          <div class="sec" style="margin-top:0">
            <p class="para" id="absIntro">
              ุฅูู ูู ููู <strong><span id="absDayP">โ</span></strong>
              ุงูููุงูู <strong><span id="absDateYMD">โ</span></strong>
              ุชุบูุจุช ุนู ุงูุนูู.
            </p>
            <h3>( 1 ) ุทูุจ ุงูุฅูุงุฏุฉ</h3>
            <p class="para"><strong>ุงูุฃุณุชุงุฐ ุงููุงุถู /</strong> <span id="abs-name-top">โ</span> <span>ุญูุธู ุงููู</span></p>
            <p class="para"><strong>ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู</strong> ูุจุนุฏ ุุุ</p>
            <p class="para">
              ูู ุฎูุงู ูุชุงุจุนุฉ ุณุฌู ุงูุฏูุงู ุชุจูู ุบูุงุจูู ุฎูุงู ุงููุชุฑุฉ ุงูููุถุญุฉ ุจุนุงููุฉุ ุขูู ุงูุฅูุงุฏุฉ ุนู ุณุจุจ ุฐูู
              ูุนูููู ุชูุฏูู ูุง ูุคูุฏ ุนุฐุฑูู ุฎูุงู ุฃุณุจูุน ููุท ูู ุชุงุฑูุฎูุ ุนููุงู ุจุฃูู ูู ุญุงูุฉ ุนุฏู ุงูุฅูุชุฒุงู ุณูุชู ุงุชุฎุงุฐ ุงููุงุฒู ุญุณุจ ุงูุชุนูููุงุช.
            </p>
            <p class="para">
              <strong>ุงุณู ุงูุฑุฆูุณ ุงููุจุงุดุฑ :</strong> <span id="managerName4">ููุฏ ุจู ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</span>
              &nbsp;&nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> ______ / ______ / ______ ูู
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) ุงูุฅูุงุฏุฉ</h3>
            <p class="para"><strong>ุงูุฃุณุชุงุฐ ุงููุงุถู / ูุฏูุฑ ุงููุฏุฑุณุฉ</strong> ุญูุธู ุงููู</p>
            <p class="para"><strong>ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู</strong> ูุจุนุฏ:</p>
            <p class="para">ุฃููุฏูู ุฃู ุบูุงุจู ูุงู ููุฃุณุจุงุจ ุงูุชุงููุฉ:</p>
            <div class="lines"><div></div><div></div><div></div></div>
            <p class="para">ูุณุฃููู ุจุชูุฏูู ูุง ูุซุจุช ุฐูู ุฎูุงู ุฃุณุจูุน ูู ุชุงุฑูุฎู.</p>
            <p class="para">
              <strong>ุงุณู ุงููุนูู :</strong> <span id="abs-teacher-name">โ</span>
              &nbsp;&nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> ______ / ______ / ______ ูู
            </p>
          </div>

          <div class="sec">
            <h3>( 3 ) ูุฏูุฑ ุงููุฏุฑุณุฉ</h3>
            <div class="choices">
              <label><input type="checkbox"> ุชูุญุชุณุจ ูู ุฅุฌุงุฒุฉ ูุฑุถูุฉ ุจุนุฏ ุงูุชุฃูุฏ ูู ูุธุงููุฉ ุงูุชูุฑูุฑ.</label>
              <label><input type="checkbox"> ููุญุชุณุจ ุบูุงุจู ูู ุฑุตูุฏู ููุฅุฌุงุฒุงุช ุงูุฅุถุทุฑุงุฑูุฉ ููุจูู ุนุฐุฑู ุฅุฐุง ูุงู ุฑุตูุฏู ูุณูุญ ููุง ููุญุณู ุนููู.</label>
              <label><input type="checkbox"> ูุนุชูุฏ ุงูุญุณู ูุนุฏู ูุจูู ุนุฐุฑู.</label>
            </div>
            <p class="para">
              <strong>ุงุณู ุงูุฑุฆูุณ ุงููุจุงุดุฑ :</strong> <span id="managerName5">ููุฏ ุจู ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</span>
              &nbsp;&nbsp;&nbsp; <strong>ุงูุชูููุน :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>ุงูุชุงุฑูุฎ :</strong> ______ / ______ / ______ ูู
            </p>
          </div>

          <div class="note">
            <strong>ููุงุญุธุงุช ูุงูุฉ</strong><br>
            1- ุชูุณุชููู ุงูุงุณุชูุงุฑุฉ ูุชูุณูู ูุดุคูู ุงูููุธููู ูุงุณุชููุงู ูุง ูุฌุจ ุญูุงููุง.<br>
            2- ุฅุฐุง ุณุจู ุงูุนุทู ุงูุฑุณููุฉ ุบูุงุจ ููุญููุง ุบูุงุจ ุชูุญุชุณุจ ูุฏุฉ ุงูุบูุงุจ ูุงููุฉ ุจูุง ูููุง ุงูุนุทู ุงูุฑุณููุฉ.<br>
            3- ูุฌุจ ุฃู ููุถุญ ุงููุชุบูุจ ุฃุณุจุงุจ ุบูุงุจู ููุฑ ุชุณููู ุงูุงุณุชูุงุฑุฉ ููุนูุฏูุง ูุฑุฆูุณู.<br>
            4- ููุนุทู ุงููุชุบูุจ ูุฏุฉ ุฃุณุจูุน ูุชูุฏูู ูุง ูุคูุฏ ุนุฐุฑู ูุฅุฐุง ุงููุถุช ุงููุฏุฉ ุงูุฒูููุฉ ุชูุณุชููู ุงูุงุณุชูุงุฑุฉ ููุชู ุงูุญุณู.
          </div>
        </div>

        <!-- (ุฌ) ูููุฐุฌ ููุช ุงููุธุฑ -->
        <div id="notePack" class="sec" style="display:none">
          <h3>ูููุฐุฌ ููุช ุงููุธุฑ</h3>

          <p style="margin:0 0 4px">
            <span><strong>ุงูุฃุณุชุงุฐ ุงููุงุถู/</strong></span>
            <span id="noteTeacherName" contenteditable="true" style="font-weight:900"></span>
            <span>ุญูุธู ุงููู</span>
          </p>
          <p style="margin:0 0 6px"><strong>ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชูุ ูุจุนุฏ ุุุ</strong></p>

          <!-- ุงูููุฑุฉ ุงูุฑุฆูุณุฉ ุจุงุณุชุฏุนุงุก ุงูุณุจุจ ูู ุงููุงุฆูุฉ -->
          <p id="noteParagraph" style="margin:0 0 8px">
            ุฅุดุงุฑุฉู ุฅูู ุงูุชุนูููุงุช ูุงูุฃูุธูุฉ ุงููุนุชูุฏุฉุ ููุญูุธ 
            <span id="noteReasonText" style="font-weight:900">ุงููููุฉ ุงููุญุฏุฏุฉ</span>
            ููู ุงูุฌุฏูู ูุงูุชุนูููุงุช ุงูููุธูุฉ. ููุฃูู ูููู ุงููุจุงุฏุฑุฉ ุจูุนุงูุฌุฉ ุฐููุ ูุงูุงูุชุฒุงู ุงูุชุงู ุฏุนููุง ููุงูุถุจุงุท ุงููููู ูุฑูุนูุง ูุฌูุฏุฉ ุงูุฃุฏุงุก.
          </p>

          <!-- ุงููุงุฆูุฉ ุงูููุณุฏูุฉ (ุจุฏูู ุฅุทุงุฑุ ุฃุณูููุง ุฎุท ูููุท) -->
          <div class="reason-wrap" title="ุงุฎุชุฑ ุณุจุจ ููุช ุงููุธุฑ">
            <select id="noteReasonSelect">
              <option value="">โ ุงุฎุชุฑ ุงูุณุจุจ โ</option>
              <option>ุนุฏู ุงููุดุงุฑูุฉ ูู ุงูุฅุดุฑุงู ุงูุตุจุงุญู ุงูููููู ุจู ููู ุฌุฏูู ุงูููุงูุจุฉ ุงููุนุชูุฏุ ููุง ุฃุซูุฑ ุนูู ุงูุชุธุงู ุณูุฑ ุงูุทุงุจูุฑ ุงูุตุจุงุญู ูุงูุถุจุงุท ุงูุทูุงุจ.</option>
              <option>ุนุฏู ุฃุฏุงุก ููุงู ุงูููุงูุจุฉ ูู ููุงูุฉ ุงูุฏูุงู ุงููุฏุฑุณูุ ููุง ูุชุฑุชุจ ุนููู ูู ุถุนู ูู ุชูุธูู ุฎุฑูุฌ ุงูุทูุงุจ ูุถูุงู ุณูุงูุชูู.</option>
              <option>ุงูุชูุตูุฑ ูู ุงูุฅุดุฑุงู ุฃุซูุงุก ูุชุฑุฉ ุงููุณุญุฉุ ููุง ูุชุฌ ุนูู ุบูุงุจ ุงููุชุงุจุนุฉ ุงูุณููููุฉ ุงููุงุฒูุฉ ููุทูุงุจ ุฏุงุฎู ุงูุณุงุญุฉ ุงููุฏุฑุณูุฉ.</option>
              <option>ุนุฏู ุงูุฅุดุฑุงู ุนูู ุฃุฏุงุก ุตูุงุฉ ุงูุธูุฑ ูู ุงููุตูู ุงููุฏุฑุณู ุฑุบู ุฅุฏุฑุงุฌู ุถูู ุงูููุงู ุงูููููุฉ.</option>
              <option>ุนุฏู ุงูุงูุชุฒุงู ุจุฅุนุฏุงุฏ ุงูุฏุฑูุณ ุฃู ุงูุชุญุถูุฑ ุงูุฅููุชุฑููู ูู ููุตุฉ ูุฏุฑุณุชู ููู ุงููุชุทูุจุงุช ุงูุชุฑุจููุฉ ุงููุนุชูุฏุฉ.</option>
              <option>ุงูุฎุฑูุฌ ูู ุงูุญุตุฉ ุงูุฏุฑุงุณูุฉ ูุจู ุงูุชูุงุก ููุชูุง ุงููุญุฏุฏ ุฏูู ูุจุฑุฑ ูุธุงููุ ููุง ูุคุซุฑ ุนูู ุงูุถุจุงุท ุงูุนูููุฉ ุงูุชุนููููุฉ.</option>
              <option>ุงูุชุฃุฎุฑ ูู ุฏุฎูู ุงูุญุตุฉ ุงูุฏุฑุงุณูุฉ ุนู ุงูููุช ุงููุญุฏุฏ ูู ุงูุฌุฏูู ุงูุฒูููุ ููุง ูุฎููู ุจุงูุถุจุงุท ุงูุฌุฏูู ุงููููู ูููุฏุฑุณุฉ.</option>
              <option>ุนุฏู ุงูุญุถูุฑ ููุทุงุจูุฑ ุงูุตุจุงุญู ุฏูู ุนุฐุฑ ุฑุณููุ ููู ูุง ููุนุฏ ุชูุตูุฑูุง ูู ุฃุฏุงุก ุงููุงุฌุจุงุช ุงูููููุฉ ุงูููุงุทุฉ ุจุงููุนูู.</option>
              <option>ุนุฏู ุญุถูุฑ ูุฌูุณ ุฃูููุงุก ุงูุฃููุฑ ุจุงูุฑุบู ูู ุชูุฌูู ุงูุฏุนูุฉ ุงูุฑุณููุฉุ ููุง ูููุช ูุฑุตุฉ ุงูุชูุงุตู ุงููุนูุงู ูุน ุฃูููุงุก ุงูุฃููุฑ ูุฏุนู ุงูุดุฑุงูุฉ ุงููุฏุฑุณูุฉ.</option>
              <option>ุงูุชุบูุจ ุนู ุงุฌุชูุงุน ุงููุฏุฑุณุฉ ุงูุฑุณูู ุฏูู ุนุฐุฑ ูุธุงููุ ููู ูุง ููุนุฏ ูุฎุงููุฉ ููุฃูุธูุฉ ูุงูุชุนูููุงุช ุงูุฅุฏุงุฑูุฉ.</option>
              <option>ุนุฏู ุงูุฑุฏ ุนูู ุงููุณุงุกูุฉ ุงูุฅุฏุงุฑูุฉ ุงูููุฌูุฉ ูู ุงูููุช ุงููุญุฏุฏุ ููุง ูุฏู ุนูู ุนุฏู ุชุฌุงูุจ ูุน ุงูุฅุฌุฑุงุกุงุช ุงููุธุงููุฉ.</option>
              <option>ุฑูุถ ุงูุชูููุน ุนูู ุงูููุงุฐุฌ ุฃู ุงููุญุงุถุฑ ุงูุฑุณููุฉ ุงูุตุงุฏุฑุฉ ูู ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉุ ููู ูุง ูุฎุงูู ููุชุถู ุงูุชุนุงูู ุงูุฅุฏุงุฑู ูุงููููู.</option>
              <option>ุฑูุถ ุชูููุฐ ุงูุชูุฌูู ุงูุฅุฏุงุฑู ุฃู ุงูุชุฑุจูู ุงูุตุงุฏุฑ ูู ูุงุฆุฏ ุงููุฏุฑุณุฉ ุฃู ุงููุดุฑู ุงูุชุฑุจูู ุฏูู ูุจุฑุฑ ูุธุงูู.</option>
              <option>ุนุฏู ุฑูุน ุจูุงูุงุช ุงูุบูุงุจ ุนูู ููุตุฉ (ูุงุฑุณ) ูู ุงูููุช ุงููุญุฏุฏ ููู ุงูุชุนูููุงุช ุงูููุธูุฉ.</option>

              <!-- ุฅุถุงูุงุช ุจุตูุงุบุฉ ุฑุณููุฉ ุชุฑุจููุฉ (ุงูุงูุชุธุงุฑ) -->
              <option>ุนุฏู ุฏุฎูููู ุญุตุฉ ุงูุงูุชุธุงุฑ ุงููููููู ุจูุง ููู ุงูุฌุฏูู ุงููุนุชูุฏ ูุงูุชุนูููุงุช ุงูููุธูุฉุ ููุง ุชุฑุชูุจ ุนูู ุฐูู ูู ุฅุฎูุงู ุจุงูุถุจุงุท ุณูุฑ ุงูููู ุงูุฏุฑุงุณู ููุชุงุจุนุฉ ุงูุทูุงุจ.</option>
              <option>ุชุฃุฎููุฑูู ุนู ูุจุงุดุฑุฉ ุญุตุฉ ุงูุงูุชุธุงุฑ ุงููููููู ุจูุง ูู ููุชูุง ุงููุญุฏุฏ ููู ุงูุฌุฏูู ุงููุนุชูุฏุ ุจูุง ูุคุซูุฑ ูู ุงูุถุจุงุท ุงูุญุตุต ูุชุณูุณููุง ูุงุณุชูุฑุงุฑูุฉ ุงูุชุนููู.</option>
            </select>
          </div>

          <!-- ุฎุชุงู -->
          <p style="margin:10px 0 8px">
           ุญุฑุตูุง ุนูู ุงูุงูุถุจุงุท ุงููููู ูุฑูุน ููุงุกุฉ ุงูููุงุฑุณุฉ ุฏุงุฎู ุงููุฏุฑุณุฉุ ูุฃูู ุชูุงูู ูุง ูุฑุฏ ูุณุชูุจูุงูุ ูุงูุงูุชุฒุงู ุงูุชุงู ุจุงูุชุนูููุงุช ูุงูููุงู ุงููุธูููุฉ ุงููุนุชูุฏุฉุ ุฏุนููุง ูุฌูุฏุฉ ุงูุฃุฏุงุก ูุชุญููููุง ููุตูุญุฉ ุงูุนูู ุงููุฏุฑุณู.
           ุชุจููุบ ูุง ูุดุชุฑุท ุงูุฅูุงุฏุฉ.
            ูุชูุจูููุง ุฎุงูุต ุงูุชุญูุฉ ูุงูุชูุฏูุฑุุ
          </p>

          <!-- ุงูุชูููุนุงุช -->
          <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
            <div style="flex:1">
              <p style="margin:0 0 4px"><strong>ุชูููุน ุงูููุธู ุจุงูุงุทูุงุน:</strong> ...............................</p>
              <p style="margin:0 0 4px"><strong>ุงูุงุณู:</strong> ...............................</p>
              <p style="margin:0"><strong>ุงูุชุงุฑูุฎ:</strong> ______ / ______ / 14ูู</p>
            </div>
            <div style="flex:1">
              <p style="margin:0 0 4px"><strong>ุชูููุน ูุงุฆุฏ ุงููุฏุฑุณุฉ:</strong> <span id="managerNameNote">ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</span></p>
            </div>
          </div>
        </div>

        <div class="rights">ูุจุงุฏุฑุฉ ุงููุนููุจู โ ุชุทููุฑ: ููุฏ ุญุงูุฏ ุงูุฒูุฑุงูู</div>

      </div>
    </div>
  </div>
</div>

<!-- ุญูุงุฑ ุงูุงุณุชูุฑุงุฏ -->
<div id="importDialog" role="dialog" aria-modal="true">
  <div id="importCard">
    <h3 style="margin-top:0;color:#0b5e63">ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงููุนูููู</h3>
    <div class="map-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0">
      <label>ูุฑูุฉ ุงูุนูู (Sheet)</label><select id="sheetSelect"></select>
      <label>ุนููุฏ ุงูุงุณู</label><select id="mapName"></select>
      <label>ุนููุฏ ุงูุณุฌู ุงููุฏูู / ุงููููุฉ</label><select id="mapCivil"></select>
      <label>ุนููุฏ ุงูุชุฎุตุต</label><select id="mapSpec"></select>
      <label>ุนููุฏ ุงููุฑุชุจุฉ / ุงููุณุชูู</label><select id="mapLevel"></select>
      <label>ุนููุฏ ุฑูู ุงููุธููุฉ</label><select id="mapJob"></select>
      <label>ุนููุฏ ุงูุนูู ุงูุญุงูู</label><select id="mapWork"></select>
      <label>ุนููุฏ ุงููุฏุฑุณุฉ (ุงุฎุชูุงุฑู)</label><select id="mapSchool"></select>
      <label>ุนููุฏ ุงูุฌูุงู / ูุงุชุณุงุจ</label><select id="mapPhone"></select>
    </div>
    <div class="preview" style="max-height:260px;overflow:auto;border:1px solid #e5efef;border-radius:10px;margin-top:8px">
      <table id="previewTable"></table>
    </div>
    <div class="dlg-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn-ghost" id="btnCancelImport" style="border:1px solid #d7ecec;background:#eef7f7;color:#0b5e63;border-radius:10px;padding:9px 12px;font-weight:800">ุฅูุบุงุก</button>
      <button class="btn-primary" id="btnConfirmImport" style="background:#0b7e88;color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800">ุงุนุชูุงุฏ ุงูุงุณุชูุฑุงุฏ</button>
    </div>
  </div>
</div>

<!-- ูุงูุฐุฉ ุงูุฅุญุตุงุฆูุงุช -->
<div id="statsDialog" role="dialog" aria-modal="true">
  <div id="statsCard">
    <h3>ุฅุญุตุงุฆูุงุช ูุฅุฑุดูู ุงููุณุงุกูุงุช ูุงูุชูุจููุงุช</h3>
    <div class="stats-actions">
      <button id="btnExportArchive" class="ghost">๐พ ูุณุฎ ุงุญุชูุงุทู</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        โคด๏ธ ุงุณุชุนุงุฏุฉ
        <input id="restoreInput" type="file" accept=".json" style="display:none">
      </label>
      <button id="btnResetAll" class="ghost">โบ ุชุตููุฑ ุงููุณุงุกูุงุช</button>
      <span class="hint">ูููู ุชุตููุฉ ุงูุฃุฑุดูู ุจุงุณู ุงููุนูู:</span>
      <input id="statsFilter" class="search" placeholder="ุงูุชุจ ุงุณู ูุนููโฆ">
      <button id="btnCloseStats" class="primary">ุฅุบูุงู</button>
    </div>

    <div class="stats-grid">
      <div>
        <h3 style="margin-top:0">ุงูุฃุฑุดูู (ุชูุตููู)</h3>
        <table class="stats-table" id="tblArchive">
          <thead><tr>
            <th>ุงูุชุงุฑูุฎ (ูุฌุฑู)</th>
            <th>ุงุณู ุงููุนูู</th>
            <th>ุงูุณุฌู ุงููุฏูู</th>
            <th>ููุน ุงูุฅุฌุฑุงุก</th>
            <th>ุฑูู ุงูุฅุฌุฑุงุก</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h3 style="margin-top:0">ููุฎุต ุญุณุจ ุงููุนูู</h3>
        <table class="stats-table" id="tblSummary">
          <thead><tr>
            <th>ุงููุนูู</th>
            <th>ุงูุณุฌู ุงููุฏูู</th>
            <th>ูุณุงุกูุฉ ุบูุงุจ</th>
            <th>ุชูุจูู ุชุฃุฎุฑ</th>
            <th>ุชูุจูู ุนุฏู ุชูุงุฌุฏ</th>
            <th>ุชูุจูู ุงูุตุฑุงู ูุจูุฑ</th>
            <th>ููุช ูุธุฑ</th>
            <th>ุงูุฅุฌูุงูู</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ููุญุฉ ุงููุคููุช -->
<div id="timePad" style="display:none;position:fixed;background:#fff;border:1px solid #e6eeee;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.25);padding:10px;z-index:200">
  <div class="display" id="timePadDisplay" style="font:700 18px ui-monospace,Consolas,monospace;text-align:center;margin-bottom:6px">--:--</div>
  <div class="grid" style="display:grid;grid-template-columns:repeat(3,44px);gap:6px;justify-content:center">
    <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
    <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
    <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
    <button data-k=":">:</button><button data-k="0">0</button><button class="del">โซ</button>
  </div>
  <div class="row" style="display:flex;gap:8px;justify-content:center;margin-top:8px">
    <button class="action" id="timePadSave">ุญูุธ</button><button id="timePadClose">ุฅุบูุงู</button>
  </div>
</div>

<script>
/* ===== ูููุฉ ูุชูุงูู ===== */
const BASE_TITLE='ุงูุดุคูู ุงูุฅุฏุงุฑูุฉ ูุงููุชุงุจุนุฉ';
const DEFAULT_WA='966504532489';
const AR='ููกูขูฃูคูฅูฆูงูจูฉ', EN='0123456789';
const en2ar = s => (s+'').replace(/[0-9]/g,d=>AR[d]);
const ar2en = s => (s+'').replace(/[ู-ูฉ]/g,d=>EN[AR.indexOf(d)]);

/* ===== ุชูุงุณุจ ุชููุงุฆู ููู ุงูุฃุฌูุฒุฉ ===== */
function fitSheet(){
  const sheet=document.getElementById('sheet');
  if(!sheet) return;
  const avail = Math.max(320, window.innerWidth - 16);
  const scale = Math.min(1, avail / sheet.offsetWidth);
  document.documentElement.style.setProperty('--scale', String(scale));
}
addEventListener('resize', fitSheet);
addEventListener('orientationchange', fitSheet);
document.addEventListener('DOMContentLoaded', fitSheet);

/* ===== ุชุงุฑูุฎ ูุฌุฑู (ุฃู ุงููุฑู) ===== */
function fmtHijriNoSuffix(d){
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  const DD=en2ar(parts.find(p=>p.type==='day').value.padStart(2,'0'));
  const MM=en2ar(parts.find(p=>p.type==='month').value.padStart(2,'0'));
  const YY=en2ar(parts.find(p=>p.type==='year').value);
  return `${DD}/${MM}/${YY}`;
}
function fmtHijriYMDNoSuffix(d){
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  const DD=en2ar(parts.find(p=>p.type==='day').value.padStart(2,'0'));
  const MM=en2ar(parts.find(p=>p.type==='month').value.padStart(2,'0'));
  const YY=en2ar(parts.find(p=>p.type==='year').value);
  return `${YY}/${MM}/${DD}`;
}
const wdHijri = d => new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(d);

function hijriToGregorian(y,m,d){
  const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'});
  const parts = dt => { const p=fmt.formatToParts(dt); let yy,mm,dd;
    p.forEach(q=>{ if(q.type==='year') yy=parseInt(ar2en(q.value),10);
                   if(q.type==='month') mm=parseInt(ar2en(q.value),10);
                   if(q.type==='day') dd=parseInt(ar2en(q.value),10); });
    return {yy,mm,dd}; };
  let t=new Date(1937,0,1);
  for(let i=0;i<60000;i++){
    const a=parts(t);
    if(a.yy===y && a.mm===m && a.dd===d) return new Date(t.getFullYear(),t.getMonth(),t.getDate());
    t.setDate(t.getDate()+1);
  }
  return null;
}

(function buildHijriPicker(){
  const dSel=document.getElementById('hjDay'), mSel=document.getElementById('hjMonth'), ySel=document.getElementById('hjYear');
  for(let d=1; d<=30; d++) dSel.add(new Option(en2ar(String(d).padStart(2,'0')), d));
  for(let m=1; m<=12; m++) mSel.add(new Option(en2ar(String(m).padStart(2,'0')), m));
  const now=new Date();
  const curAH=parseInt(ar2en(new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric'}).format(now)),10);
  for(let y=curAH-10; y<=curAH+10; y++) ySel.add(new Option(en2ar(y), y));
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
  dSel.value=parseInt(ar2en(parts.find(p=>p.type==='day').value),10);
  mSel.value=parseInt(ar2en(parts.find(p=>p.type==='month').value),10);
  ySel.value=parseInt(ar2en(parts.find(p=>p.type==='year').value),10);
  function update(){
    const y=+ySel.value,m=+mSel.value,d=+dSel.value;
    const g=hijriToGregorian(y,m,d); if(!g){ alert('ุชุนุฐูุฑ ุชุญููู ุงูุชุงุฑูุฎ ุงููุฌุฑู'); return; }
    const hijYMD=fmtHijriYMDNoSuffix(g);
    document.getElementById('hdrHijri').textContent = `${hijYMD} ูู`;
    const hijNo=fmtHijriNoSuffix(g);
    const dayName = wdHijri(g);
    document.getElementById('dynDay').textContent = dayName;
    document.getElementById('dynHijri').textContent = hijNo;
    document.getElementById('absDayP').textContent  = dayName;
    document.getElementById('absDateYMD').textContent = hijYMD;
  }
  dSel.onchange=mSel.onchange=ySel.onchange=update; update();
})();

/* ===== ุจูุงูุงุช ุงููุนูููู (cache) ===== */
let TEACHERS=JSON.parse(localStorage.getItem('teachersCache')||'[]');
let currentIdx = null;
function pad2(n){return String(n).padStart(2,'0');}

/* ุงุณู ุงููุฏูุฑ โ ูุณูุญ ุจุชุนุฏูู ุงูุขููุฉ (cache) */
const MANAGER_KEY='managerName';
function getManagerName(){
  return localStorage.getItem(MANAGER_KEY) || 'ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู';
}
function setManagerName(v){
  if(!v) return; localStorage.setItem(MANAGER_KEY, v);
  ['managerName1','managerName2','managerName3','managerName4','managerName5','managerNameNote'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent=v;
  });
}

/* ===== ุฃุฑุดูู ุงูุฅุฌุฑุงุกุงุช (ุฏุงุฆู + ูุณุฎ ุงุญุชูุงุทู) ===== */
const ARCHIVE_KEY='caseArchive_v1';
let ARCHIVE = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');

function teacherKeyFromObj(obj){
  const civil=(obj.civil||'').trim();
  const name=(obj.name||'').trim();
  return civil? ('id:'+civil) : ('name:'+name);
}
function getCurrentTeacher(){ if(currentIdx==null) return null; return TEACHERS[currentIdx] || null; }
function computeCountsFor(key){
  let total=0, byType={gaib:0, late:0, absent:0, early:0, note:0};
  for(const e of ARCHIVE){ if(e.tkey===key){ total++; if(byType[e.kind]!=null) byType[e.kind]++; } }
  return {total, byType};
}
function nextSerialFor(key){ return computeCountsFor(key).total + 1; }
function refreshHeaderCounts(){
  const t=getCurrentTeacher(); 
  if(!t){ document.getElementById('serialNo').textContent='01'; document.getElementById('caseTotal').textContent='0'; return; }
  const key=teacherKeyFromObj(t);
  document.getElementById('serialNo').textContent = pad2(nextSerialFor(key));
  document.getElementById('caseTotal').textContent = computeCountsFor(key).total;
}
function saveArchive(){ localStorage.setItem(ARCHIVE_KEY, JSON.stringify(ARCHIVE)); refreshHeaderCounts(); }

/* ุชุณุฌูู ุฅุฌุฑุงุก ุฌุฏูุฏ ูู ุงูุฃุฑุดูู */
function recordCase(kind, source){
  const t=getCurrentTeacher();
  if(!t){ alert('ูุฑุฌู ุงุฎุชูุงุฑ ูุนููู ุฃููุงู.'); return; }
  const key=teacherKeyFromObj(t);
  const serial = nextSerialFor(key);
  const hj=document.getElementById('hdrHijri').textContent.replace('ูู','').trim();
  const day=document.getElementById('dynDay').textContent.trim();
  ARCHIVE.push({
    ts: Date.now(), hj, day, kind, serial, source: source || 'manual',
    tkey: key, name: (t.name||'').trim(), civil: (t.civil||'').trim()
  });
  saveArchive();
}

/* ุฑุจุท ุงูุฑูู ูุงูุฅุฌูุงูู ุจุงููุนูู ุงูุญุงูู */
function refreshCaseNo(){ refreshHeaderCounts(); }

/* ุชุทุจูู ุงููุนูู ุงููุฎุชุงุฑ */
function applyTeacher(t, idx){
  currentIdx = idx;
  document.getElementById('schoolNameHdr').textContent = t.school || 'ูุฏุฑุณุฉ ุงููุนููุจู ุงูุซุงูููุฉ';
  const set=(id,v)=>document.getElementById(id).textContent=v||'';
  set('t_name',t.name); set('t_spec',t.spec); set('t_level',t.level||t.rank); set('t_job',t.job); set('t_work',t.work);
  document.getElementById('t_civil').textContent = t.civil || '';
  document.getElementById('afadaName').textContent = t.name || 'โ';
  document.getElementById('abs-name-top').textContent = t.name || 'โ';
  document.getElementById('abs-teacher-name').textContent = t.name || 'โ';
  /* ููุช ูุธุฑ โ ุงูุงุณู */
  document.getElementById('noteTeacherName').textContent = t.name || '';
  refreshCaseNo();
}
function refillSelect(){
  const sel=document.getElementById('teacherSelect');
  sel.innerHTML='<option value="">โ ุงุฎุชุฑ ูุนููุงู โ</option>';
  TEACHERS.forEach((t,i)=> sel.add(new Option(t.name? t.name : `ุจุฏูู ุงุณู ${i+1}`, i)));
}
refillSelect();
document.getElementById('teacherSelect').addEventListener('change',e=>{
  const i=+e.target.value; if(Number.isInteger(i)&&TEACHERS[i]) applyTeacher(TEACHERS[i], i);
});
document.getElementById('teacherSearch').addEventListener('input',e=>{
  const q=e.target.value.trim(); const sel=document.getElementById('teacherSelect');
  for(const o of sel.options){ if(!o.value){o.hidden=false;continue;} o.hidden=q && !o.text.includes(q); }
});
['t_name','t_spec','t_level','t_job','t_work','t_civil','noteTeacherName'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('blur',()=>{
    if(currentIdx==null || !TEACHERS[currentIdx]) return;
    const v=el.textContent.trim();
    if(id==='t_name' || id==='noteTeacherName'){ 
      TEACHERS[currentIdx].name=v;
      document.getElementById('t_name').textContent=v;
      document.getElementById('noteTeacherName').textContent=v;
      document.getElementById('afadaName').textContent=v||'โ';
      document.getElementById('abs-name-top').textContent=v||'โ';
      document.getElementById('abs-teacher-name').textContent=v||'โ';
    } else if(id==='t_spec'){ TEACHERS[currentIdx].spec=v; }
    else if(id==='t_level'){ TEACHERS[currentIdx].level=v; }
    else if(id==='t_job'){ TEACHERS[currentIdx].job=v; }
    else if(id==='t_work'){ TEACHERS[currentIdx].work=v; }
    else if(id==='t_civil'){ TEACHERS[currentIdx].civil=v; }
    localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
    refreshCaseNo();
  });
});

/* ุชูููู ุชุนุฏูู ุงุณู ุงููุฏูุฑ ูุฏููุงู (ููุฑุฉ ูุฒุฏูุฌุฉ) */
['managerName1','managerName2','managerName3','managerName4','managerName5','managerNameNote'].forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
  el.setAttribute('contenteditable','true');
  el.addEventListener('blur', ()=> setManagerName(el.textContent.trim()||''));
});
setManagerName(getManagerName());

/* ุชุตููุฑ ุงูุงุณุชูุฑุงุฏ */
document.getElementById('btnClearImport').addEventListener('click', ()=>{
  if(!confirm('ุชุฃููุฏ ุชุตููุฑ ุจูุงูุงุช ุงูุงุณุชูุฑุงุฏ ูุงูุฃุณูุงุกุ')) return;
  TEACHERS=[]; localStorage.removeItem('teachersCache'); refillSelect();
  ['t_name','t_spec','t_level','t_job','t_work','t_civil','afadaName','abs-name-top','abs-teacher-name','noteTeacherName'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent='';
  });
  document.getElementById('afadaName').textContent='โ';
  document.getElementById('abs-name-top').textContent='โ';
  document.getElementById('abs-teacher-name').textContent='โ';
  currentIdx=null;
  refreshCaseNo();
});

/* ===== ุงูุงุณุชูุฑุงุฏ (ููุง ูู) ===== */
const fileInput=document.getElementById('fileInput');
const drop=document.getElementById('dropZone');
const importDialog=document.getElementById('importDialog');
document.getElementById('btnImport').addEventListener('click',()=>fileInput.click());
drop.addEventListener('click', (e)=>{ if(e.target.id!=='btnImport') fileInput.click();});
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background='#f7ffff';}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background='transparent';}));
drop.addEventListener('drop',e=>{e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(f) beginImport(f);});
fileInput.addEventListener('change',e=>{if(e.target.files && e.target.files[0]) beginImport(e.target.files[0]);});

let IMPORT_CTX = {workbook:null, sheets:[], arrays:{}, headers:{}};

function detectSeparator(txt){
  const cTab=(txt.match(/\t/g)||[]).length, cSemi=(txt.match(/;/g)||[]).length, cComma=(txt.match(/,/g)||[]).length;
  if(cTab>cSemi && cTab>cComma) return '\t';
  if(cSemi>cComma) return ';';
  return ',';
}
async function readTextAllEnc(file){
  const buf=await file.arrayBuffer();
  try{ return new TextDecoder('utf-8',{fatal:false}).decode(buf); }catch{}
  try{ return new TextDecoder('windows-1256',{fatal:false}).decode(buf); }catch{}
  try{ return new TextDecoder('iso-8859-6',{fatal:false}).decode(buf); }catch{}
  return await file.text();
}
function sheetToAOA(ws){ return XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:''}); }
function pickHeaderRow(A){
  const rowsToCheck = Math.min(5, A.length);
  let bestIdx = 0, bestScore = -1;
  const keywords = ['ุงูุงุณู','ุงุณู','name','ุงููุนูู','ุงูููุธู','ุงูุณุฌู','ุงููููุฉ','ุงูุชุฎุตุต','ุงููุฑุชุจุฉ','ุงููุณุชูู','ุฑูู ุงููุธููุฉ','ุงูุนูู','ุงูุฌูุงู','ุงููุงุชู','whatsapp','mobile','phone','ุงูุฅูููู','ุงูุงูููู','ุงูุจุฑูุฏ'];
  for(let r=0;r<rowsToCheck;r++){
    const row=(A[r]||[]).join(' ').toLowerCase();
    let score=0; keywords.forEach(k=>{ if(row.includes(k)) score++; });
    if(score>bestScore){ bestScore=score; bestIdx=r; }
  }
  return bestIdx;
}
function guess(header){
  const h=(header||'').toString().trim().toLowerCase();
  const norm=h.replace(/[^\u0600-\u06FFa-z0-9 ]/g,'');
  const tests={
    name:['name','ุงูุงุณู','ุงุณู','ุงููุนูู','ูุนูู','ุงูููุธู','ููุธู'],
    civil:['civil','national','id','identity','ุงูุณุฌู','ุงูุณุฌู ุงููุฏูู','ุฑูู ุงููููุฉ','ุงููููุฉ','ูููุฉ','ุฑูู ุงูุณุฌู'],
    spec:['ุงูุชุฎุตุต','ุชุฎุตุต','subject','spec','specialty'],
    level:['ุงููุฑุชุจุฉ','ุฑุชุจุฉ','rank','grade','level','ุงููุณุชูู','ูุณุชูู','ุงูุฑุชุจู'],
    job:['ุฑูู ุงููุธููุฉ','ูุธููุฉ','job','employee id','ููุฏ','ุฑูู ูุธููู'],
    work:['ุงูุนูู ุงูุญุงูู','ุงูุนูู','work','job title','ุงููุณูู'],
    school:['ุงููุฏุฑุณุฉ','school'],
    phone:['ุงูุฌูุงู','ุงููุงุชู','ูุงุชุณุงุจ','whatsapp','mobile','phone','ุฑูู','ุฑูู ุงูุฌูุงู','ุฑูู ุงููุงุชู','contact'],
    email:['ุงูุฅูููู','ุงูุงูููู','ุงูุจุฑูุฏ','email','e-mail','mail']
  };
  for(const k in tests){ if(tests[k].some(key=>norm.includes(key))) return k; }
  return null;
}

/* === beginImport (ููุง ูู) === */
async function beginImport(file){
  try{
    const lower=(file.name||'').toLowerCase();
    let wb=null;

    if(/\.(csv|tsv|txt)$/.test(lower)){
      const text=await readTextAllEnc(file);
      const sep = detectSeparator(text);
      const rows = text.split(/\r?\n/).map(line=> line.split(sep));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wbNew = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wbNew, ws, 'ุงูุจูุงูุงุช');
      wb = wbNew;
    } else if(/\.json$/.test(lower)){
      const text=await readTextAllEnc(file);
      const data = JSON.parse(text);
      const ws = XLSX.utils.json_to_sheet(Array.isArray(data)? data : []);
      const wbNew = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wbNew, ws, 'ุงูุจูุงูุงุช');
      wb = wbNew;
    } else {
      const buf=await file.arrayBuffer();
      wb = XLSX.read(buf, {type:'array'});
    }

    if(!wb || !wb.SheetNames || !wb.SheetNames.length) throw new Error('ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃูุฑุงู ูู ุงูููู.');

    IMPORT_CTX.workbook=wb;
    IMPORT_CTX.sheets=wb.SheetNames.slice();
    IMPORT_CTX.arrays={};
    wb.SheetNames.forEach(sh=>{
      const ws=wb.Sheets[sh];
      IMPORT_CTX.arrays[sh]=sheetToAOA(ws);
    });

    openImportDialog();
  }catch(err){
    console.error(err);
    alert('ุชุนุฐูุฑ ุงุณุชูุฑุงุฏ ุงูููู. ุชุฃููุฏ ูู ุงูุตูุบุฉ ูุฃู ุงูููู ุบูุฑ ูุญูู ุจูููุฉ ูุฑูุฑ.\nุงูุชูุงุตูู: ' + (err.message||err));
  }
}

function openImportDialog(){
  const sheetSel=document.getElementById('sheetSelect');
  sheetSel.innerHTML='';
  (IMPORT_CTX.sheets.length?IMPORT_CTX.sheets:['ุงูุจูุงูุงุช']).forEach(sh=>sheetSel.add(new Option(sh,sh)));
  sheetSel.onchange=refreshMappingUI;

  ['mapName','mapCivil','mapSpec','mapLevel','mapJob','mapWork','mapSchool','mapPhone'].forEach(id=>document.getElementById(id).innerHTML='');
  refreshMappingUI();
  importDialog.style.display='flex';
  document.getElementById('btnCancelImport').onclick=()=>{ importDialog.style.display='none'; };
  document.getElementById('btnConfirmImport').onclick=confirmImport;
}
function refreshMappingUI(){
  const sheetSel=document.getElementById('sheetSelect');
  const sh=sheetSel.value || IMPORT_CTX.sheets[0] || 'ุงูุจูุงูุงุช';
  const A=(IMPORT_CTX.arrays[sh]||[]).slice(); if(!A.length){ return; }

  const headerRowIdx = pickHeaderRow(A);
  const HEADS = (A[headerRowIdx]||[]).map(x=>String(x||'').trim());
  const ROWS  = A.slice(headerRowIdx+1, headerRowIdx+1+20);

  const fillSel=id=>{ const el=document.getElementById(id); el.innerHTML='<option value="">โ ุงุฎุชุฑ ุนููุฏูุง โ</option>'; HEADS.forEach((h,i)=>el.add(new Option(h||`ุนููุฏ ${i+1}`, i))); return el; };
  const sName=fillSel('mapName'), sCivil=fillSel('mapCivil'), sSpec=fillSel('mapSpec'),
        sLevel=fillSel('mapLevel'), sJob=fillSel('mapJob'), sWork=fillSel('mapWork'),
        sSchool=fillSel('mapSchool'), sPhone=fillSel('mapPhone');

  const idxByRole={}; HEADS.forEach((h,i)=>{ const r=guess(h); if(r && idxByRole[r]==null) idxByRole[r]=i; });
  if(idxByRole.name!=null) sName.value=idxByRole.name;
  if(idxByRole.civil!=null) sCivil.value=idxByRole.civil;
  if(idxByRole.spec!=null) sSpec.value=idxByRole.spec;
  if(idxByRole.level!=null) sLevel.value=idxByRole.level;
  if(idxByRole.job!=null) sJob.value=idxByRole.job;
  if(idxByRole.work!=null) sWork.value=idxByRole.work;
  if(idxByRole.school!=null) sSchool.value=idxByRole.school;
  if(idxByRole.phone!=null) sPhone.value=idxByRole.phone;

  const table=document.getElementById('previewTable');
  table.innerHTML='';
  const thead=document.createElement('thead'); const hr=document.createElement('tr');
  HEADS.forEach(h=>{const th=document.createElement('th'); th.textContent=h||''; hr.appendChild(th);});
  thead.appendChild(hr); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  ROWS.forEach(r=>{
    const tr=document.createElement('tr');
    HEADS.forEach((_,i)=>{const td=document.createElement('td'); td.textContent=(r[i]!=null?r[i]:''); tr.appendChild(td);});
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  IMPORT_CTX.headers={sheet:sh, headerRowIdx, heads:HEADS};
}
function normalizePhone(raw){
  if(!raw) return '';
  let s = String(raw).trim();
  s = ar2en(s).replace(/[^\d]/g,'');
  if(s.startsWith('00966')) s = s.slice(2);
  if(s.startsWith('00')) s = s.slice(2);
  if(s.startsWith('966')) { if(s.length===13 && s[3]==='0') s='966'+s.slice(4); return s; }
  if(s.startsWith('05') && s.length===10) return '966'+s.slice(1);
  if(s.startsWith('5')  && s.length===9 ) return '966'+s;
  return s;
}
function confirmImport(){
  try{
    const ctx=IMPORT_CTX.headers||{};
    const A=IMPORT_CTX.arrays[ctx.sheet]||[];
    if(!A.length){ alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ูู ุงููุฑูุฉ ุงููุญุฏุฏุฉ.'); return; }

    const getIdx = id => { const v=document.getElementById(id).value; return v? parseInt(v,10): -1; };
    const ixName=getIdx('mapName'), ixCivil=getIdx('mapCivil'), ixSpec=getIdx('mapSpec'),
          ixLevel=getIdx('mapLevel'), ixJob=getIdx('mapJob'), ixWork=getIdx('mapWork'),
          ixSchool=getIdx('mapSchool'), ixPhone=getIdx('mapPhone');

    const start = (ctx.headerRowIdx!=null? ctx.headerRowIdx+1 : 1);
    const out=[];
    for(let r=start;r<A.length;r++){
      const row=A[r]||[]; if(!row.some(c=>String(c||'').trim())) continue;
      const pick=i=> (i>=0 && i<row.length)? String(row[i]??'').trim() : '';
      out.push({
        name:pick(ixName),
        civil:pick(ixCivil),
        spec:pick(ixSpec),
        level:pick(ixLevel),
        job:pick(ixJob),
        work:pick(ixWork),
        school:pick(ixSchool),
        phone:normalizePhone(pick(ixPhone))
      });
    }
    TEACHERS=out.filter(t=> (t.name||t.civil||t.spec||t.level||t.job||t.work||t.phone));
    localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
    refillSelect();
    importDialog.style.display='none';
    if(TEACHERS.length){ document.getElementById('teacherSelect').value='0'; applyTeacher(TEACHERS[0],0); }
    else alert('ุชู ุงูุงุณุชูุฑุงุฏุ ูููู ูู ูุชู ุงูุนุซูุฑ ุนูู ุตููู ุจูุงูุงุช ุตุงูุญุฉ ุจุนุฏ ุงูุชุญูู ูู ุงูุฎุฑุงุฆุท.');
  }catch(err){
    console.error(err);
    alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุนุชูุงุฏ ุงูุงุณุชูุฑุงุฏ: ' + (err.message||err));
  }
}

/* ===== ุชุจุฏูู ููุน ุงูุฅุฌุฑุงุก ===== */
const segEl   = document.getElementById('noticeSeg');
const radios  = segEl.querySelectorAll('input[name="nt"]');
const kindLbl = document.getElementById('kindTitle');
const mainTitle = document.getElementById('mainTitle');
const alertPack = document.getElementById('alertPack');
const absencePack = document.getElementById('absencePack');
const notePack = document.getElementById('notePack');
const rowLate  = document.getElementById('lineLate');
const rowAbs   = document.getElementById('lineAbs');
const rowEarly = document.getElementById('lineEarly');

function setNotice(kind){
  // ุฅุธูุงุฑ ุงูุตูุญุฉ ุงููุทููุจุฉ ุฏูู ุฅุฎูุงุก ุฏุงุฆู ูุฃู ุตูุญุฉ โ ุงูุชูููู ุขูู
  alertPack.style.display   = (kind==='late' || kind==='absent' || kind==='early') ? 'block':'none';
  absencePack.style.display = (kind==='gaib') ? 'block':'none';
  notePack.style.display    = (kind==='note') ? 'block':'none';

  if(kind==='gaib'){
    mainTitle.textContent = 'ูุณุงุกูุฉ ุบูุงุจ';
  }else if(kind==='note'){
    mainTitle.textContent = 'ููุช ูุธุฑ';
  }else{
    mainTitle.textContent = 'ุชูุจูู';
  }

  // ุนููุงู ุงูููุน ุฏุงุฎู ุฎุทุงุจ ุงูุชูุจูู
  if(kind==='late'){ kindLbl.textContent='ุชุฃุฎุฑ'; }
  else if(kind==='absent'){ kindLbl.textContent='ุนุฏู ุชูุงุฌุฏ'; }
  else if(kind==='early'){ kindLbl.textContent='ุงูุตุฑุงู ูุจูุฑ'; }

  rowLate.style.display  = (kind==='late')   ? 'flex' : 'none';
  rowAbs.style.display   = (kind==='absent') ? 'flex' : 'none';
  rowEarly.style.display = (kind==='early')  ? 'flex' : 'none';

  refreshCaseNo();
}
radios.forEach(r => r.addEventListener('change', e => setNotice(e.target.value)));
setNotice(segEl.querySelector('input[name="nt"]:checked')?.value || 'late');

/* ===== PDF ุจุฌูุฏุฉ ุนุงููุฉ (ูุญุงูุธ ุนูู ุงูุนุฑุจูุฉ/RTL) ===== */
async function exportPDFBlob(){
  const root=document.documentElement;
  const prevScale = getComputedStyle(root).getPropertyValue('--scale');
  root.style.setProperty('--scale','1'); document.body.classList.add('exporting');
  const sheet=document.getElementById('sheet');
  const canvas = await html2canvas(sheet,{scale:4,useCORS:true,background:'#ffffff',logging:false,letterRendering:true});
  document.body.classList.remove('exporting'); root.style.setProperty('--scale', prevScale||'1');
  const img = canvas.toDataURL('image/jpeg',1.0);
  const {jsPDF}=window.jspdf; const pdf=new jsPDF('p','mm','a4');
  const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
  const px2mm=px=>px*25.4/96, imgWmm=px2mm(canvas.width), imgHmm=px2mm(canvas.height);
  const s=Math.min(pageW/imgWmm,pageH/imgHmm), w=imgWmm*s, h=imgHmm*s;
  pdf.addImage(img,'JPEG',(pageW-w)/2,(pageH-h)/2,w,h);
  return pdf.output('blob');
}
document.getElementById('btnMakePDF').addEventListener('click', async ()=>{
  const kind=document.querySelector('input[name="nt"]:checked')?.value || 'late';
  recordCase(kind,'PDF');
  const name=(document.getElementById('t_name').textContent||document.getElementById('noteTeacherName').textContent||'ุจุฏูู ุงุณู').trim();
  const hj=(document.getElementById('hdrHijri').textContent||'ุงูุชุงุฑูุฎ ุงููุฌุฑู').trim();
  const fileName=`${BASE_TITLE} โ ${document.getElementById('mainTitle').textContent} โ ${name} โ ${hj}.pdf`;
  const blob=await exportPDFBlob();
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=fileName; a.click(); URL.revokeObjectURL(url);
});

/* ===== ูุคููุช ูุญุณุงุจุงุช (ููุง ูู) ===== */
let active=null; const pad=document.getElementById('timePad'),disp=document.getElementById('timePadDisplay');
document.querySelectorAll('.timebox').forEach(el=>el.addEventListener('click',()=>openPad(el)));
function openPad(el){active=el;disp.textContent=el.dataset.value||'--:--';pad.style.display='block';const r=el.getBoundingClientRect();pad.style.left=Math.min(window.innerWidth-220,r.left)+'px';pad.style.top=(r.bottom+8)+'px';}
function closePad(){pad.style.display='none';active=null;}
document.getElementById('timePadClose').addEventListener('click',closePad);
document.getElementById('timePadSave').addEventListener('click',()=>{if(!active) return; const v=disp.textContent; active.textContent=v; active.classList.toggle('empty',!/\d\d:\d\d/.test(v)); active.dataset.value=v; recalc(); closePad();});
document.querySelectorAll('#timePad .grid button').forEach(b=>b.addEventListener('click',()=>{
  if(b.classList.contains('del')){disp.textContent=disp.textContent.slice(0,-1)||'--:--';return;}
  const k=b.dataset.k; let v=disp.textContent.replace(/-/g,'').replace(/:/g,''); if(disp.textContent==='--:--') v='';
  if(k===':'){if(v.length>=2 && !v.includes(':')) disp.textContent=v.slice(0,2)+':'+v.slice(2); return;}
  if(/[0-9]/.test(k)){v+=k; if(v.length<=4){disp.textContent=(v.padEnd(4,'-').slice(0,2))+':'+(v.padEnd(4,'-').slice(2,4));}}
}));
const t2m=t=>{ if(!/^\d{2}:\d{2}$/.test(t||'')) return null; const [h,m]=t.split(':').map(Number); return h*60+m; };
const fmtDur=mins=>{ mins=Math.max(0,Math.round(mins||0)); const h=Math.floor(mins/60),m=mins%60; return h?(m?`${h} ุณุงุนุฉ ู ${m} ุฏูููุฉ`:`${h} ุณุงุนุฉ`):`${m} ุฏูููุฉ`; };
function recalc(){
  const ws=document.getElementById('workStart')?.value||'06:45';
  const we=document.getElementById('workEnd')?.value||'13:45';
  const mWS=t2m(ws), mWE=t2m(we);
  const mLate=t2m((document.getElementById('tLateIn')?.dataset.value)||'');
  const late = (mWS!=null && mLate!=null) ? Math.max(0, mLate - mWS) : 0;
  const mAF=t2m((document.getElementById('tAbsFrom')?.dataset.value)||'');
  const mAT=t2m((document.getElementById('tAbsTo')?.dataset.value)||'');
  const abs = (mAF!=null && mAT!=null) ? Math.max(0, mAT - mAF) : 0;
  const mEF=t2m((document.getElementById('tEarlyFrom')?.dataset.value)||'');
  const early = (mWE!=null && mEF!=null) ? Math.max(0, mWE - mEF) : 0;
  document.getElementById('lateTotal').textContent  = fmtDur(late);
  document.getElementById('absTotal').textContent   = fmtDur(abs);
  document.getElementById('earlyTotal').textContent = fmtDur(early);
}
recalc();

/* ===== ุฑุณุงูุฉ ูุงุชุณุงุจ โ ุฏุนู ยซููุช ูุธุฑยป ุฃูุถุงู ===== */
function beautifyTime(t){ return en2ar((t||'--:--')); }
function buildWhatsAppMessage(){
  const school = (document.getElementById('schoolNameHdr').textContent||'ูุฏุฑุณุฉ ุงููุนููุจู ุงูุซุงูููุฉ').trim();
  const name   = (document.getElementById('t_name').textContent||document.getElementById('noteTeacherName').textContent||'โ').trim();
  const kind   = document.querySelector('input[name="nt"]:checked')?.value || 'late';
  const hj     = (document.getElementById('hdrHijri').textContent||'โ').replace(/\s+/g,' ').trim();
  const dayName= (document.getElementById('dynDay').textContent||'โ').trim();
  const serial = (document.getElementById('serialNo').textContent||'01').trim();
  const total  = (document.getElementById('caseTotal').textContent||'0').trim();
  const ws     = beautifyTime(document.getElementById('workStart')?.value||'--:--');
  const we     = beautifyTime(document.getElementById('workEnd')?.value||'--:--');

  if(kind==='note'){
    const reason = document.getElementById('noteReasonText').textContent.trim();
    return `ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู

ุงูุฃุณุชุงุฐ/ ${name} ุญูุธู ุงูููุ

ูููุฏูู ุจุตุฏูุฑ ยซููุช ูุธุฑยป ุฑูู (${en2ar(serial)}) ูู ${school} ููู ${dayName} ุงูููุงูู ${hj}.
ุงููุต: ููุญุธ ุนุฏู ูุจุงุดุฑุชูู ุฃุฏุงุก ${reason} ููู ุงูุชุนูููุงุช ุงููุนุชูุฏุฉ.

ูุฃูู ุชูุงูู ุฐูู ูุณุชูุจููุง ูุงูุงูุชุฒุงู ุจุงูููุงู ุงููุธูููุฉ. ูุน ุงูุดูุฑ ูุงูุชูุฏูุฑ.

ูุฏูุฑ ุงููุฏุฑุณุฉ:
${getManagerName()}

ุฅุฌูุงูู ุงูุฅุฌุฑุงุกุงุช ุญุชู ุชุงุฑูุฎู: ${en2ar(total)}.`;
  }

  let body='';
  if(kind==='gaib'){
    body =
`ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู

ุงูุฃุณุชุงุฐ/ ${name} ูููู ุงูููุ

ูููุฏูู ุจูุฌูุฏ ูุณุงุกูุฉ ุบูุงุจ ุจุฑูู (${en2ar(serial)}) ูู ${school}.
ูุฐูู ููู ${dayName} ุงูููุงูู ${hj}ุ ููุฏ ุชู ุชุณุฌูู ุบูุงุจูู ุนู ุงูุนูู ูู ุฐูู ุงูููู.

ูุฃูู ุงูุชูุฑูู ุจูุฑุงุฌุนุฉ ูุฏูุฑ ุงููุฏุฑุณุฉ ูุชูุฏูู ุฅูุงุฏุชูู ุฎูุงู ุงููุฏุฉ ุงููุธุงููุฉ (ูง ุฃูุงู).

ูุฏูุฑ ุงููุฏุฑุณุฉ:
${getManagerName()}

ุฅุฌูุงูู ูุณุงุกูุงุชูู ุญุชู ุชุงุฑูุฎู: ${en2ar(total)}.`;
  }
  else if(kind==='late'){
    const tIn = beautifyTime(document.getElementById('tLateIn').dataset.value||'--:--');
    const dur = (document.getElementById('lateTotal').textContent||'โ');
    body =
`ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู

ุงูุฃุณุชุงุฐ/ ${name} ูููู ุงูููุ

ูููุฏูู ุจูุฌูุฏ ุชูุจูู ุชุฃุฎุฑ ุจุฑูู (${en2ar(serial)}) ูู ${school}.
ููู ${dayName} ุงูููุงูู ${hj}.
ุจุฏุงูุฉ ุงูุฏูุงู: (${ws}) โ ููุช ุญุถูุฑูู: (${tIn}) โ ุฅุฌูุงูู ุงูุชุฃุฎุฑ: ${dur}.

ูุฃูู ูุฑุงุฌุนุฉ ุงูุฅุฏุงุฑุฉ ูุชูุฏูู ุงูุฅูุงุฏุฉ ุฎูุงู (ูง ุฃูุงู).

ูุฏูุฑ ุงููุฏุฑุณุฉ:
${getManagerName()}

ุฅุฌูุงูู ูุณุงุกูุงุชูู ุญุชู ุชุงุฑูุฎู: ${en2ar(total)}.`;
  }
  else if(kind==='absent'){
    const from = beautifyTime(document.getElementById('tAbsFrom').dataset.value||'--:--');
    const to   = beautifyTime(document.getElementById('tAbsTo').dataset.value||'--:--');
    const dur  = (document.getElementById('absTotal').textContent||'โ');
    body =
`ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู

ุงูุฃุณุชุงุฐ/ ${name} ูููู ุงูููุ

ูููุฏูู ุจูุฌูุฏ ุชูุจูู ุนุฏู ุชูุงุฌุฏ ุจุฑูู (${en2ar(serial)}) ูู ${school}.
ููู ${dayName} ุงูููุงูู ${hj}.
ูุฏุฉ ุนุฏู ุงูุชูุงุฌุฏ ูู (${from}) ุฅูู (${to}) โ ุงูุฅุฌูุงูู: ${dur}.

ูุฃูู ูุฑุงุฌุนุฉ ุงูุฅุฏุงุฑุฉ ูุชูุฏูู ุงูุฅูุงุฏุฉ ุฎูุงู (ูง ุฃูุงู).

ูุฏูุฑ ุงููุฏุฑุณุฉ:
${getManagerName()}

ุฅุฌูุงูู ูุณุงุกูุงุชูู ุญุชู ุชุงุฑูุฎู: ${en2ar(total)}.`;
  }
  else { // early
    const from = beautifyTime(document.getElementById('tEarlyFrom').dataset.value||'--:--');
    const dur  = (document.getElementById('earlyTotal').textContent||'โ');
    body =
`ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู

ุงูุฃุณุชุงุฐ/ ${name} ูููู ุงูููุ

ูููุฏูู ุจูุฌูุฏ ุชูุจูู ุงูุตุฑุงู ูุจูุฑ ุจุฑูู (${en2ar(serial)}) ูู ${school}.
ููู ${dayName} ุงูููุงูู ${hj}.
ููุช ุงูุงูุตุฑุงู: (${from}) โ ููุงูุฉ ุงูุฏูุงู ุงููุธุงููุฉ: (${we}) โ ูุฏุฉ ุงูุงูุตุฑุงู ุงููุจูุฑ: ${dur}.

ูุฃูู ูุฑุงุฌุนุฉ ุงูุฅุฏุงุฑุฉ ูุชูุฏูู ุงูุฅูุงุฏุฉ ุฎูุงู (ูง ุฃูุงู).

ูุฏูุฑ ุงููุฏุฑุณุฉ:
${getManagerName()}

ุฅุฌูุงูู ูุณุงุกูุงุชูู ุญุชู ุชุงุฑูุฎู: ${en2ar(total)}.`;
  }

  return body;
}
function getCurrentTeacherPhone(){
  if(currentIdx==null || !TEACHERS[currentIdx]) return '';
  return TEACHERS[currentIdx].phone || '';
}
document.getElementById('btnWA').addEventListener('click', ()=>{
  if(currentIdx==null){ alert('ูุฑุฌู ุงุฎุชูุงุฑ ูุนููู ุฃููุงู ูู ุงููุงุฆูุฉ.'); return; }
  const kind=document.querySelector('input[name="nt"]:checked')?.value || 'late';
  recordCase(kind,'WA');

  let phone = getCurrentTeacherPhone();
  if(!phone){
    alert('ูุง ููุฌุฏ ุฑูู ุฌูุงู ูููุนููู ูู ุงููููุ ุณููุณุชุฎุฏู ุงูุฑูู ุงูุงูุชุฑุงุถู ูุคูุชูุง.');
    phone = DEFAULT_WA;
  }
  const msg=buildWhatsAppMessage();
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
});

/* ===== ุฅุญุตุงุฆูุงุช ูุฃุฑุดูู โ ุฏุนู ููุน note ===== */
const dlgStats=document.getElementById('statsDialog');
const btnOpenStats=document.getElementById('btnOpenStats');
const btnCloseStats=document.getElementById('btnCloseStats');
const statsFilter=document.getElementById('statsFilter');
const tblArchiveBody=document.querySelector('#tblArchive tbody');
const tblSummaryBody=document.querySelector('#tblSummary tbody');

btnOpenStats.addEventListener('click',()=>{ renderStatsTables(); dlgStats.style.display='flex'; });
btnCloseStats.addEventListener('click',()=>{ dlgStats.style.display='none'; });

document.getElementById('btnExportArchive').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(ARCHIVE,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ุงุฑุดูู_ูุณุงุกูุงุช_ุงููุนูููู.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('restoreInput').parentElement.addEventListener('click', ()=> document.getElementById('restoreInput').click());
document.getElementById('restoreInput').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(Array.isArray(data)){ ARCHIVE=data; saveArchive(); renderStatsTables(); alert('ุชูุช ุงูุงุณุชุนุงุฏุฉ ุจูุฌุงุญ.'); }
      else alert('ุงูููู ุบูุฑ ุตุงูุญ.');
    }catch{ alert('ุชุนุฐุฑ ูุฑุงุกุฉ ุงูููู.'); }
  };
  r.readAsText(f);
});
document.getElementById('btnResetAll').addEventListener('click', ()=>{
  if(!confirm('ุณูุชู ุญุฐู ูู ุงูุฃุฑุดูู ูุฌููุน ุงูุนุฏุงุฏุงุช. ูู ุฃูุช ูุชุฃูุฏุ')) return;
  ARCHIVE=[]; saveArchive(); renderStatsTables(); alert('ุชู ุงูุชุตููุฑ.');
});
statsFilter.addEventListener('input', renderStatsTables);

function renderStatsTables(){
  const q=(statsFilter.value||'').trim();
  const filtered = ARCHIVE.slice().sort((a,b)=>b.ts-a.ts).filter(e=> !q || (e.name||'').includes(q));

  // ุฃุฑุดูู ุชูุตููู
  tblArchiveBody.innerHTML='';
  filtered.forEach(e=>{
    const tr=document.createElement('tr');
    const typeText = e.kind==='gaib'?'ูุณุงุกูุฉ ุบูุงุจ': e.kind==='late'?'ุชูุจูู ุชุฃุฎุฑ': e.kind==='absent'?'ุชูุจูู ุนุฏู ุชูุงุฌุฏ': e.kind==='early'?'ุชูุจูู ุงูุตุฑุงู ูุจูุฑ':'ููุช ูุธุฑ';
    tr.innerHTML = `<td>${e.hj}</td><td>${e.name||''}</td><td>${e.civil||''}</td><td>${typeText}</td><td>${pad2(e.serial)}</td>`;
    tblArchiveBody.appendChild(tr);
  });

  // ููุฎุต ุญุณุจ ุงููุนูู (ุฃุถููุง ุนููุฏ ููุช ูุธุฑ)
  const map=new Map();
  for(const e of ARCHIVE){
    const k=e.tkey; if(!map.has(k)) map.set(k,{name:e.name||'',civil:e.civil||'',gaib:0,late:0,absent:0,early:0,note:0,total:0});
    const row=map.get(k); row[e.kind]=(row[e.kind]||0)+1; row.total++;
  }
  const rows=[...map.values()].sort((a,b)=> b.total-a.total);
  tblSummaryBody.innerHTML='';
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.civil}</td><td>${r.gaib||0}</td><td>${r.late||0}</td><td>${r.absent||0}</td><td>${r.early||0}</td><td>${r.note||0}</td><td><strong>${r.total||0}</strong></td>`;
    tblSummaryBody.appendChild(tr);
  }
  refreshHeaderCounts();
}

/* ===== ููุช ุงููุธุฑ โ ููุทู ุฏูุฌ ุงูุณุจุจ ===== */
const noteSelect = document.getElementById('noteReasonSelect');
const noteText   = document.getElementById('noteReasonText');
noteSelect.addEventListener('change', ()=>{
  const v = noteSelect.value.trim();
  noteText.textContent = v ? v : 'ุงููููุฉ ุงููุญุฏุฏุฉ';
});

/* ===== ุนูุฏ ุงูุจุฏุก ===== */
refreshHeaderCounts();
</script>
</body>
</html>
