<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>تنبيه — (و.م.ع.ن.-02-03)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --moe:#0b7e88; --ink:#111; --label:#064c50;
  --bg:#f7fafc; --content:190mm; --nudgeX:0mm;
}
*{box-sizing:border-box}
html,body{
  margin:0;background:var(--bg);color:var(--ink);
  font:13.8px/1.9 "Tajawal","Noto Sans Arabic","Noto Naskh Arabic",system-ui;
  -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
}
.sheet-wrap{display:grid;place-items:center;margin:10mm 0}
.sheet{width:210mm;min-height:297mm;background:#fff;transform:translateX(var(--nudgeX))}

/* الهيدر */
.header{padding:9mm 12mm 6mm;border-bottom:2px solid #eaf1f1}
.header .row{display:flex;justify-content:space-between;align-items:center;gap:10mm}
.header .row>div{width:50%}
.org{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:var(--label);transform:translateX(12mm)}
.org .l1{font-weight:900;font-size:16px}
.org .l2{font-weight:900}
.org .l3{font-weight:800}
.meta{text-align:left}
.meta-item{display:block;white-space:nowrap;margin:0 0 2px}
.meta-item .label{font-weight:900;color:var(--label);margin-left:4px}
.meta-item .value{font-weight:900}
.case-total{margin-top:4px;font-size:10.8px;color:#2f4f4b}

/* شريط الأدوات */
.toolbar{position:sticky;top:0;z-index:10;display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:10px 12mm;background:#fff;border-bottom:1px solid #eee}
.toolbar button{border:0;border-radius:10px;padding:9px 12px;cursor:pointer;background:var(--moe);color:#fff;font-weight:800}
.toolbar .secondary{background:#eef7f7;color:#0b5e63;border:1px solid #d7ecec}
.toolbar input[type=file]{display:none}
.toolbar .hint{font-size:12px;color:#6b7280}
.select,.search,.t{padding:8px 10px;border:1px solid #d7ecec;border-radius:10px;background:#fff}
.toolbar-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;width:100%}
.controls-row{width:100%;display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:8px;padding-top:6px;border-top:1px dashed #e5efef}
.controls-row .block{display:flex;align-items:center;gap:6px}
.controls-row .pack{display:flex;align-items:center;gap:4px}

/* الصفحة الداخلية */
.page{padding:6mm 0 10mm;display:grid;place-items:center}
.content{width:var(--content);margin:0 auto}

/* عنوان */
.notice-center{width:var(--content);margin:5mm auto 2mm;display:flex;flex-direction:column;align-items:center;gap:6px}
.notice-center .title{font-weight:900;font-size:28px;line-height:1.1;color:#0b5e63;filter:contrast(120%)}
.seg{display:inline-flex;background:#eef7f7;border:1px solid #d7ecec;border-radius:999px;overflow:hidden}
.seg input{display:none}
.seg label{padding:10px 16px;cursor:pointer;font-weight:800;color:#0b5e63;user-select:none}
.seg input:checked+label{background:#0b7e88;color:#fff}

/* جدول بيانات المعلم */
.table-wrap{width:var(--content);margin:4mm auto 0;display:flex;justify-content:center}
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl thead th{
  background:#0b5e63;color:#fff;border:1.2px solid #244a4a;
  padding:6px 7px;text-align:center;font-weight:900;font-size:13px
}
.tbl td{
  border:1.2px solid #3f5b57;padding:5px 7px;vertical-align:middle;
  height:12mm;font-size:13.2px;line-height:1.55;background:#fff;text-align:center
}
.tbl thead th.name,.tbl td.name{width:38%}
.tbl thead th.spec,.tbl td.spec{width:14%}
.tbl thead th.level,.tbl td.level{width:16%}
.tbl thead th.job,.tbl td.job{width:16%}
.tbl thead th.work,.tbl td.work{width:16%}
.tbl td span[contenteditable]{display:block;outline:none;overflow-wrap:anywhere;word-break:break-word;font-weight:700}
.tbl td.name span[contenteditable]{font-size:15.5px;font-weight:900}

/* السجل المدني — خارج الجدول تحت الاسم (مزاح يمين) */
.below-flex{
  width:var(--content);
  margin:2mm auto 0;
  display:flex;
  flex-direction:row-reverse;
  justify-content:flex-end;
}
.civil-badge{
  width:38%;
  display:flex; align-items:center; gap:10px; justify-content:center;
  border:1.5px solid var(--moe);
  background:#fff;
  color:#0b3340;
  border-radius:12px; min-height:9.5mm; padding:3px 6px;
}
.civil-badge .labTag{
  background:var(--moe); color:#fff; font-weight:900;
  padding:2px 10px; border-radius:8px; white-space:nowrap
}
.civil-badge .civilValue{
  background:#fff;
  padding:0 6px; border-radius:6px; min-width:42mm;
  display:inline-block; text-align:center; font-weight:900
}

/* أقسام التنبيه الأصلي */
.sec{width:var(--content);margin:6mm auto;padding:0}
.sec h3{margin:0 0 8px;color:#0b5e63}
.sec h3 .kind{color:#0b7e88}
.rule-row{display:flex;align-items:center;gap:8px;margin-top:4px}
.rule-row .label{font-weight:900;white-space:nowrap}
.rule-row .dots{flex:1;border-bottom:1px dotted #9fb7b3;height:0}
.rule-row .leftnote{white-space:nowrap}
.dotfield{display:inline-block;min-width:28mm;border-bottom:1px dotted #9fb7b3;text-align:center;padding:0 2mm}
.checks{margin:6px 0 8px}
.checkline{display:flex;align-items:flex-start;gap:8px;margin:6px 0}
.checkline input{margin-top:4px;transform:scale(1.15)}
.checkline .text{flex:1}
.calc{font-weight:900;color:#0b5e63}
.timebox{display:inline-block;min-width:28mm;text-align:center;padding:.5mm 3mm;background:#fff;color:#111;font-weight:900;border-radius:6px;border:1px solid #000;font-family:ui-monospace,Consolas,monospace}
.timebox.empty{color:#777;border-color:#bbb}

/* حزمة “مساءلة غياب” */
.abs-pack{width:var(--content);margin:6mm auto}
.abs-pack h3{margin:0 0 8px;color:#0b5e63}
.abs-pack .para{margin:0 0 6px}
.abs-pack .lines{min-height:28mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe}
.abs-pack .lines div{height:10mm;border-bottom:1px dotted #9fb7b3}
.abs-pack .lines div:last-child{border-bottom:0}
.abs-pack .choices label{display:block;margin:6px 0}
.abs-pack .note{color:#374151;font-size:11.2px;line-height:1.85;margin-top:6mm}

/* تذييل مرئي فقط */
.rights{width:var(--content);margin:2mm auto 8mm;text-align:center;font-size:9.2px;color:#6b7280;font-weight:700}
@media print{ .rights{display:none !important} }
body.exporting .rights{display:none !important}
body.exporting .seg{display:none !important}

/* طباعة */
@media print{
  @page{size:A4;margin:9mm}
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  body{background:#fff;color:#000}
  .toolbar{display:none !important}
  .sheet-wrap{margin:0}
  .sheet{margin:0;transform:translateX(var(--nudgeX))}
  .page{padding:0;display:block}
  :root{--content:190mm}
  .content,.notice-center,.table-wrap,.below-flex,.sec,.abs-pack{width:var(--content) !important;margin:0 auto !important}
  .tbl td,.tbl th{border-color:#000 !important}
}
</style>
</head>
<body>

<!-- شريط الأدوات -->
<div class="toolbar">
  <div class="toolbar-row">
    <button id="btnPrint">🖨️ طباعة / حفظ PDF</button>
    <button id="btnMakePDF" class="secondary">📄 إنشاء PDF</button>
    <button id="btnWA" class="secondary">📲 واتساب</button>
    <button id="btnResetCases" class="secondary">↺ تصفير المساءلات</button>
    <button id="btnClearImport" class="secondary" title="مسح الأسماء/البيانات">🧹 تصفير الاستيراد</button>

    <div class="drop" id="dropZone">
      <button id="btnImport" class="secondary">⬆️ استيراد ملفات</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.ods,.csv,.tsv,.json">
      <span class="hint">أفلت الملف هنا أو اضغط للاستيراد</span>
    </div>

    <span class="hint">ابحث واختر معلماً:</span>
    <input id="teacherSearch" class="search" placeholder="ابحث بالاسم…">
    <select id="teacherSelect" class="select" style="min-width:220px">
      <option value="">— اختر معلماً —</option>
    </select>
  </div>

  <div class="controls-row">
    <div class="block">
      <span class="hint">تاريخ الواقعة (هجري):</span>
      <div class="pack">
        <select id="hjDay" class="select"></select>
        <select id="hjMonth" class="select"></select>
        <select id="hjYear" class="select"></select>
      </div>
    </div>
    <div class="block"><span class="hint">بداية الدوام:</span><input id="workStart" class="t" type="time" value="06:45" step="60"></div>
    <div class="block"><span class="hint">نهاية الدوام:</span><input id="workEnd" class="t" type="time" value="13:45" step="60"></div>
  </div>
</div>

<div class="sheet-wrap">
  <div class="sheet" id="sheet">
    <!-- الهيدر -->
    <div class="header">
      <div class="row">
        <div class="org">
          <div class="l1">المملكة العربية السعودية</div>
          <div class="l2">وزارة التعليم</div>
          <div class="l3">الإدارة العامة للتعليم بالمنطقة الشرقية</div>
          <div class="l3" id="schoolNameHdr">مدرسة اليعقوبي الثانوية</div>
        </div>
        <div class="meta">
          <div class="meta-item"><span class="label">الرقم:</span><span class="value" id="serialNo">01</span></div>
          <div class="meta-item"><span class="label">التاريخ:</span><span class="value" id="hdrHijri">١٤٤٧/٠٤/١٣ هـ</span></div>
          <!-- تمت إزالة سطر "اسم النموذج / رمز النموذج" نهائياً -->
          <div class="case-total">إجمالي مساءلات المعلم: <strong id="caseTotal">0</strong></div>
        </div>
      </div>
    </div>

    <div class="page">
      <div class="content">

        <!-- عنوان واختيار النوع -->
        <div class="notice-center">
          <div class="title" id="mainTitle">تنبيه</div>
          <div class="seg" id="noticeSeg">
            <input type="radio" name="nt" id="nt-gaib"  value="gaib"><label for="nt-gaib">غياب</label>
            <input type="radio" name="nt" id="nt-late"  value="late" checked><label for="nt-late">تأخر</label>
            <input type="radio" name="nt" id="nt-abs"   value="absent"><label for="nt-abs">عدم تواجد</label>
            <input type="radio" name="nt" id="nt-early" value="early"><label for="nt-early">انصراف مبكر</label>
          </div>
        </div>

        <!-- جدول بيانات المعلم -->
        <div class="table-wrap">
          <table class="tbl" aria-label="بيانات الموظف">
            <thead>
              <tr>
                <th class="name">الاسم</th>
                <th class="spec">التخصص</th>
                <th class="level">المرتبة</th>
                <th class="job">رقم الوظيفة</th>
                <th class="work">العمل الحالي</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="name"><span id="t_name"  contenteditable="true"></span></td>
                <td class="spec"><span id="t_spec"  contenteditable="true"></span></td>
                <td class="level"><span id="t_level" contenteditable="true"></span></td>
                <td class="job"><span  id="t_job"   contenteditable="true"></span></td>
                <td class="work"><span id="t_work"  contenteditable="true"></span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- السجل المدني أسفل الاسم خارج الجدول -->
        <div class="below-flex">
          <div class="civil-badge">
            <span class="labTag">السجل المدني</span>
            <span id="t_civil" class="civilValue" contenteditable="true"></span>
          </div>
        </div>

        <!-- (أ) حزمة التنبيه -->
        <div id="alertPack">
          <div class="sec">
            <h3>( 1 ) خطاب التنبيه — <span class="kind" id="kindTitle">تأخر</span></h3>

            <div class="rule-row">
              <span class="label">المكرم المعلم :</span>
              <span class="dots"></span>
              <span class="leftnote">وفقه الله</span>
            </div>

            <p style="margin:6px 0 2px"><strong>السلام عليكم ورحمة الله وبركاته</strong></p>
            <p style="margin:0 0 6px">وبعد :</p>

            <p style="margin:0 0 6px">
              إنه في يوم
              <span class="dotfield" id="dayField"><span id="dynDay">—</span></span>
              الموافق
              <span class="dotfield" id="hijriField"><span id="dynHijri">—</span> هـ</span>
              :
            </p>

            <div class="checks">
              <label id="lineLate" class="checkline">
                <input type="checkbox" checked>
                <span class="text">
                  تأخركم من بداية العمل، وحضوركم الساعة ( <span id="tLateIn" class="timebox empty">--:--</span> ).
                  <span class="calc">— إجمالي التأخر: <span id="lateTotal">0 دقيقة</span></span>
                </span>
              </label>

              <label id="lineAbs" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  عدم تواجدكم أثناء العمل من الساعة : ( <span id="tAbsFrom" class="timebox empty">--:--</span> )
                  إلى الساعة : ( <span id="tAbsTo" class="timebox empty">--:--</span> ).
                  <span class="calc">— مدة عدم التواجد: <span id="absTotal">0 دقيقة</span></span>
                </span>
              </label>

              <label id="lineEarly" class="checkline" style="display:none">
                <input type="checkbox" checked>
                <span class="text">
                  انصرافكم مبكرًا قبل نهاية العمل من الساعة : ( <span id="tEarlyFrom" class="timebox empty">--:--</span> ).
                  <span class="calc">— مدة الانصراف المبكر: <span id="earlyTotal">0 دقيقة</span></span>
                </span>
              </label>
            </div>

            <p>عليه نأمل توضيح أسباب ذلك مع إرفاق ما يؤيد عذركم … ولكم تحياتي.</p>

            <p style="margin-top:8px">
              <strong>مدير المدرسة :</strong>
              <span class="dotfield" style="min-width:45mm">فهد حامد علي الزهراني</span>
              &nbsp;&nbsp; <strong>التوقيع :</strong> <span class="dotfield" style="min-width:30mm"></span>
              &nbsp;&nbsp; <strong>التاريخ :</strong> <span class="dotfield" style="min-width:22mm"></span> هـ
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) الإفادة</h3>
            <p><strong>مدير المدرسة :</strong> فهد حامد علي الزهراني</p>
            <p><strong>المكرم / مدير مدرسة.</strong></p>
            <p>السلام عليكم ورحمة الله وبركاته وبعد :</p>
            <div style="min-height:38mm;border:1px dashed #9fb7b3;border-radius:10px;padding:8px 10px;background:#fafefe">
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;border-bottom:1px dotted #9fb7b3"></div>
              <div style="height:10mm;"></div>
            </div>
            <p><span>الاسم :</span> <strong id="afadaName">—</strong>
               &nbsp;&nbsp;&nbsp; <span>التوقيع :</span> ____________________
               &nbsp;&nbsp;&nbsp; <span>التاريخ :</span> ____________________ هـ</p>
          </div>

          <div class="sec">
            <h3>( 3 ) رأي مدير المدرسة</h3>
            <p><label><input type="radio" name="opinion"> عذره مقبول</label>
               &nbsp;&nbsp;<label><input type="radio" name="opinion"> عذره غير مقبول ويُحسم عليه</label></p>
            <p><strong>مدير المدرسة :</strong> فهد حامد علي الزهراني</p>
            <p><span>التوقيع :</span> ____________________ &nbsp;&nbsp; <span>التاريخ :</span> ____________________ هـ</p>
          </div>
        </div>

        <!-- (ب) حزمة مساءلة غياب -->
        <div id="absencePack" class="abs-pack" style="display:none">
          <div class="sec" style="margin-top:0">
            <p class="para" id="absIntro">
              إنه في يوم <strong><span id="absDayP">—</span></strong>
              الموافق <strong><span id="absDateYMD">—</span></strong>
              تغيبت عن العمل.
            </p>
            <h3>( 1 ) طلب الإفادة</h3>
            <p class="para"><strong>المكرم /</strong> <span id="abs-name-top">—</span> <span>وفقه الله</span></p>
            <p class="para"><strong>السلام عليكم ورحمة الله وبركاته</strong> وبعد ،،،</p>
            <p class="para">
              من خلال متابعة سجل الدوام تبين غيابكم خلال الفترة الموضحة بعالية، آمل الإفادة عن سبب ذلك
              وعليكم تقديم ما يؤيد عذركم خلال أسبوع فقط من تاريخه، علماً بأنه في حالة عدم الإلتزام سيتم اتخاذ اللازم حسب التعليمات.
            </p>
            <p class="para">
              <strong>اسم الرئيس المباشر :</strong> فهد بن حامد علي الزهراني
              &nbsp;&nbsp;&nbsp; <strong>التوقيع :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______ هـ
            </p>
          </div>

          <div class="sec">
            <h3>( 2 ) الإفادة</h3>
            <p class="para"><strong>المكرم / مدير المدرسة</strong> وفقه الله</p>
            <p class="para"><strong>السلام عليكم ورحمة الله وبركاته</strong> وبعد:</p>
            <p class="para">أفيدكم أن غيابي كان للأسباب التالية:</p>
            <div class="lines">
              <div></div><div></div><div></div>
            </div>
            <p class="para">وسأقوم بتقديم ما يثبت ذلك خلال أسبوع من تاريخه.</p>
            <p class="para">
              <strong>اسم المعلم :</strong> <span id="abs-teacher-name">—</span>
              &nbsp;&nbsp;&nbsp; <strong>التوقيع :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______ هـ
            </p>
          </div>

          <div class="sec">
            <h3>( 3 ) مدير المدرسة</h3>
            <div class="choices">
              <label><input type="checkbox"> تُحتسب له إجازة مرضية بعد التأكد من نظامية التقرير.</label>
              <label><input type="checkbox"> يُحتسب غيابه من رصيده للإجازات الإضطرارية لقبول عذره إذا كان رصيده يسمح ولا يُحسم عليه.</label>
              <label><input type="checkbox"> يعتمد الحسم لعدم قبول عذره.</label>
            </div>
            <p class="para">
              <strong>اسم الرئيس المباشر :</strong> فهد بن حامد علي الزهراني
              &nbsp;&nbsp;&nbsp; <strong>التوقيع :</strong> ____________________
              &nbsp;&nbsp;&nbsp; <strong>التاريخ :</strong> ______ / ______ / ______ هـ
            </p>
          </div>

          <div class="note">
            <strong>ملاحظات هامة</strong><br>
            1- تُستكمل الاستمارة وتُسلم لشؤون الموظفين لاستكمال ما يجب حيالها.<br>
            2- إذا سبق العطل الرسمية غياب ولحقها غياب تُحتسب مدة الغياب كاملة بما فيها العطل الرسمية.<br>
            3- يجب أن يوضح المتغيب أسباب غيابه فور تسلمه الاستمارة ويعيدها لرئيسه.<br>
            4- يُعطى المتغيب مدة أسبوع لتقديم ما يؤيد عذره فإذا انقضت المدة الزمنية تُستكمل الاستمارة ويتم الحسم.
          </div>
        </div>

        <div class="rights">مبادرة اليعقوبي — تطوير: فهد حامد الزهراني</div>

      </div>
    </div>
  </div>
</div>

<!-- حوار الاستيراد -->
<div id="importDialog" role="dialog" aria-modal="true" style="display:none">
  <div id="importCard" style="background:#fff;border-radius:14px;min-width:320px;max-width:800px;width:90%;padding:16px;border:1px solid #e6eeee;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <h3 style="margin-top:0;color:#0b5e63">استيراد بيانات المعلمين</h3>
    <div class="map-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0">
      <label>ورقة العمل (Sheet)</label><select id="sheetSelect"></select>
      <label>عمود الاسم</label><select id="mapName"></select>
      <label>عمود السجل المدني / الهوية</label><select id="mapCivil"></select>
      <label>عمود التخصص</label><select id="mapSpec"></select>
      <label>عمود المرتبة / المستوى</label><select id="mapLevel"></select>
      <label>عمود رقم الوظيفة</label><select id="mapJob"></select>
      <label>عمود العمل الحالي</label><select id="mapWork"></select>
      <label>عمود المدرسة (اختياري)</label><select id="mapSchool"></select>
    </div>
    <div class="preview" style="max-height:220px;overflow:auto;border:1px solid #e5efef;border-radius:10px;margin-top:8px">
      <table id="previewTable" style="width:100%;border-collapse:collapse"></table>
    </div>
    <div class="dlg-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn-ghost" id="btnCancelImport" style="border:1px solid #d7ecec;background:#eef7f7;color:#0b5e63;border-radius:10px;padding:9px 12px;font-weight:800">إلغاء</button>
      <button class="btn-primary" id="btnConfirmImport" style="background:#0b7e88;color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800">اعتماد الاستيراد</button>
    </div>
  </div>
</div>

<!-- لوحة المؤقّت -->
<div id="timePad" style="display:none;position:fixed;background:#fff;border:1px solid #e6eeee;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.25);padding:10px;z-index:200">
  <div class="display" id="timePadDisplay" style="font:700 18px ui-monospace,Consolas,monospace;text-align:center;margin-bottom:6px">--:--</div>
  <div class="grid" style="display:grid;grid-template-columns:repeat(3,44px);gap:6px;justify-content:center">
    <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
    <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
    <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
    <button data-k=":">:</button><button data-k="0">0</button><button class="del">⌫</button>
  </div>
  <div class="row" style="display:flex;gap:8px;justify-content:center;margin-top:8px">
    <button class="action" id="timePadSave">حفظ</button><button id="timePadClose">إغلاق</button>
  </div>
</div>

<script>
/* أرقام عربية */
const DEFAULT_WA='966504532489';
const AR='٠١٢٣٤٥٦٧٨٩', EN='0123456789';
const en2ar = s => (s+'').replace(/[0-9]/g,d=>AR[d]);
const ar2en = s => (s+'').replace(/[٠-٩]/g,d=>EN[AR.indexOf(d)]);

/* Hijri (Umm Al-Qura) */
function fmtHijriNoSuffix(d){  // DD/MM/YYYY
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  const DD=en2ar(parts.find(p=>p.type==='day').value.padStart(2,'0'));
  const MM=en2ar(parts.find(p=>p.type==='month').value.padStart(2,'0'));
  const YY=en2ar(parts.find(p=>p.type==='year').value);
  return `${DD}/${MM}/${YY}`;
}
function fmtHijriYMDNoSuffix(d){ // YYYY/MM/DD
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  const DD=en2ar(parts.find(p=>p.type==='day').value.padStart(2,'0'));
  const MM=en2ar(parts.find(p=>p.type==='month').value.padStart(2,'0'));
  const YY=en2ar(parts.find(p=>p.type==='year').value);
  return `${YY}/${MM}/${DD}`;
}
const wdHijri  = d => new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long'}).format(d);

function hijriToGregorian(y,m,d){
  const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'});
  const parts = dt => { const p=fmt.formatToParts(dt); let yy,mm,dd;
    p.forEach(q=>{ if(q.type==='year') yy=parseInt(ar2en(q.value),10);
                   if(q.type==='month') mm=parseInt(ar2en(q.value),10);
                   if(q.type==='day') dd=parseInt(ar2en(q.value),10); });
    return {yy,mm,dd}; };
  let t=new Date(1937,0,1);
  for(let i=0;i<60000;i++){
    const a=parts(t);
    if(a.yy===y && a.mm===m && a.dd===d) return new Date(t.getFullYear(),t.getMonth(),t.getDate());
    t.setDate(t.getDate()+1);
  }
  return null;
}

/* مُنتقي التاريخ الهجري */
(function buildHijriPicker(){
  const dSel=document.getElementById('hjDay'), mSel=document.getElementById('hjMonth'), ySel=document.getElementById('hjYear');
  for(let d=1; d<=30; d++) dSel.add(new Option(en2ar(String(d).padStart(2,'0')), d));
  for(let m=1; m<=12; m++) mSel.add(new Option(en2ar(String(m).padStart(2,'0')), m));
  const now=new Date();
  const curAH=parseInt(ar2en(new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric'}).format(now)),10);
  for(let y=curAH-10; y<=curAH+10; y++) ySel.add(new Option(en2ar(y), y));
  const parts=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
  dSel.value=parseInt(ar2en(parts.find(p=>p.type==='day').value),10);
  mSel.value=parseInt(ar2en(parts.find(p=>p.type==='month').value),10);
  ySel.value=parseInt(ar2en(parts.find(p=>p.type==='year').value),10);

  function update(){
    const y=+ySel.value,m=+mSel.value,d=+dSel.value;
    const g=hijriToGregorian(y,m,d); if(!g){ alert('تعذّر تحويل التاريخ الهجري'); return; }

    /* الهيدر: السنة/الشهر/اليوم */
    const hijYMD=fmtHijriYMDNoSuffix(g);
    document.getElementById('hdrHijri').textContent = `${hijYMD} هـ`;

    /* سطور التنبيه (اليوم/الشهر/السنة) */
    const hijNo=fmtHijriNoSuffix(g);
    const dayName = wdHijri(g);
    document.getElementById('dynDay').textContent = dayName;
    document.getElementById('dynHijri').textContent = hijNo;

    /* مساءلة الغياب (السنة/الشهر/اليوم) */
    document.getElementById('absDayP').textContent  = dayName;
    document.getElementById('absDateYMD').textContent = hijYMD;
  }
  dSel.onchange=mSel.onchange=ySel.onchange=update; update();
})();

/* بيانات المعلمين */
let TEACHERS=JSON.parse(localStorage.getItem('teachersCache')||'[]');
let currentIdx = null;
function pad2(n){return String(n).padStart(2,'0');}
function refreshCaseNo(name){ const key='cases_'+(name||''); const total=parseInt(localStorage.getItem(key)||'0',10);
  document.getElementById('serialNo').textContent = pad2(total+1);
  document.getElementById('caseTotal').textContent = total;
}
function applyTeacher(t, idx=null){
  currentIdx = idx;
  document.getElementById('schoolNameHdr').textContent = t.school || 'مدرسة اليعقوبي الثانوية';
  const set=(id,v)=>document.getElementById(id).textContent=v||'';
  set('t_name',t.name); set('t_spec',t.spec); set('t_level',t.level||t.rank); set('t_job',t.job); set('t_work',t.work);
  document.getElementById('t_civil').textContent = t.civil || '';
  document.getElementById('afadaName').textContent = t.name || '—';
  document.getElementById('abs-name-top').textContent = t.name || '—';
  document.getElementById('abs-teacher-name').textContent = t.name || '—';
  refreshCaseNo(t.name||'');
}
function refillSelect(){
  const sel=document.getElementById('teacherSelect');
  sel.innerHTML='<option value="">— اختر معلماً —</option>';
  TEACHERS.forEach((t,i)=> sel.add(new Option(t.name? t.name : `بدون اسم ${i+1}`, i)));
}
refillSelect();
const selEl=document.getElementById('teacherSelect');
const searchEl=document.getElementById('teacherSearch');
selEl && selEl.addEventListener('change',e=>{const i=+e.target.value; if(Number.isInteger(i)&&TEACHERS[i]) applyTeacher(TEACHERS[i], i);});
searchEl && searchEl.addEventListener('input',()=>{const q=searchEl.value.trim(); for(const o of selEl.options){ if(!o.value){o.hidden=false;continue;} o.hidden=q && !o.text.includes(q); }});
['t_name','t_spec','t_level','t_job','t_work','t_civil'].forEach(id=>{
  const el=document.getElementById(id); if(!el) return;
  el.addEventListener('blur',()=>{
    if(currentIdx==null || !TEACHERS[currentIdx]) return;
    const v=el.textContent.trim();
    if(id==='t_name'){ TEACHERS[currentIdx].name=v; document.getElementById('afadaName').textContent=v||'—';
      document.getElementById('abs-name-top').textContent=v||'—';
      document.getElementById('abs-teacher-name').textContent=v||'—';
    } else if(id==='t_spec'){ TEACHERS[currentIdx].spec=v; }
    else if(id==='t_level'){ TEACHERS[currentIdx].level=v; }
    else if(id==='t_job'){ TEACHERS[currentIdx].job=v; }
    else if(id==='t_work'){ TEACHERS[currentIdx].work=v; }
    else if(id==='t_civil'){ TEACHERS[currentIdx].civil=v; }
    localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
  });
});

/* تصفير الاستيراد */
document.getElementById('btnClearImport')?.addEventListener('click', ()=>{
  if(!confirm('تأكيد تصفير بيانات الاستيراد والأسماء؟')) return;
  TEACHERS=[]; localStorage.removeItem('teachersCache'); refillSelect();
  ['t_name','t_spec','t_level','t_job','t_work','t_civil','afadaName','abs-name-top','abs-teacher-name'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return; el.textContent='';
  });
  document.getElementById('afadaName').textContent='—';
  document.getElementById('abs-name-top').textContent='—';
  document.getElementById('abs-teacher-name').textContent='—';
});

/* الاستيراد متعدد الصيغ */
const fileInput=document.getElementById('fileInput');
const drop=document.getElementById('dropZone');
const importDialog=document.getElementById('importDialog');
document.getElementById('btnImport')?.addEventListener('click',()=>fileInput.click());
['dragenter','dragover'].forEach(ev=>drop?.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>drop?.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag');}));
drop?.addEventListener('drop',e=>{e.preventDefault(); const f=e.dataTransfer.files[0]; if(f) beginImport(f);});
fileInput?.addEventListener('change',e=>{if(e.target.files[0]) beginImport(e.target.files[0]);});

let IMPORT_CTX = {workbook:null, sheets:[], arrays:{}, headers:{}};
async function beginImport(file){
  const name=file.name||''; const ext=(name.split('.').pop()||'').toLowerCase();
  try{
    let wb=null, sheetNames=[], arrays={};
    if(['xlsx','xls','xlsm','xlsb','xltx','xltm','ods'].includes(ext)){
      const ab=await file.arrayBuffer(); wb=XLSX.read(ab,{type:'array'}); sheetNames=wb.SheetNames;
      for(const sh of sheetNames){ const ws=wb.Sheets[sh]; arrays[sh]=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:''}); }
    }else if(['csv','tsv','json'].includes(ext) || !ext){
      if(ext==='json'){
        const txt=await file.text(); const obj=JSON.parse(txt);
        const keys=new Set(); obj.forEach(r=>Object.keys(r).forEach(k=>keys.add(k)));
        const heads=[...keys]; const rows=obj.map(r=>heads.map(h=>r[h]??'')); arrays['البيانات']=[heads,...rows]; sheetNames=['البيانات'];
      }else{
        const txt=await file.text();
        const sep=(ext==='tsv'||txt.includes('\t'))?'\t':','; 
        const lines=txt.trim().split(/\r?\n/);
        const heads=lines.shift().split(sep).map(h=>h.trim()); 
        const rows=lines.map(line=>line.split(sep)); 
        arrays['البيانات']=[heads,...rows]; sheetNames=['البيانات'];
      }
    }else{
      const ab=await file.arrayBuffer(); const wb2=XLSX.read(ab,{type:'array'}); wb=wb2; sheetNames=wb2.SheetNames;
      for(const sh of sheetNames){ const ws=wb2.Sheets[sh]; arrays[sh]=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:''}); }
    }
    IMPORT_CTX={workbook:wb,sheets:sheetNames,arrays:arrays,headers:{}};
    openImportDialog();
  }catch(err){ console.error(err); alert('تعذّر قراءة الملف.'); }
}
function openImportDialog(){
  const sheetSel=document.getElementById('sheetSelect'); sheetSel.innerHTML='';
  IMPORT_CTX.sheets.forEach(sh=>sheetSel.add(new Option(sh,sh)));
  sheetSel.onchange=refreshMappingUI;
  ['mapName','mapCivil','mapSpec','mapLevel','mapJob','mapWork','mapSchool'].forEach(id=>document.getElementById(id).innerHTML='');
  refreshMappingUI(); importDialog.style.display='flex';
  document.getElementById('btnCancelImport').onclick=()=>{ importDialog.style.display='none'; };
  document.getElementById('btnConfirmImport').onclick=confirmImport;
}
function guess(header){
  const h=(header||'').toString().trim().toLowerCase();
  const norm=h.replace(/[^\u0600-\u06FFa-z0-9 ]/g,'');
  const tests={
    name:['name','الاسم','اسم','المعلم','معلم','الموظف','موظف'],
    civil:['civil','national','id','identity','السجل','السجل المدني','رقم الهوية','الهوية','هوية','رقم السجل'],
    spec:['التخصص','تخصص','subject','spec','specialty'],
    level:['المرتبة','رتبة','rank','grade','level','المستوى','مستوى'],
    job:['رقم الوظيفة','وظيفة','job','employee id','كود'],
    work:['العمل الحالي','العمل','work','job title','المسمى'],
    school:['المدرسة','school']
  };
  for(const k in tests){ if(tests[k].some(key=>norm.includes(key))) return k; }
  return null;
}
function refreshMappingUI(){
  const sheetSel=document.getElementById('sheetSelect');
  const sh=sheetSel.value || IMPORT_CTX.sheets[0]; const A=IMPORT_CTX.arrays[sh]||[];
  const heads=(A[0]||[]).map(x=>String(x||'').trim()); const rows=A.slice(1,1+10);
  const fillSel=id=>{ const el=document.getElementById(id); el.innerHTML='<option value="">— اختر عمودًا —</option>'; heads.forEach((h,i)=>el.add(new Option(h||`عمود ${i+1}`, i))); return el; };
  const sName=fillSel('mapName'), sCivil=fillSel('mapCivil'), sSpec=fillSel('mapSpec'),
        sLevel=fillSel('mapLevel'), sJob=fillSel('mapJob'), sWork=fillSel('mapWork'), sSchool=fillSel('mapSchool');
  const idxByRole={}; heads.forEach((h,i)=>{ const r=guess(h); if(r && idxByRole[r]==null) idxByRole[r]=i; });
  if(idxByRole.name!=null) sName.value=idxByRole.name;
  if(idxByRole.civil!=null) sCivil.value=idxByRole.civil;
  if(idxByRole.spec!=null) sSpec.value=idxByRole.spec;
  if(idxByRole.level!=null) sLevel.value=idxByRole.level;
  if(idxByRole.job!=null) sJob.value=idxByRole.job;
  if(idxByRole.work!=null) sWork.value=idxByRole.work;
  if(idxByRole.school!=null) sSchool.value=idxByRole.school;

  const table=document.getElementById('previewTable');
  table.innerHTML='';
  const thead=document.createElement('thead'); const hr=document.createElement('tr');
  heads.forEach(h=>{const th=document.createElement('th'); th.textContent=h||''; hr.appendChild(th);});
  thead.appendChild(hr); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    heads.forEach((_,i)=>{const td=document.createElement('td'); td.textContent=(r[i]!=null?r[i]:''); tr.appendChild(td);});
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
}
function confirmImport(){
  const sheetSel=document.getElementById('sheetSelect');
  const sh=sheetSel.value || IMPORT_CTX.sheets[0]; const A=IMPORT_CTX.arrays[sh]||[]; if(A.length<2){ alert('لا توجد بيانات.'); return; }
  const getIdx = id => { const v=document.getElementById(id).value; return v? parseInt(v,10): -1; };
  const ixName=getIdx('mapName'), ixCivil=getIdx('mapCivil'), ixSpec=getIdx('mapSpec'),
        ixLevel=getIdx('mapLevel'), ixJob=getIdx('mapJob'), ixWork=getIdx('mapWork'), ixSchool=getIdx('mapSchool');
  const out=[];
  for(let r=1;r<A.length;r++){
    const row=A[r]||[]; const pick=i=> (i>=0 && i<row.length)? String(row[i]??'').trim() : '';
    out.push({name:pick(ixName),civil:pick(ixCivil),spec:pick(ixSpec),level:pick(ixLevel),job:pick(ixJob),work:pick(ixWork),school:pick(ixSchool)});
  }
  TEACHERS=out.filter(t=> (t.name||t.civil||t.spec||t.level||t.job||t.work));
  localStorage.setItem('teachersCache', JSON.stringify(TEACHERS));
  refillSelect(); importDialog.style.display='none';
}

/* تبديل الوضع (غياب / تنبيه) */
const segEl   = document.getElementById('noticeSeg');
const radios  = segEl.querySelectorAll('input[name="nt"]');
const kindLbl = document.getElementById('kindTitle');
const mainTitle = document.getElementById('mainTitle');
const alertPack = document.getElementById('alertPack');
const absencePack = document.getElementById('absencePack');
const rowLate  = document.getElementById('lineLate');
const rowAbs   = document.getElementById('lineAbs');
const rowEarly = document.getElementById('lineEarly');

function setNotice(kind){
  if(kind==='gaib'){
    mainTitle.textContent = 'مساءلة غياب';
    alertPack.style.display = 'none';
    absencePack.style.display = 'block';
  }else{
    mainTitle.textContent = 'تنبيه';
    alertPack.style.display = 'block';
    absencePack.style.display = 'none';
    kindLbl.textContent = (kind==='late') ? 'تأخر' : (kind==='absent' ? 'عدم تواجد' : 'انصراف مبكر');
    rowLate.style.display  = (kind==='late')   ? 'flex' : 'none';
    rowAbs.style.display   = (kind==='absent') ? 'flex' : 'none';
    rowEarly.style.display = (kind==='early')  ? 'flex' : 'none';
  }
}
radios.forEach(r => r.addEventListener('change', e => setNotice(e.target.value)));
setNotice(segEl.querySelector('input[name="nt"]:checked')?.value || 'late');

/* طباعة / PDF / واتساب */
document.getElementById('btnPrint')?.addEventListener('click',()=>{
  const name=(document.getElementById('t_name').textContent||'').trim();
  if(name){
    const key='cases_'+name; let total=parseInt(localStorage.getItem(key)||'0',10);
    total += 1; localStorage.setItem(key,total);
    document.getElementById('caseTotal').textContent = total;
    document.getElementById('serialNo').textContent  = (total<100? String(total).padStart(2,'0'): String(total));
  }
  const hj=(document.getElementById('hdrHijri').textContent||'').replace(/\s+/g,' ').trim();
  const old=document.title; document.title=`${mainTitle.textContent} — ${name||'بدون اسم'} — ${hj}`; window.print(); setTimeout(()=>document.title=old,500);
});

async function exportPDFBlob(){
  document.body.classList.add('exporting');
  const sheet=document.getElementById('sheet');
  const canvas = await html2canvas(sheet,{scale:3,useCORS:true,background:'#ffffff',logging:false});
  document.body.classList.remove('exporting');
  const img = canvas.toDataURL('image/jpeg',1.0);
  const {jsPDF}=window.jspdf; const pdf=new jsPDF('p','mm','a4');
  const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
  const px2mm=px=>px*25.4/96, imgWmm=px2mm(canvas.width), imgHmm=px2mm(canvas.height);
  const s=Math.min(pageW/imgWmm,pageH/imgHmm), w=imgWmm*s, h=imgHmm*s;
  pdf.addImage(img,'JPEG',(pageW-w)/2,(pageH-h)/2,w,h);
  return pdf.output('blob');
}
document.getElementById('btnMakePDF')?.addEventListener('click', async ()=>{
  const blob=await exportPDFBlob();
  const name=(document.getElementById('t_name').textContent||'بدون اسم').trim();
  const hj=(document.getElementById('hdrHijri').textContent||'التاريخ الهجري').trim();
  const fileName=`${mainTitle.textContent} — ${name} — ${hj}.pdf`;
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=fileName; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('btnWA')?.addEventListener('click', async ()=>{
  const blob=await exportPDFBlob();
  const name=(document.getElementById('t_name').textContent||'بدون اسم').trim();
  const hj=(document.getElementById('hdrHijri').textContent||'التاريخ الهجري').trim();
  const fileName=`${mainTitle.textContent} — ${name} — ${hj}.pdf`;
  const msg=`${mainTitle.textContent} للمعلم: ${name}\nالتاريخ الهجري: ${hj}\n(مرفق ملف PDF)`;
  const file=new File([blob],fileName,{type:'application/pdf'});
  if(navigator.canShare && navigator.canShare({files:[file]})){
    try{ await navigator.share({files:[file], text:msg, title:fileName}); }catch(e){}
  }
  window.open(`https://wa.me/${DEFAULT_WA}?text=${encodeURIComponent(msg)}`,'_blank');
});

/* مؤقت الساعة والحسابات */
let active=null; const pad=document.getElementById('timePad'),disp=document.getElementById('timePadDisplay');
document.querySelectorAll('.timebox').forEach(el=>el.addEventListener('click',()=>openPad(el)));
function openPad(el){active=el;disp.textContent=el.dataset.value||'--:--';pad.style.display='block';const r=el.getBoundingClientRect();pad.style.left=Math.min(window.innerWidth-220,r.left)+'px';pad.style.top=(r.bottom+8)+'px';}
function closePad(){pad.style.display='none';active=null;}
document.getElementById('timePadClose')?.addEventListener('click',closePad);
document.getElementById('timePadSave')?.addEventListener('click',()=>{if(!active) return; const v=disp.textContent; active.textContent=v; active.classList.toggle('empty',!/\d\d:\d\d/.test(v)); active.dataset.value=v; recalc(); closePad();});
document.querySelectorAll('#timePad .grid button').forEach(b=>b.addEventListener('click',()=>{
  if(b.classList.contains('del')){disp.textContent=disp.textContent.slice(0,-1)||'--:--';return;}
  const k=b.dataset.k; let v=disp.textContent.replace(/-/g,'').replace(/:/g,''); if(disp.textContent==='--:--') v='';
  if(k===':'){if(v.length>=2 && !v.includes(':')) disp.textContent=v.slice(0,2)+':'+v.slice(2); return;}
  if(/[0-9]/.test(k)){v+=k; if(v.length<=4){disp.textContent=(v.padEnd(4,'-').slice(0,2))+':'+(v.padEnd(4,'-').slice(2,4));}}
}));
const t2m=t=>{ if(!/^\d{2}:\d{2}$/.test(t||'')) return null; const [h,m]=t.split(':').map(Number); return h*60+m; };
const fmtDur=mins=>{ mins=Math.max(0,Math.round(mins||0)); const h=Math.floor(mins/60),m=mins%60; return h?(م?`${h} ساعة و ${m} دقيقة`:`${h} ساعة`):`${m} دقيقة`; };
function recalc(){
  const ws=document.getElementById('workStart')?.value||'06:45';
  const we=document.getElementById('workEnd')?.value||'13:45';
  const mWS=t2m(ws), mWE=t2m(we);
  const mLate=t2m((document.getElementById('tLateIn')?.dataset.value)||'');
  const late = (mWS!=null && mLate!=null) ? Math.max(0, mLate - mWS) : 0;
  const mAF=t2m((document.getElementById('tAbsFrom')?.dataset.value)||'');
  const mAT=t2m((document.getElementById('tAbsTo')?.dataset.value)||'');
  const abs = (mAF!=null && mAT!=null) ? Math.max(0, mAT - mAF) : 0;
  const mEF=t2m((document.getElementById('tEarlyFrom')?.dataset.value)||'');
  const early = (mWE!=null && mEF!=null) ? Math.max(0, mWE - mEF) : 0;
  document.getElementById('lateTotal').textContent  = fmtDur(late);
  document.getElementById('absTotal').textContent   = fmtDur(abs);
  document.getElementById('earlyTotal').textContent = fmtDur(early);
}
recalc();

/* تصفير عدّادات المساءلات */
document.getElementById('btnResetCases')?.addEventListener('click',()=>{
  if(!confirm('تأكيد تصفير جميع عدّادات المساءلات؟')) return;
  const keys=[]; for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i); if(k && k.startsWith('cases_')) keys.push(k);}
  keys.forEach(k=>localStorage.removeItem(k));
  document.getElementById('caseTotal').textContent='0';
  document.getElementById('serialNo').textContent='01';
});
</script>
</body>
</html>
